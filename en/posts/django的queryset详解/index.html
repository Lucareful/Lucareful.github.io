<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Luenci</title>
<meta name=keywords content><meta name=description content="从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。
一、QuerySet何时被提交

在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作：

迭代

QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来：



1
2


for e in Entry.objects.all():
	print(e.headline)



切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。

Pickling/缓存


repr()"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/django%E7%9A%84queryset%E8%AF%A6%E8%A7%A3/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/django%E7%9A%84queryset%E8%AF%A6%E8%A7%A3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://umami.luenci.com/script.js data-website-id=b0a9e971-b470-43a2-bda9-182c654377f4></script><meta property="og:title" content><meta property="og:description" content="从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。
一、QuerySet何时被提交

在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作：

迭代

QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来：



1
2


for e in Entry.objects.all():
	print(e.headline)



切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。

Pickling/缓存


repr()"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/django%E7%9A%84queryset%E8%AF%A6%E8%A7%A3/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。
一、QuerySet何时被提交

在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作：

迭代

QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来：



1
2


for e in Entry.objects.all():
	print(e.headline)



切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。

Pickling/缓存


repr()"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"","item":"https://luenci.com/en/posts/django%E7%9A%84queryset%E8%AF%A6%E8%A7%A3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。\n一、QuerySet何时被提交 在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作： 迭代 QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来： 1 2 for e in Entry.objects.all(): print(e.headline) 切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。 Pickling/缓存 repr()\n","keywords":[],"articleBody":"从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。\n一、QuerySet何时被提交 在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作： 迭代 QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来： 1 2 for e in Entry.objects.all(): print(e.headline) 切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。 Pickling/缓存 repr()\nlen()：当你对QuerySet调用len()时， 将提交数据库操作。\nlist()：对QuerySet调用list()将强制提交操作entry_list = list(Entry.objects.all())\nbool()\n测试布尔值，像这样：\n1 2 if Entry.objects.filter(headline=\"Test\"): print(\"There is at least one Entry with the headline Test\") 注：如果你需要知道是否存在至少一条记录（而不需要真实的对象），使用exists() 将更加高效。\n二、QuerySet 下面是对于QuerySet的正式定义：\nclass QuerySet(model=None, query=None, using=None)[source] QuerySet类具有两个公有属性用于内省：\nordered：如果QuerySet是排好序的则为True，否则为False。\ndb：如果现在执行，则返回使用的数据库。\n三、返回新QuerySets的API 以下的方法都将返回一个新的QuerySets。重点是加粗的几个API，其它的使用场景很少。 方法名 解释 filter() 过滤查询对象。\nexclude() 排除满足条件的对象\nannotate() 使用聚合函数\norder_by() 对查询集进行排序\nreverse() 反向排序\ndistinct() 对查询集去重\nvalues() 返回包含对象具体值的字典的QuerySet\nvalues_list() 与values()类似，只是返回的是元组而不是字典。\ndates() 根据日期获取查询集\ndatetimes() 根据时间获取查询集\nnone() 创建空的查询集\nall() 获取所有的对象\nunion() 并集\nintersection() 交集\ndifference() 差集\nselect_related() 附带查询关联对象\nprefetch_related()预先查询\nextra() 附加SQL查询\ndefer() 不加载指定字段\nonly() 只加载指定的字段\nusing() 选择数据库\nselect_for_update()锁住选择的对象，直到事务结束。\nraw() 接收一个原始的SQL查询\n1. filter() filter(**kwargs)\n返回满足查询参数的对象集合。\n查找的参数（**kwargs）应该满足下文字段查找中的格式。多个参数之间是和AND的关系。\n2. exclude() exclude(**kwargs)\n返回一个新的QuerySet，它包含不满足给定的查找参数的对象。\n查找的参数（**kwargs）应该满足下文字段查找中的格式。多个参数通过AND连接，然后所有的内容放入NOT() 中。\n1 2 3 4 5 6 7 # 下面的示例排除所有pub_date晚于2005-1-3且headline为“Hello” 的记录： Entry.objects.exclude(pub_date__gt=[datetime.date](2005, 1, 3), headline='Hello') # 下面的示例排除所有pub_date晚于2005-1-3或者headline 为“Hello” 的记录： Entry.objects.exclude(pub_date__gt=[datetime.date](2005, 1, 3)).exclude(headline='Hello') 3. annotate() annotate(args, *kwargs)\n使用提供的聚合表达式查询对象。\n表达式可以是简单的值、对模型（或任何关联模型）上的字段的引用或者聚合表达式（平均值、总和等）。\nannotate()的每个参数都是一个annotation，它将添加到返回的QuerySet每个对象中。\n关键字参数指定的Annotation将使用关键字作为Annotation 的别名。 匿名参数的别名将基于聚合函数的名称和模型的字段生成。 只有引用单个字段的聚合表达式才可以使用匿名参数。 其它所有形式都必须用关键字参数。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # 例如，如果正在操作一个Blog列表，你可能想知道每个Blog有多少Entry： \u003e\u003e\u003e from django.db.models import Count \u003e\u003e\u003e q = Blog.objects.annotate(Count('entry')) # The name of the first blog \u003e\u003e\u003e q[0].name 'Blogasaurus' # The number of entries on the first blog \u003e\u003e\u003e q[0].entry__count 42 # Blog模型本身没有定义entry__count属性，但是通过使用一个关键字参数来指定聚合函数，可以控制Annotation的名称： \u003e\u003e\u003e q = Blog.objects.annotate(number_of_entries=Count('entry')) # The number of entries on the first blog, using the name provided \u003e\u003e\u003e q[0].number_of_entries 42 4. order_by() order_by(*fields)\n默认情况下，根据模型的Meta类中的ordering属性对QuerySet中的对象进行排序 Entry.objects.filter(pub_date__year=2005).order_by('-pub_date', 'headline')\n上面的结果将按照pub_date降序排序，然后再按照headline升序排序。\"-pub_date\"前面的负号表示降序顺序。 升序是默认的。 要随机排序，使用\"?\"，如下所示：\nEntry.objects.order_by(’?')\n注：order_by(’?’)可能耗费资源且很慢，这取决于使用的数据库。\n若要按照另外一个模型中的字段排序，可以使用查询关联模型的语法。即通过字段的名称后面跟两个下划线（__），再加上新模型中的字段的名称，直到希望连接的模型。 像这样：\nEntry.objects.order_by(‘blog__name’, ‘headline’)\n如果排序的字段与另外一个模型关联，Django将使用关联的模型的默认排序，或者如果没有指定Meta.ordering将通过关联的模型的主键排序。 例如，因为Blog模型没有指定默认的排序：\nEntry.objects.order_by(‘blog’)\n与以下相同：\nEntry.objects.order_by('blog__id')\n如果Blog设置了ordering = [’name’]，那么第一个QuerySet将等同于：\nEntry.objects.order_by(‘blog__name’)\n还可以通过调用表达式的desc()或者asc()方法：\nEntry.objects.order_by(Coalesce(‘summary’, ‘headline’).desc())\n考虑下面的情况，指定一个多值字段来排序（例如，一个ManyToManyField 字段或者ForeignKey 字段的反向关联）：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class Event(Model): parent = models.ForeignKey( 'self', on_delete=models.CASCADE, related_name='children', ) date = models.DateField() Event.objects.order_by('children__date') 在这里，每个Event可能有多个排序数据；具有多个children的每个Event将被多次返回到order_by()创建的新的QuerySet中。 换句话说，用order_by()方法对QuerySet对象进行操作会返回一个扩大版的新QuerySet对象。因此，使用多值字段对结果进行排序时要格外小心。\n没有方法指定排序是否考虑大小写。 对于大小写的敏感性，Django将根据数据库中的排序方式排序结果。\n可以通过Lower将一个字段转换为小写来排序，它将达到大小写一致的排序：\nEntry.objects.order_by(Lower('headline').desc())\n可以通过检查QuerySet.ordered属性来知道查询是否是排序的。\n每个order_by()都将清除前面的任何排序。 例如下面的查询将按照pub_date排序，而不是headline：\nEntry.objects.order_by('headline').order_by('pub_date')\n5. reverse() reverse()\n反向排序QuerySet中返回的元素。 第二次调用reverse()将恢复到原有的排序。\n如要获取QuerySet中最后五个元素，可以这样做：\nmy_queryset.reverse()[:5]\n这与Python直接使用负索引有点不一样。 Django不支持负索引，只能曲线救国。\n6. distinct() distinct(*fields)\n去除查询结果中重复的行。\n默认情况下，QuerySet不会去除重复的行。当查询跨越多张表的数据时，QuerySet可能得到重复的结果，这时候可以使用distinct()进行去重。\n7. values() values(fields, *expressions)\n返回一个包含数据的字典的queryset，而不是模型实例。\n每个字典表示一个对象，键对应于模型对象的属性名称。\n下面的例子将values() 与普通的模型对象进行比较：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 # 列表中包含的是Blog对象 \u003e\u003e\u003e Blog.objects.filter(name__startswith='Beatles') \u003cQuerySet [\u003cBlog: Beatles Blog\u003e]\u003e # 列表中包含的是数据字典 \u003e\u003e\u003e Blog.objects.filter(name__startswith='Beatles').values() \u003cQuerySet [{'id': 1, 'name': 'Beatles Blog', 'tagline': 'All the latest Beatles news.'}]\u003e 该方法接收可选的位置参数*fields，它指定values()应该限制哪些字段。如果指定字段，每个字典将只包含指定的字段的键/值。如果没有指定字段，每个字典将包含数据库表中所有字段的键和值。 例如： \u003e\u003e\u003e Blog.objects.values() \u003cQuerySet [{'id': 1, 'name': 'Beatles Blog', 'tagline': 'All the latest Beatles news.'}]\u003e \u003e\u003e\u003e Blog.objects.values('id', 'name') \u003cQuerySet [{'id': 1, 'name': 'Beatles Blog'}]\u003e values()方法还有关键字参数**expressions，这些参数将传递给annotate()： \u003e\u003e\u003e from django.db.models.functions import Lower \u003e\u003e\u003e Blog.objects.values(lower_name=Lower('name')) \u003cQuerySet [{'lower_name': 'beatles blog'}]\u003e 在values()子句中的聚合应用于相同values()子句中的其他参数之前。 如果需要按另一个值分组，请将其添加到较早的values()子句中。 像这样： \u003e\u003e\u003e from django.db.models import Count \u003e\u003e\u003e Blog.objects.values('author', entries=Count('entry')) \u003cQuerySet [{'author': 1, 'entries': 20}, {'author': 1, 'entries': 13}]\u003e \u003e\u003e\u003e Blog.objects.values('author').annotate(entries=Count('entry')) \u003cQuerySet [{'author': 1, 'entries': 33}]\u003e 注意： 如果你有一个字段foo是一个ForeignKey，默认的foo_id参数返回的字典中将有一个叫做foo 的键，因为这是保存实际值的那个隐藏的模型属性的名称。 当调用foo_id并传递字段的名称，传递foo 或values()都可以，得到的结果是相同的。像这样： \u003e\u003e\u003e Entry.objects.values() \u003cQuerySet [{'blog_id': 1, 'headline': 'First Entry', ...}, ...]\u003e \u003e\u003e\u003e Entry.objects.values('blog') \u003cQuerySet [{'blog': 1}, ...]\u003e \u003e\u003e\u003e Entry.objects.values('blog_id') \u003cQuerySet [{'blog_id': 1}, ...]\u003e 当values()与distinct()一起使用时，注意排序可能影响最终的结果。 如果values()子句位于extra()调用之后，extra()中的select参数定义的字段必须显式包含在values()调用中。 values( 调用后面的extra( 调用将忽略选择的额外的字段。在values()之后调用only()和defer()不太合理，所以将引发一个NotImplementedError。可以通过ManyToManyField、ForeignKey 和 OneToOneFiel 属性反向引用关联的模型的字段： \u003e\u003e\u003e Blog.objects.values('name', 'entry__headline') \u003cQuerySet [{'name': 'My blog', 'entry__headline': 'An entry'},{'name': 'My blog', 'entry__headline': 'Another entry'}, ...]\u003e 8. values_list() values_list(*fields, flat=False)\n与values()类似，只是在迭代时返回的是元组而不是字典。每个元组包含传递给values_list()调用的相应字段或表达式的值，因此第一个项目是第一个字段等。 像这样： 1 2 3 4 5 6 7 8 9 \u003e\u003e\u003e Entry.objects.values_list('id', 'headline') \u003cQuerySet [(1, 'First entry'), ...]\u003e \u003e\u003e\u003e from django.db.models.functions import Lower \u003e\u003e\u003e Entry.objects.values_list('id', Lower('headline')) \u003cQuerySet [(1, 'first entry'), ...]\u003e 如果只传递一个字段，还可以传递flat参数。 如果为True，它表示返回的结果为单个值而不是元组。 如下所示： 1 2 3 4 5 6 7 \u003e\u003e\u003e Entry.objects.values_list('id').order_by('id') \u003cQuerySet[(1,), (2,), (3,), ...]\u003e \u003e\u003e\u003e Entry.objects.values_list('id', flat=True).order_by('id') \u003cQuerySet [1, 2, 3, ...]\u003e 如果有多个字段，传递flat将发生错误。\n如果不传递任何值给values_list()，它将返回模型中的所有字段，以在模型中定义的顺序。\n常见的情况是获取某个模型实例的特定字段值。可以使用values_list()，然后调用get()：\n1 2 \u003e\u003e\u003e Entry.objects.values_list('headline', flat=True).get(pk=1) 'First entry' values()和values_list()都用于特定情况下的优化：检索数据子集，而无需创建模型实例。 注意通过ManyToManyField进行查询时的行为： 1 2 3 4 5 6 7 8 9 10 \u003e\u003e\u003e Author.objects.values_list('name', 'entry__headline') \u003cQuerySet [('Noam Chomsky', 'Impressions of Gaza'),('George Orwell', 'Why Socialists Do Not Believe in Fun'), ('George Orwell', 'In Defence of English Cooking'),('Don Quixote', None)]\u003e # 类似地，当查询反向外键时，对于没有任何作者的条目，返回None。 \u003e\u003e\u003e Entry.objects.values_list('authors') \u003cQuerySet [('Noam Chomsky',), ('George Orwell',), (None,)]\u003e 9. dates() dates(field, kind, order='ASC')\n返回一个QuerySet，表示QuerySet内容中特定类型的所有可用日期的datetime.date对象列表。\nfield参数是模型的DateField的名称。 kind参数应为\"year\"，“month\"或\"day”。 结果列表中的每个datetime.date对象被截取为给定的类型。\n“year” 返回对应该field的所有不同年份值的列表。\n“month\"返回字段的所有不同年/月值的列表。\n“day\"返回字段的所有不同年/月/日值的列表。\norder参数默认为’ASC’，或者’DESC’。 它指定如何排序结果。\n例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u003e\u003e\u003e Entry.objects.dates('pub_date', 'year') [[datetime.date](2005, 1, 1)] \u003e\u003e\u003e Entry.objects.dates('pub_date', 'month') [[datetime.date](2005, 3, 1)] \u003e\u003e\u003e Entry.objects.dates('pub_date', 'day') [[datetime.date](2005, 3, 20)] \u003e\u003e\u003e Entry.objects.dates('pub_date', 'day', order='DESC') [[datetime.date](2005, 2, 20)] \u003e\u003e\u003e Entry.objects.filter(headline__contains='Lennon').dates('pub_date', 'day') [[datetime.date](2005, 3, 20)] 10. datetimes() datetimes(field_name, kind, order='ASC', tzinfo=None)\n返回QuerySet，为datetime.datetime对象的列表，表示QuerySet内容中特定种类的所有可用日期。\nfield_name应为模型的DateTimeField的名称。\nkind参数应为\"hour”，“minute”，“month”，“year”，“second\"或\"day”。\n结果列表中的每个datetime.datetime对象被截取到给定的类型。\norder参数默认为’ASC’，或者’DESC’。 它指定如何排序结果。\ntzinfo参数定义在截取之前将数据时间转换到的时区。\n11. none() none()\n调用none()将创建一个不返回任何对象的查询集，并且在访问结果时不会执行任何查询。 1 2 3 4 5 6 7 8 9 10 11 例子： \u003e\u003e\u003e Entry.objects.none() \u003cQuerySet []\u003e \u003e\u003e\u003e from django.db.models.query import EmptyQuerySet \u003e\u003e\u003e isinstance(Entry.objects.none(), EmptyQuerySet) True 12. all() all()\n返回当前QuerySet（或QuerySet子类）的副本。通常用于获取全部QuerySet对象。 13. union() union(*other_qs, all=False)\nDjango中的新功能1.11。也就是集合中并集的概念！\n使用SQL的UNION运算符组合两个或更多个QuerySet的结果。例如：\nqs1.union(qs2, qs3)\n默认情况下，UNION操作符仅选择不同的值。 要允许重复值，请使用all=True参数。 14. intersection() intersection(*other_qs)\nDjango中的新功能1.11。也就是集合中交集的概念！\n使用SQL的INTERSECT运算符返回两个或更多个QuerySet的共有元素。例如：\nqs1.intersection(qs2, qs3)\n15. difference() difference(*other_qs)\nDjango中的新功能1.11。也就是集合中差集的概念！\n使用SQL的EXCEPT运算符只保留QuerySet中的元素，但不保留其他QuerySet中的元素。例如：\nqs1.difference(qs2, qs3)\n16. select_related() select_related(*fields)\n沿着外键关系查询关联的对象的数据。这会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要再次数据库查询。\n下面的例子解释了普通查询和select_related()查询的区别。 下面是一个标准的查询：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # 访问数据库。 e = Entry.objects.get(id=5) # 再次访问数据库以得到关联的Blog对象。 b = [e.blog] 下面是一个select_related查询： # 访问数据库。 e = Entry.objects.select_related('blog').get(id=5) # 不会访问数据库，因为e.blog已经在前面的查询中获得了。 b = [e.blog] select_related()可用于objects任何的查询集： from django.utils import timezone # Find all the blogs with entries scheduled to be published in the future. blogs = set() for e in Entry.objects.filter(pub_date__gt=[timezone.now]()).select_related('blog'): # 没有select_related()，下面的语句将为每次循环迭代生成一个数据库查询,以获得每个entry关联的blog。 blogs.add([e.blog]) filter()和select_related()的顺序不重要。 下面的查询集是等同的： Entry.objects.filter(pub_date__gt=[timezone.now].select_related('blog') Entry.objects.select_related('blog').filter(pub_date__gt=[timezone.now]()) 可以沿着外键查询。 如果有以下模型：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from django.db import models class City(models.Model): # ... pass class Person(models.Model): # ... hometown = models.ForeignKey( City, on_delete=models.SET_NULL, blank=True, null=True, ) class Book(models.Model): # ... author = models.ForeignKey(Person, on_delete=models.CASCADE) 调用Book.objects.select_related(‘author__hometown’).get(id=4)将缓存相关的Person 和相关的City：\n1 2 3 4 5 6 7 8 9 10 11 b = Book.objects.select_related('author__hometown').get(id=4) p = [b.author] # Doesn't hit the database. c = p.hometown # Doesn't hit the database. b = Book.objects.get(id=4) # No select_related() in this example. p = [b.author] # Hits the database. c = p.hometown # Hits the database. 在传递给select_related()的字段中，可以使用任何ForeignKey和OneToOneField。\n在传递给select_related()的字段中，还可以反向引用OneToOneField。也就是说，可以回溯到定义OneToOneField 的字段。 此时，可以使用关联对象字段的related_name，而不要指定字段的名称。\n17. prefetch_related() prefetch_related(*lookups)\n在单个批处理中自动检索每个指定查找的相关对象。\n与select_related类似，但是策略是完全不同的。\n假设有这些模型：\n1 2 3 4 5 6 7 8 9 10 11 from django.db import models class weightping(models.Model): name = models.CharField(max_length=30) class Pizza(models.Model): name = models.CharField(max_length=50) weightpings = models.ManyToManyField(weightping) def __str__(self): # __unicode__ on Python 2 return \"%s (%s)\" % ( self.name, \", \".join(weightping.name for weightping in self.weightpings.all()), ) 并运行：\n1 2 3 \u003e\u003e\u003e Pizza.objects.all() [\"Hawaiian (ham, pineapple)\", \"Seafood (prawns, smoked salmon)\" 问题是每次QuerySet要求Pizza.objects.all()查询数据库，因此self.weightpings.all()将在Pizza Pizza.__str__()中的每个项目的weightpings表上运行查询。\n可以使用prefetch_related减少为只有两个查询：\nPizza.objects.all().prefetch_related('weightpings')\n这意味着现在每次self.weightpings.all()被调用，不会再去数据库查找，而是在一个预取的QuerySet缓存中查找。\n还可以使用正常连接语法来执行相关字段的相关字段。 假设在上面的例子中增加一个额外的模型：\n1 2 3 4 5 class Restaurant(models.Model): pizzas = models.ManyToManyField(Pizza, related_name='restaurants') best_pizza = models.ForeignKey(Pizza, related_name='championed_by') 以下是合法的：\nRestaurant.objects.prefetch_related('pizzas__weightpings')\n这将预取所有属于餐厅的比萨饼，和所有属于那些比萨饼的配料。 这将导致总共3个查询 - 一个用于餐馆，一个用于比萨饼，一个用于配料。 Restaurant.objects.prefetch_related('best_pizza__weightpings')\n这将获取最好的比萨饼和每个餐厅最好的披萨的所有配料。 这将在3个表中查询 - 一个为餐厅，一个为“最佳比萨饼”，一个为配料。\n当然，也可以使用best_pizza来获取select_related关系，以将查询数减少为2：\nRestaurant.objects.select_related('best_pizza').prefetch_related('best_pizza__weightpings')\n18. extra() extra(select=None, where=None, params=None, tables=None, order_by=None, select_params=None)\n有些情况下，Django的查询语法难以简单的表达复杂的WHERE子句，对于这种情况,可以在extra()生成的SQL从句中注入新子句。使用这种方法作为最后的手段，这是一个旧的API，在将来的某个时候可能被弃用。仅当无法使用其他查询方法表达查询时才使用它。 例如：\n1 2 3 4 qs.extra( select={'val': \"select col from sometable where othercol = %s\"}, select_params=(someparam,), ) 相当于：\nqs.annotate(val=RawSQL(\"select col from sometable where othercol = %s\", (someparam,)))\n19. defer() defer(*fields)\n在一些复杂的数据建模情况下，模型可能包含大量字段，其中一些可能包含大尺寸数据（例如文本字段），将它们转换为Python对象需要花费很大的代价。\n当最初获取数据时不知道是否需要这些特定字段的情况下，如果正在使用查询集的结果，可以告诉Django不要从数据库中检索它们。\n通过传递字段名称到defer()实现不加载：\nEntry.objects.defer(\"headline\", \"body\")\n具有延迟加载字段的查询集仍将返回模型实例。\n每个延迟字段将在你访问该字段时从数据库中检索（每次只检索一个，而不是一次检索所有的延迟字段）。\n可以多次调用defer()。 每个调用都向延迟集添加新字段：\n延迟body和headline两个字段。 Entry.objects.defer(\"body\").filter(rating=5).defer(\"headline\")\n字段添加到延迟集的顺序无关紧要。对已经延迟的字段名称再次defer()没有问题（该字段仍将被延迟）。\n可以使用标准的双下划线符号来分隔关联的字段，从而加载关联模型中的字段：\nBlog.objects.select_related().defer(\"entry__headline\", \"entry__body\")\n如果要清除延迟字段集，将None作为参数传递到defer()： 立即加载所有的字段。 my_queryset.defer(None)\ndefer()方法（及其兄弟，only()）仅适用于高级用例，它们提供了数据加载的优化方法。\n20. only() only(*fields)\nonly()方法与defer()相反。\n如果有一个模型几乎所有的字段需要延迟，使用only()指定补充的字段集可以使代码更简单。\n假设有一个包含字段biography、age和name的模型。 以下两个查询集是相同的，就延迟字段而言：\nPerson.objects.defer(“age”, “biography”) Person.objects.only(“name”) 每当你调用only()时，它将替换立即加载的字段集。因此，对only()的连续调用的结果是只有最后一次调用的字段被考虑：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # This will defer all fields except the headline. Entry.objects.only(\"body\", \"rating\").only(\"headline\") 由于defer()以递增方式动作（向延迟列表中添加字段），因此你可以结合only()和defer()调用： # Final result is that everything except \"headline\" is deferred. Entry.objects.only(\"headline\", \"body\").defer(\"body\") # Final result loads headline and body immediately (only() replaces any # existing set of fields). Entry.objects.defer(\"body\").only(\"headline\", \"body\") 当对具有延迟字段的实例调用save()时，仅保存加载的字段。\n21. using() using(alias)\n如果正在使用多个数据库，这个方法用于指定在哪个数据库上查询QuerySet。方法的唯一参数是数据库的别名，定义在DATABASES。 例如：\n1 2 3 4 5 6 7 # queries the database with the 'default' alias. \u003e\u003e\u003e Entry.objects.all() # queries the database with the 'backup' alias \u003e\u003e\u003e Entry.objects.using('backup') 22. select_for_update() select_for_update(nowait=False, skip_locked=False)\n返回一个锁住行直到事务结束的查询集，如果数据库支持，它将生成一个SELECT … FOR UPDATE语句。 例如：\nentries = Entry.objects.select_for_update().filter(author=request.user)\n所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。\n一般情况下如果其他事务锁定了相关行，那么本查询将被阻塞，直到锁被释放。使用select_for_update(nowait=True)将使查询不阻塞。如果其它事务持有冲突的锁,那么查询将引发DatabaseError异常。也可以使用select_for_update(skip_locked=True)忽略锁定的行。nowait和skip_locked是互斥的。\n目前，postgresql，oracle和mysql数据库后端支持select_for_update()。但是，MySQL不支持nowait和skip_locked参数。\n23. raw() raw(raw_query, params=None, translations=None)\n接收一个原始的SQL查询，执行它并返回一个django.db.models.query.RawQuerySet实例。\n这个RawQuerySet实例可以迭代，就像普通的QuerySet一样。\n四、不返回QuerySets的API 以下的方法不会返回QuerySets，但是作用非常强大，尤其是粗体显示的方法，需要背下来。 方法名 解释 get() 获取单个对象\ncreate() 创建对象，无需save()\nget_or_create() 查询对象，如果没有找到就新建对象\nupdate_or_create() 更新对象，如果没有找到就创建对象\nbulk_create()\n批量创建对象\ncount() 统计对象的个数\nin_bulk()\n根据主键值的列表，批量返回对象\niterator()\n获取包含对象的迭代器\nlatest() 获取最近的对象\nearliest() 获取最早的对象\nfirst() 获取第一个对象\nlast() 获取最后一个对象\naggregate() 聚合操作\nexists() 判断queryset中是否有对象\nupdate() 批量更新对象\ndelete() 批量删除对象\nas_manager() 获取管理器\n1. get() get(**kwargs)\n返回按照查询参数匹配到的单个对象，参数的格式应该符合Field lookups的要求。\n如果匹配到的对象个数不只一个的话，触发MultipleObjectsReturned异常\n如果根据给出的参数匹配不到对象的话，触发DoesNotExist异常。例如：\nEntry.objects.get(id='foo') # raises Entry.DoesNotExist\nDoesNotExist异常从django.core.exceptions.ObjectDoesNotExist继承，可以定位多个DoesNotExist异常。 例如： 1 2 3 4 5 6 7 from django.core.exceptions import ObjectDoesNotExist try: e = Entry.objects.get(id=3) b = Blog.objects.get(id=1) except ObjectDoesNotExist: print(\"Either the entry or blog doesn't exist.\") 如果希望查询器只返回一行，则可以使用get()而不使用任何参数来返回该行的对象： entry = Entry.objects.filter(...).exclude(...).get()\n2. create() create(**kwargs)\n在一步操作中同时创建并且保存对象的便捷方法. p = Person.objects.create(first_name=\"Bruce\", last_name=\"Springsteen\")\n等于:\np = Person(first_name=\"Bruce\", last_name=\"Springsteen\")\np.save(force_insert=True)\n参数force_insert表示强制创建对象。如果model中有一个你手动设置的主键，并且这个值已经存在于数据库中, 调用create()将会失败并且触发IntegrityError因为主键必须是唯一的。如果你手动设置了主键，做好异常处理的准备。 3. get_or_create() get_or_create(defaults=None, **kwargs)\n通过kwargs来查询对象的便捷方法（如果模型中的所有字段都有默认值，可以为空），如果该对象不存在则创建一个新对象。\n该方法返回一个由(object, created)组成的元组，元组中的object 是一个查询到的或者是被创建的对象， created是一个表示是否创建了新的对象的布尔值。\n对于下面的代码：\n1 2 3 4 5 6 7 8 9 try: obj = Person.objects.get(first_name='John', last_name='Lennon') except Person.DoesNotExist: obj = Person(first_name='John', last_name='Lennon', birthday=date(1940, 10, 9)) obj.save() 如果模型的字段数量较大的话，这种模式就变的非常不易用了。 上面的示例可以用get_or_create()重写 :\n1 2 3 4 5 obj, created = Person.objects.get_or_create( first_name='John', last_name='Lennon', defaults={'birthday': date(1940, 10, 9)}, ) 任何传递给get_or_create()的关键字参数，除了一个可选的defaults，都将传递给get()调用。 如果查找到一个对象，返回一个包含匹配到的对象以及False 组成的元组。 如果查找到的对象超过一个以上，将引发MultipleObjectsReturned。如果查找不到对象，get_or_create()将会实例化并保存一个新的对象，返回一个由新的对象以及True组成的元组。新的对象将会按照以下的逻辑创建: 1 2 3 4 5 6 7 params = {k: v for k, v in kwargs.items() if '__' not in k} params.update({k: v() if callable(v) else v for k, v in defaults.items()}) obj = self.model(**params) obj.save() 它表示从非’defaults’ 且不包含双下划线的关键字参数开始。然后将defaults的内容添加进来，覆盖必要的键，并使用结果作为关键字参数传递给模型类。\n如果有一个名为defaults__exact的字段，并且想在get_or_create()时用它作为精确查询，只需要使用defaults，像这样：\nFoo.objects.get_or_create(defaults__exact='bar', defaults={'defaults': 'baz'})\n当你使用手动指定的主键时，get_or_create()方法与create()方法有相似的错误行为 。 如果需要创建一个对象而该对象的主键早已存在于数据库中，IntegrityError异常将会被触发。\n这个方法假设进行的是原子操作，并且正确地配置了数据库和正确的底层数据库行为。如果数据库级别没有对get_or_create中用到的kwargs强制要求唯一性（unique和unique_together），方法容易导致竞态条件，可能会有相同参数的多行同时插入。（简单理解，kwargs必须指定的是主键或者unique属性的字段才安全。）\n最后建议只在Django视图的POST请求中使用get_or_create()，因为这是一个具有修改性质的动作，不应该使用在GET请求中，那样不安全。\n可以通过ManyToManyField属性和反向关联使用get_or_create()。在这种情况下，应该限制查询在关联的上下文内部。 否则，可能导致完整性问题。\n例如下面的模型：\n1 2 3 4 5 6 7 8 9 class Chapter(models.Model): title = models.CharField(max_length=255, unique=True) class Book(models.Model): title = models.CharField(max_length=256) chapters = models.ManyToManyField(Chapter) 可以通过Book的chapters字段使用get_or_create()，但是它只会获取该Book内部的上下文：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u003e\u003e\u003e book = Book.objects.create(title=\"Ulysses\") \u003e\u003e\u003e book.chapters.get_or_create(title=\"Telemachus\") (\u003cChapter: Telemachus\u003e, True) \u003e\u003e\u003e book.chapters.get_or_create(title=\"Telemachus\") (\u003cChapter: Telemachus\u003e, False) \u003e\u003e\u003e Chapter.objects.create(title=\"Chapter 1\") \u003cChapter: Chapter 1\u003e \u003e\u003e\u003e book.chapters.get_or_create(title=\"Chapter 1\") # Raises IntegrityError 发生这个错误是因为尝试通过Book “Ulysses”获取或者创建“Chapter 1”，但是它不能，因为它与这个book不关联，但因为title 字段是唯一的它仍然不能创建。 在Django1.11在defaults中增加了对可调用值的支持。\n4. update_or_create() update_or_create(defaults=None, **kwargs)\n类似前面的get_or_create()。\n通过给出的kwargs来更新对象的便捷方法， 如果没找到对象，则创建一个新的对象。defaults是一个由 (field, value)对组成的字典，用于更新对象。defaults中的值可以是可调用对象（也就是说函数等）。\n该方法返回一个由(object, created)组成的元组,元组中的object是一个创建的或者是被更新的对象， created是一个标示是否创建了新的对象的布尔值。\nupdate_or_create方法尝试通过给出的kwargs 去从数据库中获取匹配的对象。 如果找到匹配的对象，它将会依据defaults 字典给出的值更新字段。\n像下面的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 defaults = {'first_name': 'Bob'} try: obj = Person.objects.get(first_name='John', last_name='Lennon') for key, value in defaults.items(): setattr(obj, key, value) obj.save() except Person.DoesNotExist: new_values = {'first_name': 'John', 'last_name': 'Lennon'} new_values.update(defaults) obj = Person(**new_values) obj.save() 如果模型的字段数量较大的话，这种模式就变的非常不易用了。 上面的示例可以用update_or_create() 重写:\n1 2 3 4 5 6 7 obj, created = Person.objects.update_or_create( first_name='John', last_name='Lennon', defaults={'first_name': 'Bob'}, ) kwargs中的名称如何解析的详细描述可以参见get_or_create()。\n和get_or_create()一样，这个方法也容易导致竞态条件，如果数据库层级没有前置唯一性会让多行同时插入。\n在Django1.11在defaults中增加了对可调用值的支持。\n5. bulk_create() bulk_create(objs, batch_size=None)\n以高效的方式（通常只有1个查询，无论有多少对象）将提供的对象列表插入到数据库中： 1 2 3 4 5 6 7 \u003e\u003e\u003e Entry.objects.bulk_create([ ... Entry(headline='This is a test'), ... Entry(headline='This is only a test'), ... ]) 注意事项：\n不会调用模型的save()方法，并且不会发送pre_save和post_save信号。\n不适用于多表继承场景中的子模型。\n如果模型的主键是AutoField，则不会像save()那样检索并设置主键属性，除非数据库后端支持。\n不适用于多对多关系。\nbatch_size参数控制在单个查询中创建的对象数。\n6. count() count()\n返回在数据库中对应的QuerySet对象的个数。count()永远不会引发异常。 例如：\n1 2 3 4 5 6 7 # 返回总个数. Entry.objects.count() # 返回包含有'Lennon'的对象的总数 Entry.objects.filter(headline__contains='Lennon').count() 7. in_bulk() in_bulk(id_list=None)\n获取主键值的列表，并返回将每个主键值映射到具有给定ID的对象的实例的字典。 如果未提供列表，则会返回查询集中的所有对象。 例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u003e\u003e\u003e Blog.objects.in_bulk([1]) {1: \u003cBlog: Beatles Blog\u003e} \u003e\u003e\u003e Blog.objects.in_bulk([1, 2]) {1: \u003cBlog: Beatles Blog\u003e, 2: \u003cBlog: Cheddar Talk\u003e} \u003e\u003e\u003e Blog.objects.in_bulk([]) {} \u003e\u003e\u003e Blog.objects.in_bulk() {1: \u003cBlog: Beatles Blog\u003e, 2: \u003cBlog: Cheddar Talk\u003e, 3: \u003cBlog: Django Weblog\u003e} 如果向in_bulk()传递一个空列表，会得到一个空的字典。\n在旧版本中，id_list是必需的参数，现在是一个可选参数。\n8. iterator() iterator()\n提交数据库操作，获取QuerySet，并返回一个迭代器。\nQuerySet通常会在内部缓存其结果，以便在重复计算时不会导致额外的查询。而iterator()将直接读取结果，不在QuerySet级别执行任何缓存。对于返回大量只需要访问一次的对象的QuerySet，这可以带来更好的性能，显著减少内存使用。\n请注意，在已经提交了的iterator()上使用QuerySet会强制它再次提交数据库操作，进行重复查询。此外，使用iterator()会导致先前的prefetch_related()调用被忽略，因为这两个一起优化没有意义。\n9. latest() latest(field_name=None)\n使用日期字段field_name，按日期返回最新对象。\n下例根据Entry的’pub_date’字段返回最新发布的entry：\nEntry.objects.latest('pub_date')\n如果模型的Meta指定了get_latest_by，则可以将latest()参数留给earliest()或者field_name。 默认情况下，Django将使用get_latest_by中指定的字段。\nearliest()和latest()可能会返回空日期的实例,可能需要过滤掉空值：\nEntry.objects.filter(pub_date__isnull=False).latest('pub_date')\n10. earliest() earliest(field_name=None)\n类同latest()。\n11. first() first()\n返回结果集的第一个对象, 当没有找到时返回None。如果QuerySet没有设置排序,则将会自动按主键进行排序。例如： p = Article.objects.order_by('title', 'pub_date').first()\nfirst()是一个简便方法，下面的例子和上面的代码效果是一样： 1 2 3 4 try: p = Article.objects.order_by('title', 'pub_date')[0] except IndexError: p = None 12. last() last()\n工作方式类似first()，只是返回的是查询集中最后一个对象。\n13. aggregate() aggregate(args, *kwargs)\n返回汇总值的字典（平均值，总和等）,通过QuerySet进行计算。每个参数指定返回的字典中将要包含的值。\n使用关键字参数指定的聚合将使用关键字参数的名称作为Annotation 的名称。 匿名参数的名称将基于聚合函数的名称和模型字段生成。 复杂的聚合不可以使用匿名参数，必须指定一个关键字参数作为别名。\n例如，想知道Blog Entry 的数目：\n1 2 3 4 from django.db.models import Count q = Blog.objects.aggregate(Count('entry')) {'entry__count': 16} 通过使用关键字参数来指定聚合函数，可以控制返回的聚合的值的名称：\n1 2 3 q = Blog.objects.aggregate(number_of_entries=Count('entry')) {'number_of_entries': 16} 14. exists() exists()\n如果QuerySet包含任何结果，则返回True，否则返回False。\n查找具有唯一性字段（例如primary_key）的模型是否在一个QuerySet中的最高效的方法是：\n1 2 3 4 5 entry = Entry.objects.get(pk=123) if some_queryset.filter(pk=entry.pk).exists(): print(\"Entry contained in queryset\") 它将比下面的方法快很多，这个方法要求对QuerySet求值并迭代整个QuerySet：\n1 2 if entry in some_queryset: print(\"Entry contained in QuerySet\") 若要查找一个QuerySet是否包含任何元素：\n1 2 3 4 5 if some_queryset.exists(): print(\"There is at least one object in some_queryset\") 将快于： if some_queryset: print(\"There is at least one object in some_queryset\") 15. update() update(**kwargs)\n对指定的字段执行批量更新操作，并返回匹配的行数（如果某些行已具有新值，则可能不等于已更新的行数）。\n例如，要对2010年发布的所有博客条目启用评论，可以执行以下操作：\nEntry.objects.filter(pub_date__year=2010).update(comments_on=False)\n可以同时更新多个字段 （没有多少字段的限制）。 例如同时更新comments_on和headline字段： Entry.objects.filter(pub_date__year=2010).update(comments_on=False, headline='This is old')\nupdate()方法无需save操作。唯一限制是它只能更新模型主表中的列，而不是关联的模型，例如不能这样做：\nEntry.objects.update(blog__name='foo') # Won't work!\n仍然可以根据相关字段进行过滤：\nEntry.objects.filter(blog__id=1).update(comments_on=True)\nupdate()方法返回受影响的行数：\n1 2 3 4 5 6 7 8 9 10 11 Entry.objects.filter(id=64).update(comments_on=True) 1 \u003e\u003e\u003e Entry.objects.filter(slug='nonexistent-slug').update(comments_on=True) 0 \u003e\u003e\u003e Entry.objects.filter(pub_date__year=2010).update(comments_on=False) 132 如果你只是更新一下对象，不需要为对象做别的事情，最有效的方法是调用update()，而不是将模型对象加载到内存中。 例如，不要这样做：\n1 2 3 4 5 e = Entry.objects.get(id=10) e.comments_on = False e.save() 建议如下操作：\nEntry.objects.filter(id=10).update(comments_on=False)\n用update()还可以防止在加载对象和调用save()之间的短时间内数据库中某些内容可能发生更改的竞争条件。\n如果想更新一个具有自定义save()方法的模型的记录，请循环遍历它们并调用save()，如下所示：\n1 2 3 for e in Entry.objects.filter(pub_date__year=2010): e.comments_on = False e.save() 16. delete() delete()\n批量删除QuerySet中的所有对象，并返回删除的对象个数和每个对象类型的删除次数的字典。\ndelete()动作是立即执行的。\n不能在QuerySet上调用delete()。\n例如，要删除特定博客中的所有条目：\n1 2 3 4 5 b = Blog.objects.get(pk=1) # Delete all the entries belonging to this Blog. Entry.objects.filter(blog=b).delete() (4, {'weblog.Entry': 2, 'weblog.Entry_authors': 2}) 默认情况下，Django的ForeignKey使用SQL约束ON DELETE CASCADE，任何具有指向要删除的对象的外键的对象将与它们一起被删除。 像这样：\n1 2 3 4 5 blogs = Blog.objects.all() # This will delete all Blogs and all of their Entry objects. blogs.delete() (5, {'weblog.Blog': 1, 'weblog.Entry': 2, 'weblog.Entry_authors': 2}) 这种级联的行为可以通过的ForeignKey的on_delete参数自定义。（什么时候要改变这种行为呢？比如日志数据，就不能和它关联的主体一并被删除！）\ndelete()会为所有已删除的对象（包括级联删除）发出pre_delete和post_delete信号。\n17. as_manager() classmethod as_manager()\n一个类方法，返回Manager的实例与QuerySet的方法的副本 ","wordCount":"12928","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/django%E7%9A%84queryset%E8%AF%A6%E8%A7%A3/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>📅最后更新:&nbsp;0001-01-01&nbsp|&nbsp⏲︎时长: 26 min&nbsp|&nbsp📖字数: 12928 words&nbsp;|&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%80queryset%e4%bd%95%e6%97%b6%e8%a2%ab%e6%8f%90%e4%ba%a4 aria-label=一、QuerySet何时被提交>一、QuerySet何时被提交</a><ul><li><a href=#%e8%bf%ad%e4%bb%a3 aria-label=迭代>迭代</a></li><li><a href=#pickling%e7%bc%93%e5%ad%98 aria-label=Pickling/缓存>Pickling/缓存</a></li></ul></li><li><a href=#%e4%ba%8cqueryset aria-label=二、QuerySet>二、QuerySet</a></li><li><a href=#%e4%b8%89%e8%bf%94%e5%9b%9e%e6%96%b0querysets%e7%9a%84api aria-label=三、返回新QuerySets的API>三、返回新QuerySets的API</a><ul><li><a href=#%e6%96%b9%e6%b3%95%e5%90%8d-%e8%a7%a3%e9%87%8a aria-label="方法名 解释"><strong>方法名 解释</strong></a><ul><li><a href=#1-filter aria-label="1. filter()">1. filter()</a></li><li><a href=#2-exclude aria-label="2. exclude()">2. exclude()</a></li><li><a href=#3-annotate aria-label="3. annotate()">3. annotate()</a></li><li><a href=#4-order_by aria-label="4. order_by()">4. order_by()</a></li><li><a href=#5-reverse aria-label="5. reverse()">5. reverse()</a></li><li><a href=#6-distinct aria-label="6. distinct()">6. distinct()</a></li><li><a href=#7-values aria-label="7. values()">7. values()</a></li><li><a href=#8-values_list aria-label="8. values_list()">8. values_list()</a></li><li><a href=#9-dates aria-label="9. dates()">9. dates()</a></li><li><a href=#10-datetimes aria-label="10. datetimes()">10. datetimes()</a></li><li><a href=#11-none aria-label="11. none()">11. none()</a></li><li><a href=#12-all aria-label="12. all()">12. all()</a></li><li><a href=#13-union aria-label="13. union()">13. union()</a></li><li><a href=#14-intersection aria-label="14. intersection()">14. intersection()</a></li><li><a href=#15-difference aria-label="15. difference()">15. difference()</a></li><li><a href=#16-select_related aria-label="16. select_related()">16. select_related()</a></li><li><a href=#17-prefetch_related aria-label="17. prefetch_related()">17. prefetch_related()</a></li><li><a href=#18-extra aria-label="18. extra()">18. extra()</a></li><li><a href=#19-defer aria-label="19. defer()">19. defer()</a><ul><li><a href=#%e5%bb%b6%e8%bf%9fbody%e5%92%8cheadline%e4%b8%a4%e4%b8%aa%e5%ad%97%e6%ae%b5 aria-label=延迟body和headline两个字段。>延迟body和headline两个字段。</a></li><li><a href=#%e7%ab%8b%e5%8d%b3%e5%8a%a0%e8%bd%bd%e6%89%80%e6%9c%89%e7%9a%84%e5%ad%97%e6%ae%b5 aria-label=立即加载所有的字段。>立即加载所有的字段。</a></li></ul></li><li><a href=#20-only aria-label="20. only()">20. only()</a></li><li><a href=#21-using aria-label="21. using()">21. using()</a></li><li><a href=#22-select_for_update aria-label="22. select_for_update()">22. select_for_update()</a></li><li><a href=#23-raw aria-label="23. raw()">23. raw()</a></li></ul></li></ul></li><li><a href=#%e5%9b%9b%e4%b8%8d%e8%bf%94%e5%9b%9equerysets%e7%9a%84api aria-label=四、不返回QuerySets的API>四、不返回QuerySets的API</a><ul><li><a href=#%e6%96%b9%e6%b3%95%e5%90%8d-%e8%a7%a3%e9%87%8a-1 aria-label="方法名 解释"><strong>方法名 解释</strong></a><ul><li><a href=#1-get aria-label="1. get()">1. get()</a></li><li><a href=#2-create aria-label="2. create()">2. create()</a></li><li><a href=#3-get_or_create aria-label="3. get_or_create()">3. get_or_create()</a></li><li><a href=#4-update_or_create aria-label="4. update_or_create()">4. update_or_create()</a></li><li><a href=#5-bulk_create aria-label="5. bulk_create()">5. bulk_create()</a></li><li><a href=#6-count aria-label="6. count()">6. count()</a></li><li><a href=#7-in_bulk aria-label="7. in_bulk()">7. in_bulk()</a></li><li><a href=#8-iterator aria-label="8. iterator()">8. iterator()</a></li><li><a href=#9-latest aria-label="9. latest()">9. latest()</a></li><li><a href=#10-earliest aria-label="10. earliest()">10. earliest()</a></li><li><a href=#11-first aria-label="11. first()">11. first()</a></li><li><a href=#12-last aria-label="12. last()">12. last()</a></li><li><a href=#13-aggregate aria-label="13. aggregate()">13. aggregate()</a></li><li><a href=#14-exists aria-label="14. exists()">14. exists()</a></li><li><a href=#15-update aria-label="15. update()">15. update()</a></li><li><a href=#16-delete aria-label="16. delete()">16. delete()</a></li><li><a href=#17-as_manager aria-label="17. as_manager()">17. as_manager()</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>从数据库中查询出来的结果一般是一个集合，这个集合叫做 QuerySet。</p><h1 id=一queryset何时被提交>一、QuerySet何时被提交<a hidden class=anchor aria-hidden=true href=#一queryset何时被提交>#</a></h1><ul><li>在内部，创建、过滤、切片和传递一个QuerySet不会真实操作数据库，在你对查询集提交之前，不会发生任何实际的数据库操作。可以使用下列方法对QuerySet提交查询操作：</li></ul><h2 id=迭代>迭代<a hidden class=anchor aria-hidden=true href=#迭代>#</a></h2><ul><li>QuerySet是可迭代的，在首次迭代查询集时执行实际的数据库查询。 例如， 下面的语句会将数据库中所有Entry的headline打印出来：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>for</span> e <span style=color:#ff7b72;font-weight:700>in</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>all():
</span></span><span style=display:flex><span>	print(e<span style=color:#ff7b72;font-weight:700>.</span>headline)
</span></span></code></pre></td></tr></table></div></div><ul><li>切片：如果使用切片的”step“参数，Django 将执行数据库查询并返回一个列表。</li></ul><h2 id=pickling缓存>Pickling/缓存<a hidden class=anchor aria-hidden=true href=#pickling缓存>#</a></h2><ul><li><p>repr()</p></li><li><p>len()：当你对QuerySet调用len()时， 将提交数据库操作。</p></li><li><p>list()：对QuerySet调用list()将强制提交操作entry_list = list(Entry.objects.all())</p></li><li><p>bool()</p><ul><li><p>测试布尔值，像这样：</p></li><li><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>if</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(headline<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Test&#34;</span>):
</span></span><span style=display:flex><span>  print(<span style=color:#a5d6ff>&#34;There is at least one Entry with the headline Test&#34;</span>)
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><p>注：如果你需要知道是否存在至少一条记录（而不需要真实的对象），使用exists() 将更加高效。</p><h1 id=二queryset>二、QuerySet<a hidden class=anchor aria-hidden=true href=#二queryset>#</a></h1><p>下面是对于QuerySet的正式定义：</p><ul><li>class QuerySet(model=None, query=None, using=None)[source]</li></ul><p>QuerySet类具有两个公有属性用于内省：</p><ul><li><p>ordered：如果QuerySet是排好序的则为True，否则为False。</p></li><li><p>db：如果现在执行，则返回使用的数据库。</p></li></ul><h1 id=三返回新querysets的api>三、返回新QuerySets的API<a hidden class=anchor aria-hidden=true href=#三返回新querysets的api>#</a></h1><ul><li>以下的方法都将返回一个新的QuerySets。重点是加粗的几个API，其它的使用场景很少。</li></ul><h2 id=方法名-解释><strong>方法名 解释</strong><a hidden class=anchor aria-hidden=true href=#方法名-解释>#</a></h2><ul><li><p>filter() 过滤查询对象。</p></li><li><p>exclude() 排除满足条件的对象</p></li><li><p>annotate() 使用聚合函数</p></li><li><p>order_by() 对查询集进行排序</p></li><li><p>reverse() 反向排序</p></li><li><p>distinct() 对查询集去重</p></li><li><p>values() 返回包含对象具体值的字典的QuerySet</p></li><li><p>values_list() 与values()类似，只是返回的是元组而不是字典。</p></li><li><p>dates() 根据日期获取查询集</p></li><li><p>datetimes() 根据时间获取查询集</p></li><li><p>none() 创建空的查询集</p></li><li><p>all() 获取所有的对象</p></li><li><p>union() 并集</p></li><li><p>intersection() 交集</p></li><li><p>difference() 差集</p></li><li><p>select_related() 附带查询关联对象</p></li><li><p>prefetch_related()预先查询</p></li><li><p>extra() 附加SQL查询</p></li><li><p>defer() 不加载指定字段</p></li><li><p>only() 只加载指定的字段</p></li><li><p>using() 选择数据库</p></li><li><p>select_for_update()锁住选择的对象，直到事务结束。</p></li><li><p>raw() 接收一个原始的SQL查询</p></li></ul><h3 id=1-filter>1. filter()<a hidden class=anchor aria-hidden=true href=#1-filter>#</a></h3><p><code>filter(**kwargs)</code></p><ul><li><p>返回满足查询参数的对象集合。</p></li><li><p>查找的参数（**kwargs）应该满足下文字段查找中的格式。多个参数之间是和AND的关系。</p></li></ul><h3 id=2-exclude>2. exclude()<a hidden class=anchor aria-hidden=true href=#2-exclude>#</a></h3><p><code>exclude(**kwargs)</code></p><ul><li><p>返回一个新的<code>QuerySet</code>，它包含<code>不满足给定的查找参数的对象</code>。</p></li><li><p>查找的参数（**kwargs）应该满足下文字段查找中的格式。多个参数通过<code>AND连接</code>，然后所有的内容放入<code>NOT() </code>中。</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 下面的示例排除所有pub_date晚于2005-1-3且headline为“Hello” 的记录：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>exclude(pub_date__gt<span style=color:#ff7b72;font-weight:700>=</span>[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>3</span>), headline<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Hello&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 下面的示例排除所有pub_date晚于2005-1-3或者headline 为“Hello” 的记录：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>exclude(pub_date__gt<span style=color:#ff7b72;font-weight:700>=</span>[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>3</span>))<span style=color:#ff7b72;font-weight:700>.</span>exclude(headline<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Hello&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=3-annotate>3. annotate()<a hidden class=anchor aria-hidden=true href=#3-annotate>#</a></h3><p><code>annotate(args, *kwargs)</code></p><ul><li><p>使用提供的聚合表达式查询对象。</p></li><li><p>表达式可以是简单的值、对模型（或任何关联模型）上的字段的引用或者聚合表达式（<code>平均值、总和等</code>）。</p></li><li><p>annotate()的每个参数都是一个annotation，它将添加到返回的QuerySet每个对象中。</p></li><li><p>关键字参数指定的Annotation将使用关键字作为Annotation 的别名。 匿名参数的别名将基于聚合函数的名称和模型的字段生成。 只有引用单个字段的聚合表达式才可以使用匿名参数。 其它所有形式都必须用关键字参数。</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 例如，如果正在操作一个Blog列表，你可能想知道每个Blog有多少Entry：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models</span> <span style=color:#ff7b72>import</span> Count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> q <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>annotate(Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># The name of the first blog</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> q[<span style=color:#a5d6ff>0</span>]<span style=color:#ff7b72;font-weight:700>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#39;Blogasaurus&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># The number of entries on the first blog</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> q[<span style=color:#a5d6ff>0</span>]<span style=color:#ff7b72;font-weight:700>.</span>entry__count
</span></span><span style=display:flex><span><span style=color:#a5d6ff>42</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Blog模型本身没有定义entry__count属性，但是通过使用一个关键字参数来指定聚合函数，可以控制Annotation的名称：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> q <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>annotate(number_of_entries<span style=color:#ff7b72;font-weight:700>=</span>Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># The number of entries on the first blog, using the name provided</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> q[<span style=color:#a5d6ff>0</span>]<span style=color:#ff7b72;font-weight:700>.</span>number_of_entries
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>42</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-order_by>4. order_by()<a hidden class=anchor aria-hidden=true href=#4-order_by>#</a></h3><p><code>order_by(*fields)</code></p><ul><li>默认情况下，根据模型的Meta类中的ordering属性对QuerySet中的对象进行排序</li></ul><p><code>Entry.objects.filter(pub_date__year=2005).order_by('-pub_date', 'headline')</code></p><ul><li><p>上面的结果将按照pub_date降序排序，然后再按照headline升序排序。"-pub_date"前面的负号表示降序顺序。 升序是默认的。 要随机排序，使用"?"，如下所示：</p></li><li><p>Entry.objects.order_by(&rsquo;?')</p></li></ul><blockquote><p>注：order_by(&rsquo;?&rsquo;)可能耗费资源且很慢，这取决于使用的数据库。</p></blockquote><ul><li><p>若要按照另外一个模型中的字段排序，可以使用查询关联模型的语法。即通过字段的名称后面跟两个下划线（__），再加上新模型中的字段的名称，直到希望连接的模型。 像这样：</p></li><li><p>Entry.objects.order_by(&lsquo;blog__name&rsquo;, &lsquo;headline&rsquo;)</p></li><li><p>如果排序的字段与另外一个模型关联，Django将使用关联的模型的默认排序，或者如果没有指定Meta.ordering将通过关联的模型的主键排序。 例如，因为Blog模型没有指定默认的排序：</p></li><li><p>Entry.objects.order_by(&lsquo;blog&rsquo;)</p></li></ul><p>与以下相同：</p><p><code>Entry.objects.order_by('blog__id')</code></p><ul><li><p>如果Blog设置了ordering = [&rsquo;name&rsquo;]，那么第一个QuerySet将等同于：</p></li><li><p>Entry.objects.order_by(&lsquo;blog__name&rsquo;)</p></li><li><p>还可以通过调用表达式的<code>desc()</code>或者<code>asc()</code>方法：</p></li><li><p>Entry.objects.order_by(Coalesce(&lsquo;summary&rsquo;, &lsquo;headline&rsquo;).desc())</p></li></ul><p>考虑下面的情况，指定一个多值字段来排序（例如，一个ManyToManyField 字段或者ForeignKey 字段的反向关联）：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Event</span>(Model):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>parent <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>ForeignKey(
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#39;self&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>on_delete<span style=color:#ff7b72;font-weight:700>=</span>models<span style=color:#ff7b72;font-weight:700>.</span>CASCADE,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>related_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;children&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>DateField()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Event<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>order_by(<span style=color:#a5d6ff>&#39;children__date&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li><p>在这里，每个Event可能有多个排序数据；具有多个children的每个Event将被多次返回到order_by()创建的新的QuerySet中。 换句话说，用order_by()方法对QuerySet对象进行操作会返回一个扩大版的新QuerySet对象。因此，使用多值字段对结果进行排序时要格外小心。</p></li><li><p>没有方法指定排序是否考虑大小写。 对于大小写的敏感性，Django将根据数据库中的排序方式排序结果。</p></li><li><p>可以通过Lower将一个字段转换为小写来排序，它将达到大小写一致的排序：</p></li><li><p><code>Entry.objects.order_by(Lower('headline').desc())</code></p></li><li><p>可以通过检查QuerySet.ordered属性来知道查询是否是排序的。</p></li><li><p>每个<code>order_by()</code>都将清除前面的任何排序。 例如下面的查询将按照pub_date排序，而不是headline：</p></li><li><p><code>Entry.objects.order_by('headline').order_by('pub_date')</code></p></li></ul><h3 id=5-reverse>5. reverse()<a hidden class=anchor aria-hidden=true href=#5-reverse>#</a></h3><p><code>reverse()</code></p><ul><li><p>反向排序QuerySet中返回的元素。 第二次调用reverse()将恢复到原有的排序。</p></li><li><p>如要获取QuerySet中最后五个元素，可以这样做：</p></li><li><p>my_queryset.reverse()[:5]</p></li><li><p>这与Python直接使用负索引有点不一样。 <code>Django不支持负索引，只能曲线救国</code>。</p></li></ul><h3 id=6-distinct>6. distinct()<a hidden class=anchor aria-hidden=true href=#6-distinct>#</a></h3><p><code>distinct(*fields)</code></p><ul><li><p>去除查询结果中重复的行。</p></li><li><p>默认情况下，QuerySet不会去除重复的行。当查询跨越多张表的数据时，QuerySet可能得到重复的结果，这时候可以使用<code>distinct()</code>进行去重。</p></li></ul><h3 id=7-values>7. values()<a hidden class=anchor aria-hidden=true href=#7-values>#</a></h3><p><code>values(fields, *expressions)</code></p><ul><li><p>返回一个包含数据的字典的queryset，而不是模型实例。</p></li><li><p>每个字典表示一个对象，键对应于模型对象的属性名称。</p></li></ul><p>下面的例子将values() 与普通的模型对象进行比较：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 列表中包含的是Blog对象</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(name__startswith<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Beatles&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [<span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Beatles Blog<span style=color:#ff7b72;font-weight:700>&gt;</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 列表中包含的是数据字典</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(name__startswith<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Beatles&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>values()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;name&#39;</span>: <span style=color:#a5d6ff>&#39;Beatles Blog&#39;</span>, <span style=color:#a5d6ff>&#39;tagline&#39;</span>: <span style=color:#a5d6ff>&#39;All the latest Beatles news.&#39;</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>该方法接收可选的位置参数<span style=color:#ff7b72;font-weight:700>*</span>fields<span style=color:#f85149>，</span>它指定values()应该限制哪些字段<span style=color:#f85149>。</span>如果指定字段<span style=color:#f85149>，</span>每个字典将只包含指定的字段的键<span style=color:#ff7b72;font-weight:700>/</span>值<span style=color:#f85149>。</span>如果没有指定字段<span style=color:#f85149>，</span>每个字典将包含数据库表中所有字段的键和值<span style=color:#f85149>。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>例如<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;name&#39;</span>: <span style=color:#a5d6ff>&#39;Beatles Blog&#39;</span>, <span style=color:#a5d6ff>&#39;tagline&#39;</span>: <span style=color:#a5d6ff>&#39;All the latest Beatles news.&#39;</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;id&#39;</span>, <span style=color:#a5d6ff>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;id&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;name&#39;</span>: <span style=color:#a5d6ff>&#39;Beatles Blog&#39;</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>values()方法还有关键字参数<span style=color:#ff7b72;font-weight:700>**</span>expressions<span style=color:#f85149>，</span>这些参数将传递给annotate()<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models.functions</span> <span style=color:#ff7b72>import</span> Lower
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(lower_name<span style=color:#ff7b72;font-weight:700>=</span>Lower(<span style=color:#a5d6ff>&#39;name&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;lower_name&#39;</span>: <span style=color:#a5d6ff>&#39;beatles blog&#39;</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>在values()子句中的聚合应用于相同values()子句中的其他参数之前<span style=color:#f85149>。</span> 如果需要按另一个值分组<span style=color:#f85149>，</span>请将其添加到较早的values()子句中<span style=color:#f85149>。</span> 像这样<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models</span> <span style=color:#ff7b72>import</span> Count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;author&#39;</span>, entries<span style=color:#ff7b72;font-weight:700>=</span>Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;author&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;entries&#39;</span>: <span style=color:#a5d6ff>20</span>}, {<span style=color:#a5d6ff>&#39;author&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;entries&#39;</span>: <span style=color:#a5d6ff>13</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;author&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>annotate(entries<span style=color:#ff7b72;font-weight:700>=</span>Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;author&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;entries&#39;</span>: <span style=color:#a5d6ff>33</span>}]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>注意<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>如果你有一个字段foo是一个ForeignKey<span style=color:#f85149>，</span>默认的foo_id参数返回的字典中将有一个叫做foo 的键<span style=color:#f85149>，</span>因为这是保存实际值的那个隐藏的模型属性的名称<span style=color:#f85149>。</span> 当调用foo_id并传递字段的名称<span style=color:#f85149>，</span>传递foo 或values()都可以<span style=color:#f85149>，</span>得到的结果是相同的<span style=color:#f85149>。</span>像这样<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;blog_id&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;headline&#39;</span>: <span style=color:#a5d6ff>&#39;First Entry&#39;</span>, <span style=color:#ff7b72;font-weight:700>...</span>}, <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;blog&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;blog&#39;</span>: <span style=color:#a5d6ff>1</span>}, <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;blog_id&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;blog_id&#39;</span>: <span style=color:#a5d6ff>1</span>}, <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>当values()与distinct()一起使用时<span style=color:#f85149>，</span>注意排序可能影响最终的结果<span style=color:#f85149>。</span>
</span></span><span style=display:flex><span>如果values()子句位于extra()调用之后<span style=color:#f85149>，</span>extra()中的select参数定义的字段必须显式包含在values()调用中<span style=color:#f85149>。</span> values( 调用后面的extra( 调用将忽略选择的额外的字段<span style=color:#f85149>。</span>在values()之后调用only()和defer()不太合理<span style=color:#f85149>，</span>所以将引发一个NotImplementedError<span style=color:#f85149>。</span>可以通过ManyToManyField<span style=color:#f85149>、</span>ForeignKey 和 OneToOneFiel 属性反向引用关联的模型的字段<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values(<span style=color:#a5d6ff>&#39;name&#39;</span>, <span style=color:#a5d6ff>&#39;entry__headline&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [{<span style=color:#a5d6ff>&#39;name&#39;</span>: <span style=color:#a5d6ff>&#39;My blog&#39;</span>, <span style=color:#a5d6ff>&#39;entry__headline&#39;</span>: <span style=color:#a5d6ff>&#39;An entry&#39;</span>},{<span style=color:#a5d6ff>&#39;name&#39;</span>: <span style=color:#a5d6ff>&#39;My blog&#39;</span>, <span style=color:#a5d6ff>&#39;entry__headline&#39;</span>: <span style=color:#a5d6ff>&#39;Another entry&#39;</span>}, <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=8-values_list>8. values_list()<a hidden class=anchor aria-hidden=true href=#8-values_list>#</a></h3><p><code>values_list(*fields, flat=False)</code></p><ul><li>与values()类似，只是在迭代时返回的是元组而不是字典。每个元组包含传递给values_list()调用的相应字段或表达式的值，因此第一个项目是第一个字段等。 像这样：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;id&#39;</span>, <span style=color:#a5d6ff>&#39;headline&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [(<span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;First entry&#39;</span>), <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models.functions</span> <span style=color:#ff7b72>import</span> Lower
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;id&#39;</span>, Lower(<span style=color:#a5d6ff>&#39;headline&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [(<span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;first entry&#39;</span>), <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>如果只传递一个字段，还可以传递<code>flat</code>参数。 如果为True，它表示返回的结果为单个值而不是元组。 如下所示：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;id&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>order_by(<span style=color:#a5d6ff>&#39;id&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet[(<span style=color:#a5d6ff>1</span>,), (<span style=color:#a5d6ff>2</span>,), (<span style=color:#a5d6ff>3</span>,), <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;id&#39;</span>, flat<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)<span style=color:#ff7b72;font-weight:700>.</span>order_by(<span style=color:#a5d6ff>&#39;id&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [<span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>2</span>, <span style=color:#a5d6ff>3</span>, <span style=color:#ff7b72;font-weight:700>...</span>]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>如果有多个字段，传递flat将发生错误。</p></li><li><p>如果不传递任何值给values_list()，它将返回模型中的所有字段，以在模型中定义的顺序。</p></li><li><p>常见的情况是获取某个模型实例的特定字段值。可以使用values_list()，然后调用get()：</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;headline&#39;</span>, flat<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)<span style=color:#ff7b72;font-weight:700>.</span>get(pk<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#39;First entry&#39;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>values()和values_list()都用于特定情况下的优化：检索数据子集，而无需创建模型实例。</li><li>注意通过ManyToManyField进行查询时的行为：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Author<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;name&#39;</span>, <span style=color:#a5d6ff>&#39;entry__headline&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [(<span style=color:#a5d6ff>&#39;Noam Chomsky&#39;</span>, <span style=color:#a5d6ff>&#39;Impressions of Gaza&#39;</span>),(<span style=color:#a5d6ff>&#39;George Orwell&#39;</span>, <span style=color:#a5d6ff>&#39;Why Socialists Do Not Believe in Fun&#39;</span>),
</span></span><span style=display:flex><span>(<span style=color:#a5d6ff>&#39;George Orwell&#39;</span>, <span style=color:#a5d6ff>&#39;In Defence of English Cooking&#39;</span>),(<span style=color:#a5d6ff>&#39;Don Quixote&#39;</span>, <span style=color:#79c0ff>None</span>)]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 类似地，当查询反向外键时，对于没有任何作者的条目，返回None。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>values_list(<span style=color:#a5d6ff>&#39;authors&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet [(<span style=color:#a5d6ff>&#39;Noam Chomsky&#39;</span>,), (<span style=color:#a5d6ff>&#39;George Orwell&#39;</span>,), (<span style=color:#79c0ff>None</span>,)]<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=9-dates>9. dates()<a hidden class=anchor aria-hidden=true href=#9-dates>#</a></h3><p><code>dates(field, kind, order='ASC')</code></p><ul><li><p>返回一个QuerySet，表示QuerySet内容中特定类型的所有可用日期的datetime.date对象列表。</p></li><li><p>field参数是模型的DateField的名称。 kind参数应为"year"，&ldquo;month"或"day&rdquo;。 结果列表中的每个datetime.date对象被截取为给定的类型。</p></li><li><p>&ldquo;year&rdquo; 返回对应该field的所有不同年份值的列表。</p></li><li><p>&ldquo;month"返回字段的所有不同年/月值的列表。</p></li><li><p>&ldquo;day"返回字段的所有不同年/月/日值的列表。</p></li><li><p>order参数默认为&rsquo;ASC&rsquo;，或者&rsquo;DESC&rsquo;。 它指定如何排序结果。</p></li></ul><p>例子：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>dates(<span style=color:#a5d6ff>&#39;pub_date&#39;</span>, <span style=color:#a5d6ff>&#39;year&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>1</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>dates(<span style=color:#a5d6ff>&#39;pub_date&#39;</span>, <span style=color:#a5d6ff>&#39;month&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>3</span>, <span style=color:#a5d6ff>1</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>dates(<span style=color:#a5d6ff>&#39;pub_date&#39;</span>, <span style=color:#a5d6ff>&#39;day&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>3</span>, <span style=color:#a5d6ff>20</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>dates(<span style=color:#a5d6ff>&#39;pub_date&#39;</span>, <span style=color:#a5d6ff>&#39;day&#39;</span>, order<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;DESC&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>2</span>, <span style=color:#a5d6ff>20</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(headline__contains<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>dates(<span style=color:#a5d6ff>&#39;pub_date&#39;</span>, <span style=color:#a5d6ff>&#39;day&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[datetime<span style=color:#ff7b72;font-weight:700>.</span>date](<span style=color:#a5d6ff>2005</span>, <span style=color:#a5d6ff>3</span>, <span style=color:#a5d6ff>20</span>)]
</span></span></code></pre></td></tr></table></div></div><h3 id=10-datetimes>10. datetimes()<a hidden class=anchor aria-hidden=true href=#10-datetimes>#</a></h3><p><code>datetimes(field_name, kind, order='ASC', tzinfo=None)</code></p><ul><li><p>返回QuerySet，为datetime.datetime对象的列表，表示QuerySet内容中特定种类的所有可用日期。</p></li><li><p>field_name应为模型的DateTimeField的名称。</p></li><li><p>kind参数应为"hour&rdquo;，&ldquo;minute&rdquo;，&ldquo;month&rdquo;，&ldquo;year&rdquo;，&ldquo;second"或"day&rdquo;。</p></li><li><p>结果列表中的每个datetime.datetime对象被截取到给定的类型。</p></li><li><p>order参数默认为&rsquo;ASC&rsquo;，或者&rsquo;DESC&rsquo;。 它指定如何排序结果。</p></li><li><p>tzinfo参数定义在截取之前将数据时间转换到的时区。</p></li></ul><h3 id=11-none>11. none()<a hidden class=anchor aria-hidden=true href=#11-none>#</a></h3><p><code>none()</code></p><ul><li>调用none()将创建一个不返回任何对象的查询集，并且在访问结果时不会执行任何查询。</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>例子<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>none()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>QuerySet []<span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models.query</span> <span style=color:#ff7b72>import</span> EmptyQuerySet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> isinstance(Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>none(), EmptyQuerySet)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=12-all>12. all()<a hidden class=anchor aria-hidden=true href=#12-all>#</a></h3><p><code>all()</code></p><ul><li>返回当前QuerySet（或QuerySet子类）的副本。通常用于获取全部QuerySet对象。</li></ul><h3 id=13-union>13. union()<a hidden class=anchor aria-hidden=true href=#13-union>#</a></h3><p><code>union(*other_qs, all=False)</code></p><ul><li><p>Django中的新功能1.11。也就是集合中并集的概念！</p></li><li><p>使用SQL的UNION运算符组合两个或更多个QuerySet的结果。例如：</p></li></ul><p><code>qs1.union(qs2, qs3)</code></p><ul><li>默认情况下，UNION操作符仅选择不同的值。 要允许重复值，请使用all=True参数。</li></ul><h3 id=14-intersection>14. intersection()<a hidden class=anchor aria-hidden=true href=#14-intersection>#</a></h3><ul><li><p>intersection(*other_qs)</p></li><li><p>Django中的新功能1.11。也就是集合中<code>交集</code>的概念！</p></li><li><p>使用SQL的INTERSECT运算符返回两个或更多个QuerySet的共有元素。例如：</p></li></ul><p><code>qs1.intersection(qs2, qs3)</code></p><h3 id=15-difference>15. difference()<a hidden class=anchor aria-hidden=true href=#15-difference>#</a></h3><p><code>difference(*other_qs)</code></p><ul><li><p>Django中的新功能1.11。也就是集合中<code>差集</code>的概念！</p></li><li><p>使用SQL的EXCEPT运算符只保留QuerySet中的元素，但不保留其他QuerySet中的元素。例如：</p></li></ul><p><code>qs1.difference(qs2, qs3)</code></p><h3 id=16-select_related>16. select_related()<a hidden class=anchor aria-hidden=true href=#16-select_related>#</a></h3><p><code>select_related(*fields)</code></p><ul><li><p>沿着外键关系查询关联的对象的数据。这会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要再次数据库查询。</p></li><li><p>下面的例子解释了普通查询和select_related()查询的区别。 下面是一个标准的查询：</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 访问数据库。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e <span style=color:#ff7b72;font-weight:700>=</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 再次访问数据库以得到关联的Blog对象。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>=</span> [e<span style=color:#ff7b72;font-weight:700>.</span>blog]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>下面是一个select_related查询<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 访问数据库。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e <span style=color:#ff7b72;font-weight:700>=</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>select_related(<span style=color:#a5d6ff>&#39;blog&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 不会访问数据库，因为e.blog已经在前面的查询中获得了。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>=</span> [e<span style=color:#ff7b72;font-weight:700>.</span>blog]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select_related()可用于objects任何的查询集<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.utils</span> <span style=color:#ff7b72>import</span> timezone
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Find all the blogs with entries scheduled to be published in the future.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>blogs <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> e <span style=color:#ff7b72;font-weight:700>in</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(pub_date__gt<span style=color:#ff7b72;font-weight:700>=</span>[timezone<span style=color:#ff7b72;font-weight:700>.</span>now]())<span style=color:#ff7b72;font-weight:700>.</span>select_related(<span style=color:#a5d6ff>&#39;blog&#39;</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 没有select_related()，下面的语句将为每次循环迭代生成一个数据库查询,以获得每个entry关联的blog。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>blogs<span style=color:#ff7b72;font-weight:700>.</span>add([e<span style=color:#ff7b72;font-weight:700>.</span>blog])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>filter()和select_related()的顺序不重要<span style=color:#f85149>。</span> 下面的查询集是等同的<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(pub_date__gt<span style=color:#ff7b72;font-weight:700>=</span>[timezone<span style=color:#ff7b72;font-weight:700>.</span>now]<span style=color:#ff7b72;font-weight:700>.</span>select_related(<span style=color:#a5d6ff>&#39;blog&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>select_related(<span style=color:#a5d6ff>&#39;blog&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>filter(pub_date__gt<span style=color:#ff7b72;font-weight:700>=</span>[timezone<span style=color:#ff7b72;font-weight:700>.</span>now]())
</span></span></code></pre></td></tr></table></div></div><p>可以沿着外键查询。 如果有以下模型：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>from django.db import models
</span></span><span style=display:flex><span>class City(models.Model):
</span></span><span style=display:flex><span>    # ...
</span></span><span style=display:flex><span>    pass
</span></span><span style=display:flex><span>class Person(models.Model):
</span></span><span style=display:flex><span>    # ...
</span></span><span style=display:flex><span>    hometown = models.ForeignKey(
</span></span><span style=display:flex><span>        City,
</span></span><span style=display:flex><span>        on_delete=models.SET_NULL,
</span></span><span style=display:flex><span>        blank=True,
</span></span><span style=display:flex><span>        null=True,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>class Book(models.Model):
</span></span><span style=display:flex><span>    # ...
</span></span><span style=display:flex><span>    author = models.ForeignKey(Person, on_delete=models.CASCADE)
</span></span></code></pre></td></tr></table></div></div><p>调用Book.objects.select_related(&lsquo;author__hometown&rsquo;).get(id=4)将缓存相关的Person 和相关的City：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>=</span> Book<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>select_related(<span style=color:#a5d6ff>&#39;author__hometown&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#ff7b72;font-weight:700>=</span> [b<span style=color:#ff7b72;font-weight:700>.</span>author] <span style=color:#8b949e;font-style:italic># Doesn&#39;t hit the database.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#ff7b72;font-weight:700>=</span> p<span style=color:#ff7b72;font-weight:700>.</span>hometown <span style=color:#8b949e;font-style:italic># Doesn&#39;t hit the database.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>=</span> Book<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>4</span>) <span style=color:#8b949e;font-style:italic># No select_related() in this example.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#ff7b72;font-weight:700>=</span> [b<span style=color:#ff7b72;font-weight:700>.</span>author] <span style=color:#8b949e;font-style:italic># Hits the database.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#ff7b72;font-weight:700>=</span> p<span style=color:#ff7b72;font-weight:700>.</span>hometown <span style=color:#8b949e;font-style:italic># Hits the database.</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>在传递给select_related()的字段中，可以使用<code>任何ForeignKey</code>和<code>OneToOneField</code>。</p></li><li><p>在传递给select_related()的字段中，还可以反向引用OneToOneField。也就是说，可以回溯到定义OneToOneField 的字段。 此时，可以使用关联对象字段的related_name，而不要指定字段的名称。</p></li></ul><h3 id=17-prefetch_related>17. prefetch_related()<a hidden class=anchor aria-hidden=true href=#17-prefetch_related>#</a></h3><p><code>prefetch_related(*lookups)</code></p><ul><li><p>在单个批处理中自动检索每个指定查找的相关对象。</p></li><li><p>与select_related类似，但是策略是完全不同的。</p></li></ul><p>假设有这些模型：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>from django.db import models
</span></span><span style=display:flex><span>class weightping(models.Model):
</span></span><span style=display:flex><span>    name = models.CharField(max_length=30)
</span></span><span style=display:flex><span>class Pizza(models.Model):
</span></span><span style=display:flex><span>    name = models.CharField(max_length=50)
</span></span><span style=display:flex><span>    weightpings = models.ManyToManyField(weightping)
</span></span><span style=display:flex><span>    def __str__(self):              # __unicode__ on Python 2
</span></span><span style=display:flex><span>        return &#34;%s (%s)&#34; % (
</span></span><span style=display:flex><span>            self.name,
</span></span><span style=display:flex><span>            &#34;, &#34;.join(weightping.name for weightping in self.weightpings.all()),
</span></span><span style=display:flex><span>        )
</span></span></code></pre></td></tr></table></div></div><p>并运行：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Pizza<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a5d6ff>&#34;Hawaiian (ham, pineapple)&#34;</span>, <span style=color:#a5d6ff>&#34;Seafood (prawns, smoked salmon)&#34;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>问题是每次QuerySet要求Pizza.objects.all()查询数据库，因此<code>self.weightpings.all()</code>将在<code>Pizza Pizza.__str__()</code>中的每个项目的<code>weightpings</code>表上运行查询。</p></li><li><p>可以使用prefetch_related减少为只有两个查询：</p></li></ul><p><code>Pizza.objects.all().prefetch_related('weightpings')</code></p><ul><li><p>这意味着现在每次<code>self.weightpings.all()</code>被调用，不会再去数据库查找，而是在一个预取的QuerySet缓存中查找。</p></li><li><p>还可以使用正常连接语法来执行相关字段的相关字段。 假设在上面的例子中增加一个额外的模型：</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Restaurant</span>(models<span style=color:#ff7b72;font-weight:700>.</span>Model):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	pizzas <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>ManyToManyField(Pizza, related_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;restaurants&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	best_pizza <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>ForeignKey(Pizza, related_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;championed_by&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>以下是合法的：</p><p><code>Restaurant.objects.prefetch_related('pizzas__weightpings')</code></p><ul><li>这将预取所有属于餐厅的比萨饼，和所有属于那些比萨饼的配料。 这将导致总共3个查询 - 一个用于餐馆，一个用于比萨饼，一个用于配料。</li></ul><p><code>Restaurant.objects.prefetch_related('best_pizza__weightpings')</code></p><ul><li><p>这将获取最好的比萨饼和每个餐厅最好的披萨的所有配料。 这将在3个表中查询 - 一个为餐厅，一个为“最佳比萨饼”，一个为配料。</p></li><li><p>当然，也可以使用best_pizza来获取select_related关系，以将查询数减少为2：</p></li></ul><p><code>Restaurant.objects.select_related('best_pizza').prefetch_related('best_pizza__weightpings')</code></p><h3 id=18-extra>18. extra()<a hidden class=anchor aria-hidden=true href=#18-extra>#</a></h3><p><code>extra(select=None, where=None, params=None, tables=None, order_by=None, select_params=None)</code></p><ul><li>有些情况下，Django的查询语法难以简单的表达复杂的WHERE子句，对于这种情况,可以在<code>extra()</code>生成的SQL从句中注入新子句。使用这种方法作为最后的手段，这是一个旧的API，在将来的某个时候可能被弃用。仅当无法使用其他查询方法表达查询时才使用它。</li></ul><p>例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>qs<span style=color:#ff7b72;font-weight:700>.</span>extra(
</span></span><span style=display:flex><span>	select<span style=color:#ff7b72;font-weight:700>=</span>{<span style=color:#a5d6ff>&#39;val&#39;</span>: <span style=color:#a5d6ff>&#34;select col from sometable where othercol = </span><span style=color:#a5d6ff>%s</span><span style=color:#a5d6ff>&#34;</span>},
</span></span><span style=display:flex><span>	select_params<span style=color:#ff7b72;font-weight:700>=</span>(someparam,),
</span></span><span style=display:flex><span> )
</span></span></code></pre></td></tr></table></div></div><p>相当于：</p><p><code>qs.annotate(val=RawSQL("select col from sometable where othercol = %s", (someparam,)))</code></p><h3 id=19-defer>19. defer()<a hidden class=anchor aria-hidden=true href=#19-defer>#</a></h3><p><code>defer(*fields)</code></p><ul><li><p>在一些复杂的数据建模情况下，模型可能包含大量字段，其中一些可能包含大尺寸数据（例如文本字段），将它们转换为Python对象需要花费很大的代价。</p></li><li><p>当最初获取数据时不知道是否需要这些特定字段的情况下，如果正在使用查询集的结果，可以告诉Django不要从数据库中检索它们。</p></li><li><p>通过传递字段名称到defer()实现不加载：</p></li></ul><p><code>Entry.objects.defer("headline", "body")</code></p><ul><li><p>具有延迟加载字段的查询集仍将返回模型实例。</p></li><li><p>每个延迟字段将在你访问该字段时从数据库中检索（每次只检索一个，而不是一次检索所有的延迟字段）。</p></li><li><p>可以多次调用defer()。 每个调用都向延迟集添加新字段：</p></li></ul><h4 id=延迟body和headline两个字段>延迟body和headline两个字段。<a hidden class=anchor aria-hidden=true href=#延迟body和headline两个字段>#</a></h4><p><code>Entry.objects.defer("body").filter(rating=5).defer("headline")</code></p><ul><li><p>字段添加到延迟集的顺序无关紧要。对已经延迟的字段名称再次defer()没有问题（该字段仍将被延迟）。</p></li><li><p>可以使用标准的双下划线符号来分隔关联的字段，从而加载关联模型中的字段：</p></li></ul><p><code>Blog.objects.select_related().defer("entry__headline", "entry__body")</code></p><ul><li>如果要清除延迟字段集，将None作为参数传递到defer()：</li></ul><h4 id=立即加载所有的字段>立即加载所有的字段。<a hidden class=anchor aria-hidden=true href=#立即加载所有的字段>#</a></h4><ul><li><p>my_queryset.defer(None)</p></li><li><p>defer()方法（及其兄弟，only()）仅适用于高级用例，它们提供了数据加载的优化方法。</p></li></ul><h3 id=20-only>20. only()<a hidden class=anchor aria-hidden=true href=#20-only>#</a></h3><p><code>only(*fields)</code></p><ul><li><p>only()方法与defer()相反。</p></li><li><p>如果有一个模型几乎所有的字段需要延迟，使用only()指定补充的字段集可以使代码更简单。</p></li><li><p>假设有一个包含字段biography、age和name的模型。 以下两个查询集是相同的，就延迟字段而言：</p><ul><li>Person.objects.defer(&ldquo;age&rdquo;, &ldquo;biography&rdquo;)</li><li>Person.objects.only(&ldquo;name&rdquo;)</li></ul></li></ul><p>每当你调用only()时，它将替换立即加载的字段集。因此，对only()的连续调用的结果是只有最后一次调用的字段被考虑：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This will defer all fields except the headline.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>only(<span style=color:#a5d6ff>&#34;body&#34;</span>, <span style=color:#a5d6ff>&#34;rating&#34;</span>)<span style=color:#ff7b72;font-weight:700>.</span>only(<span style=color:#a5d6ff>&#34;headline&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>由于defer()以递增方式动作<span style=color:#f85149>（</span>向延迟列表中添加字段<span style=color:#f85149>），</span>因此你可以结合only()和defer()调用<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Final result is that everything except &#34;headline&#34; is deferred.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>only(<span style=color:#a5d6ff>&#34;headline&#34;</span>, <span style=color:#a5d6ff>&#34;body&#34;</span>)<span style=color:#ff7b72;font-weight:700>.</span>defer(<span style=color:#a5d6ff>&#34;body&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Final result loads headline and body immediately (only() replaces any</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># existing set of fields).</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>defer(<span style=color:#a5d6ff>&#34;body&#34;</span>)<span style=color:#ff7b72;font-weight:700>.</span>only(<span style=color:#a5d6ff>&#34;headline&#34;</span>, <span style=color:#a5d6ff>&#34;body&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>当对具有延迟字段的实例调用save()时，仅保存加载的字段。</p><h3 id=21-using>21. using()<a hidden class=anchor aria-hidden=true href=#21-using>#</a></h3><p><code>using(alias)</code></p><ul><li>如果正在使用多个数据库，这个方法用于指定在哪个数据库上查询QuerySet。方法的唯一参数是数据库的别名，定义在DATABASES。</li></ul><p>例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># queries the database with the &#39;default&#39; alias.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># queries the database with the &#39;backup&#39; alias</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>using(<span style=color:#a5d6ff>&#39;backup&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=22-select_for_update>22. select_for_update()<a hidden class=anchor aria-hidden=true href=#22-select_for_update>#</a></h3><p><code>select_for_update(nowait=False, skip_locked=False)</code></p><ul><li>返回一个锁住行直到事务结束的查询集，如果数据库支持，它将生成一个SELECT &mldr; FOR UPDATE语句。</li></ul><p>例如：</p><p><code>entries = Entry.objects.select_for_update().filter(author=request.user)</code></p><ul><li><p>所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。</p></li><li><p>一般情况下如果其他事务锁定了相关行，那么本查询将被阻塞，直到锁被释放。使用select_for_update(nowait=True)将使查询不阻塞。如果其它事务持有冲突的锁,那么查询将引发DatabaseError异常。也可以使用select_for_update(skip_locked=True)忽略锁定的行。nowait和skip_locked是互斥的。</p></li><li><p>目前，postgresql，oracle和mysql数据库后端支持select_for_update()。但是，MySQL不支持nowait和skip_locked参数。</p></li></ul><h3 id=23-raw>23. raw()<a hidden class=anchor aria-hidden=true href=#23-raw>#</a></h3><p>raw(raw_query, params=None, translations=None)</p><p>接收一个原始的SQL查询，执行它并返回一个django.db.models.query.RawQuerySet实例。</p><p>这个RawQuerySet实例可以迭代，就像普通的QuerySet一样。</p><h1 id=四不返回querysets的api>四、不返回QuerySets的API<a hidden class=anchor aria-hidden=true href=#四不返回querysets的api>#</a></h1><ul><li>以下的方法不会返回QuerySets，但是作用非常强大，尤其是粗体显示的方法，需要背下来。</li></ul><h2 id=方法名-解释-1><strong>方法名 解释</strong><a hidden class=anchor aria-hidden=true href=#方法名-解释-1>#</a></h2><p>get() 获取单个对象</p><p>create() 创建对象，无需save()</p><p>get_or_create() 查询对象，如果没有找到就新建对象</p><p>update_or_create() 更新对象，如果没有找到就创建对象</p><p>bulk_create()</p><p>批量创建对象</p><p>count() 统计对象的个数</p><p>in_bulk()</p><p>根据主键值的列表，批量返回对象</p><p>iterator()</p><p>获取包含对象的迭代器</p><p>latest() 获取最近的对象</p><p>earliest() 获取最早的对象</p><p>first() 获取第一个对象</p><p>last() 获取最后一个对象</p><p>aggregate() 聚合操作</p><p>exists() 判断queryset中是否有对象</p><p>update() 批量更新对象</p><p>delete() 批量删除对象</p><p>as_manager() 获取管理器</p><h3 id=1-get>1. get()<a hidden class=anchor aria-hidden=true href=#1-get>#</a></h3><p><code>get(**kwargs)</code></p><ul><li><p>返回按照查询参数匹配到的单个对象，参数的格式应该符合Field lookups的要求。</p></li><li><p>如果匹配到的对象个数不只一个的话，触发MultipleObjectsReturned异常</p></li><li><p>如果根据给出的参数匹配不到对象的话，触发DoesNotExist异常。例如：</p></li></ul><p><code>Entry.objects.get(id='foo') # raises Entry.DoesNotExist</code></p><ul><li>DoesNotExist异常从django.core.exceptions.ObjectDoesNotExist继承，可以定位多个DoesNotExist异常。 例如：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.core.exceptions</span> <span style=color:#ff7b72>import</span> ObjectDoesNotExist
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>	e <span style=color:#ff7b72;font-weight:700>=</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>	b <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> ObjectDoesNotExist:
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;Either the entry or blog doesn&#39;t exist.&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>如果希望查询器只返回一行，则可以使用get()而不使用任何参数来返回该行的对象：</li></ul><p><code>entry = Entry.objects.filter(...).exclude(...).get()</code></p><h3 id=2-create>2. create()<a hidden class=anchor aria-hidden=true href=#2-create>#</a></h3><p><code>create(**kwargs)</code></p><ul><li>在一步操作中<code>同时创建</code>并且<code>保存对象</code>的便捷方法.</li></ul><p><code>p = Person.objects.create(first_name="Bruce", last_name="Springsteen")</code></p><p>等于:</p><p><code>p = Person(first_name="Bruce", last_name="Springsteen")</code></p><p><code>p.save(force_insert=True)</code></p><ul><li>参数force_insert表示强制创建对象。如果model中有一个你手动设置的主键，并且这个值已经存在于数据库中, 调用create()将会失败并且触发IntegrityError因为主键必须是唯一的。如果你手动设置了主键，做好异常处理的准备。</li></ul><h3 id=3-get_or_create>3. get_or_create()<a hidden class=anchor aria-hidden=true href=#3-get_or_create>#</a></h3><p><code>get_or_create(defaults=None, **kwargs)</code></p><ul><li><p>通过kwargs来查询对象的便捷方法（如果模型中的所有字段都有默认值，可以为空），如果该对象不存在则创建一个新对象。</p></li><li><p>该方法返回一个由(object, created)组成的元组，元组中的object 是一个查询到的或者是被创建的对象， created是一个表示是否创建了新的对象的布尔值。</p></li></ul><p>对于下面的代码：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj <span style=color:#ff7b72;font-weight:700>=</span> Person<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(first_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;John&#39;</span>, last_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> Person<span style=color:#ff7b72;font-weight:700>.</span>DoesNotExist:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj <span style=color:#ff7b72;font-weight:700>=</span> Person(first_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;John&#39;</span>, last_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>, birthday<span style=color:#ff7b72;font-weight:700>=</span>date(<span style=color:#a5d6ff>1940</span>, <span style=color:#a5d6ff>10</span>, <span style=color:#a5d6ff>9</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span></code></pre></td></tr></table></div></div><p>如果模型的字段数量较大的话，这种模式就变的非常不易用了。 上面的示例可以用get_or_create()重写 :</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>obj, created <span style=color:#ff7b72;font-weight:700>=</span> Person<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get_or_create(
</span></span><span style=display:flex><span>  first_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;John&#39;</span>,
</span></span><span style=display:flex><span>  last_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>,
</span></span><span style=display:flex><span>  defaults<span style=color:#ff7b72;font-weight:700>=</span>{<span style=color:#a5d6ff>&#39;birthday&#39;</span>: date(<span style=color:#a5d6ff>1940</span>, <span style=color:#a5d6ff>10</span>, <span style=color:#a5d6ff>9</span>)},
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>任何传递给get_or_create()的关键字参数，除了一个可选的defaults，都将传递给get()调用。 如果查找到一个对象，返回一个包含匹配到的对象以及False 组成的元组。 如果查找到的对象超过一个以上，将引发MultipleObjectsReturned。如果查找不到对象，get_or_create()将会实例化并保存一个新的对象，返回一个由新的对象以及True组成的元组。新的对象将会按照以下的逻辑创建:</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>params <span style=color:#ff7b72;font-weight:700>=</span> {k: v <span style=color:#ff7b72>for</span> k, v <span style=color:#ff7b72;font-weight:700>in</span> kwargs<span style=color:#ff7b72;font-weight:700>.</span>items() <span style=color:#ff7b72>if</span> <span style=color:#a5d6ff>&#39;__&#39;</span> <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> k}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>params<span style=color:#ff7b72;font-weight:700>.</span>update({k: v() <span style=color:#ff7b72>if</span> callable(v) <span style=color:#ff7b72>else</span> v <span style=color:#ff7b72>for</span> k, v <span style=color:#ff7b72;font-weight:700>in</span> defaults<span style=color:#ff7b72;font-weight:700>.</span>items()})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>obj <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>model(<span style=color:#ff7b72;font-weight:700>**</span>params)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>obj<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span></code></pre></td></tr></table></div></div><ul><li><p>它表示从非&rsquo;defaults&rsquo; 且不包含双下划线的关键字参数开始。然后将defaults的内容添加进来，覆盖必要的键，并使用结果作为关键字参数传递给模型类。</p></li><li><p>如果有一个名为defaults__exact的字段，并且想在get_or_create()时用它作为精确查询，只需要使用defaults，像这样：</p></li></ul><p><code>Foo.objects.get_or_create(defaults__exact='bar', defaults={'defaults': 'baz'})</code></p><ul><li><p>当你使用手动指定的主键时，get_or_create()方法与create()方法有相似的错误行为 。 如果需要创建一个对象而该对象的主键早已存在于数据库中，IntegrityError异常将会被触发。</p></li><li><p>这个方法假设进行的是原子操作，并且正确地配置了数据库和正确的底层数据库行为。如果数据库级别没有对get_or_create中用到的kwargs强制要求唯一性（unique和unique_together），方法容易导致竞态条件，可能会有相同参数的多行同时插入。（简单理解，kwargs必须指定的是主键或者unique属性的字段才安全。）</p></li><li><p>最后建议只在Django视图的POST请求中使用get_or_create()，因为这是一个具有修改性质的动作，不应该使用在GET请求中，那样不安全。</p></li><li><p>可以通过ManyToManyField属性和反向关联使用get_or_create()。在这种情况下，应该限制查询在关联的上下文内部。 否则，可能导致完整性问题。</p></li></ul><p>例如下面的模型：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Chapter</span>(models<span style=color:#ff7b72;font-weight:700>.</span>Model):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  title <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>CharField(max_length<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>255</span>, unique<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Book</span>(models<span style=color:#ff7b72;font-weight:700>.</span>Model):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  title <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>CharField(max_length<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>256</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  chapters <span style=color:#ff7b72;font-weight:700>=</span> models<span style=color:#ff7b72;font-weight:700>.</span>ManyToManyField(Chapter)
</span></span></code></pre></td></tr></table></div></div><p>可以通过Book的chapters字段使用get_or_create()，但是它只会获取该Book内部的上下文：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> book <span style=color:#ff7b72;font-weight:700>=</span> Book<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>create(title<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Ulysses&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> book<span style=color:#ff7b72;font-weight:700>.</span>chapters<span style=color:#ff7b72;font-weight:700>.</span>get_or_create(title<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Telemachus&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#ff7b72;font-weight:700>&lt;</span>Chapter: Telemachus<span style=color:#ff7b72;font-weight:700>&gt;</span>, <span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> book<span style=color:#ff7b72;font-weight:700>.</span>chapters<span style=color:#ff7b72;font-weight:700>.</span>get_or_create(title<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Telemachus&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#ff7b72;font-weight:700>&lt;</span>Chapter: Telemachus<span style=color:#ff7b72;font-weight:700>&gt;</span>, <span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Chapter<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>create(title<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Chapter 1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&lt;</span>Chapter: Chapter <span style=color:#a5d6ff>1</span><span style=color:#ff7b72;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> book<span style=color:#ff7b72;font-weight:700>.</span>chapters<span style=color:#ff7b72;font-weight:700>.</span>get_or_create(title<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;Chapter 1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Raises IntegrityError</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>发生这个错误是因为尝试通过Book “Ulysses”获取或者创建“Chapter 1”，但是它不能，因为它与这个book不关联，但因为title 字段是唯一的它仍然不能创建。</li></ul><p>在Django1.11在defaults中增加了对可调用值的支持。</p><h3 id=4-update_or_create>4. update_or_create()<a hidden class=anchor aria-hidden=true href=#4-update_or_create>#</a></h3><p><code>update_or_create(defaults=None, **kwargs)</code></p><p>类似前面的get_or_create()。</p><ul><li><p>通过给出的kwargs来更新对象的便捷方法， 如果没找到对象，则创建一个新的对象。defaults是一个由 (field, value)对组成的字典，用于更新对象。defaults中的值可以是可调用对象（也就是说函数等）。</p></li><li><p>该方法返回一个由(object, created)组成的元组,元组中的object是一个创建的或者是被更新的对象， created是一个标示是否创建了新的对象的布尔值。</p></li><li><p>update_or_create方法尝试通过给出的kwargs 去从数据库中获取匹配的对象。 如果找到匹配的对象，它将会依据defaults 字典给出的值更新字段。</p></li></ul><p>像下面的代码：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>defaults <span style=color:#ff7b72;font-weight:700>=</span> {<span style=color:#a5d6ff>&#39;first_name&#39;</span>: <span style=color:#a5d6ff>&#39;Bob&#39;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj <span style=color:#ff7b72;font-weight:700>=</span> Person<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(first_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;John&#39;</span>, last_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>for</span> key, value <span style=color:#ff7b72;font-weight:700>in</span> defaults<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  setattr(obj, key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> Person<span style=color:#ff7b72;font-weight:700>.</span>DoesNotExist:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  new_values <span style=color:#ff7b72;font-weight:700>=</span> {<span style=color:#a5d6ff>&#39;first_name&#39;</span>: <span style=color:#a5d6ff>&#39;John&#39;</span>, <span style=color:#a5d6ff>&#39;last_name&#39;</span>: <span style=color:#a5d6ff>&#39;Lennon&#39;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  new_values<span style=color:#ff7b72;font-weight:700>.</span>update(defaults)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  obj <span style=color:#ff7b72;font-weight:700>=</span> Person(<span style=color:#ff7b72;font-weight:700>**</span>new_values)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	obj<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span></code></pre></td></tr></table></div></div><p>如果模型的字段数量较大的话，这种模式就变的非常不易用了。 上面的示例可以用update_or_create() 重写:</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>obj, created <span style=color:#ff7b72;font-weight:700>=</span> Person<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>update_or_create(
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>first_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;John&#39;</span>, last_name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>defaults<span style=color:#ff7b72;font-weight:700>=</span>{<span style=color:#a5d6ff>&#39;first_name&#39;</span>: <span style=color:#a5d6ff>&#39;Bob&#39;</span>},
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><ul><li><p>kwargs中的名称如何解析的详细描述可以参见get_or_create()。</p></li><li><p>和get_or_create()一样，这个方法也容易导致竞态条件，如果数据库层级没有前置唯一性会让多行同时插入。</p></li></ul><p>在Django1.11在defaults中增加了对可调用值的支持。</p><h3 id=5-bulk_create>5. bulk_create()<a hidden class=anchor aria-hidden=true href=#5-bulk_create>#</a></h3><p><code>bulk_create(objs, batch_size=None)</code></p><ul><li>以高效的方式（通常只有1个查询，无论有多少对象）将提供的对象列表插入到数据库中：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>bulk_create([
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>...</span> Entry(headline<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;This is a test&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>...</span> Entry(headline<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;This is only a test&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>...</span> ])
</span></span></code></pre></td></tr></table></div></div><p>注意事项：</p><ul><li><p>不会调用模型的save()方法，并且不会发送pre_save和post_save信号。</p></li><li><p>不适用于多表继承场景中的子模型。</p></li><li><p>如果模型的主键是AutoField，则不会像save()那样检索并设置主键属性，除非数据库后端支持。</p></li><li><p>不适用于多对多关系。</p></li><li><p>batch_size参数控制在单个查询中创建的对象数。</p></li></ul><h3 id=6-count>6. count()<a hidden class=anchor aria-hidden=true href=#6-count>#</a></h3><p><code>count()</code></p><ul><li>返回在数据库中对应的QuerySet对象的个数。count()永远不会引发异常。</li></ul><p>例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 返回总个数.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>count()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 返回包含有&#39;Lennon&#39;的对象的总数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(headline__contains<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;Lennon&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>count()
</span></span></code></pre></td></tr></table></div></div><h3 id=7-in_bulk>7. in_bulk()<a hidden class=anchor aria-hidden=true href=#7-in_bulk>#</a></h3><p><code>in_bulk(id_list=None)</code></p><ul><li>获取主键值的列表，并返回将每个主键值映射到具有给定ID的对象的实例的字典。 如果未提供列表，则会返回查询集中的所有对象。</li></ul><p>例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>in_bulk([<span style=color:#a5d6ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#a5d6ff>1</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Beatles Blog<span style=color:#ff7b72;font-weight:700>&gt;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>in_bulk([<span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>2</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#a5d6ff>1</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Beatles Blog<span style=color:#ff7b72;font-weight:700>&gt;</span>, <span style=color:#a5d6ff>2</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Cheddar Talk<span style=color:#ff7b72;font-weight:700>&gt;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>in_bulk([])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>in_bulk()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#a5d6ff>1</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Beatles Blog<span style=color:#ff7b72;font-weight:700>&gt;</span>, <span style=color:#a5d6ff>2</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Cheddar Talk<span style=color:#ff7b72;font-weight:700>&gt;</span>, <span style=color:#a5d6ff>3</span>: <span style=color:#ff7b72;font-weight:700>&lt;</span>Blog: Django Weblog<span style=color:#ff7b72;font-weight:700>&gt;</span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>如果向in_bulk()传递一个空列表，会得到一个空的字典。</p></li><li><p>在旧版本中，id_list是必需的参数，现在是一个可选参数。</p></li></ul><h3 id=8-iterator>8. iterator()<a hidden class=anchor aria-hidden=true href=#8-iterator>#</a></h3><p><code>iterator()</code></p><ul><li><p>提交数据库操作，获取QuerySet，并返回一个迭代器。</p></li><li><p>QuerySet通常会在内部缓存其结果，以便在重复计算时不会导致额外的查询。而iterator()将直接读取结果，不在QuerySet级别执行任何缓存。对于返回大量只需要访问一次的对象的QuerySet，这可以带来更好的性能，显著减少内存使用。</p></li></ul><blockquote><p>请注意，在已经提交了的iterator()上使用QuerySet会强制它再次提交数据库操作，进行重复查询。此外，使用iterator()会导致先前的prefetch_related()调用被忽略，因为这两个一起优化没有意义。</p></blockquote><h3 id=9-latest>9. latest()<a hidden class=anchor aria-hidden=true href=#9-latest>#</a></h3><p><code>latest(field_name=None)</code></p><ul><li><p>使用日期字段field_name，按日期返回最新对象。</p></li><li><p>下例根据Entry的&rsquo;pub_date&rsquo;字段返回最新发布的entry：</p><p><code>Entry.objects.latest('pub_date')</code></p></li><li><p>如果模型的Meta指定了get_latest_by，则可以将latest()参数留给earliest()或者field_name。 默认情况下，Django将使用get_latest_by中指定的字段。</p></li><li><p>earliest()和latest()可能会返回空日期的实例,可能需要过滤掉空值：</p></li></ul><p><code>Entry.objects.filter(pub_date__isnull=False).latest('pub_date')</code></p><h3 id=10-earliest>10. earliest()<a hidden class=anchor aria-hidden=true href=#10-earliest>#</a></h3><p>earliest(field_name=None)</p><p>类同latest()。</p><h3 id=11-first>11. first()<a hidden class=anchor aria-hidden=true href=#11-first>#</a></h3><p><code>first()</code></p><ul><li>返回结果集的第一个对象, 当没有找到时返回None。如果QuerySet没有设置排序,则将会自动按主键进行排序。例如：</li></ul><p><code>p = Article.objects.order_by('title', 'pub_date').first()</code></p><ul><li>first()是一个简便方法，下面的例子和上面的代码效果是一样：</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>	p <span style=color:#ff7b72;font-weight:700>=</span> Article<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>order_by(<span style=color:#a5d6ff>&#39;title&#39;</span>, <span style=color:#a5d6ff>&#39;pub_date&#39;</span>)[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#ff7b72>except</span> <span style=color:#f0883e;font-weight:700>IndexError</span>:
</span></span><span style=display:flex><span>	p <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=12-last>12. last()<a hidden class=anchor aria-hidden=true href=#12-last>#</a></h3><p><code>last()</code></p><p>工作方式类似first()，只是返回的是查询集中最后一个对象。</p><h3 id=13-aggregate>13. aggregate()<a hidden class=anchor aria-hidden=true href=#13-aggregate>#</a></h3><p><code>aggregate(args, *kwargs)</code></p><ul><li><p>返回汇总值的字典（平均值，总和等）,通过QuerySet进行计算。每个参数指定返回的字典中将要包含的值。</p></li><li><p>使用关键字参数指定的聚合将使用关键字参数的名称作为Annotation 的名称。 匿名参数的名称将基于聚合函数的名称和模型字段生成。 复杂的聚合不可以使用匿名参数，必须指定一个关键字参数作为别名。</p></li></ul><p>例如，想知道Blog Entry 的数目：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>django.db.models</span> <span style=color:#ff7b72>import</span> Count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>q <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>aggregate(Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>{<span style=color:#a5d6ff>&#39;entry__count&#39;</span>: <span style=color:#a5d6ff>16</span>}
</span></span></code></pre></td></tr></table></div></div><p>通过使用关键字参数来指定聚合函数，可以控制返回的聚合的值的名称：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>q <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>aggregate(number_of_entries<span style=color:#ff7b72;font-weight:700>=</span>Count(<span style=color:#a5d6ff>&#39;entry&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#a5d6ff>&#39;number_of_entries&#39;</span>: <span style=color:#a5d6ff>16</span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=14-exists>14. exists()<a hidden class=anchor aria-hidden=true href=#14-exists>#</a></h3><p>exists()</p><ul><li><p>如果QuerySet包含任何结果，则返回True，否则返回False。</p></li><li><p>查找具有唯一性字段（例如primary_key）的模型是否在一个QuerySet中的最高效的方法是：</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>entry <span style=color:#ff7b72;font-weight:700>=</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(pk<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>123</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> some_queryset<span style=color:#ff7b72;font-weight:700>.</span>filter(pk<span style=color:#ff7b72;font-weight:700>=</span>entry<span style=color:#ff7b72;font-weight:700>.</span>pk)<span style=color:#ff7b72;font-weight:700>.</span>exists():
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;Entry contained in queryset&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>它将比下面的方法快很多，这个方法要求对QuerySet求值并迭代整个QuerySet：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>if</span> entry <span style=color:#ff7b72;font-weight:700>in</span> some_queryset:
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;Entry contained in QuerySet&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>若要查找一个QuerySet是否包含任何元素：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>if</span> some_queryset<span style=color:#ff7b72;font-weight:700>.</span>exists():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;There is at least one object in some_queryset&#34;</span>)
</span></span><span style=display:flex><span>将快于<span style=color:#f85149>：</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> some_queryset:
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;There is at least one object in some_queryset&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=15-update>15. update()<a hidden class=anchor aria-hidden=true href=#15-update>#</a></h3><p><code>update(**kwargs)</code></p><ul><li><p>对指定的字段执行批量更新操作，并返回匹配的行数（如果某些行已具有新值，则可能不等于已更新的行数）。</p></li><li><p>例如，要对2010年发布的所有博客条目启用评论，可以执行以下操作：</p></li></ul><p><code>Entry.objects.filter(pub_date__year=2010).update(comments_on=False)</code></p><ul><li>可以同时更新多个字段 （没有多少字段的限制）。 例如同时更新comments_on和headline字段：</li></ul><p><code>Entry.objects.filter(pub_date__year=2010).update(comments_on=False, headline='This is old')</code></p><p>update()方法<code>无需save</code>操作。唯一限制是它只能更新模型主表中的列，而不是关联的模型，例如不能这样做：</p><p><code>Entry.objects.update(blog__name='foo') # Won't work!</code></p><p>仍然可以根据相关字段进行过滤：</p><p><code>Entry.objects.filter(blog__id=1).update(comments_on=True)</code></p><p>update()方法返回受影响的行数：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>64</span>)<span style=color:#ff7b72;font-weight:700>.</span>update(comments_on<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(slug<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;nonexistent-slug&#39;</span>)<span style=color:#ff7b72;font-weight:700>.</span>update(comments_on<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(pub_date__year<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2010</span>)<span style=color:#ff7b72;font-weight:700>.</span>update(comments_on<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>132</span>
</span></span></code></pre></td></tr></table></div></div><p>如果你只是更新一下对象，不需要为对象做别的事情，最有效的方法是调用update()，而不是将模型对象加载到内存中。 例如，不要这样做：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>e <span style=color:#ff7b72;font-weight:700>=</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e<span style=color:#ff7b72;font-weight:700>.</span>comments_on <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span></code></pre></td></tr></table></div></div><p>建议如下操作：</p><p><code>Entry.objects.filter(id=10).update(comments_on=False)</code></p><p>用update()还可以防止在加载对象和调用save()之间的短时间内数据库中某些内容可能发生更改的竞争条件。</p><p>如果想更新一个具有自定义save()方法的模型的记录，请循环遍历它们并调用save()，如下所示：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>for</span> e <span style=color:#ff7b72;font-weight:700>in</span> Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(pub_date__year<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2010</span>):
</span></span><span style=display:flex><span>  e<span style=color:#ff7b72;font-weight:700>.</span>comments_on <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>False</span>
</span></span><span style=display:flex><span>  e<span style=color:#ff7b72;font-weight:700>.</span>save()
</span></span></code></pre></td></tr></table></div></div><h3 id=16-delete>16. delete()<a hidden class=anchor aria-hidden=true href=#16-delete>#</a></h3><p><code>delete()</code></p><ul><li><p>批量删除QuerySet中的所有对象，并返回删除的对象个数和每个对象类型的删除次数的字典。</p></li><li><p>delete()动作是立即执行的。</p></li><li><p>不能在QuerySet上调用delete()。</p></li><li><p>例如，要删除特定博客中的所有条目：</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>get(pk<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Delete all the entries belonging to this Blog.</span>
</span></span><span style=display:flex><span>Entry<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>filter(blog<span style=color:#ff7b72;font-weight:700>=</span>b)<span style=color:#ff7b72;font-weight:700>.</span>delete()
</span></span><span style=display:flex><span>(<span style=color:#a5d6ff>4</span>, {<span style=color:#a5d6ff>&#39;weblog.Entry&#39;</span>: <span style=color:#a5d6ff>2</span>, <span style=color:#a5d6ff>&#39;weblog.Entry_authors&#39;</span>: <span style=color:#a5d6ff>2</span>})
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，Django的ForeignKey使用SQL约束ON DELETE CASCADE，任何具有指向要删除的对象的外键的对象将与它们一起被删除。 像这样：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>blogs <span style=color:#ff7b72;font-weight:700>=</span> Blog<span style=color:#ff7b72;font-weight:700>.</span>objects<span style=color:#ff7b72;font-weight:700>.</span>all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># This will delete all Blogs and all of their Entry objects.</span>
</span></span><span style=display:flex><span>blogs<span style=color:#ff7b72;font-weight:700>.</span>delete()
</span></span><span style=display:flex><span>(<span style=color:#a5d6ff>5</span>, {<span style=color:#a5d6ff>&#39;weblog.Blog&#39;</span>: <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>&#39;weblog.Entry&#39;</span>: <span style=color:#a5d6ff>2</span>, <span style=color:#a5d6ff>&#39;weblog.Entry_authors&#39;</span>: <span style=color:#a5d6ff>2</span>})
</span></span></code></pre></td></tr></table></div></div><p>这种级联的行为可以通过的ForeignKey的on_delete参数自定义。（什么时候要改变这种行为呢？比如日志数据，就不能和它关联的主体一并被删除！）</p><p>delete()会为所有已删除的对象（包括级联删除）发出<code>pre_delete</code>和<code>post_delete</code>信号。</p><h3 id=17-as_manager>17. as_manager()<a hidden class=anchor aria-hidden=true href=#17-as_manager>#</a></h3><p><code>classmethod as_manager()</code></p><ul><li>一个类方法，返回Manager的实例与QuerySet的方法的副本</li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/django%E7%9A%84logger/><span class=title>« Prev</span><br><span>Django的logger配置</span>
</a><a class=next href=https://luenci.com/en/posts/golang%E7%9A%84%E5%80%BC%E4%BC%A0%E9%80%92%E5%92%8C%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/><span class=title>Next »</span><br><span></span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share  on x" href="https://x.com/intent/tweet/?text=&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f&amp;title=&amp;summary=&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f&title="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on whatsapp" href="https://api.whatsapp.com/send?text=%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on telegram" href="https://telegram.me/share/url?text=&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share  on ycombinator" href="https://news.ycombinator.com/submitlink?t=&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fdjango%25E7%259A%2584queryset%25E8%25AF%25A6%25E8%25A7%25A3%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2025 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>