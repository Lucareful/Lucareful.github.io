<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Context 正确使用姿势（推荐） | Luenci</title>
<meta name=keywords content="Golang"><meta name=description content="Context 正确使用姿势

原文参考：https://juejin.cn/post/6844903929340231694

Context 是 immutable（不可变的）
context.Context API
基本上是两类操作：

3个函数用于限定什么时候你的子节点退出；
1个函数用于设置请求范畴的变量



1
2
3
4
5
6
7
8


type Context interface {
  //  啥时候退出
  Deadline() (deadline time.Time, ok bool)
  Done() <-chan struct{}
  Err() error
  //  设置变量
  Value(key interface{}) interface{}
}


如何创建 Context？

在 RPC 开始的时候，使用 context.Background()

有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是不对的。直接每个请求，源自自己的 context.Background() 即可。


如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO()
如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子）

Context 放哪？

把 Context 想象为一条河流流过你的程序
理想情况下，Context 存在于调用栈（Call Stack） 中
不要把 Context 存储到一个 struct 里

除非你使用的是像 http.Request 中的 request 结构体的方式


request 结构体应该以 Request 结束为生命终止
当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference）
Request 结束，Context 就应该结束。

Context 包的注意事项

要养成关闭 Context 的习惯

特别是 超时的 Contexts


如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了



1
2


ctx, cancel := context.WithTimeout(parentCtx, time.Second * 2)
		defer cancel()、



使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。
在建立之后，立即 defer cancel() 是一个好习惯。
"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/context%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/context%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://umami.luenci.com/script.js data-website-id=b0a9e971-b470-43a2-bda9-182c654377f4></script><meta property="og:title" content="Context 正确使用姿势（推荐）"><meta property="og:description" content="Context 正确使用姿势

原文参考：https://juejin.cn/post/6844903929340231694

Context 是 immutable（不可变的）
context.Context API
基本上是两类操作：

3个函数用于限定什么时候你的子节点退出；
1个函数用于设置请求范畴的变量



1
2
3
4
5
6
7
8


type Context interface {
  //  啥时候退出
  Deadline() (deadline time.Time, ok bool)
  Done() <-chan struct{}
  Err() error
  //  设置变量
  Value(key interface{}) interface{}
}


如何创建 Context？

在 RPC 开始的时候，使用 context.Background()

有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是不对的。直接每个请求，源自自己的 context.Background() 即可。


如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO()
如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子）

Context 放哪？

把 Context 想象为一条河流流过你的程序
理想情况下，Context 存在于调用栈（Call Stack） 中
不要把 Context 存储到一个 struct 里

除非你使用的是像 http.Request 中的 request 结构体的方式


request 结构体应该以 Request 结束为生命终止
当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference）
Request 结束，Context 就应该结束。

Context 包的注意事项

要养成关闭 Context 的习惯

特别是 超时的 Contexts


如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了



1
2


ctx, cancel := context.WithTimeout(parentCtx, time.Second * 2)
		defer cancel()、



使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。
在建立之后，立即 defer cancel() 是一个好习惯。
"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/context%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="Context 正确使用姿势（推荐）"><meta name=twitter:description content="Context 正确使用姿势

原文参考：https://juejin.cn/post/6844903929340231694

Context 是 immutable（不可变的）
context.Context API
基本上是两类操作：

3个函数用于限定什么时候你的子节点退出；
1个函数用于设置请求范畴的变量



1
2
3
4
5
6
7
8


type Context interface {
  //  啥时候退出
  Deadline() (deadline time.Time, ok bool)
  Done() <-chan struct{}
  Err() error
  //  设置变量
  Value(key interface{}) interface{}
}


如何创建 Context？

在 RPC 开始的时候，使用 context.Background()

有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是不对的。直接每个请求，源自自己的 context.Background() 即可。


如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO()
如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子）

Context 放哪？

把 Context 想象为一条河流流过你的程序
理想情况下，Context 存在于调用栈（Call Stack） 中
不要把 Context 存储到一个 struct 里

除非你使用的是像 http.Request 中的 request 结构体的方式


request 结构体应该以 Request 结束为生命终止
当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference）
Request 结束，Context 就应该结束。

Context 包的注意事项

要养成关闭 Context 的习惯

特别是 超时的 Contexts


如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了



1
2


ctx, cancel := context.WithTimeout(parentCtx, time.Second * 2)
		defer cancel()、



使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。
在建立之后，立即 defer cancel() 是一个好习惯。
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"Context 正确使用姿势（推荐）","item":"https://luenci.com/en/posts/context%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Context 正确使用姿势（推荐）","name":"Context 正确使用姿势（推荐）","description":"Context 正确使用姿势 原文参考：https://juejin.cn/post/6844903929340231694\nContext 是 immutable（不可变的）\ncontext.Context API 基本上是两类操作：\n3个函数用于限定什么时候你的子节点退出； 1个函数用于设置请求范畴的变量 1 2 3 4 5 6 7 8 type Context interface { // 啥时候退出 Deadline() (deadline time.Time, ok bool) Done() \u0026lt;-chan struct{} Err() error // 设置变量 Value(key interface{}) interface{} } 如何创建 Context？ 在 RPC 开始的时候，使用 context.Background() 有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是不对的。直接每个请求，源自自己的 context.Background() 即可。 如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO() 如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子） Context 放哪？ 把 Context 想象为一条河流流过你的程序 理想情况下，Context 存在于调用栈（Call Stack） 中 不要把 Context 存储到一个 struct 里 除非你使用的是像 http.Request 中的 request 结构体的方式 request 结构体应该以 Request 结束为生命终止 当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference） Request 结束，Context 就应该结束。 Context 包的注意事项 要养成关闭 Context 的习惯 特别是 超时的 Contexts 如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了 1 2 ctx, cancel := context.WithTimeout(parentCtx, time.Second * 2) defer cancel()、 使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。 在建立之后，立即 defer cancel() 是一个好习惯。 ","keywords":["Golang"],"articleBody":"Context 正确使用姿势 原文参考：https://juejin.cn/post/6844903929340231694\nContext 是 immutable（不可变的）\ncontext.Context API 基本上是两类操作：\n3个函数用于限定什么时候你的子节点退出； 1个函数用于设置请求范畴的变量 1 2 3 4 5 6 7 8 type Context interface { // 啥时候退出 Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error // 设置变量 Value(key interface{}) interface{} } 如何创建 Context？ 在 RPC 开始的时候，使用 context.Background() 有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是不对的。直接每个请求，源自自己的 context.Background() 即可。 如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO() 如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子） Context 放哪？ 把 Context 想象为一条河流流过你的程序 理想情况下，Context 存在于调用栈（Call Stack） 中 不要把 Context 存储到一个 struct 里 除非你使用的是像 http.Request 中的 request 结构体的方式 request 结构体应该以 Request 结束为生命终止 当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference） Request 结束，Context 就应该结束。 Context 包的注意事项 要养成关闭 Context 的习惯 特别是 超时的 Contexts 如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了 1 2 ctx, cancel := context.WithTimeout(parentCtx, time.Second * 2) defer cancel()、 使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。 在建立之后，立即 defer cancel() 是一个好习惯。 终止请求 (Request Cancellation) 当你不再关心接下来获取的结果的时候，有可能会 Cancel 一个 Context？\n以 golang.org/x/sync/errgroup 为例，errgroup 使用 Context 来提供 RPC 的终止行为。\n1 2 3 4 5 6 type Group struct { cancel func() wg sync.WaitGroup errOnce sync.Once err error } 创建一个 group 和 context：\n1 2 3 4 func WithContext(ctx context.Context) (*Group, context.Context) { ctx, cancel := context.WithCancel(ctx) return \u0026Group{cancel: cancel}, ctx } 这样就返回了一个可以被提前 cancel 的 group。\n而调用的时候，并不是直接调用 go func()，而是调用 Go()，将函数作为参数传进去，用高阶函数的形式来调用，其内部才是 go func() 开启 goroutine。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (g *Group) Go(f func() error) { g.wg.Add(1) go func() { defer g.wg.Done() if err := f(); err != nil { g.errOnce.Do(func() { g.err = err if g.cancel != nil { g.cancel() } }) } }() } 当给入函数 f 返回错误，则使用 sync.Once 来 cancel context，而错误被保存于 g.err 之中，在随后的 Wait() 函数中返回。\n1 2 3 4 5 6 7 func (g *Group) Wait() error { g.wg.Wait() if g.cancel != nil { g.cancel() } return g.err } 注意：这里在 Wait() 结束后，调用了一次 cancel()。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package main func DoTwoRequestsAtOnce(ctx context.Context) error { eg, egCtx := errgroup.WithContext(ctx) var resp1, resp2 *http.Response f := func(loc string, respIn **http.Response) func() error { return func() error { reqCtx, cancel := context.WithTimeout(egCtx, time.Second) defer cancel() req, _ := http.NewRequest(\"GET\", loc, nil) var err error *respIn, err = http.DefaultClient.Do(req.WithContext(reqCtx)) if err == nil \u0026\u0026 (*respIn).StatusCode \u003e= 500 { return errors.New(\"unexpected!\") } return err } } eg.Go(f(\"\", \u0026resp1)) eg.Go(f(\"\", \u0026resp2)) return eg.Wait() } 在这个例子中，同时发起了两个 RPC 调用，当任何一个调用超时或者出错后，会终止另一个 RPC 调用。这里就是利用前面讲到的 errgroup 来实现的，应对有很多并非请求，并需要集中处理超时、出错终止其它并发任务的时候，这个 pattern 使用起来很方便。\nContext.Value - Request 范畴的值 context.Value API 的万金油（duct tape) 胶带（duct tape) 几乎可以修任何东西，从破箱子，到人的伤口，到汽车引擎，甚至到NASA登月任务中的阿波罗13号飞船（Yeah! True Story)。所以在西方文化里，胶带是个“万能”的东西。在中文里，恐怕万金油是更合适的对应词汇，从头疼、脑热，感冒发烧，到跌打损伤几乎无所不治。\n当然，治标不治本，这点东西方文化中的潜台词都是一样的。这里提及的 context.Value 对于 API 而言，就是这类性质的东西，啥都可以干，但是治标不治本。\nvalue 节点是 Context 链中的一个节点 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package context type valueCtx struct { Context key, val interface{} } func WithValue(parent Context, key, val interface{}) Context { // ... return \u0026valueCtx{parent, key, val} } func (c *valueCtx) Value(key interface{}) interface{} { if c.key == key { return c.val } return c.Context.Value(key) } 可以看到，WithValue() 实际上就是在 Context 树形结构中，增加一个节点罢了。\n约束 key 的空间 为了防止树形结构中出现重复的键，建议约束键的空间。比如使用私有类型，然后用 GetXxx() 和 WithXxxx() 来操作私有实体。\n1 2 3 4 5 6 7 8 9 10 11 type privateCtxType string var ( reqID = privateCtxType(\"req-id\") ) func GetRequestID(ctx context.Context) (int, bool) { id, exists := ctx.Value(reqID).(int) return id, exists } func WithRequestID(ctx context.Context, reqid int) context.Context { return context.WithValue(ctx, reqID, reqid) } 这里使用 WithXxx 而不是 SetXxx 也是因为 Context 实际上是 immutable 的，所以不是修改 Context 里某个值，而是产生新的 Context 带某个值。\nContext.Value 是 immutable 的 再多次的强调 Context.Value 是 immutable 的也不过分。\ncontext.Context 从设计上就是按照 immutable （不可变的）模式设计的 同样，Context.Value 也是 immutable 的 不要试图在 Context.Value 里存某个可变更的值，然后改变，期望别的 Context 可以看到这个改变 更别指望着在 Context.Value 里存可变的值，最后多个 goroutine 并发访问没竞争冒险啥的，因为自始至终，就是按照不可变来设计的 比如设置了超时，就别以为可以改变这个设置的超时值 在使用 Context.Value 的时候，一定要记住这一点 应该把什么放到 Context.Value 里？ 应该保存 Request 范畴的值 任何关于 Context 自身的都是 Request 范畴的（这俩同生共死） 从 Request 数据衍生出来，并且随着 Request 的结束而终结 什么东西不属于 Request 范畴？ 在 Request 以外建立的，并且不随着 Request 改变而变化 比如你 func main() 里建立的东西显然不属于 Request 范畴 数据库连接 如果 User ID 在连接里呢？(稍后会提及) 全局 logger 如果 logger 里需要有 User ID 呢？（稍后会提及） 那么用 Context.Value 有什么问题？ 不幸的是，好像所有东西都是由请求衍生出来的 那么我们为什么还需要函数参数？然后干脆只来一个 Context 就完了？ 1 2 3 func Add(ctx context.Context) int { return ctx.Value(\"first\").(int) + ctx.Value(\"second\").(int) } 曾经看到过一个 API，就是这种形式：\n1 2 3 4 func IsAdminUser(ctx context.Context) bool { userID := GetUser(ctx) return authSingleton.IsAdmin(userID) } 这里API实现内部从 context 中取得 UserID，然后再进行权限判断。但是从函数签名看，则完全无法理解这个函数具体需要什么、以及做什么。\n代码要以可读性为优先设计考虑。\n别人拿到一个代码，一般不是掉进函数实现细节里去一行行的读代码，而是会先浏览一下函数接口。所以清晰的函数接口设计，会更加利于别人（或者是几个月后的你自己）理解这段代码。\n一个良好的 API 设计，应该从函数签名就清晰的理解函数的逻辑。如果我们将上面的接口改为：\n1 func IsAdminUser(ctx context.Context, userID string, authenticator auth.Service) bool 我们从这个函数签名就可以清楚的知道：\n这个函数很可能可以提前被 cancel 这个函数需要 User ID 这个函数需要一个authenticator来 而且由于 authenticator 是传入参数，而不是依赖于隐式的某个东西，我们知道，测试的时候就很容易传入一个模拟认证函数来做测试 userID 是传入值，因此我们可以修改它，不用担心影响别的东西 所有这些信息，都是从函数签名得到的，而无需打开函数实现一行行去看。\n那什么可以放到 Context.Value 里去？ 现在知道 Context.Value 会让接口定义更加模糊，似乎不应该使用。那么又回到了原来的问题，到底什么可以放到 Context.Value 里去？换个角度去想，什么不是衍生于 Request？\nContext.Value 应该是告知性质的东西，而不是控制性质的东西 应该永远都不需要写进文档作为必须存在的输入数据 如果你发现你的函数在某些 Context.Value 下无法正确工作，那就说明这个 Context.Value 里的信息不应该放在里面，而应该放在接口上。因为已经让接口太模糊了。 什么东西不是控制性质的东西？ Request ID 只是给每个 RPC 调用一个 ID，而没有实际意义 这就是个数字/字符串，反正你也不会用其作为逻辑判断 一般也就是日志的时候需要记录一下 而 logger 本身不是 Request 范畴，所以 logger 不应该在 Context 里 非 Request 范畴的 logger 应该只是利用 Context 信息来修饰日志 User ID （如果仅仅是作为日志用） Incoming Request ID 什么显然是控制性质的东西？ 数据库连接 显然会非常严重的影响逻辑 因此这应该在函数参数里，明确表示出来 认证服务(Authentication) 显然不同的认证服务导致的逻辑不同 也应该放到函数参数里，明确表示出来 Context WithValue的常见使用场景 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 package main import ( \"context\" \"fmt\" \"net/http\" ) /* case1: 首先，我们创建一个空上下文并将其分配给ctx变量。 1.ctx使用其键和值创建 3 个上下文作为父值。 2.然后我们创建另一个ctx1作为父级的上下文并给它一个键和值。 3.我们将尝试从中提取价值ctx1，ctx2，ctx3用正确的密钥。它将根据键返回给我们值。 4.如果我们尝试从具有错误键的上下文中提取值，它将返回nil值。 case2: 在http上下文中插入固值(中间件的方式)，如 userID，Token等。 */ func main() { //case1() http.Handle(\"/\", middleware1(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { // After Insert Claim into Context fmt.Printf(\"%+v\\\\n\", CtxClaim(r.Context())) fmt.Fprintf(w, \"%+v\\\\n\", CtxClaim(r.Context())) }))) http.ListenAndServe(\":8080\", nil) } type Claims struct { ID int `json:\"id\"` } var contextKey = \"ctx-key\" func middleware1(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { // Example: Get UserID From Token // .... // .... fmt.Println(\"Insert Claim into Context\") newCtx := context.WithValue(r.Context(), contextKey, \u0026Claims{ ID: 1, // example User ID: 1 }) r = r.WithContext(newCtx) next.ServeHTTP(w, r) }) } func CtxClaim(ctx context.Context) *Claims { raw, _ := ctx.Value(contextKey).(*Claims) return raw } func case1() { ctx := context.Background() // Empty Context ctx1 := context.WithValue(ctx, \"key1\", \"value1\") // parent: ctx ctx2 := context.WithValue(ctx, \"key2\", \"value2\") // parent: ctx ctx3 := context.WithValue(ctx, \"key3\", \"value3\") // parent: ctx ctx4 := context.WithValue(ctx1, \"key4\", \"value4\") // parent: ctx1 fmt.Println(ctx1.Value(\"key1\")) // value1 fmt.Println(ctx2.Value(\"key2\")) // value2 fmt.Println(ctx3.Value(\"key3\")) // value3 fmt.Println(ctx4.Value(\"key4\")) // value4 fmt.Println(ctx4.Value(\"key1\")) // value1 fmt.Println(ctx3.Value(\"key1\")) // nil } 小结 个人不推荐在 context 中封装太多的东西向下传递是非常的不 “simple”，时刻记住context设计初衷从API就可以看出：1.超时控制。2.固值传递（如UserID等）。\n","wordCount":"3432","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/context%E7%9A%84%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Context 正确使用姿势（推荐）</h1><div class=post-meta>7 min&nbsp;·&nbsp;3432 words&nbsp;·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#context-%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf aria-label="Context 正确使用姿势">Context 正确使用姿势</a><ul><li><a href=#contextcontext-api aria-label="context.Context API">context.Context API</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba-context aria-label="如何创建 Context？">如何创建 Context？</a></li><li><a href=#context-%e6%94%be%e5%93%aa aria-label="Context 放哪？">Context 放哪？</a></li><li><a href=#context-%e5%8c%85%e7%9a%84%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label="Context 包的注意事项">Context 包的注意事项</a></li><li><a href=#%e7%bb%88%e6%ad%a2%e8%af%b7%e6%b1%82-request-cancellation aria-label="终止请求 (Request Cancellation)">终止请求 (Request Cancellation)</a></li><li><a href=#contextvalue---request-%e8%8c%83%e7%95%b4%e7%9a%84%e5%80%bc aria-label="Context.Value - Request 范畴的值">Context.Value - Request 范畴的值</a><ul><li><a href=#contextvalue-api-%e7%9a%84%e4%b8%87%e9%87%91%e6%b2%b9duct-tape aria-label="context.Value API 的万金油（duct tape)">context.Value API 的万金油（duct tape)</a></li><li><a href=#%e7%ba%a6%e6%9d%9f-key-%e7%9a%84%e7%a9%ba%e9%97%b4 aria-label="约束 key 的空间">约束 key 的空间</a></li><li><a href=#contextvalue-%e6%98%af-immutable-%e7%9a%84 aria-label="Context.Value 是 immutable 的">Context.Value 是 immutable 的</a></li><li><a href=#%e5%ba%94%e8%af%a5%e6%8a%8a%e4%bb%80%e4%b9%88%e6%94%be%e5%88%b0-contextvalue-%e9%87%8c aria-label="应该把什么放到 Context.Value 里？">应该把什么放到 Context.Value 里？</a></li><li><a href=#%e4%bb%80%e4%b9%88%e4%b8%9c%e8%a5%bf%e4%b8%8d%e5%b1%9e%e4%ba%8e-request-%e8%8c%83%e7%95%b4 aria-label="什么东西不属于 Request 范畴？">什么东西不属于 Request 范畴？</a></li><li><a href=#%e9%82%a3%e4%b9%88%e7%94%a8-contextvalue-%e6%9c%89%e4%bb%80%e4%b9%88%e9%97%ae%e9%a2%98 aria-label="那么用 Context.Value 有什么问题？">那么用 Context.Value 有什么问题？</a></li><li><a href=#%e9%82%a3%e4%bb%80%e4%b9%88%e5%8f%af%e4%bb%a5%e6%94%be%e5%88%b0-contextvalue-%e9%87%8c%e5%8e%bb aria-label="那什么可以放到 Context.Value 里去？">那什么可以放到 Context.Value 里去？</a></li><li><a href=#%e4%bb%80%e4%b9%88%e4%b8%9c%e8%a5%bf%e4%b8%8d%e6%98%af%e6%8e%a7%e5%88%b6%e6%80%a7%e8%b4%a8%e7%9a%84%e4%b8%9c%e8%a5%bf aria-label=什么东西不是控制性质的东西？>什么东西不是控制性质的东西？</a></li><li><a href=#%e4%bb%80%e4%b9%88%e6%98%be%e7%84%b6%e6%98%af%e6%8e%a7%e5%88%b6%e6%80%a7%e8%b4%a8%e7%9a%84%e4%b8%9c%e8%a5%bf aria-label=什么显然是控制性质的东西？>什么显然是控制性质的东西？</a></li></ul></li><li><a href=#context-withvalue%e7%9a%84%e5%b8%b8%e8%a7%81%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label="Context WithValue的常见使用场景">Context WithValue的常见使用场景</a></li><li><a href=#%e5%b0%8f%e7%bb%93 aria-label=小结>小结</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=context-正确使用姿势>Context 正确使用姿势<a hidden class=anchor aria-hidden=true href=#context-正确使用姿势>#</a></h1><blockquote><p>原文参考：https://juejin.cn/post/6844903929340231694</p></blockquote><blockquote><p>Context 是 immutable（不可变的）</p></blockquote><h2 id=contextcontext-api>context.Context API<a hidden class=anchor aria-hidden=true href=#contextcontext-api>#</a></h2><p>基本上是两类操作：</p><ul><li>3个函数用于<strong>限定什么时候你的子节点退出</strong>；</li><li>1个函数用于<strong>设置请求范畴的变量</strong></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Context <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//  啥时候退出</span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>Deadline</span>() (deadline time.Time, ok <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>Done</span>() <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>struct</span>{}
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>Err</span>() <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//  设置变量</span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>Value</span>(key <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=如何创建-context>如何创建 Context？<a hidden class=anchor aria-hidden=true href=#如何创建-context>#</a></h2><ul><li>在 RPC 开始的时候，使用 context.Background()<ul><li>有些人把在 main() 里记录一个 context.Background()，然后把这个放到服务器的某个变量里，然后请求来了后从这个变量里继承 context。这么做是<strong>不对的</strong>。直接每个请求，源自自己的 context.Background() 即可。</li></ul></li><li>如果你没有 context，却需要调用一个 context 的函数的话，用 context.TODO()</li><li>如果某步操作需要自己的超时设置的话，给它一个独立的 sub-context（如前面的例子）</li></ul><h2 id=context-放哪>Context 放哪？<a hidden class=anchor aria-hidden=true href=#context-放哪>#</a></h2><ul><li>把 Context 想象为一条河流流过你的程序</li><li>理想情况下，Context 存在于调用栈（Call Stack） 中</li><li>不要把 Context 存储到一个 struct 里<ul><li>除非你使用的是像 http.Request 中的 request 结构体的方式</li></ul></li><li>request 结构体应该以 Request 结束为生命终止</li><li>当 RPC 请求处理结束后，应该去掉对 Context 变量的引用（Unreference）</li><li>Request 结束，Context 就应该结束。</li></ul><h2 id=context-包的注意事项>Context 包的注意事项<a hidden class=anchor aria-hidden=true href=#context-包的注意事项>#</a></h2><ul><li>要养成关闭 Context 的习惯<ul><li><strong>特别是</strong> 超时的 Contexts</li></ul></li><li>如果一个 context 被 GC 而不是 cancel 了，那一般是你做错了</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>ctx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithTimeout</span>(parentCtx, time.Second <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> <span style=color:#d2a8ff;font-weight:700>cancel</span>()<span style=color:#f85149>、</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>使用 Timeout 会导致内部使用 time.AfterFunc，从而会导致 context 在计时器到时之前都不会被垃圾回收。</li><li>在建立之后，立即 defer cancel() 是一个好习惯。</li></ul><h2 id=终止请求-request-cancellation>终止请求 (Request Cancellation)<a hidden class=anchor aria-hidden=true href=#终止请求-request-cancellation>#</a></h2><p>当你不再关心接下来获取的结果的时候，有可能会 Cancel 一个 Context？</p><p>以 <a href=http://golang.org/x/sync/errgroup>golang.org/x/sync/errgroup</a> 为例，errgroup 使用 Context 来提供 RPC 的终止行为。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Group <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	cancel  <span style=color:#ff7b72>func</span>()
</span></span><span style=display:flex><span>	wg      sync.WaitGroup
</span></span><span style=display:flex><span>	errOnce sync.Once
</span></span><span style=display:flex><span>	err     <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>创建一个 group 和 context：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>WithContext</span>(ctx context.Context) (<span style=color:#ff7b72;font-weight:700>*</span>Group, context.Context) {
</span></span><span style=display:flex><span>  ctx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithCancel</span>(ctx)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>Group{cancel: cancel}, ctx
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这样就返回了一个可以被提前 cancel 的 group。</p><p>而调用的时候，并不是直接调用 go func()，而是调用 Go()，将函数作为参数传进去，用高阶函数的形式来调用，其内部才是 go func() 开启 goroutine。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (g <span style=color:#ff7b72;font-weight:700>*</span>Group) <span style=color:#d2a8ff;font-weight:700>Go</span>(f <span style=color:#ff7b72>func</span>() <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>  g.wg.<span style=color:#d2a8ff;font-weight:700>Add</span>(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> g.wg.<span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>f</span>(); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>      g.errOnce.<span style=color:#d2a8ff;font-weight:700>Do</span>(<span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>        g.err = err
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> g.cancel <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>          g.<span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>当给入函数 f 返回错误，则使用 sync.Once 来 cancel context，而错误被保存于 g.err 之中，在随后的 Wait() 函数中返回。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (g <span style=color:#ff7b72;font-weight:700>*</span>Group) <span style=color:#d2a8ff;font-weight:700>Wait</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>  g.wg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> g.cancel <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    g.<span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> g.err
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>注意：这里在 Wait() 结束后，调用了一次 cancel()。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>DoTwoRequestsAtOnce</span>(ctx context.Context) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>  eg, egCtx <span style=color:#ff7b72;font-weight:700>:=</span> errgroup.<span style=color:#d2a8ff;font-weight:700>WithContext</span>(ctx)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>var</span> resp1, resp2 <span style=color:#ff7b72;font-weight:700>*</span>http.Response
</span></span><span style=display:flex><span>  f <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>func</span>(loc <span style=color:#ff7b72>string</span>, respIn <span style=color:#ff7b72;font-weight:700>**</span>http.Response) <span style=color:#ff7b72>func</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>func</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>      reqCtx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithTimeout</span>(egCtx, time.Second)
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>defer</span> <span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>      req, _ <span style=color:#ff7b72;font-weight:700>:=</span> http.<span style=color:#d2a8ff;font-weight:700>NewRequest</span>(<span style=color:#a5d6ff>&#34;GET&#34;</span>, loc, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>var</span> err <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>      <span style=color:#ff7b72;font-weight:700>*</span>respIn, err = http.DefaultClient.<span style=color:#d2a8ff;font-weight:700>Do</span>(req.<span style=color:#d2a8ff;font-weight:700>WithContext</span>(reqCtx))
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>nil</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> (<span style=color:#ff7b72;font-weight:700>*</span>respIn).StatusCode <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#a5d6ff>500</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> errors.<span style=color:#d2a8ff;font-weight:700>New</span>(<span style=color:#a5d6ff>&#34;unexpected!&#34;</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  eg.<span style=color:#d2a8ff;font-weight:700>Go</span>(<span style=color:#d2a8ff;font-weight:700>f</span>(<span style=color:#a5d6ff>&#34;&lt;http://localhost:8080/fast_request&gt;&#34;</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>resp1))
</span></span><span style=display:flex><span>  eg.<span style=color:#d2a8ff;font-weight:700>Go</span>(<span style=color:#d2a8ff;font-weight:700>f</span>(<span style=color:#a5d6ff>&#34;&lt;http://localhost:8080/slow_request&gt;&#34;</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>resp2))
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> eg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在这个例子中，同时发起了两个 RPC 调用，当任何一个调用超时或者出错后，会终止另一个 RPC 调用。这里就是利用前面讲到的 errgroup 来实现的，应对有很多并非请求，并需要集中处理超时、出错终止其它并发任务的时候，这个 pattern 使用起来很方便。</p><h2 id=contextvalue---request-范畴的值>Context.Value - Request 范畴的值<a hidden class=anchor aria-hidden=true href=#contextvalue---request-范畴的值>#</a></h2><h3 id=contextvalue-api-的万金油duct-tape>context.Value API 的万金油（duct tape)<a hidden class=anchor aria-hidden=true href=#contextvalue-api-的万金油duct-tape>#</a></h3><p>胶带（duct tape) 几乎可以修任何东西，从破箱子，到人的伤口，到汽车引擎，甚至到NASA登月任务中的阿波罗13号飞船（Yeah! True Story)。所以在西方文化里，胶带是个“万能”的东西。在中文里，恐怕万金油是更合适的对应词汇，从头疼、脑热，感冒发烧，到跌打损伤几乎无所不治。</p><p>当然，<strong>治标不治本</strong>，这点东西方文化中的潜台词都是一样的。这里提及的 context.Value 对于 API 而言，就是这类性质的东西，啥都可以干，但是治标不治本。</p><ul><li>value 节点是 Context 链中的一个节点</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> context
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> valueCtx <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>  Context
</span></span><span style=display:flex><span>  key, val <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>WithValue</span>(parent Context, key, val <span style=color:#ff7b72>interface</span>{}) Context {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//  ...</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>valueCtx{parent, key, val}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>valueCtx) <span style=color:#d2a8ff;font-weight:700>Value</span>(key <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> c.key <span style=color:#ff7b72;font-weight:700>==</span> key {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> c.val
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> c.Context.<span style=color:#d2a8ff;font-weight:700>Value</span>(key)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到，WithValue() 实际上就是在 Context 树形结构中，增加一个节点罢了。</p><h3 id=约束-key-的空间>约束 key 的空间<a hidden class=anchor aria-hidden=true href=#约束-key-的空间>#</a></h3><p>为了防止树形结构中出现重复的键，建议约束键的空间。比如使用私有类型，然后用 GetXxx() 和 WithXxxx() 来操作私有实体。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> privateCtxType <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> (
</span></span><span style=display:flex><span>  reqID = <span style=color:#d2a8ff;font-weight:700>privateCtxType</span>(<span style=color:#a5d6ff>&#34;req-id&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>GetRequestID</span>(ctx context.Context) (<span style=color:#ff7b72>int</span>, <span style=color:#ff7b72>bool</span>) {
</span></span><span style=display:flex><span>  id, exists <span style=color:#ff7b72;font-weight:700>:=</span> ctx.<span style=color:#d2a8ff;font-weight:700>Value</span>(reqID).(<span style=color:#ff7b72>int</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> id, exists
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>WithRequestID</span>(ctx context.Context, reqid <span style=color:#ff7b72>int</span>) context.Context {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(ctx, reqID, reqid)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里使用 WithXxx 而不是 SetXxx 也是因为 Context 实际上是 immutable 的，所以不是修改 Context 里某个值，而是产生新的 Context <strong>带某个值</strong>。</p><h3 id=contextvalue-是-immutable-的>Context.Value 是 immutable 的<a hidden class=anchor aria-hidden=true href=#contextvalue-是-immutable-的>#</a></h3><p><strong>再多次的强调 Context.Value 是 immutable 的也不过分。</strong></p><ul><li>context.Context 从设计上就是按照 immutable （不可变的）模式设计的</li><li>同样，Context.Value 也是 immutable 的</li><li>不要试图在 Context.Value 里存某个可变更的值，然后改变，期望别的 Context 可以看到这个改变<ul><li>更别指望着在 Context.Value 里存可变的值，最后多个 goroutine 并发访问没竞争冒险啥的，因为自始至终，就是按照不可变来设计的</li><li>比如设置了超时，就别以为可以改变这个设置的超时值</li></ul></li><li>在使用 Context.Value 的时候，一定要记住这一点</li></ul><h3 id=应该把什么放到-contextvalue-里>应该把什么放到 Context.Value 里？<a hidden class=anchor aria-hidden=true href=#应该把什么放到-contextvalue-里>#</a></h3><ul><li>应该保存 Request 范畴的值<ul><li>任何关于 Context 自身的都是 Request 范畴的（这俩同生共死）</li><li>从 Request 数据衍生出来，并且随着 Request 的结束而终结</li></ul></li></ul><h3 id=什么东西不属于-request-范畴>什么东西不属于 Request 范畴？<a hidden class=anchor aria-hidden=true href=#什么东西不属于-request-范畴>#</a></h3><ul><li>在 Request 以外建立的，并且不随着 Request 改变而变化<ul><li>比如你 func main() 里建立的东西显然不属于 Request 范畴</li></ul></li><li>数据库连接<ul><li>如果 User ID 在连接里呢？(稍后会提及)</li></ul></li><li>全局 logger<ul><li>如果 logger 里需要有 User ID 呢？（稍后会提及）</li></ul></li></ul><h3 id=那么用-contextvalue-有什么问题>那么用 Context.Value 有什么问题？<a hidden class=anchor aria-hidden=true href=#那么用-contextvalue-有什么问题>#</a></h3><ul><li>不幸的是，好像所有东西都是由请求衍生出来的</li><li>那么我们为什么还需要函数参数？然后干脆只来一个 Context 就完了？</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>Add</span>(ctx context.Context) <span style=color:#ff7b72>int</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> ctx.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;first&#34;</span>).(<span style=color:#ff7b72>int</span>) <span style=color:#ff7b72;font-weight:700>+</span> ctx.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;second&#34;</span>).(<span style=color:#ff7b72>int</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>曾经看到过一个 API，就是这种形式：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>IsAdminUser</span>(ctx context.Context) <span style=color:#ff7b72>bool</span> {
</span></span><span style=display:flex><span>  userID <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>GetUser</span>(ctx)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> authSingleton.<span style=color:#d2a8ff;font-weight:700>IsAdmin</span>(userID)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里API实现内部从 context 中取得 UserID，然后再进行权限判断。但是从函数签名看，则完全无法理解这个函数具体需要什么、以及做什么。</p><blockquote><p>代码要以可读性为优先设计考虑。</p></blockquote><p>别人拿到一个代码，一般不是掉进函数实现细节里去一行行的读代码，而是会先浏览一下函数接口。所以清晰的函数接口设计，会更加利于别人（<strong>或者是几个月后的你自己</strong>）理解这段代码。</p><p>一个良好的 API 设计，应该从函数签名就清晰的理解函数的逻辑。如果我们将上面的接口改为：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>IsAdminUser</span>(ctx context.Context, userID <span style=color:#ff7b72>string</span>, authenticator auth.Service) <span style=color:#ff7b72>bool</span>
</span></span></code></pre></td></tr></table></div></div><p>我们从这个函数签名就可以清楚的知道：</p><ul><li>这个函数很可能可以提前被 cancel</li><li>这个函数需要 User ID</li><li>这个函数需要一个authenticator来</li><li>而且由于 authenticator 是传入参数，而不是依赖于隐式的某个东西，我们知道，测试的时候就很容易传入一个模拟认证函数来做测试</li><li>userID 是传入值，因此我们可以修改它，不用担心影响别的东西</li></ul><p>所有这些信息，都是从函数签名得到的，而无需打开函数实现一行行去看。</p><h3 id=那什么可以放到-contextvalue-里去>那什么可以放到 Context.Value 里去？<a hidden class=anchor aria-hidden=true href=#那什么可以放到-contextvalue-里去>#</a></h3><p>现在知道 Context.Value 会让接口定义更加模糊，似乎不应该使用。那么又回到了原来的问题，到底什么可以放到 Context.Value 里去？换个角度去想，什么不是衍生于 Request？</p><ul><li>Context.Value 应该是告知性质的东西，而不是控制性质的东西</li><li>应该永远都不需要写进文档作为必须存在的输入数据</li><li>如果你发现你的函数在某些 Context.Value 下无法正确工作，那就说明这个 Context.Value 里的信息不应该放在里面，而应该放在接口上。因为已经让接口太模糊了。</li></ul><h3 id=什么东西不是控制性质的东西>什么东西不是控制性质的东西？<a hidden class=anchor aria-hidden=true href=#什么东西不是控制性质的东西>#</a></h3><ul><li>Request ID<ul><li>只是给每个 RPC 调用一个 ID，而没有实际意义</li><li>这就是个数字/字符串，反正你也不会用其作为逻辑判断</li><li>一般也就是日志的时候需要记录一下<ul><li>而 logger 本身不是 Request 范畴，所以 logger 不应该在 Context 里</li><li>非 Request 范畴的 logger 应该只是利用 Context 信息来修饰日志</li></ul></li></ul></li><li>User ID （如果仅仅是作为日志用）</li><li>Incoming Request ID</li></ul><h3 id=什么显然是控制性质的东西>什么显然是控制性质的东西？<a hidden class=anchor aria-hidden=true href=#什么显然是控制性质的东西>#</a></h3><ul><li>数据库连接<ul><li>显然会非常严重的影响逻辑</li><li>因此这应该在函数参数里，明确表示出来</li></ul></li><li>认证服务(Authentication)<ul><li>显然不同的认证服务导致的逻辑不同</li><li>也应该放到函数参数里，明确表示出来</li></ul></li></ul><h2 id=context-withvalue的常见使用场景>Context WithValue的常见使用场景<a hidden class=anchor aria-hidden=true href=#context-withvalue的常见使用场景>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>case1:
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>首先，我们创建一个空上下文并将其分配给ctx变量。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>	1.ctx使用其键和值创建 3 个上下文作为父值。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>	2.然后我们创建另一个ctx1作为父级的上下文并给它一个键和值。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>	3.我们将尝试从中提取价值ctx1，ctx2，ctx3用正确的密钥。它将根据键返回给我们值。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>	4.如果我们尝试从具有错误键的上下文中提取值，它将返回nil值。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>case2:
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>	在http上下文中插入固值(中间件的方式)，如 userID，Token等。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>//case1()</span>
</span></span><span style=display:flex><span>	http.<span style=color:#d2a8ff;font-weight:700>Handle</span>(<span style=color:#a5d6ff>&#34;/&#34;</span>, <span style=color:#d2a8ff;font-weight:700>middleware1</span>(http.<span style=color:#d2a8ff;font-weight:700>HandlerFunc</span>(<span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// After Insert Claim into Context</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;%+v\\n&#34;</span>, <span style=color:#d2a8ff;font-weight:700>CtxClaim</span>(r.<span style=color:#d2a8ff;font-weight:700>Context</span>()))
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Fprintf</span>(w, <span style=color:#a5d6ff>&#34;%+v\\n&#34;</span>, <span style=color:#d2a8ff;font-weight:700>CtxClaim</span>(r.<span style=color:#d2a8ff;font-weight:700>Context</span>()))
</span></span><span style=display:flex><span>	})))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	http.<span style=color:#d2a8ff;font-weight:700>ListenAndServe</span>(<span style=color:#a5d6ff>&#34;:8080&#34;</span>, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> Claims <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	ID <span style=color:#ff7b72>int</span> <span style=color:#a5d6ff>`json:&#34;id&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> contextKey = <span style=color:#a5d6ff>&#34;ctx-key&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>middleware1</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> http.<span style=color:#d2a8ff;font-weight:700>HandlerFunc</span>(<span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// Example: Get UserID From Token</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// ....</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// ....</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;Insert Claim into Context&#34;</span>)
</span></span><span style=display:flex><span>		newCtx <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(r.<span style=color:#d2a8ff;font-weight:700>Context</span>(), contextKey, <span style=color:#ff7b72;font-weight:700>&amp;</span>Claims{
</span></span><span style=display:flex><span>			ID: <span style=color:#a5d6ff>1</span>, <span style=color:#8b949e;font-style:italic>// example User ID: 1</span>
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		r = r.<span style=color:#d2a8ff;font-weight:700>WithContext</span>(newCtx)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		next.<span style=color:#d2a8ff;font-weight:700>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CtxClaim</span>(ctx context.Context) <span style=color:#ff7b72;font-weight:700>*</span>Claims {
</span></span><span style=display:flex><span>	raw, _ <span style=color:#ff7b72;font-weight:700>:=</span> ctx.<span style=color:#d2a8ff;font-weight:700>Value</span>(contextKey).(<span style=color:#ff7b72;font-weight:700>*</span>Claims)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> raw
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>case1</span>() {
</span></span><span style=display:flex><span>	ctx <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>Background</span>() <span style=color:#8b949e;font-style:italic>// Empty Context</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ctx1 <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(ctx, <span style=color:#a5d6ff>&#34;key1&#34;</span>, <span style=color:#a5d6ff>&#34;value1&#34;</span>) <span style=color:#8b949e;font-style:italic>// parent: ctx</span>
</span></span><span style=display:flex><span>	ctx2 <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(ctx, <span style=color:#a5d6ff>&#34;key2&#34;</span>, <span style=color:#a5d6ff>&#34;value2&#34;</span>) <span style=color:#8b949e;font-style:italic>// parent: ctx</span>
</span></span><span style=display:flex><span>	ctx3 <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(ctx, <span style=color:#a5d6ff>&#34;key3&#34;</span>, <span style=color:#a5d6ff>&#34;value3&#34;</span>) <span style=color:#8b949e;font-style:italic>// parent: ctx</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ctx4 <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithValue</span>(ctx1, <span style=color:#a5d6ff>&#34;key4&#34;</span>, <span style=color:#a5d6ff>&#34;value4&#34;</span>) <span style=color:#8b949e;font-style:italic>// parent: ctx1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx1.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key1&#34;</span>)) <span style=color:#8b949e;font-style:italic>// value1</span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx2.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key2&#34;</span>)) <span style=color:#8b949e;font-style:italic>// value2</span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx3.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key3&#34;</span>)) <span style=color:#8b949e;font-style:italic>// value3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx4.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key4&#34;</span>)) <span style=color:#8b949e;font-style:italic>// value4</span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx4.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key1&#34;</span>)) <span style=color:#8b949e;font-style:italic>// value1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(ctx3.<span style=color:#d2a8ff;font-weight:700>Value</span>(<span style=color:#a5d6ff>&#34;key1&#34;</span>)) <span style=color:#8b949e;font-style:italic>// nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=小结>小结<a hidden class=anchor aria-hidden=true href=#小结>#</a></h2><p>个人不推荐在 context 中封装太多的东西向下传递是非常的不 “simple”，时刻记住context设计初衷从API就可以看出：1.超时控制。2.固值传递（如UserID等）。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.com/en/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/golang%E7%9A%84%E7%BB%84%E5%90%88%E5%92%8C%E5%B5%8C%E5%A5%97/><span class=title>« Prev</span><br><span>golang的组合和嵌套（面向接口编程）</span>
</a><a class=next href=https://luenci.com/en/posts/%E8%81%8A%E8%81%8Awire%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/><span class=title>Next »</span><br><span>聊聊 Wire 依赖注入</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on x" href="https://x.com/intent/tweet/?text=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f&amp;hashtags=Golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f&amp;title=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89&amp;summary=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f&title=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on whatsapp" href="https://api.whatsapp.com/send?text=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on telegram" href="https://telegram.me/share/url?text=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Context 正确使用姿势（推荐） on ycombinator" href="https://news.ycombinator.com/submitlink?t=Context%20%e6%ad%a3%e7%a1%ae%e4%bd%bf%e7%94%a8%e5%a7%bf%e5%8a%bf%ef%bc%88%e6%8e%a8%e8%8d%90%ef%bc%89&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fcontext%25E7%259A%2584%25E6%25AD%25A3%25E7%25A1%25AE%25E4%25BD%25BF%25E7%2594%25A8%25E5%25A7%25BF%25E5%258A%25BF%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2025 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>