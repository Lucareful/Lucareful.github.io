<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>golangå¹¶å‘ç¼–ç¨‹ | Luenci</title>
<meta name=keywords content="Golang"><meta name=description content="é¢„å¤‡çŸ¥è¯†
unsafe.Pointer

unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚

å¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ

unsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚

unsafe.Pointer å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š

ä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ
ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr

ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š

ä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢
ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚

CASæ¯”è¾ƒå¹¶äº¤æ¢&mdash;-Compare And Swap
Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯

åœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2&mldr;Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚


å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ Channelï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­

äº’æ–¥é”å®ç°æœºåˆ¶

ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚


ä¸´ç•ŒåŒº

åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚





åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚

å…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚
ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚
æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚
"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.me/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.me/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.me/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.me/images/L.png><link rel=apple-touch-icon href=https://luenci.me/L.png><link rel=mask-icon href=https://luenci.me/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.me/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="golangå¹¶å‘ç¼–ç¨‹"><meta property="og:description" content="é¢„å¤‡çŸ¥è¯†
unsafe.Pointer

unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚

å¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ

unsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚

unsafe.Pointer å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š

ä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ
ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr

ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š

ä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢
ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚

CASæ¯”è¾ƒå¹¶äº¤æ¢&mdash;-Compare And Swap
Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯

åœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2&mldr;Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚


å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ Channelï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­

äº’æ–¥é”å®ç°æœºåˆ¶

ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚


ä¸´ç•ŒåŒº

åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚





åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚

å…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚
ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚
æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚
"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.me/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(ã€ƒ'â–½'ã€ƒ)"><meta name=twitter:card content="summary"><meta name=twitter:title content="golangå¹¶å‘ç¼–ç¨‹"><meta name=twitter:description content="é¢„å¤‡çŸ¥è¯†
unsafe.Pointer

unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚

å¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ

unsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚

unsafe.Pointer å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š

ä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ
ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer
ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr

ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š

ä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢
ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚

CASæ¯”è¾ƒå¹¶äº¤æ¢&mdash;-Compare And Swap
Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯

åœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2&mldr;Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚


å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ Channelï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­

äº’æ–¥é”å®ç°æœºåˆ¶

ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚


ä¸´ç•ŒåŒº

åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚





åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚

å…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚
ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚
æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.me/en/posts/"},{"@type":"ListItem","position":2,"name":"golangå¹¶å‘ç¼–ç¨‹","item":"https://luenci.me/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golangå¹¶å‘ç¼–ç¨‹","name":"golangå¹¶å‘ç¼–ç¨‹","description":"é¢„å¤‡çŸ¥è¯† unsafe.Pointer unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚\nå¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ\nunsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚\nunsafe.Pointer å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š\nä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š\nä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢ ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚ CASæ¯”è¾ƒå¹¶äº¤æ¢\u0026mdash;-Compare And Swap Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯\nåœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2\u0026hellip;Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚ å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ Channelï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­\näº’æ–¥é”å®ç°æœºåˆ¶ ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚\nä¸´ç•ŒåŒº åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚ åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚\nå…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚ ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚ æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚ ","keywords":["Golang"],"articleBody":"é¢„å¤‡çŸ¥è¯† unsafe.Pointer unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚\nå¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ\nunsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚\nunsafe.Pointer å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š\nä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š\nä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢ ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚ CASæ¯”è¾ƒå¹¶äº¤æ¢â€”-Compare And Swap Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯\nåœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2â€¦Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚ å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ Channelï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­\näº’æ–¥é”å®ç°æœºåˆ¶ ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚\nä¸´ç•ŒåŒº åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚ åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚\nå…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚ ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚ æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚ ç®€å•çš„è®¡æ•°å™¨ä¾‹å­ Counter æ–¹æ³•ä¸€ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import( \"fmt\" \"sync\" ) func main() { var count = 0 // äº’æ–¥é”ä¿æŠ¤è®¡æ•°å™¨ var mu sync.Mutex var wg sync.WaitGroup wg.Add(10) for i := 0; i \u003c 10; i++{ go func() { defer wg.Done() // å¯¹å˜é‡ count è¿›è¡ŒåŠ æ³•æ“ä½œ // count++ ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå®ƒè‡³å°‘åŒ…å«å‡ ä¸ªæ­¥éª¤ï¼Œ // æ¯”å¦‚è¯»å–å˜é‡ count çš„å½“å‰å€¼ï¼Œ // å¯¹è¿™ä¸ªå€¼åŠ  1ï¼ŒæŠŠç»“æœå†ä¿å­˜åˆ° count ä¸­ã€‚ // å› ä¸ºä¸æ˜¯åŸå­æ“ä½œï¼Œå°±å¯èƒ½æœ‰å¹¶å‘çš„é—®é¢˜ã€‚ for i := 0; i \u003c 10000; i++{ mu.Lock() count++ mu.Unlock() } }() } // ç­‰å¾… 10 ä¸ª goroutine å®Œæˆ wg.Wait() fmt.Println(\"ç»“æœä¸º\", count) } æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 type Counter struct{ id int name string mu sync.Mutex count uint } func(c *Counter)Inc() { c.mu.Lock() c.count++ c.mu.Unlock() } func(c *Counter)Count()uint{ c.mu.Lock() defer c.mu.Unlock() return c.count } func main2() { var counter Counter var wg sync.WaitGroup wg.Add(10) for i := 0; i \u003c 10; i++{ go func() { defer wg.Done() for i := 0; i \u003c 10000; i++{ counter.Inc()// å—åˆ° mutex ä¿æŠ¤çš„æ–¹æ³• } }() } wg.Wait() fmt.Println(\"ç»“æœä¸º\", counter.count) } ç­‰å¾…çš„goroutineä»¬æ˜¯ä»¥FIFOæ’é˜Ÿçš„\n1ï¼‰å½“Mutexå¤„äºæ­£å¸¸æ¨¡å¼æ—¶ï¼Œè‹¥æ­¤æ—¶æ²¡æœ‰æ–°goroutineä¸é˜Ÿå¤´goroutineç«äº‰ï¼Œåˆ™é˜Ÿå¤´goroutineè·å¾—ã€‚è‹¥æœ‰æ–°goroutineç«äº‰å¤§æ¦‚ç‡æ–°goroutineè·å¾—ã€‚\n2ï¼‰å½“é˜Ÿå¤´goroutineç«äº‰é”å¤±è´¥1msåï¼Œå®ƒä¼šå°†Mutexè°ƒæ•´ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚è¿›å…¥é¥¥é¥¿æ¨¡å¼åï¼Œé”çš„æ‰€æœ‰æƒä¼šç›´æ¥ä»è§£é”goroutineç§»äº¤ç»™é˜Ÿå¤´goroutineï¼Œæ­¤æ—¶æ–°æ¥çš„goroutineç›´æ¥æ”¾å…¥é˜Ÿå°¾ã€‚\n3ï¼‰å½“ä¸€ä¸ªgoroutineè·å–é”åï¼Œå¦‚æœå‘ç°è‡ªå·±æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ª\nå®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ª å®ƒç­‰å¾…é”çš„æ—¶é—´å°‘äº1ms å°†é”åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼\nmutex æ³¨æ„ç‚¹ Unlock æ–¹æ³•å¯ä»¥è¢«ä»»æ„çš„ goroutine è°ƒç”¨é‡Šæ”¾é”ï¼Œå³ä½¿æ˜¯æ²¡æŒæœ‰è¿™ä¸ªäº’æ–¥é”çš„ goroutineï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè¿™ä¸ªæ“ä½œã€‚è¿™æ˜¯å› ä¸ºï¼ŒMutex æœ¬èº«å¹¶æ²¡æœ‰åŒ…å«æŒæœ‰è¿™æŠŠé”çš„ goroutine çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ï¼ŒUnlock ä¹Ÿä¸ä¼šå¯¹æ­¤è¿›è¡Œæ£€æŸ¥ã€‚Mutex çš„è¿™ä¸ªè®¾è®¡ä¸€ç›´ä¿æŒè‡³ä»Šã€‚ Mutexå¸¸è§é”™è¯¯ Mutex å¸¸è§çš„é”™è¯¯åœºæ™¯æœ‰ 4 ç±»ï¼Œåˆ†åˆ«æ˜¯ Lock/Unlock ä¸æ˜¯æˆå¯¹å‡ºç°ã€Copy å·²ä½¿ç”¨çš„ Mutexã€é‡å…¥å’Œæ­»é”ã€‚\nå¯é‡å…¥çš„æ¦‚å¿µ\nå½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ‹¥æœ‰è¿™ä¸ªé”ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªçº¿ç¨‹å°±æˆåŠŸè·å–åˆ°è¿™ä¸ªé”ã€‚ä¹‹åï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹å†è¯·æ±‚è¿™ä¸ªé”ï¼Œå°±ä¼šå¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‹¥æœ‰è¿™æŠŠé”çš„çº¿ç¨‹å†è¯·æ±‚è¿™æŠŠé”çš„è¯ï¼Œä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯æˆåŠŸè¿”å›ï¼Œæ‰€ä»¥å«å¯é‡å…¥é”ï¼ˆæœ‰æ—¶å€™ä¹Ÿå«åšé€’å½’é”ï¼‰ã€‚åªè¦ä½ æ‹¥æœ‰è¿™æŠŠé”ï¼Œä½ å¯ä»¥å¯ç€åŠ²å„¿åœ°è°ƒç”¨ï¼Œæ¯”å¦‚é€šè¿‡é€’å½’å®ç°ä¸€äº›ç®—æ³•ï¼Œè°ƒç”¨è€…ä¸ä¼šé˜»å¡æˆ–è€…æ­»é”ã€‚ æ­»é”\nä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼Œgoroutineï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºå…±äº«èµ„æºè€Œå¤„äºä¸€ç§äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰å¤–éƒ¨å¹²æ¶‰ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚ é¿å…æ­»é”ï¼Œåªè¦ç ´åè¿™å››ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å‡ ä¸ªï¼Œå°±å¯ä»¥äº†ã€‚\näº’æ–¥ï¼š è‡³å°‘ä¸€ä¸ªèµ„æºæ˜¯è¢«æ’ä»–æ€§ç‹¬äº«çš„ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°èµ„æºè¢«é‡Šæ”¾ã€‚ æŒæœ‰å’Œç­‰å¾…ï¼šgoroutine æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”è¿˜åœ¨è¯·æ±‚å…¶å®ƒ goroutine æŒæœ‰çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å¸¸è¯´çš„â€œåƒç€ç¢—é‡Œï¼Œçœ‹ç€é”…é‡Œâ€çš„æ„æ€ã€‚ ä¸å¯å‰¥å¤ºï¼šèµ„æºåªèƒ½ç”±æŒæœ‰å®ƒçš„ goroutine æ¥é‡Šæ”¾ã€‚ ç¯è·¯ç­‰å¾…ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå­˜åœ¨ä¸€ç»„ç­‰å¾…è¿›ç¨‹ï¼ŒP={P1ï¼ŒP2ï¼Œâ€¦ï¼ŒPN}ï¼ŒP1 ç­‰å¾… P2 æŒæœ‰çš„èµ„æºï¼ŒP2 ç­‰å¾… P3 æŒæœ‰çš„èµ„æºï¼Œä¾æ­¤ç±»æ¨ï¼Œæœ€åæ˜¯ PN ç­‰å¾… P1 æŒæœ‰çš„èµ„æºï¼Œè¿™å°±å½¢æˆäº†ä¸€ä¸ªç¯è·¯ç­‰å¾…çš„æ­»ç»“ã€‚ Mutexå°ç»“ RWMutex â€” è¯»å†™é” æ ‡å‡†åº“ä¸­çš„ RWMutex æ˜¯ä¸€ä¸ª reader/writer äº’æ–¥é”ã€‚RWMutexåœ¨æŸä¸€æ—¶åˆ»åªèƒ½ç”±ä»»æ„æ•°é‡çš„ reader æŒæœ‰ï¼Œæˆ–è€…æ˜¯åªè¢«å•ä¸ªçš„ writer æŒæœ‰ã€‚RWMutex çš„æ–¹æ³•ä¹Ÿå¾ˆå°‘ï¼Œæ€»å…±æœ‰ 5 ä¸ªã€‚\nLock/Unlockï¼šå†™æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•ã€‚å¦‚æœé”å·²ç»è¢« reader æˆ–è€… writer æŒæœ‰ï¼Œé‚£ä¹ˆï¼ŒLock æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼›Unlock åˆ™æ˜¯é…å¯¹çš„é‡Šæ”¾é”çš„æ–¹æ³•ã€‚\nRLock/RUnlockï¼šè¯»æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•ã€‚å¦‚æœé”å·²ç»è¢« writer æŒæœ‰çš„è¯ï¼ŒRLock æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼Œå¦åˆ™å°±ç›´æ¥è¿”å›ï¼›è€Œ RUnlock æ˜¯ reader é‡Šæ”¾é”çš„æ–¹æ³•ã€‚\nRLockerï¼šè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä¸ºè¯»æ“ä½œè¿”å›ä¸€ä¸ª Locker æ¥å£çš„å¯¹è±¡ã€‚å®ƒçš„ Lock æ–¹æ³•ä¼šè°ƒç”¨ RWMutex çš„ RLock æ–¹æ³•ï¼Œå®ƒçš„ Unlock æ–¹æ³•ä¼šè°ƒç”¨ RWMutex çš„ RUnlock æ–¹æ³•ã€‚\nRWMutex çš„é›¶å€¼æ˜¯æœªåŠ é”çš„çŠ¶æ€ï¼Œæ‰€ä»¥ï¼Œå½“ä½ ä½¿ç”¨ RWMutex çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å£°æ˜å˜é‡ï¼Œè¿˜æ˜¯åµŒå…¥åˆ°å…¶å®ƒ struct ä¸­ï¼Œéƒ½ä¸å¿…æ˜¾å¼åœ°åˆå§‹åŒ–ã€‚\nå¦‚æœä½ é‡åˆ°å¯ä»¥æ˜ç¡®åŒºåˆ† reader å’Œ writer goroutine çš„åœºæ™¯ï¼Œä¸”æœ‰å¤§é‡çš„å¹¶å‘è¯»ã€å°‘é‡çš„å¹¶å‘å†™ï¼Œå¹¶ä¸”æœ‰å¼ºçƒˆçš„æ€§èƒ½éœ€æ±‚ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¯»å†™é” RWMutex æ›¿æ¢ Mutexã€‚\nRWMutex çš„å®ç°åŸç† RWMutex æ˜¯å¾ˆå¸¸è§çš„å¹¶å‘åŸè¯­ï¼Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„åº“éƒ½æä¾›äº†ç±»ä¼¼çš„å¹¶å‘ç±»å‹ã€‚RWMutex ä¸€èˆ¬éƒ½æ˜¯åŸºäºäº’æ–¥é”ã€æ¡ä»¶å˜é‡ï¼ˆcondition variablesï¼‰æˆ–è€…ä¿¡å·é‡ï¼ˆsemaphoresï¼‰ç­‰å¹¶å‘åŸè¯­æ¥å®ç°ã€‚Go æ ‡å‡†åº“ä¸­çš„ RWMutex æ˜¯åŸºäº Mutex å®ç°çš„ã€‚\nreaders-writers é—®é¢˜ä¸€èˆ¬æœ‰ä¸‰ç±»ï¼ŒåŸºäºå¯¹è¯»å’Œå†™æ“ä½œçš„ä¼˜å…ˆçº§ï¼Œè¯»å†™é”çš„è®¾è®¡å’Œå®ç°ä¹Ÿåˆ†æˆä¸‰ç±»ã€‚Read-preferringï¼šè¯»ä¼˜å…ˆçš„è®¾è®¡å¯ä»¥æä¾›å¾ˆé«˜çš„å¹¶å‘æ€§ï¼Œä½†æ˜¯ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´å†™é¥¥é¥¿ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæœ‰å¤§é‡çš„è¯»ï¼Œè¿™ç§è®¾è®¡ä¼šå¯¼è‡´åªæœ‰æ‰€æœ‰çš„è¯»éƒ½é‡Šæ”¾äº†é”ä¹‹åï¼Œå†™æ‰å¯èƒ½è·å–åˆ°é”ã€‚ Write-preferringï¼šå†™ä¼˜å…ˆçš„è®¾è®¡æ„å‘³ç€ï¼Œå¦‚æœå·²ç»æœ‰ä¸€ä¸ª writer åœ¨ç­‰å¾…è¯·æ±‚é”çš„è¯ï¼Œå®ƒä¼šé˜»æ­¢æ–°æ¥çš„è¯·æ±‚é”çš„ reader è·å–åˆ°é”ï¼Œæ‰€ä»¥ä¼˜å…ˆä¿éšœ writerã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ä¸€äº› reader å·²ç»è¯·æ±‚äº†é”çš„è¯ï¼Œæ–°è¯·æ±‚çš„ writer ä¹Ÿä¼šç­‰å¾…å·²ç»å­˜åœ¨çš„ reader éƒ½é‡Šæ”¾é”ä¹‹åæ‰èƒ½è·å–ã€‚æ‰€ä»¥ï¼Œå†™ä¼˜å…ˆçº§è®¾è®¡ä¸­çš„ä¼˜å…ˆæƒæ˜¯é’ˆå¯¹æ–°æ¥çš„è¯·æ±‚è€Œè¨€çš„ã€‚è¿™ç§è®¾è®¡ä¸»è¦é¿å…äº† writer çš„é¥¥é¥¿é—®é¢˜ã€‚ ä¸æŒ‡å®šä¼˜å…ˆçº§ï¼šè¿™ç§è®¾è®¡æ¯”è¾ƒç®€å•ï¼Œä¸åŒºåˆ† reader å’Œ writer ä¼˜å…ˆçº§ï¼ŒæŸäº›åœºæ™¯ä¸‹è¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¾è®¡åè€Œæ›´æœ‰æ•ˆï¼Œå› ä¸ºç¬¬ä¸€ç±»ä¼˜å…ˆçº§ä¼šå¯¼è‡´å†™é¥¥é¥¿ï¼Œç¬¬äºŒç±»ä¼˜å…ˆçº§å¯èƒ½ä¼šå¯¼è‡´è¯»é¥¥é¥¿ï¼Œè¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¿é—®ä¸å†åŒºåˆ†è¯»å†™ï¼Œå¤§å®¶éƒ½æ˜¯åŒä¸€ä¸ªä¼˜å…ˆçº§ï¼Œè§£å†³äº†é¥¥é¥¿çš„é—®é¢˜ã€‚ Go æ ‡å‡†åº“ä¸­çš„ RWMutex è®¾è®¡æ˜¯ Write-preferring æ–¹æ¡ˆã€‚ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„ Lock è°ƒç”¨ä¼šæ’é™¤æ–°çš„ reader è¯·æ±‚åˆ°é”ã€‚\nRWMutexçš„é” RWMutex æ˜¯â¼€ä¸ªå¤š writer å¤š reader çš„è¯»å†™é”ï¼Œæ‰€ä»¥åŒæ—¶å¯èƒ½æœ‰å¤šä¸ª writer å’Œ readerã€‚é‚£ ä¹ˆï¼Œä¸ºäº†é¿å… writer ä¹‹é—´çš„ç«äº‰ï¼ŒRWMutex å°±ä¼šä½¿ç”¨â¼€ä¸ª Mutex æ¥ä¿è¯ writer çš„äº’æ–¥ã€‚\nåœ¨ Lock æ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆè·å–å†…éƒ¨äº’æ–¥é”ï¼Œæ‰ä¼šä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼› åœ¨ Unlock æ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼Œæ‰ä¼šé‡Šæ”¾å†…éƒ¨äº’æ–¥é”ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å­—æ®µçš„ä¿®æ”¹ä¹Ÿå—åˆ°äº’æ–¥é”çš„ä¿æŠ¤ã€‚ ä½¿ç”¨è¯»å†™é”æœ€éœ€è¦æ³¨æ„çš„â¼€ç‚¹å°±æ˜¯å°½é‡é¿å…é‡å…¥ï¼Œé‡å…¥å¸¦æ¥çš„æ­»é”â¾®å¸¸éšè”½ï¼Œâ½½ä¸”éš¾ä»¥ è¯Šæ–­ã€‚\nWaitGroupï¼šååŒç­‰å¾…ï¼Œä»»åŠ¡ç¼–æ’åˆ©å™¨ WaitGroupåŸºæœ¬ç”¨æ³• 1 2 3 func (wg *WaitGroup) Add(delta int) func (wg *WaitGroup) Done() func (wg *WaitGroup) Wait() Addï¼Œç”¨æ¥è®¾ç½® WaitGroup çš„è®¡æ•°å€¼ï¼› Doneï¼Œç”¨æ¥å°† WaitGroup çš„è®¡æ•°å€¼å‡ 1ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† Add(-1)ï¼› Waitï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ goroutine ä¼šâ¼€ç›´é˜»å¡ï¼Œç›´åˆ° WaitGroup çš„è®¡æ•°å€¼å˜ä¸º 0ã€‚ WaitGroupæ•°æ®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type WaitGroup struct { // é¿å…å¤åˆ¶ä½¿ç”¨çš„â¼€ä¸ªæŠ€å·§ï¼Œå¯ä»¥å‘Šè¯‰vetâ¼¯å…·è¿åäº†å¤åˆ¶ä½¿ç”¨çš„è§„åˆ™ noCopy noCopy // 64bit(8bytes)çš„å€¼åˆ†æˆä¸¤æ®µï¼Œâ¾¼32bitæ˜¯è®¡æ•°å€¼ï¼Œä½32bitæ˜¯waiterçš„è®¡æ•° // å¦å¤–32bitæ˜¯ç”¨ä½œä¿¡å·é‡çš„ // å› ä¸º64bitå€¼çš„åŸå­æ“ä½œéœ€è¦64bitå¯¹â»¬ï¼Œä½†æ˜¯32bitç¼–è¯‘å™¨ä¸â½€æŒï¼Œæ‰€ä»¥æ•°ç»„ä¸­çš„å…ƒç´ åœ¨ä¸åŒçš„æ¶æ„ // æ€»ä¹‹ï¼Œä¼šæ‰¾åˆ°å¯¹â»¬çš„é‚£64bitä½œä¸ºstateï¼Œå…¶ä½™çš„32bitåšä¿¡å·é‡ state1 [3]uint32 } // å¾—åˆ°stateçš„åœ°å€å’Œä¿¡å·é‡çš„åœ°å€ func (wg *WaitGroup) state() (statep *uint64, semap *uint32) { if uintptr(unsafe.Pointer(\u0026wg.state1))%8 == 0 { // å¦‚æœåœ°å€æ˜¯64bitå¯¹â»¬çš„ï¼Œæ•°ç»„å‰ä¸¤ä¸ªå…ƒç´ åšstateï¼Œåâ¼€ä¸ªå…ƒç´ åšä¿¡å·é‡ return (*uint64)(unsafe.Pointer(\u0026wg.state1)), \u0026wg.state1[2] } else { // å¦‚æœåœ°å€æ˜¯32bitå¯¹â»¬çš„ï¼Œæ•°ç»„åä¸¤ä¸ªå…ƒç´ ç”¨æ¥åšstateï¼Œå®ƒå¯ä»¥ç”¨æ¥åš64bitçš„åŸå­æ“ä½œï¼Œç¬¬ return (*uint64)(unsafe.Pointer(\u0026wg.state1[1])), \u0026wg.state1[0] } } WaitGroup æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚åªè¦ WaitGroup çš„è®¡æ•°å€¼æ¢å¤åˆ°é›¶å€¼çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«çœ‹ä½œæ˜¯æ–°åˆ›å»ºçš„ WaitGroupï¼Œè¢«é‡å¤ä½¿ç”¨\nå°ç»“ ä¸é‡ç”¨ WaitGroupã€‚æ–°å»ºâ¼€ä¸ª WaitGroup ä¸ä¼šå¸¦æ¥å¤šâ¼¤çš„èµ„æºå¼€é”€ï¼Œé‡ç”¨åâ½½æ›´å®¹æ˜“å‡º é”™ã€‚ ä¿è¯æ‰€æœ‰çš„ Add æ–¹æ³•è°ƒç”¨éƒ½åœ¨ Wait ä¹‹å‰ã€‚ ä¸ä¼ é€’è´Ÿæ•°ç»™ Add æ–¹æ³•ï¼Œåªé€šè¿‡ Done æ¥ç»™è®¡æ•°å€¼å‡ 1ã€‚ ä¸åšå¤šä½™çš„ Done æ–¹æ³•è°ƒç”¨ï¼Œä¿è¯ Add çš„è®¡æ•°å€¼å’Œ Done æ–¹æ³•è°ƒç”¨çš„æ•°é‡æ˜¯â¼€æ ·çš„ã€‚ ä¸é—æ¼ Done æ–¹æ³•çš„è°ƒç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ Wait hang ä½â½†æ³•è¿”å›ã€‚ Cond Go æ ‡å‡†åº“æä¾› Cond åŸè¯­çš„ç›®çš„æ˜¯ï¼Œä¸ºç­‰å¾… / é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›â½€æŒã€‚\nCond çš„åŸºæœ¬ç”¨æ³• 1 2 3 4 5 type Cond func NeWCond(l Locker) *Cond func (c *Cond) Broadcast() func (c *Cond) Signal() func (c *Cond) Wait() â¾¸å…ˆï¼ŒCond å…³è”çš„ Locker å®ä¾‹å¯ä»¥é€šè¿‡ c.L è®¿é—®ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ç€â¼€ä¸ªå…ˆå…¥å…ˆå‡ºçš„ç­‰å¾…é˜Ÿ åˆ—ã€‚ Signal æ–¹æ³•ï¼Œå…è®¸è°ƒç”¨è€… Caller å”¤é†’â¼€ä¸ªç­‰å¾…æ­¤ Cond çš„ goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„goroutineï¼Œæ˜¾ç„¶â½†éœ€é€šçŸ¥ waiterï¼›å¦‚æœ Cond ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰â¼€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™éœ€è¦ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç¬¬â¼€ä¸ª goroutine å¹¶æŠŠå®ƒå”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œâ½å¦‚ Java è¯­â¾”ä¸­ï¼ŒSignal æ–¹æ³•ä¹Ÿè¢«å«åš notify æ–¹æ³•ã€‚ è°ƒç”¨ Signal æ–¹æ³•æ—¶ï¼Œä¸å¼ºæ±‚ä½ â¼€å®šè¦æŒæœ‰ c.L çš„é”ã€‚ Broadcast æ–¹æ³•ï¼Œå…è®¸è°ƒç”¨è€… Caller å”¤é†’æ‰€æœ‰ç­‰å¾…æ­¤ Cond çš„ goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„ goroutineï¼Œæ˜¾ç„¶â½†éœ€é€šçŸ¥ waiterï¼›å¦‚æœ Cond ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰â¼€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™æ¸…ç©ºæ‰€æœ‰ç­‰å¾…çš„ goroutineï¼Œå¹¶å…¨éƒ¨å”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­â¾”ä¸­ï¼Œâ½å¦‚ Java è¯­â¾”ä¸­ï¼ŒBroadcast æ–¹æ³•ä¹Ÿè¢«å«åš notifyAll æ–¹æ³•ã€‚ åŒæ ·åœ°ï¼Œè°ƒç”¨ Broadcast æ–¹æ³•æ—¶ï¼Œä¹Ÿä¸å¼ºæ±‚ä½ â¼€å®šæŒæœ‰ c.L çš„é”ã€‚ Wait æ–¹æ³•ï¼Œä¼šæŠŠè°ƒç”¨è€… Caller æ”¾å…¥ Cond çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶é˜»å¡ï¼Œç›´åˆ°è¢« Signal æˆ–è€…Broadcast çš„æ–¹æ³•ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶å”¤é†’ã€‚ è°ƒç”¨ Wait æ–¹æ³•æ—¶å¿…é¡»è¦æŒæœ‰ c.L çš„é”ã€‚ æ¡ˆä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package main import ( \"log\" \"math/rand\" \"sync\" \"time\" ) func main() { c := sync.NewCond(\u0026sync.Mutex{}) var ready int for i := 0; i \u003c10 ; i++ { go func(i int) { time.Sleep(time.Duration(rand.Int63n(10)) * time.Second) // åŠ é”æ›´æ”¹ç­‰å¾…æ¡ä»¶ c.L.Lock() ready++ c.L.Unlock() log.Printf(\"è¿åŠ¨å‘˜#%d å‡†å¤‡å°±ç»ª\\\\n\", i) // å¹¿æ’­å”¤é†’æ‰€æœ‰çš„ç­‰å¾…ç€ c.Broadcast() }(i) } c.L.Lock() for ready!= 10{ c.Wait() log.Printf(\"è£åˆ¤å‘˜è¢«å”¤é†’ä¸€æ¬¡\") } c.L.Unlock() // æ‰€æœ‰è¿åŠ¨å‘˜æ˜¯å¦å‡†å¤‡å°±ç»ª log.Println(\"æ‰€æœ‰è¿åŠ¨å‘˜å‡†å¤‡å°±ç»ªï¼Œæ¯”èµ›å¼€å§‹ï¼\") } å°ç»“ Cond æ˜¯ä¸ºç­‰å¾… / é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›â½€æŒçš„ã€‚å®ƒæä¾›äº†æ¡ä»¶å˜é‡çš„ä¸‰ä¸ªåŸºæœ¬æ–¹æ³•Signalã€Broadcast å’Œ Waitï¼Œä¸ºå¹¶å‘çš„ goroutine æä¾›ç­‰å¾… / é€šçŸ¥æœºåˆ¶ã€‚ ä½¿ç”¨ Cond ä¹‹æ‰€ä»¥å®¹æ˜“å‡ºé”™ï¼Œå°±æ˜¯ Wait è°ƒç”¨éœ€è¦åŠ é”ï¼Œä»¥åŠè¢«å”¤é†’åâ¼€å®šè¦æ£€æŸ¥æ¡ä»¶æ˜¯å¦çœŸ çš„å·²ç»æ»¡â¾œã€‚ä½ éœ€è¦ç‰¢è®°è¿™ä¸¤ç‚¹ã€‚ WaitGroupå’Œ Cond çš„åŒºåˆ«ï¼šWaitGroup æ˜¯ä¸» goroutine ç­‰å¾…ç¡®å®šæ•°é‡çš„å­ goroutine å®Œæˆä»»åŠ¡ï¼›â½½ Cond æ˜¯ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡â¾œï¼Œè¿™ä¸ªæ¡ä»¶çš„ä¿®æ”¹å¯ä»¥è¢«ä»»æ„å¤šçš„ goroutine æ›´æ–°ï¼Œâ½½ä¸” Condçš„ Wait ä¸å…³â¼¼ä¹Ÿä¸çŸ¥é“å…¶ä»– goroutine çš„æ•°é‡ï¼Œåªå…³â¼¼ç­‰å¾…æ¡ä»¶ã€‚â½½ä¸” Cond è¿˜æœ‰å•ä¸ªé€šçŸ¥çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ Signal æ–¹æ³•ã€‚ Once Onceå¯ä»¥ç”¨æ¥æ‰§è¡Œä¸”ä»…ä»…æ‰§è¡Œâ¼€æ¬¡åŠ¨ä½œï¼Œå¸¸å¸¸ç”¨äºå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–åœºæ™¯ã€‚\nä½¿ç”¨åœºæ™¯ sync.Once åªæš´éœ²äº†â¼€ä¸ªæ–¹æ³• Doï¼Œä½ å¯ä»¥å¤šæ¬¡è°ƒç”¨ Do æ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ç¬¬â¼€æ¬¡è°ƒç”¨ Do æ–¹æ³• æ—¶ f å‚æ•°æ‰ä¼šæ‰§è¡Œï¼Œè¿™â¾¥çš„ f æ˜¯â¼€ä¸ªâ½†å‚æ•°â½†è¿”å›å€¼çš„å‡½æ•°ã€‚\n1 func (o *Once) Do(f func()) Once å¸¸å¸¸ç”¨æ¥åˆå§‹åŒ–å•ä¾‹èµ„æºï¼Œæˆ–è€…å¹¶å‘è®¿é—®åªéœ€åˆå§‹åŒ–â¼€æ¬¡çš„å…±äº«èµ„æºï¼Œæˆ–è€…åœ¨æµ‹è¯•çš„æ—¶å€™åˆå§‹åŒ–â¼€æ¬¡æµ‹è¯•èµ„æºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package main import ( \"fmt\" \"sync\" ) func main() { var once sync.Once f1:=func(){ fmt.Println(\"f1 exceï¼\") } once.Do(f1) f2 := func() { fmt.Println(\"f2 exce\") } once.Do(f2) } å°ç»“ â¼€æ—¦ä½ é‡åˆ°åªéœ€è¦åˆå§‹åŒ–â¼€æ¬¡çš„åœºæ™¯ï¼Œâ¾¸å…ˆæƒ³åˆ°çš„å°±åº”è¯¥æ˜¯ Once å¹¶å‘åŸè¯­ã€‚\nPool Go æ ‡å‡†åº“ä¸­æä¾›äº†â¼€ä¸ªé€šç”¨çš„ Pool æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ sync.Poolï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒå¯ä»¥åˆ›å»ºæ± åŒ–çš„å¯¹è±¡ã€‚ä½†æ˜¯å®ƒæ± åŒ–çš„å¯¹è±¡å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚\nsync.Pool æ•°æ®ç±»å‹ç”¨æ¥ä¿å­˜â¼€ç»„å¯ç‹¬ç«‹è®¿é—®çš„ä¸´æ—¶å¯¹è±¡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ± åŒ–çš„å¯¹è±¡ä¼šåœ¨æœªæ¥çš„æŸä¸ªæ—¶å€™è¢«æ¯«æ— é¢„å…†åœ°ç§»é™¤æ‰ã€‚è€Œä¸”ï¼Œå¦‚æœæ²¡æœ‰åˆ«çš„å¯¹è±¡å¼•ç”¨è¿™ä¸ªè¢«ç§»é™¤çš„å¯¹è±¡çš„è¯ï¼Œè¿™ä¸ªè¢«ç§»é™¤çš„å¯¹è±¡å°±ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚ æ³¨æ„ç‚¹ sync.Pool æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ª goroutine å¯ä»¥å¹¶å‘åœ°è°ƒç”¨å®ƒçš„æ–¹æ³•å­˜å–å¯¹è±¡ï¼› sync.Pool ä¸å¯åœ¨ä½¿ç”¨ä¹‹åå†å¤åˆ¶ä½¿ç”¨ã€‚ æ–¹æ³•ä»‹ç» 1.New\nPool struct åŒ…å«â¼€ä¸ª New å­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯å‡½æ•° func() interface{}ã€‚å½“è°ƒç”¨ Pool çš„ Get æ–¹æ³•ä»æ± ä¸­è·å–å…ƒç´ ï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²å…ƒç´ å¯è¿”å›æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ª New æ–¹æ³•æ¥åˆ›å»ºæ–° çš„å…ƒç´ ã€‚å¦‚æœä½ æ²¡æœ‰è®¾ç½® New å­—æ®µï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²å…ƒç´ å¯è¿”å›æ—¶ï¼ŒGet æ–¹æ³•å°†è¿”å› nilï¼Œè¡¨ æ˜å½“å‰æ²¡æœ‰å¯ç”¨çš„å…ƒç´ ã€‚ æœ‰è¶£çš„æ˜¯ï¼ŒNew æ˜¯å¯å˜çš„å­—æ®µã€‚è¿™å°±æ„å‘³ç€ï¼Œä½ å¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æ”¹å˜åˆ›å»ºå…ƒç´ çš„æ–¹ æ³•ã€‚å½“ç„¶ï¼Œå¾ˆå°‘æœ‰â¼ˆä¼šè¿™ä¹ˆåšï¼Œå› ä¸ºâ¼€èˆ¬æˆ‘ä»¬åˆ›å»ºå…ƒç´ çš„é€»è¾‘éƒ½æ˜¯â¼€è‡´çš„ï¼Œè¦åˆ›å»ºçš„ä¹Ÿæ˜¯åŒâ¼€ ç±»çš„å…ƒç´ ï¼Œæ‰€ä»¥ä½ åœ¨ä½¿ç”¨ Pool çš„æ—¶å€™ä¹Ÿæ²¡å¿…è¦ç©â¼€äº›â€œèŠ±æ´»â€ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶æ›´æ”¹ New çš„ å€¼ã€‚ 2.Get\nå¦‚æœè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°±ä¼šä» Poolå–â¾›â¼€ä¸ªå…ƒç´ ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ä¸ªå…ƒç´ ä¼šä» Pool ä¸­ç§»é™¤ï¼Œ è¿”å›ç»™è°ƒç”¨è€…ã€‚ä¸è¿‡ï¼Œé™¤äº†è¿”å›å€¼æ˜¯æ­£å¸¸å®ä¾‹åŒ–çš„å…ƒç´ ï¼ŒGet æ–¹æ³•çš„è¿”å›å€¼è¿˜å¯èƒ½ä¼šæ˜¯â¼€ä¸ª nilï¼ˆPool.New å­—æ®µæ²¡æœ‰è®¾ç½®ï¼Œâ¼œæ²¡æœ‰ç©ºé—²å…ƒç´ å¯ä»¥è¿”å›ï¼‰ï¼Œæ‰€ä»¥ä½ åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦ åˆ¤æ–­ã€‚ 3.Put\nè¿™ä¸ªæ–¹æ³•ç”¨äºå°†â¼€ä¸ªå…ƒç´ è¿”è¿˜ç»™ Poolï¼ŒPool ä¼šæŠŠè¿™ä¸ªå…ƒç´ ä¿å­˜åˆ°æ± ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å¤ç”¨ã€‚ä½†å¦‚ æœ Put â¼€ä¸ª nil å€¼ï¼ŒPool å°±ä¼šå¿½ç•¥è¿™ä¸ªå€¼ã€‚ æ¨èçš„ä¸‰æ–¹pool gammazero/workerpoolï¼šgammazero/workerpool å¯ä»¥â½†é™åˆ¶åœ°æäº¤ä»»åŠ¡ï¼Œæä¾›äº†æ›´ä¾¿åˆ©çš„ Submit å’Œ SubmitWait æ–¹æ³•æäº¤ä»»åŠ¡ï¼Œè¿˜å¯ä»¥æä¾›å½“å‰çš„ worker æ•°å’Œä»»åŠ¡æ•°ä»¥åŠå…³é—­ Pool çš„åŠŸèƒ½ã€‚ ivpusic/grpoolï¼šgrpool åˆ›å»º Pool çš„æ—¶å€™éœ€è¦æä¾› Worker çš„æ•°é‡å’Œç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„ æœ€â¼¤æ•°é‡ï¼Œä»»åŠ¡çš„æäº¤æ˜¯ç›´æ¥å¾€ Channel æ”¾å…¥ä»»åŠ¡ã€‚ dpaks/goworkersï¼šdpaks/goworkers æä¾›äº†æ›´ä¾¿åˆ©çš„ Submit æ–¹æ³•æäº¤ä»»åŠ¡ä»¥åŠWorker æ•°ã€ä»»åŠ¡æ•°ç­‰æŸ¥è¯¢æ–¹æ³•ã€å…³é—­ Pool çš„æ–¹æ³•ã€‚å®ƒçš„ä»»åŠ¡çš„æ‰§è¡Œç»“æœéœ€è¦åœ¨ResultChan å’Œ ErrChan ä¸­å»è·å–ï¼Œæ²¡æœ‰æä¾›é˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½® Worker çš„æ•°é‡å’Œä»»åŠ¡æ•°ã€‚ poolå¯èƒ½é€ æˆçš„é—®é¢˜ å†…å­˜æ³„æ¼ åœ¨ä½¿ç”¨ sync.Pool å›æ”¶ buffer çš„æ—¶å€™ï¼Œâ¼€å®šè¦æ£€æŸ¥å›æ”¶çš„å¯¹è±¡çš„â¼¤â¼©ã€‚å¦‚æœ buffer å¤ªâ¼¤ï¼Œå°± ä¸è¦å›æ”¶äº†ï¼Œå¦åˆ™å°±å¤ªæµªè´¹äº† å†…å­˜æµªè´¹ è¦åšåˆ°ç‰©å°½å…¶ç”¨ï¼Œå°½å¯èƒ½ä¸æµªè´¹çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å°† buffer æ± åˆ†æˆâ¼å±‚ â¼©äº 512 byteçš„å…ƒç´ çš„ buffer å â¼€ä¸ªæ± å­ï¼›å…¶æ¬¡ï¼Œâ¼©äº 1K byte â¼¤â¼©çš„å…ƒç´ å â¼€ä¸ªæ± å­ï¼›å†æ¬¡ï¼Œâ¼©äº 4Kbyte â¼¤â¼©çš„å…ƒç´ å â¼€ä¸ªæ± å­ã€‚è¿™æ ·åˆ†æˆâ¼ä¸ªæ± å­ä»¥åï¼Œå°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œåˆ°æ‰€éœ€â¼¤â¼©çš„æ± å­ä¸­è·å– buffer äº†ã€‚ å°ç»“ Pool æ˜¯â¼€ä¸ªé€šç”¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯è§£å†³å¯¹è±¡é‡ç”¨å’Œé¢„å…ˆåˆ†é…çš„â¼€ä¸ªå¸¸ç”¨çš„ä¼˜åŒ–â¼¿æ®µã€‚å³ä½¿ä½ â¾ƒâ¼° æ²¡åœ¨é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨è¿‡ï¼Œä½†è‚¯å®šåœ¨ä½¿ç”¨å…¶å®ƒåº“çš„æ—¶å€™ï¼Œå°±äº«å—åˆ°åº”ç”¨ Pool çš„å¥½å¤„äº†ï¼Œâ½å¦‚æ•° æ®åº“çš„è®¿é—®ã€http API çš„è¯·æ±‚ç­‰ç­‰ã€‚ æˆ‘ä»¬â¼€èˆ¬ä¸ä¼šåœ¨ç¨‹åºâ¼€å¼€å§‹çš„æ—¶å€™å°±å¼€å§‹è€ƒè™‘ä¼˜åŒ–ï¼Œâ½½æ˜¯ç­‰é¡¹ç›®å¼€å‘åˆ°â¼€ä¸ªé˜¶æ®µï¼Œæˆ–è€…å¿«ç»“æŸ çš„æ—¶å€™ï¼Œæ‰å…¨â¾¯åœ°è€ƒè™‘ç¨‹åºä¸­çš„ä¼˜åŒ–ç‚¹ï¼Œâ½½ Pool å°±æ˜¯å¸¸ç”¨çš„â¼€ä¸ªä¼˜åŒ–â¼¿æ®µã€‚å¦‚æœä½ å‘ç°ç¨‹åº ä¸­æœ‰â¼€ç§ GC è€—æ—¶ç‰¹åˆ«â¾¼ï¼Œæœ‰â¼¤é‡çš„ç›¸åŒç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œä¸æ–­åœ°è¢«åˆ›å»ºé”€æ¯ï¼Œè¿™æ—¶ï¼Œä½ å°±å¯ ä»¥è€ƒè™‘çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡æ± åŒ–çš„â¼¿æ®µé‡ç”¨è¿™äº›å¯¹è±¡ã€‚ å¦å¤–ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…å¾®æœåŠ¡æ¡†æ¶ä¸­ï¼Œå¯èƒ½ä¼šæœ‰â¼¤é‡çš„å¹¶å‘ Client è¯·æ±‚ï¼Œå¦‚æœ Client çš„è€— æ—¶å â½å¾ˆâ¼¤ï¼Œä½ ä¹Ÿå¯ä»¥è€ƒè™‘æ± åŒ– Clientï¼Œä»¥ä¾¿é‡ç”¨ã€‚ å¦‚æœä½ å‘ç°ç³»ç»Ÿä¸­çš„ goroutine æ•°é‡â¾®å¸¸å¤šï¼Œç¨‹åºçš„å†…å­˜èµ„æºå ç”¨â½è¾ƒâ¼¤ï¼Œâ½½ä¸”æ•´ä½“ç³»ç»Ÿçš„è€— æ—¶å’Œ GC ä¹Ÿâ½è¾ƒâ¾¼ï¼Œæˆ‘å»ºè®®ä½ çœ‹çœ‹ï¼Œæ˜¯å¦èƒ½å¤Ÿé€šè¿‡ Worker Pool è§£å†³â¼¤é‡ goroutine çš„é—® é¢˜ï¼Œä»â½½é™ä½è¿™äº›æŒ‡æ ‡ã€‚ Contextï¼šä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡ åœ¨ APIä¹‹é—´æˆ–è€…æ–¹æ³•è°ƒç”¨ä¹‹é—´ï¼Œæ‰€ä¼ é€’çš„é™¤äº†ä¸šåŠ¡å‚æ•°ä¹‹å¤–çš„é¢å¤–ä¿¡æ¯ã€‚\ncontextä½¿ç”¨åœºæ™¯ ä¸Šä¸‹â½‚ä¿¡æ¯ä¼ é€’ ï¼ˆrequest-scopedï¼‰ï¼Œâ½å¦‚å¤„ç† http è¯·æ±‚ã€åœ¨è¯·æ±‚å¤„ç†é“¾è·¯ä¸Šä¼ é€’ä¿¡ æ¯ï¼› æ§åˆ¶å­ goroutine çš„è¿è¡Œï¼› è¶…æ—¶æ§åˆ¶çš„æ–¹æ³•è°ƒç”¨ï¼› å¯ä»¥å–æ¶ˆçš„æ–¹æ³•è°ƒç”¨ã€‚ context æ¥å£å‡½æ•° 1 2 3 4 5 6 type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error Value(key interface{}) interface{} } Deadline æ–¹æ³•ä¼šè¿”å›è¿™ä¸ª Context è¢«å–æ¶ˆçš„æˆªâ½Œâ½‡æœŸã€‚å¦‚æœæ²¡æœ‰è®¾ç½®æˆªâ½Œâ½‡æœŸï¼Œok çš„å€¼æ˜¯ falseã€‚åç»­æ¯æ¬¡è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ Deadline æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè¿”å›å’Œç¬¬â¼€æ¬¡è°ƒç”¨ç›¸åŒçš„ç»“æœã€‚ Done æ–¹æ³•è¿”å›â¼€ä¸ª Channel å¯¹è±¡ã€‚åœ¨ Context è¢«å–æ¶ˆæ—¶ï¼Œæ­¤ Channel ä¼šè¢« closeï¼Œå¦‚æœæ²¡ è¢«å–æ¶ˆï¼Œå¯èƒ½ä¼šè¿”å› nilã€‚åç»­çš„ Done è°ƒç”¨æ€»æ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚å½“ Done è¢« close çš„æ—¶ å€™ï¼Œä½ å¯ä»¥é€šè¿‡ ctx.Err è·å–é”™è¯¯ä¿¡æ¯ã€‚Done è¿™ä¸ªæ–¹æ³•åå…¶å®èµ·å¾—å¹¶ä¸å¥½ï¼Œå› ä¸ºåå­—å¤ªè¿‡ç¬¼ ç»Ÿï¼Œä¸èƒ½æ˜ç¡®åæ˜  Done è¢« close çš„åŸå› ï¼Œå› ä¸º cancelã€timeoutã€deadline éƒ½å¯èƒ½å¯¼è‡´ Done è¢« closeï¼Œä¸è¿‡ï¼Œç›®å‰è¿˜æ²¡æœ‰â¼€ä¸ªæ›´åˆé€‚çš„æ–¹æ³•åç§°ã€‚ å¦‚æœ Done æ²¡æœ‰è¢« closeï¼ŒErr æ–¹æ³•è¿”å› nilï¼›å¦‚æœ Done è¢« closeï¼ŒErr æ–¹æ³•ä¼šè¿”å› Done è¢« close çš„åŸå› ã€‚ Value è¿”å›æ­¤ ctx ä¸­å’ŒæŒ‡å®šçš„ key ç›¸å…³è”çš„ valueã€‚ Context ä¸­å®ç°äº† 2 ä¸ªå¸¸ç”¨çš„ç”Ÿæˆé¡¶å±‚ Context çš„æ–¹æ³•ã€‚\ncontext.Background()ï¼šè¿”å›â¼€ä¸ªâ¾® nil çš„ã€ç©ºçš„ Contextï¼Œæ²¡æœ‰ä»»ä½•å€¼ï¼Œä¸ä¼šè¢« cancelï¼Œä¸ä¼šè¶…æ—¶ï¼Œæ²¡æœ‰æˆªâ½Œâ½‡æœŸã€‚â¼€èˆ¬ç”¨åœ¨ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠåˆ›å»ºæ ¹ Context çš„æ—¶å€™ context.TODO()ï¼šè¿”å›â¼€ä¸ªâ¾® nil çš„ã€ç©ºçš„ Contextï¼Œæ²¡æœ‰ä»»ä½•å€¼ï¼Œä¸ä¼šè¢« cancelï¼Œä¸ä¼šè¶…æ—¶ï¼Œæ²¡æœ‰æˆªâ½Œâ½‡æœŸã€‚å½“ä½ ä¸æ¸…æ¥šæ˜¯å¦è¯¥ç”¨ Contextï¼Œæˆ–è€…ç›®å‰è¿˜ä¸çŸ¥é“è¦ä¼ é€’â¼€äº›ä»€ä¹ˆä¸Šä¸‹â½‚ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚ å…³äºContextçš„ä¸€äº›çº¦å®šè§„å®š â¼€èˆ¬å‡½æ•°ä½¿ç”¨ Context çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ªå‚æ•°æ”¾åœ¨ç¬¬â¼€ä¸ªå‚æ•°çš„ä½ç½®ã€‚ä»æ¥ä¸æŠŠ nil å½“Context ç±»å‹çš„å‚æ•°å€¼ï¼Œå¯ä»¥ä½¿ç”¨ context.Background() åˆ›å»ºâ¼€ä¸ªç©ºçš„ä¸Šä¸‹â½‚å¯¹è±¡ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ nilã€‚ 2.Context åªç”¨æ¥ä¸´æ—¶åšå‡½æ•°ä¹‹é—´çš„ä¸Šä¸‹â½‚é€ä¼ ï¼Œä¸èƒ½æŒä¹…åŒ– Context æˆ–è€…æŠŠ Context â»“ä¹…å­˜ã€‚æŠŠ Context æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€æœ¬åœ°â½‚ä»¶æˆ–è€…å…¨å±€å˜é‡ã€ç¼“å­˜ä¸­éƒ½æ˜¯é”™è¯¯çš„ç”¨æ³•ã€‚ 3.key çš„ç±»å‹ä¸åº”è¯¥æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…å…¶å®ƒå†…å»ºç±»å‹ï¼Œå¦åˆ™å®¹æ˜“åœ¨åŒ…ä¹‹é—´ä½¿ç”¨ Context æ—¶å€™äº§ç”Ÿå†²çªã€‚ä½¿ç”¨ WithValue æ—¶ï¼Œkey çš„ç±»å‹åº”è¯¥æ˜¯â¾ƒâ¼°å®šä¹‰çš„ç±»å‹ã€‚ 4.å¸¸å¸¸ä½¿ç”¨ struct{}ä½œä¸ºåº•å±‚ç±»å‹å®šä¹‰ key çš„ç±»å‹ã€‚å¯¹äº exported key çš„é™æ€ç±»å‹ï¼Œå¸¸å¸¸æ˜¯æ¥â¼æˆ–è€…æŒ‡é’ˆã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å†…å­˜åˆ†é…ã€‚ åº”ç”¨åœºæ™¯ mainå‡½æ•°è¿”å›æ—¶ï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šè¢«ç›´æ¥æ‰“æ–­ï¼Œç¨‹åºé€€å‡ºã€‚é™¤æ­¤ä¹‹å¤–å¦‚æœæƒ³é€šè¿‡ç¼–ç¨‹çš„æ–¹æ³•è®©ä¸€ä¸ªgoroutineä¸­æ–­å…¶ä»–goroutineçš„æ‰§è¡Œï¼Œåªèƒ½æ˜¯é€šè¿‡åœ¨å¤šä¸ªgoroutineé—´é€šè¿‡contextä¸Šä¸‹æ–‡å¯¹è±¡åŒæ­¥å–æ¶ˆä¿¡å·çš„æ–¹å¼æ¥å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { ctx, cancel := context.WithCancel(context.Background()) go func() { defer func() { fmt.Println(\"goroutine exit\") }() for { select { case \u003c-ctx.Done(): return default: time.Sleep(time.Second) } } }() time.Sleep(time.Second) cancel() time.Sleep(2 * time.Second) } atomic åŸå­æ“ä½œ åŸå­æ“ä½œï¼Œæ˜¯å› ä¸ºâ¼€ä¸ªåŸå­åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶å®ƒçº¿ç¨‹ä¸ä¼šçœ‹åˆ°æ‰§è¡Œâ¼€åŠçš„æ“ä½œç»“æœã€‚åœ¨å…¶å®ƒçº¿ç¨‹çœ‹æ¥ï¼ŒåŸå­æ“ä½œè¦ä¹ˆæ‰§è¡Œå®Œäº†ï¼Œè¦ä¹ˆè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œå°±åƒâ¼€ä¸ªæœ€â¼©çš„ç²’å­ - åŸå­â¼€æ ·ï¼Œä¸å¯åˆ†å‰²\natomic æä¾›çš„æ–¹æ³• atomic æ“ä½œçš„å¯¹è±¡æ˜¯â¼€ä¸ªåœ°å€ï¼Œä½ éœ€è¦æŠŠå¯å¯»å€çš„å˜é‡çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ–¹æ³•ï¼Œâ½½ä¸æ˜¯æŠŠå˜é‡çš„å€¼ä¼ é€’ç»™æ–¹æ³•ã€‚ Add Add æ–¹æ³•å°±æ˜¯ç»™ç¬¬â¼€ä¸ªå‚æ•°åœ°å€ä¸­çš„å€¼å¢åŠ â¼€ä¸ª delta å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // AddInt32 atomically adds delta to *addr and returns the new value. func AddInt32(addr *int32, delta int32) (new int32) // AddUint32 atomically adds delta to *addr and returns the new value. // To subtract a signed positive constant value c from x, do AddUint32(\u0026x, ^uint32(c-1)). // In particular, to decrement x, do AddUint32(\u0026x, ^uint32(0)). func AddUint32(addr *uint32, delta uint32) (new uint32) // AddInt64 atomically adds delta to *addr and returns the new value. func AddInt64(addr *int64, delta int64) (new int64) // AddUint64 atomically adds delta to *addr and returns the new value. // To subtract a signed positive constant value c from x, do AddUint64(\u0026x, ^uint64(c-1)). // In particular, to decrement x, do AddUint64(\u0026x, ^uint64(0)). func AddUint64(addr *uint64, delta uint64) (new uint64) // AddUintptr atomically adds delta to *addr and returns the new value. func AddUintptr(addr *uintptr, delta uintptr) (new uintptr CAS ï¼ˆCompareAndSwapï¼‰\nè¿™ä¸ªæ–¹æ³•ä¼šâ½è¾ƒå½“å‰ addr åœ°å€â¾¥çš„å€¼æ˜¯ä¸æ˜¯ oldï¼Œå¦‚æœä¸ç­‰äº oldï¼Œå°±è¿”å› falseï¼›å¦‚æœç­‰äºoldï¼Œå°±æŠŠæ­¤åœ°å€çš„å€¼æ›¿æ¢æˆ new å€¼ï¼Œè¿”å› trueã€‚è¿™å°±ç›¸å½“äºâ€œåˆ¤æ–­ç›¸ç­‰æ‰æ›¿æ¢â€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value. func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) // CompareAndSwapInt64 executes the compare-and-swap operation for an int64 value. func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool) // CompareAndSwapUint32 executes the compare-and-swap operation for a uint32 value. func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool) // CompareAndSwapUint64 executes the compare-and-swap operation for a uint64 value. func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool) // CompareAndSwapUintptr executes the compare-and-swap operation for a uintptr value. func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool) // CompareAndSwapPointer executes the compare-and-swap operation for a unsafe.Pointer value. func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool) æ•ˆæœå¦‚ä¸‹\n1 2 3 4 5 if *addr == old { *addr = new return true } return false Swap å¦‚æœä¸éœ€è¦â½è¾ƒæ—§å€¼ï¼Œåªæ˜¯â½è¾ƒç²—æš´åœ°æ›¿æ¢çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ Swap æ–¹æ³•ï¼Œå®ƒæ›¿æ¢åè¿˜å¯ä»¥ è¿”å›æ—§å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // SwapInt32 atomically stores new into *addr and returns the previous *addr value. func SwapInt32(addr *int32, new int32) (old int32) // SwapInt64 atomically stores new into *addr and returns the previous *addr value. func SwapInt64(addr *int64, new int64) (old int64) // SwapUint32 atomically stores new into *addr and returns the previous *addr value. func SwapUint32(addr *uint32, new uint32) (old uint32) // SwapUint64 atomically stores new into *addr and returns the previous *addr value. func SwapUint64(addr *uint64, new uint64) (old uint64) // SwapUintptr atomically stores new into *addr and returns the previous *addr value. func SwapUintptr(addr *uintptr, new uintptr) (old uintptr) // SwapPointer atomically stores new into *addr and returns the previous *addr value. func SwapPointer(addr *unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer) æ•ˆæœå¦‚ä¸‹ï¼š\n1 2 3 old = *addr *addr = new return old Load Load æ–¹æ³•ä¼šå–å‡º addr åœ°å€ä¸­çš„å€¼ï¼Œå³ä½¿åœ¨å¤šå¤„ç†å™¨ã€å¤šæ ¸ã€æœ‰ CPU cache çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿèƒ½ä¿è¯ Load æ˜¯â¼€ä¸ªåŸå­æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // LoadInt32 atomically loads *addr. func LoadInt32(addr *int32) (val int32) // LoadInt64 atomically loads *addr. func LoadInt64(addr *int64) (val int64) // LoadUint32 atomically loads *addr. func LoadUint32(addr *uint32) (val uint32) // LoadUint64 atomically loads *addr. func LoadUint64(addr *uint64) (val uint64) // LoadUintptr atomically loads *addr. func LoadUintptr(addr *uintptr) (val uintptr) // LoadPointer atomically loads *addr. func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer) Store Store æ–¹æ³•ä¼šæŠŠâ¼€ä¸ªå€¼å­˜å…¥åˆ°æŒ‡å®šçš„ addr åœ°å€ä¸­ï¼Œå³ä½¿åœ¨å¤šå¤„ç†å™¨ã€å¤šæ ¸ã€æœ‰ CPU cacheçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿèƒ½ä¿è¯ Store æ˜¯â¼€ä¸ªåŸå­æ“ä½œã€‚åˆ«çš„ goroutine é€šè¿‡ Load è¯»å–å‡ºæ¥ï¼Œä¸ä¼šçœ‹åˆ°å­˜å–äº†â¼€åŠçš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // StoreInt32 atomically stores val into *addr. func StoreInt32(addr *int32, val int32) // StoreInt64 atomically stores val into *addr. func StoreInt64(addr *int64, val int64) // StoreUint32 atomically stores val into *addr. func StoreUint32(addr *uint32, val uint32) // StoreUint64 atomically stores val into *addr. func StoreUint64(addr *uint64, val uint64) // StoreUintptr atomically stores val into *addr. func StoreUintptr(addr *uintptr, val uintptr) // StorePointer atomically stores val into *addr. func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer Value ç±»å‹ å®ƒå¯ä»¥åŸå­åœ°å­˜å–å¯¹è±¡ç±»å‹ï¼Œä½†ä¹Ÿåªèƒ½å­˜å–ï¼Œä¸èƒ½ CAS å’Œ Swapï¼Œå¸¸å¸¸ç”¨åœ¨é…ç½®å˜æ›´ç­‰åœºæ™¯ä¸­\n1 2 3 4 5 6 7 // A Value must not be copied after first use. type Value struct { v interface{} } func (v *Value) Load() (x interface{}) {...} func (v *Value) Store(x interface{}) {...} Channelï¼šè§£å†³å¹¶å‘é—®é¢˜ CSPå…è®¸ä½¿ç”¨è¿›ç¨‹ç»„ä»¶æ¥æè¿°ç³»ç»Ÿï¼Œå®ƒä»¬ç‹¬â½´è¿è¡Œï¼Œå¹¶ä¸”åªé€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼é€šä¿¡ã€‚\nChannel çš„åº”ç”¨åœºæ™¯ æ‰§è¡Œä¸šåŠ¡å¤„ç†çš„ goroutine ä¸è¦é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼é€šä¿¡ï¼Œâ½½æ˜¯è¦é€šè¿‡ Channel é€šä¿¡çš„æ–¹å¼åˆ†äº«æ•°æ®\nâ€œcommunicate by sharing memoryâ€æ˜¯ä¼ ç»Ÿçš„å¹¶å‘ç¼–ç¨‹å¤„ç†æ–¹å¼ï¼Œå°±æ˜¯æŒ‡ï¼Œå…±äº«çš„æ•°æ®éœ€è¦ç”¨é”è¿›è¡Œä¿æŠ¤ï¼Œgoroutine éœ€è¦è·å–åˆ°é”ï¼Œæ‰èƒ½å¹¶å‘è®¿é—®æ•°æ®ã€‚ â€œshare memory by communicatingâ€åˆ™æ˜¯ç±»ä¼¼äº CSP æ¨¡å‹çš„æ–¹å¼ï¼Œé€šè¿‡é€šä¿¡çš„æ–¹å¼ï¼Œâ¼€ä¸ªgoroutine å¯ä»¥æŠŠæ•°æ®çš„â€œæ‰€æœ‰æƒâ€äº¤ç»™å¦å¤–â¼€ä¸ª goroutineï¼ˆè™½ç„¶ Go ä¸­æ²¡æœ‰â€œæ‰€æœ‰æƒâ€çš„æ¦‚å¿µï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šè¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºæ˜¯æ‰€æœ‰æƒçš„è½¬ç§»ï¼‰ã€‚ äº”å¤§åº”ç”¨åœºæ™¯\næ•°æ®äº¤æµï¼šå½“ä½œå¹¶å‘çš„ buffer æˆ–è€… queueï¼Œè§£å†³ç”Ÿäº§è€… - æ¶ˆè´¹è€…é—®é¢˜ã€‚å¤šä¸ª goroutine å¯ä»¥å¹¶å‘å½“ä½œç”Ÿäº§è€…ï¼ˆProducerï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ã€‚ æ•°æ®ä¼ é€’ï¼šâ¼€ä¸ª goroutine å°†æ•°æ®äº¤ç»™å¦â¼€ä¸ª goroutineï¼Œç›¸å½“äºæŠŠæ•°æ®çš„æ‹¥æœ‰æƒ (å¼•ç”¨)æ‰˜ä»˜å‡ºå»ã€‚ ä¿¡å·é€šçŸ¥ï¼šâ¼€ä¸ª goroutine å¯ä»¥å°†ä¿¡å· (closingã€closedã€data ready ç­‰) ä¼ é€’ç»™å¦â¼€ä¸ªæˆ–è€…å¦â¼€ç»„ goroutine ã€‚ ä»»åŠ¡ç¼–æ’ï¼šå¯ä»¥è®©â¼€ç»„ goroutine æŒ‰ç…§â¼€å®šçš„é¡ºåºå¹¶å‘æˆ–è€…ä¸²è¡Œçš„æ‰§è¡Œï¼Œè¿™å°±æ˜¯ç¼–æ’çš„åŠŸèƒ½ã€‚ é”ï¼šåˆ©ç”¨ Channel ä¹Ÿå¯ä»¥å®ç°äº’æ–¥é”çš„æœºåˆ¶ã€‚ channel åŸºæœ¬ç”¨æ³• \u003c- væœ‰ä¸ªè§„åˆ™ï¼Œæ€»æ˜¯å°½é‡å’Œå·¦è¾¹çš„ chan ç»“åˆï¼ˆThe \u003c- operator associates with the leftmost chan possible:\nnil æ˜¯ chan çš„é›¶å€¼ï¼Œæ˜¯â¼€ç§ç‰¹æ®Šçš„ chanï¼Œå¯¹å€¼æ˜¯ nil çš„ chan çš„å‘é€æ¥æ”¶è°ƒç”¨è€…æ€»æ˜¯ä¼šé˜»å¡ å…³äºchannelçš„é€‰æ‹© å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®ä½¿ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­ï¼› å¤æ‚çš„ä»»åŠ¡ç¼–æ’å’Œæ¶ˆæ¯ä¼ é€’ä½¿ç”¨ Channelï¼› æ¶ˆæ¯é€šçŸ¥æœºåˆ¶ä½¿ç”¨ Channelï¼Œé™¤éåªæƒ³ signal â¼€ä¸ª goroutineï¼Œæ‰ä½¿ç”¨ Condï¼› ç®€å•ç­‰å¾…æ‰€æœ‰ä»»åŠ¡çš„å®Œæˆç”¨ WaitGroupï¼Œä¹Ÿæœ‰ Channel çš„æ¨å´‡è€…ç”¨ Channelï¼Œéƒ½å¯ä»¥ï¼› éœ€è¦å’Œ Select è¯­å¥ç»“åˆï¼Œä½¿ç”¨ Channelï¼› éœ€è¦å’Œè¶…æ—¶é…åˆæ—¶ï¼Œä½¿ç”¨ Channel å’Œ Contextã€‚ chan çš„ç¼–æ’æ–¹å¼ Or-Done æ¨¡å¼ã€æ‰‡å…¥æ¨¡å¼ã€æ‰‡å‡ºæ¨¡å¼ã€Stream å’Œ map-reduce\nOr-Done æ¨¡å¼ Or-Done æ¨¡å¼æ˜¯ä¿¡å·é€šçŸ¥æ¨¡å¼ä¸­æ›´å®½æ³›çš„â¼€ç§æ¨¡å¼\næˆ‘ä»¬ä¼šä½¿ç”¨â€œä¿¡å·é€šçŸ¥â€å®ç°æŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåçš„é€šçŸ¥æœºåˆ¶ï¼Œåœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªä»»åŠ¡å®šä¹‰ â¼€ä¸ªç±»å‹ä¸º chan struct{}ç±»å‹çš„ done å˜é‡ï¼Œç­‰ä»»åŠ¡ç»“æŸåï¼Œæˆ‘ä»¬å°±å¯ä»¥ close è¿™ä¸ªå˜é‡ï¼Œ ç„¶åï¼Œå…¶å®ƒ receiver å°±ä¼šæ”¶åˆ°è¿™ä¸ªé€šçŸ¥ã€‚ è¿™æ˜¯æœ‰â¼€ä¸ªä»»åŠ¡çš„æƒ…å†µï¼Œå¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ï¼Œåªè¦æœ‰ä»»æ„â¼€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œæˆ‘ä»¬å°±æƒ³è·å¾—è¿™ä¸ªä¿¡ å·ï¼Œè¿™å°±æ˜¯ Or-Done æ¨¡å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 package main import ( \"fmt\" \"reflect\" \"time\" ) // or or-done æ¨¡å¼ é€’å½’å®ç° func or(channels ...\u003c-chan interface{}) \u003c-chan interface{} { // ç‰¹æ®Šæƒ…å†µï¼Œåªæœ‰é›¶ä¸ª,1ä¸ªæˆ–2ä¸ª chan switch len(channels) { case 0: return nil case 1: return channels[0] case 2: select { case \u003c-channels[0]: case \u003c-channels[1]: } } orDone := make(chan interface{}) go func() { defer close(orDone) // fmt.Println(\"æ‰§è¡Œ\") if len(channels) \u003e 2 { m := len(channels) / 2 select { case \u003c-or(channels[:m]...): case \u003c-or(channels[m:]...): } } }() return orDone } func sig(after time.Duration) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) time.Sleep(after) }() return c } // orSelect åå°„â½…å¼ å®ç° func orSelect(channels ...\u003c-chan interface{}) \u003c-chan interface{} { // ç‰¹æ®Šæƒ…å†µï¼Œåªæœ‰é›¶ä¸ª,1ä¸ªæˆ–2ä¸ª chan switch len(channels) { case 0: return nil case 1: return channels[0] } orDone := make(chan interface{}) go func() { defer close(orDone) // åˆ©ç”¨åå°„æ„å»ºSelectCase var cases []reflect.SelectCase for _, c := range channels { cases = append(cases, reflect.SelectCase{ Dir: reflect.SelectRecv, Chan: reflect.ValueOf(c), }) } // éšæœºé€‰å–ä¸€ä¸ªå¯ç”¨ case reflect.Select(cases) }() return orDone } func main() { start := time.Now() \u003c-orSelect( sig(10*time.Second), sig(20*time.Second), sig(30*time.Second), sig(40*time.Second), sig(50*time.Second), sig(01*time.Second), ) fmt.Printf(\"done after %v\", time.Since(start)) } æ‰‡å…¥æ¨¡å¼ æ‰‡å…¥å€Ÿé‰´äº†æ•°å­—ç”µè·¯çš„æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†å•ä¸ªé€»è¾‘ä»¬èƒ½å¤Ÿæ¥å—çš„æ•°å­—ä¿¡å·è¾“å…¥æœ€â¼¤é‡çš„æœ¯è¯­ã€‚â¼€ ä¸ªé€»è¾‘ä»¬å¯ä»¥æœ‰å¤šä¸ªè¾“å…¥ï¼Œâ¼€ä¸ªè¾“å‡ºã€‚\nåœ¨è½¯ä»¶â¼¯ç¨‹ä¸­ï¼Œæ¨¡å—çš„æ‰‡å…¥æ˜¯æŒ‡æœ‰å¤šå°‘ä¸ªä¸Šçº§æ¨¡å—è°ƒç”¨å®ƒã€‚ è€Œå¯¹äºæˆ‘ä»¬è¿™é‡Œçš„ Channel æ‰‡å…¥æ¨¡å¼æ¥è¯´ï¼Œå°±æ˜¯æŒ‡æœ‰å¤šä¸ªæº Channel è¾“å…¥ã€â¼€ä¸ªç›®çš„ Channel è¾“å‡ºçš„æƒ…å†µã€‚ æ‰‡å…¥æ¯”å°±æ˜¯æº Channel æ•°é‡æ¯”1ã€‚\næ¯ä¸ªæº Channel çš„å…ƒç´ éƒ½ä¼šå‘é€ç»™ç›®æ ‡ Channelï¼Œç›¸å½“äºç›®æ ‡ Channel çš„ receiver åªéœ€è¦ ç›‘å¬ç›®æ ‡ Channelï¼Œå°±å¯ä»¥æ¥æ”¶æ‰€æœ‰å‘é€ç»™æº Channel çš„æ•°æ®ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 package main import ( \"fmt\" \"reflect\" \"time\" ) // æ‰‡å…¥æ¨¡å¼ åå°„å®ç° func fanInReflect(channels ...\u003c-chan interface{}) \u003c-chan interface{} { out:= make(chan interface{}) go func() { defer close(out) // æ„é€  SelectCases slice var cases []reflect.SelectCase for _, c := range channels{ cases = append(cases, reflect.SelectCase{ Dir: reflect.SelectRecv, Chan: reflect.ValueOf(c), }) } // å¾ªç¯ï¼Œä» cases ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ for len(cases)\u003e0{ i,v,ok:=reflect.Select(cases) if !ok{ // chan å…³é—­ cases = append(cases[:i],cases[i+1:]...) continue } out \u003c-v.Interface() } }() return out } func fanInRec(channels ...\u003c-chan interface{}) \u003c-chan interface{}{ switch len(channels){ case 0: c:= make(chan interface{}) close(c) return c case 1: return channels[0] case 2: return mergeTow(channels[0], channels[1]) default: m:=len(channels)/2 return mergeTow( fanInRec(channels[:m]...), fanInRec(channels[m:]...)) } } // åˆå¹¶ä¸¤ä¸ª chan func mergeTow(a,b \u003c-chan interface{}) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) for a!= nil || b !=nil{ select{ case v,ok := \u003c-a: if !ok { // a å·²å…³é—­ï¼Œè®¾ç½®ä¸ºnil a=nil continue } c \u003c- v case v,ok := \u003c-b: if !ok { // bå·²å…³é—­ï¼Œè®¾ç½®ä¸ºnil b=nil continue } c \u003c- v } } }() return c } func sigs(after time.Duration) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) time.Sleep(after) }() return c } func main() { start := time.Now() \u003c-fanInReflect( sigs(10*time.Second), sigs(02*time.Second), sigs(03*time.Second), sigs(04*time.Second), sigs(05*time.Second), sigs(01*time.Second), ) fmt.Printf(\"done after %v\", time.Since(start)) } æ‰‡å‡ºæ¨¡å¼ æ‰‡å‡ºæ¨¡å¼æ˜¯å’Œæ‰‡å…¥æ¨¡å¼ç›¸åçš„ã€‚\næ‰‡å‡ºæ¨¡å¼åªæœ‰â¼€ä¸ªè¾“å…¥æº Channelï¼Œæœ‰å¤šä¸ªç›®æ ‡ Channelï¼Œæ‰‡å‡ºæ¯”å°±æ˜¯ 1æ¯”ç›®æ ‡ Channel æ•° çš„å€¼ï¼Œç»å¸¸ç”¨åœ¨è®¾è®¡æ¨¡å¼ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼ˆè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼å®šä¹‰äº†å¯¹è±¡é—´çš„â¼€ç§â¼€å¯¹å¤šçš„ ç»„åˆå…³ç³»ã€‚è¿™æ ·â¼€æ¥ï¼Œâ¼€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘â½£å˜åŒ–æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥å¹¶â¾ƒåŠ¨ åˆ·æ–°ï¼‰ã€‚åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œæ•°æ®å˜åŠ¨åï¼Œå¤šä¸ªè§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°è¿™ä¸ªå˜æ›´ä¿¡å·ã€‚\n","wordCount":"10919","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.me/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.me/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.me/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.me/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.me/en/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://luenci.me/en/posts title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://luenci.me/en/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://luenci.me/en/archives title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://luenci.me/en/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://luenci.me/en/about title=ğŸ™‹ğŸ»â€â™‚ï¸å…³äº><span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span></a></li><li><a href=https://luenci.me/en/links title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li><li><a href=https://luenci.me/en/index.xml title=ğŸª§RSS><span>ğŸª§RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.me/en/>Home</a>&nbsp;Â»&nbsp;<a href=https://luenci.me/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">golangå¹¶å‘ç¼–ç¨‹</h1><div class=post-meta>22 min&nbsp;Â·&nbsp;10919 words&nbsp;Â·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86 aria-label=é¢„å¤‡çŸ¥è¯†>é¢„å¤‡çŸ¥è¯†</a><ul><li><a href=#unsafepointer aria-label=unsafe.Pointer>unsafe.Pointer</a></li><li><a href=#cas%e6%af%94%e8%be%83%e5%b9%b6%e4%ba%a4%e6%8d%a2----compare-and-swap aria-label="CASæ¯”è¾ƒå¹¶äº¤æ¢&amp;mdash;-Compare And Swap">CASæ¯”è¾ƒå¹¶äº¤æ¢&mdash;-Compare And Swap</a></li></ul></li><li><a href=#%e4%ba%92%e6%96%a5%e9%94%81%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6 aria-label=äº’æ–¥é”å®ç°æœºåˆ¶>äº’æ–¥é”å®ç°æœºåˆ¶</a><ul><li><a href=#%e7%ae%80%e5%8d%95%e7%9a%84%e8%ae%a1%e6%95%b0%e5%99%a8%e4%be%8b%e5%ad%90-counter aria-label="ç®€å•çš„è®¡æ•°å™¨ä¾‹å­ Counter">ç®€å•çš„è®¡æ•°å™¨ä¾‹å­ Counter</a></li><li><a href=#mutex-%e6%b3%a8%e6%84%8f%e7%82%b9 aria-label="mutex æ³¨æ„ç‚¹">mutex æ³¨æ„ç‚¹</a></li><li><a href=#mutex%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af aria-label=Mutexå¸¸è§é”™è¯¯>Mutexå¸¸è§é”™è¯¯</a></li><li><a href=#mutex%e5%b0%8f%e7%bb%93 aria-label=Mutexå°ç»“>Mutexå°ç»“</a></li><li><a href=#rwmutex--%e8%af%bb%e5%86%99%e9%94%81 aria-label="RWMutex â€” è¯»å†™é”">RWMutex â€” è¯»å†™é”</a></li><li><a href=#rwmutex-%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 aria-label="RWMutex çš„å®ç°åŸç†">RWMutex çš„å®ç°åŸç†</a></li><li><a href=#rwmutex%e7%9a%84%e9%94%81 aria-label=RWMutexçš„é”>RWMutexçš„é”</a></li></ul></li><li><a href=#waitgroup%e5%8d%8f%e5%90%8c%e7%ad%89%e5%be%85%e4%bb%bb%e5%8a%a1%e7%bc%96%e6%8e%92%e5%88%a9%e5%99%a8 aria-label=WaitGroupï¼šååŒç­‰å¾…ï¼Œä»»åŠ¡ç¼–æ’åˆ©å™¨>WaitGroupï¼šååŒç­‰å¾…ï¼Œä»»åŠ¡ç¼–æ’åˆ©å™¨</a><ul><li><a href=#waitgroup%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label=WaitGroupåŸºæœ¬ç”¨æ³•>WaitGroupåŸºæœ¬ç”¨æ³•</a></li><li><a href=#waitgroup%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label=WaitGroupæ•°æ®ç»“æ„>WaitGroupæ•°æ®ç»“æ„</a></li><li><a href=#%e5%b0%8f%e7%bb%93 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#cond aria-label=Cond>Cond</a><ul><li><a href=#cond-%e7%9a%84%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label="Cond çš„åŸºæœ¬ç”¨æ³•">Cond çš„åŸºæœ¬ç”¨æ³•</a></li><li><a href=#%e6%a1%88%e4%be%8b aria-label=æ¡ˆä¾‹>æ¡ˆä¾‹</a></li><li><a href=#%e5%b0%8f%e7%bb%93-1 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#once aria-label=Once>Once</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label=ä½¿ç”¨åœºæ™¯>ä½¿ç”¨åœºæ™¯</a></li><li><a href=#%e5%b0%8f%e7%bb%93-2 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#pool aria-label=Pool>Pool</a><ul><ul><li><a href=#%e6%b3%a8%e6%84%8f%e7%82%b9 aria-label=æ³¨æ„ç‚¹>æ³¨æ„ç‚¹</a></li></ul><li><a href=#%e6%96%b9%e6%b3%95%e4%bb%8b%e7%bb%8d aria-label=æ–¹æ³•ä»‹ç»>æ–¹æ³•ä»‹ç»</a></li><li><a href=#%e6%8e%a8%e8%8d%90%e7%9a%84%e4%b8%89%e6%96%b9pool aria-label=æ¨èçš„ä¸‰æ–¹pool>æ¨èçš„ä¸‰æ–¹pool</a></li><li><a href=#pool%e5%8f%af%e8%83%bd%e9%80%a0%e6%88%90%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=poolå¯èƒ½é€ æˆçš„é—®é¢˜>poolå¯èƒ½é€ æˆçš„é—®é¢˜</a></li><li><a href=#%e5%b0%8f%e7%bb%93-3 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#context%e4%bf%a1%e6%81%af%e7%a9%bf%e9%80%8f%e4%b8%8a%e4%b8%8b%e6%96%87 aria-label=Contextï¼šä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡>Contextï¼šä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡</a><ul><li><a href=#context%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label=contextä½¿ç”¨åœºæ™¯>contextä½¿ç”¨åœºæ™¯</a></li><li><a href=#context-%e6%8e%a5%e5%8f%a3%e5%87%bd%e6%95%b0 aria-label="context æ¥å£å‡½æ•°">context æ¥å£å‡½æ•°</a></li><li><a href=#%e5%85%b3%e4%ba%8econtext%e7%9a%84%e4%b8%80%e4%ba%9b%e7%ba%a6%e5%ae%9a%e8%a7%84%e5%ae%9a aria-label=å…³äºContextçš„ä¸€äº›çº¦å®šè§„å®š>å…³äºContextçš„ä¸€äº›çº¦å®šè§„å®š</a></li><li><a href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label=åº”ç”¨åœºæ™¯>åº”ç”¨åœºæ™¯</a></li></ul></li><li><a href=#atomic-%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c aria-label="atomic åŸå­æ“ä½œ">atomic åŸå­æ“ä½œ</a><ul><li><a href=#atomic-%e6%8f%90%e4%be%9b%e7%9a%84%e6%96%b9%e6%b3%95 aria-label="atomic æä¾›çš„æ–¹æ³•">atomic æä¾›çš„æ–¹æ³•</a></li><li><a href=#add aria-label=Add>Add</a></li><li><a href=#swap aria-label=Swap>Swap</a></li><li><a href=#load aria-label=Load>Load</a></li><li><a href=#store aria-label=Store>Store</a></li><li><a href=#value-%e7%b1%bb%e5%9e%8b aria-label="Value ç±»å‹">Value ç±»å‹</a></li></ul></li><li><a href=#channel%e8%a7%a3%e5%86%b3%e5%b9%b6%e5%8f%91%e9%97%ae%e9%a2%98 aria-label=Channelï¼šè§£å†³å¹¶å‘é—®é¢˜>Channelï¼šè§£å†³å¹¶å‘é—®é¢˜</a><ul><li><a href=#channel-%e7%9a%84%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label="Channel çš„åº”ç”¨åœºæ™¯">Channel çš„åº”ç”¨åœºæ™¯</a></li><li><a href=#channel-%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label="channel åŸºæœ¬ç”¨æ³•">channel åŸºæœ¬ç”¨æ³•</a></li><li><a href=#%e5%85%b3%e4%ba%8echannel%e7%9a%84%e9%80%89%e6%8b%a9 aria-label=å…³äºchannelçš„é€‰æ‹©>å…³äºchannelçš„é€‰æ‹©</a></li><li><a href=#chan-%e7%9a%84%e7%bc%96%e6%8e%92%e6%96%b9%e5%bc%8f aria-label="chan çš„ç¼–æ’æ–¹å¼">chan çš„ç¼–æ’æ–¹å¼</a><ul><li><a href=#or-done-%e6%a8%a1%e5%bc%8f aria-label="Or-Done æ¨¡å¼">Or-Done æ¨¡å¼</a></li><li><a href=#%e6%89%87%e5%85%a5%e6%a8%a1%e5%bc%8f aria-label=æ‰‡å…¥æ¨¡å¼>æ‰‡å…¥æ¨¡å¼</a></li><li><a href=#%e6%89%87%e5%87%ba%e6%a8%a1%e5%bc%8f aria-label=æ‰‡å‡ºæ¨¡å¼>æ‰‡å‡ºæ¨¡å¼</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=é¢„å¤‡çŸ¥è¯†>é¢„å¤‡çŸ¥è¯†<a hidden class=anchor aria-hidden=true href=#é¢„å¤‡çŸ¥è¯†>#</a></h1><h2 id=unsafepointer>unsafe.Pointer<a hidden class=anchor aria-hidden=true href=#unsafepointer>#</a></h2><blockquote><p>unsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº C è¯­è¨€é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚</p></blockquote><p><a href=https://zhuanlan.zhihu.com/p/137060307>å¯¹unsafe.Pointer åˆçˆ±åˆæ¨ï¼Œä½ ä¼šæœ‰æ•ˆä½¿ç”¨å®ƒå—ï¼Ÿ</a></p><blockquote><p>unsafe æ˜¯å…³æ³¨ Go ç¨‹åºæ“ä½œç±»å‹å®‰å…¨çš„åŒ…ã€‚</p></blockquote><p><code>unsafe.Pointer</code> å¯ä»¥è®©ä½ æ— è§† Go çš„ç±»å‹ç³»ç»Ÿï¼Œå®Œæˆä»»ä½•ç±»å‹ä¸å†…å»ºçš„ uintptr ç±»å‹ä¹‹é—´çš„è½¬åŒ–ã€‚æ ¹æ®æ–‡æ¡£ï¼Œunsafe.Pointer å¯ä»¥å®ç°å››ç§å…¶ä»–ç±»å‹ä¸èƒ½çš„æ“ä½œï¼š</p><ul><li>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª unsafe.Pointer</li><li>ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä»»ä½•ç±»å‹çš„æŒ‡é’ˆ</li><li>ä¸€ä¸ª uintptr å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª unsafe.Pointer</li><li>ä¸€ä¸ª unsafe.Pointer å¯ä»¥è½¬åŒ–æˆä¸€ä¸ª uintptr</li></ul><p>ä¸¤ç§åªèƒ½å€ŸåŠ© unsafe åŒ…æ‰èƒ½å®Œæˆçš„æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ unsafe.Pointer å®ç°ä¸¤ç§ç±»å‹é—´è½¬æ¢</li><li>ä½¿ç”¨ unsafe.Pointer å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚</li></ul><h2 id=casæ¯”è¾ƒå¹¶äº¤æ¢----compare-and-swap>CASæ¯”è¾ƒå¹¶äº¤æ¢&mdash;-Compare And Swap<a hidden class=anchor aria-hidden=true href=#casæ¯”è¾ƒå¹¶äº¤æ¢----compare-and-swap>#</a></h2><p><a href=https://studygolang.com/articles/23289>Go çš„ä¸€ä¸ª CAS æ“ä½œä½¿ç”¨åœºæ™¯</a></p><ul><li>åœ¨å¹¶å‘æ‰§è¡Œçš„å¤šä¸ª routine R1,R2&mldr;Rn çš„ä¸­ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸å”¯ä¸€ä¸€ä¸ª routine æ‰§è¡ŒæŸä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”å…¶ä»– routine éœ€è¦éé˜»å¡çš„çŸ¥é“è‡ªå·±æ— æƒæ“ä½œå¹¶è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ“ä½œã€‚</li></ul><blockquote><p>å¤§æ–¹å‘ï¼šä»»åŠ¡ç¼–æ’ç”¨ <code>Channel</code>ï¼Œå…±äº«èµ„æºä¿æŠ¤ç”¨ä¼ ç»Ÿ<code>å¹¶å‘åŸè¯­</code></p></blockquote><h1 id=äº’æ–¥é”å®ç°æœºåˆ¶>äº’æ–¥é”å®ç°æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#äº’æ–¥é”å®ç°æœºåˆ¶>#</a></h1><blockquote><p>ä½¿ç”¨äº’æ–¥é”ï¼Œé™å®šä¸´ç•ŒåŒºåªèƒ½åŒæ—¶ç”±ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ã€‚</p></blockquote><ul><li>ä¸´ç•ŒåŒº<ul><li>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç¨‹åºä¸­çš„ä¸€éƒ¨åˆ†ä¼šè¢«å¹¶å‘è®¿é—®æˆ–ä¿®æ”¹ï¼Œé‚£ä¹ˆï¼Œä¸ºäº†é¿å…å¹¶å‘è®¿é—®å¯¼è‡´çš„æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œè¿™éƒ¨åˆ†ç¨‹åºéœ€è¦è¢«ä¿æŠ¤èµ·æ¥ï¼Œè¿™éƒ¨åˆ†è¢«ä¿æŠ¤èµ·æ¥çš„ç¨‹åºï¼Œå°±å«åšä¸´ç•ŒåŒºã€‚</li></ul></li></ul><p><img loading=lazy src=https://gitee.com/luenci/RepoImg/raw/master/img/202108281355882.png alt=image-20210828135504575></p><p>åœ¨ Go æ ‡å‡†åº“ä¸­ï¼Œå®ƒæä¾›äº† Mutex æ¥å®ç°äº’æ–¥é”è¿™ä¸ªåŠŸèƒ½ã€‚</p><ul><li>å…±äº«èµ„æºã€‚å¹¶å‘åœ°è¯»å†™å…±äº«èµ„æºï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ Mutexã€RWMutex è¿™æ ·çš„å¹¶å‘åŸè¯­æ¥ä¿æŠ¤ã€‚</li><li>ä»»åŠ¡ç¼–æ’ã€‚éœ€è¦ goroutine æŒ‰ç…§ä¸€å®šçš„è§„å¾‹æ‰§è¡Œï¼Œè€Œ goroutine ä¹‹é—´æœ‰ç›¸äº’ç­‰å¾…æˆ–è€…ä¾èµ–çš„é¡ºåºå…³ç³»ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ WaitGroup æˆ–è€… Channel æ¥å®ç°ã€‚</li><li>æ¶ˆæ¯ä¼ é€’ã€‚ä¿¡æ¯äº¤æµä»¥åŠä¸åŒçš„ goroutine ä¹‹é—´çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æµï¼Œå¸¸å¸¸ä½¿ç”¨ Channel æ¥å®ç°ã€‚</li></ul><h2 id=ç®€å•çš„è®¡æ•°å™¨ä¾‹å­-counter>ç®€å•çš„è®¡æ•°å™¨ä¾‹å­ Counter<a hidden class=anchor aria-hidden=true href=#ç®€å•çš„è®¡æ•°å™¨ä¾‹å­-counter>#</a></h2><p>æ–¹æ³•ä¸€ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span>(
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> count = <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>   <span style=color:#8b949e;font-style:italic>// äº’æ–¥é”ä¿æŠ¤è®¡æ•°å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>   <span style=color:#ff7b72>var</span> mu sync.Mutex
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>var</span> wg sync.WaitGroup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   wg.<span style=color:#d2a8ff;font-weight:700>Add</span>(<span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span><span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> wg.<span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯¹å˜é‡ count è¿›è¡ŒåŠ æ³•æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// count++ ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå®ƒè‡³å°‘åŒ…å«å‡ ä¸ªæ­¥éª¤ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// æ¯”å¦‚è¯»å–å˜é‡ count çš„å½“å‰å€¼ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// å¯¹è¿™ä¸ªå€¼åŠ  1ï¼ŒæŠŠç»“æœå†ä¿å­˜åˆ° count ä¸­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// å› ä¸ºä¸æ˜¯åŸå­æ“ä½œï¼Œå°±å¯èƒ½æœ‰å¹¶å‘çš„é—®é¢˜ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10000</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span>mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>count<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>            mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç­‰å¾… 10 ä¸ª goroutine å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>   wg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;ç»“æœä¸º&#34;</span>, count)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Counter <span style=color:#ff7b72>struct</span>{
</span></span><span style=display:flex><span>	 id    <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>   name  <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>   mu    sync.Mutex
</span></span><span style=display:flex><span>   count <span style=color:#ff7b72>uint</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span>(c <span style=color:#ff7b72;font-weight:700>*</span>Counter)<span style=color:#d2a8ff;font-weight:700>Inc</span>() {
</span></span><span style=display:flex><span>c.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>c.count<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>   c.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span>(c <span style=color:#ff7b72;font-weight:700>*</span>Counter)<span style=color:#d2a8ff;font-weight:700>Count</span>()<span style=color:#ff7b72>uint</span>{
</span></span><span style=display:flex><span>c.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> c.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> c.count
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main2</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> counter Counter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>var</span> wg sync.WaitGroup
</span></span><span style=display:flex><span>   wg.<span style=color:#d2a8ff;font-weight:700>Add</span>(<span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span><span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> wg.<span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10000</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span>counter.<span style=color:#d2a8ff;font-weight:700>Inc</span>()<span style=color:#8b949e;font-style:italic>// å—åˆ° mutex ä¿æŠ¤çš„æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>}
</span></span><span style=display:flex><span>}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>wg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;ç»“æœä¸º&#34;</span>, counter.count)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ç­‰å¾…çš„goroutineä»¬æ˜¯ä»¥FIFOæ’é˜Ÿçš„</p><ul><li><p>1ï¼‰å½“Mutexå¤„äºæ­£å¸¸æ¨¡å¼æ—¶ï¼Œè‹¥æ­¤æ—¶æ²¡æœ‰æ–°goroutineä¸é˜Ÿå¤´goroutineç«äº‰ï¼Œåˆ™é˜Ÿå¤´goroutineè·å¾—ã€‚è‹¥æœ‰æ–°goroutineç«äº‰å¤§æ¦‚ç‡æ–°goroutineè·å¾—ã€‚</p></li><li><p>2ï¼‰å½“é˜Ÿå¤´goroutineç«äº‰é”å¤±è´¥1msåï¼Œå®ƒä¼šå°†Mutexè°ƒæ•´ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚è¿›å…¥é¥¥é¥¿æ¨¡å¼åï¼Œé”çš„æ‰€æœ‰æƒä¼šç›´æ¥ä»è§£é”goroutineç§»äº¤ç»™é˜Ÿå¤´goroutineï¼Œæ­¤æ—¶æ–°æ¥çš„goroutineç›´æ¥æ”¾å…¥é˜Ÿå°¾ã€‚</p></li><li><p>3ï¼‰å½“ä¸€ä¸ªgoroutineè·å–é”åï¼Œå¦‚æœå‘ç°è‡ªå·±æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ª</p><ul><li>å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ª</li><li>å®ƒç­‰å¾…é”çš„æ—¶é—´å°‘äº1ms</li></ul><p>å°†é”åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼</p></li></ul><h2 id=mutex-æ³¨æ„ç‚¹>mutex æ³¨æ„ç‚¹<a hidden class=anchor aria-hidden=true href=#mutex-æ³¨æ„ç‚¹>#</a></h2><ul><li>Unlock æ–¹æ³•å¯ä»¥è¢«ä»»æ„çš„ goroutine è°ƒç”¨é‡Šæ”¾é”ï¼Œå³ä½¿æ˜¯æ²¡æŒæœ‰è¿™ä¸ªäº’æ–¥é”çš„ goroutineï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè¿™ä¸ªæ“ä½œã€‚è¿™æ˜¯å› ä¸ºï¼ŒMutex æœ¬èº«å¹¶æ²¡æœ‰åŒ…å«æŒæœ‰è¿™æŠŠé”çš„ goroutine çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ï¼ŒUnlock ä¹Ÿä¸ä¼šå¯¹æ­¤è¿›è¡Œæ£€æŸ¥ã€‚Mutex çš„è¿™ä¸ªè®¾è®¡ä¸€ç›´ä¿æŒè‡³ä»Šã€‚</li></ul><h2 id=mutexå¸¸è§é”™è¯¯>Mutexå¸¸è§é”™è¯¯<a hidden class=anchor aria-hidden=true href=#mutexå¸¸è§é”™è¯¯>#</a></h2><blockquote><p>Mutex å¸¸è§çš„é”™è¯¯åœºæ™¯æœ‰ 4 ç±»ï¼Œåˆ†åˆ«æ˜¯ Lock/Unlock ä¸æ˜¯æˆå¯¹å‡ºç°ã€Copy å·²ä½¿ç”¨çš„ Mutexã€é‡å…¥å’Œæ­»é”ã€‚</p></blockquote><p>å¯é‡å…¥çš„æ¦‚å¿µ</p><ul><li>å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ‹¥æœ‰è¿™ä¸ªé”ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªçº¿ç¨‹å°±æˆåŠŸè·å–åˆ°è¿™ä¸ªé”ã€‚ä¹‹åï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹å†è¯·æ±‚è¿™ä¸ªé”ï¼Œå°±ä¼šå¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‹¥æœ‰è¿™æŠŠé”çš„çº¿ç¨‹å†è¯·æ±‚è¿™æŠŠé”çš„è¯ï¼Œä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯æˆåŠŸè¿”å›ï¼Œæ‰€ä»¥å«å¯é‡å…¥é”ï¼ˆæœ‰æ—¶å€™ä¹Ÿå«åšé€’å½’é”ï¼‰ã€‚åªè¦ä½ æ‹¥æœ‰è¿™æŠŠé”ï¼Œä½ å¯ä»¥å¯ç€åŠ²å„¿åœ°è°ƒç”¨ï¼Œæ¯”å¦‚é€šè¿‡é€’å½’å®ç°ä¸€äº›ç®—æ³•ï¼Œè°ƒç”¨è€…ä¸ä¼šé˜»å¡æˆ–è€…æ­»é”ã€‚</li></ul><p>æ­»é”</p><ul><li>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼Œgoroutineï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºå…±äº«èµ„æºè€Œå¤„äºä¸€ç§äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰å¤–éƒ¨å¹²æ¶‰ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚</li></ul><p>é¿å…æ­»é”ï¼Œåªè¦ç ´åè¿™å››ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å‡ ä¸ªï¼Œå°±å¯ä»¥äº†ã€‚</p><ul><li>äº’æ–¥ï¼š è‡³å°‘ä¸€ä¸ªèµ„æºæ˜¯è¢«æ’ä»–æ€§ç‹¬äº«çš„ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°èµ„æºè¢«é‡Šæ”¾ã€‚</li><li>æŒæœ‰å’Œç­‰å¾…ï¼šgoroutine æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”è¿˜åœ¨è¯·æ±‚å…¶å®ƒ goroutine æŒæœ‰çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å¸¸è¯´çš„â€œåƒç€ç¢—é‡Œï¼Œçœ‹ç€é”…é‡Œâ€çš„æ„æ€ã€‚</li><li>ä¸å¯å‰¥å¤ºï¼šèµ„æºåªèƒ½ç”±æŒæœ‰å®ƒçš„ goroutine æ¥é‡Šæ”¾ã€‚</li><li>ç¯è·¯ç­‰å¾…ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå­˜åœ¨ä¸€ç»„ç­‰å¾…è¿›ç¨‹ï¼ŒP={P1ï¼ŒP2ï¼Œâ€¦ï¼ŒPN}ï¼ŒP1 ç­‰å¾… P2 æŒæœ‰çš„èµ„æºï¼ŒP2 ç­‰å¾… P3 æŒæœ‰çš„èµ„æºï¼Œä¾æ­¤ç±»æ¨ï¼Œæœ€åæ˜¯ PN ç­‰å¾… P1 æŒæœ‰çš„èµ„æºï¼Œè¿™å°±å½¢æˆäº†ä¸€ä¸ªç¯è·¯ç­‰å¾…çš„æ­»ç»“ã€‚</li></ul><p><img loading=lazy src=https://gitee.com/luenci/RepoImg/raw/master/img/202108281347706.png alt=image-20210828135540673></p><h2 id=mutexå°ç»“>Mutexå°ç»“<a hidden class=anchor aria-hidden=true href=#mutexå°ç»“>#</a></h2><h2 id=rwmutex--è¯»å†™é”>RWMutex â€” è¯»å†™é”<a hidden class=anchor aria-hidden=true href=#rwmutex--è¯»å†™é”>#</a></h2><p>æ ‡å‡†åº“ä¸­çš„ RWMutex æ˜¯ä¸€ä¸ª <code>reader/writer</code> äº’æ–¥é”ã€‚RWMutexåœ¨æŸä¸€æ—¶åˆ»åªèƒ½ç”±ä»»æ„æ•°é‡çš„ reader æŒæœ‰ï¼Œæˆ–è€…æ˜¯åªè¢«å•ä¸ªçš„ writer æŒæœ‰ã€‚RWMutex çš„æ–¹æ³•ä¹Ÿå¾ˆå°‘ï¼Œæ€»å…±æœ‰ 5 ä¸ªã€‚</p><ul><li><p>Lock/Unlockï¼šå†™æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•ã€‚å¦‚æœé”å·²ç»è¢« reader æˆ–è€… writer æŒæœ‰ï¼Œé‚£ä¹ˆï¼ŒLock æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼›Unlock åˆ™æ˜¯é…å¯¹çš„é‡Šæ”¾é”çš„æ–¹æ³•ã€‚</p></li><li><p>RLock/RUnlockï¼šè¯»æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•ã€‚å¦‚æœé”å·²ç»è¢« writer æŒæœ‰çš„è¯ï¼ŒRLock æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼Œå¦åˆ™å°±ç›´æ¥è¿”å›ï¼›è€Œ RUnlock æ˜¯ reader é‡Šæ”¾é”çš„æ–¹æ³•ã€‚</p></li><li><p>RLockerï¼šè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä¸ºè¯»æ“ä½œè¿”å›ä¸€ä¸ª Locker æ¥å£çš„å¯¹è±¡ã€‚å®ƒçš„ Lock æ–¹æ³•ä¼šè°ƒç”¨ RWMutex çš„ RLock æ–¹æ³•ï¼Œå®ƒçš„ Unlock æ–¹æ³•ä¼šè°ƒç”¨ RWMutex çš„ RUnlock æ–¹æ³•ã€‚</p><p>RWMutex çš„é›¶å€¼æ˜¯æœªåŠ é”çš„çŠ¶æ€ï¼Œæ‰€ä»¥ï¼Œå½“ä½ ä½¿ç”¨ RWMutex çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å£°æ˜å˜é‡ï¼Œè¿˜æ˜¯åµŒå…¥åˆ°å…¶å®ƒ struct ä¸­ï¼Œéƒ½ä¸å¿…æ˜¾å¼åœ°åˆå§‹åŒ–ã€‚</p></li></ul><blockquote><p>å¦‚æœä½ é‡åˆ°å¯ä»¥æ˜ç¡®åŒºåˆ† reader å’Œ writer goroutine çš„åœºæ™¯ï¼Œä¸”æœ‰å¤§é‡çš„å¹¶å‘è¯»ã€å°‘é‡çš„å¹¶å‘å†™ï¼Œå¹¶ä¸”æœ‰å¼ºçƒˆçš„æ€§èƒ½éœ€æ±‚ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¯»å†™é” RWMutex æ›¿æ¢ Mutexã€‚</p></blockquote><h2 id=rwmutex-çš„å®ç°åŸç†>RWMutex çš„å®ç°åŸç†<a hidden class=anchor aria-hidden=true href=#rwmutex-çš„å®ç°åŸç†>#</a></h2><p>RWMutex æ˜¯å¾ˆå¸¸è§çš„å¹¶å‘åŸè¯­ï¼Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„åº“éƒ½æä¾›äº†ç±»ä¼¼çš„å¹¶å‘ç±»å‹ã€‚RWMutex ä¸€èˆ¬éƒ½æ˜¯åŸºäºäº’æ–¥é”ã€æ¡ä»¶å˜é‡ï¼ˆcondition variablesï¼‰æˆ–è€…ä¿¡å·é‡ï¼ˆsemaphoresï¼‰ç­‰å¹¶å‘åŸè¯­æ¥å®ç°ã€‚Go æ ‡å‡†åº“ä¸­çš„ RWMutex æ˜¯åŸºäº Mutex å®ç°çš„ã€‚</p><ul><li>readers-writers é—®é¢˜ä¸€èˆ¬æœ‰ä¸‰ç±»ï¼ŒåŸºäºå¯¹è¯»å’Œå†™æ“ä½œçš„ä¼˜å…ˆçº§ï¼Œè¯»å†™é”çš„è®¾è®¡å’Œå®ç°ä¹Ÿåˆ†æˆä¸‰ç±»ã€‚Read-preferringï¼šè¯»ä¼˜å…ˆçš„è®¾è®¡å¯ä»¥æä¾›å¾ˆé«˜çš„å¹¶å‘æ€§ï¼Œä½†æ˜¯ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´å†™é¥¥é¥¿ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæœ‰å¤§é‡çš„è¯»ï¼Œè¿™ç§è®¾è®¡ä¼šå¯¼è‡´åªæœ‰æ‰€æœ‰çš„è¯»éƒ½é‡Šæ”¾äº†é”ä¹‹åï¼Œå†™æ‰å¯èƒ½è·å–åˆ°é”ã€‚</li><li>Write-preferringï¼šå†™ä¼˜å…ˆçš„è®¾è®¡æ„å‘³ç€ï¼Œå¦‚æœå·²ç»æœ‰ä¸€ä¸ª writer åœ¨ç­‰å¾…è¯·æ±‚é”çš„è¯ï¼Œå®ƒä¼šé˜»æ­¢æ–°æ¥çš„è¯·æ±‚é”çš„ reader è·å–åˆ°é”ï¼Œæ‰€ä»¥ä¼˜å…ˆä¿éšœ writerã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ä¸€äº› reader å·²ç»è¯·æ±‚äº†é”çš„è¯ï¼Œæ–°è¯·æ±‚çš„ writer ä¹Ÿä¼šç­‰å¾…å·²ç»å­˜åœ¨çš„ reader éƒ½é‡Šæ”¾é”ä¹‹åæ‰èƒ½è·å–ã€‚æ‰€ä»¥ï¼Œå†™ä¼˜å…ˆçº§è®¾è®¡ä¸­çš„ä¼˜å…ˆæƒæ˜¯é’ˆå¯¹æ–°æ¥çš„è¯·æ±‚è€Œè¨€çš„ã€‚è¿™ç§è®¾è®¡ä¸»è¦é¿å…äº† writer çš„é¥¥é¥¿é—®é¢˜ã€‚</li><li>ä¸æŒ‡å®šä¼˜å…ˆçº§ï¼šè¿™ç§è®¾è®¡æ¯”è¾ƒç®€å•ï¼Œä¸åŒºåˆ† reader å’Œ writer ä¼˜å…ˆçº§ï¼ŒæŸäº›åœºæ™¯ä¸‹è¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¾è®¡åè€Œæ›´æœ‰æ•ˆï¼Œå› ä¸ºç¬¬ä¸€ç±»ä¼˜å…ˆçº§ä¼šå¯¼è‡´å†™é¥¥é¥¿ï¼Œç¬¬äºŒç±»ä¼˜å…ˆçº§å¯èƒ½ä¼šå¯¼è‡´è¯»é¥¥é¥¿ï¼Œè¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¿é—®ä¸å†åŒºåˆ†è¯»å†™ï¼Œå¤§å®¶éƒ½æ˜¯åŒä¸€ä¸ªä¼˜å…ˆçº§ï¼Œè§£å†³äº†é¥¥é¥¿çš„é—®é¢˜ã€‚</li></ul><p>Go æ ‡å‡†åº“ä¸­çš„ RWMutex è®¾è®¡æ˜¯ Write-preferring æ–¹æ¡ˆã€‚ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„ Lock è°ƒç”¨ä¼šæ’é™¤æ–°çš„ reader è¯·æ±‚åˆ°é”ã€‚</p><h2 id=rwmutexçš„é”>RWMutexçš„é”<a hidden class=anchor aria-hidden=true href=#rwmutexçš„é”>#</a></h2><p>RWMutex æ˜¯â¼€ä¸ªå¤š writer å¤š reader çš„è¯»å†™é”ï¼Œæ‰€ä»¥åŒæ—¶å¯èƒ½æœ‰å¤šä¸ª writer å’Œ readerã€‚é‚£ ä¹ˆï¼Œä¸ºäº†é¿å… writer ä¹‹é—´çš„ç«äº‰ï¼ŒRWMutex å°±ä¼šä½¿ç”¨â¼€ä¸ª Mutex æ¥ä¿è¯ writer çš„äº’æ–¥ã€‚</p><ul><li>åœ¨ Lock æ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆè·å–å†…éƒ¨äº’æ–¥é”ï¼Œæ‰ä¼šä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼›</li><li>åœ¨ Unlock æ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼Œæ‰ä¼šé‡Šæ”¾å†…éƒ¨äº’æ–¥é”ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å­—æ®µçš„ä¿®æ”¹ä¹Ÿå—åˆ°äº’æ–¥é”çš„ä¿æŠ¤ã€‚</li></ul><blockquote><p>ä½¿ç”¨è¯»å†™é”æœ€éœ€è¦æ³¨æ„çš„â¼€ç‚¹å°±æ˜¯å°½é‡é¿å…é‡å…¥ï¼Œé‡å…¥å¸¦æ¥çš„æ­»é”â¾®å¸¸éšè”½ï¼Œâ½½ä¸”éš¾ä»¥ è¯Šæ–­ã€‚</p></blockquote><h1 id=waitgroupååŒç­‰å¾…ä»»åŠ¡ç¼–æ’åˆ©å™¨>WaitGroupï¼šååŒç­‰å¾…ï¼Œä»»åŠ¡ç¼–æ’åˆ©å™¨<a hidden class=anchor aria-hidden=true href=#waitgroupååŒç­‰å¾…ä»»åŠ¡ç¼–æ’åˆ©å™¨>#</a></h1><h2 id=waitgroupåŸºæœ¬ç”¨æ³•>WaitGroupåŸºæœ¬ç”¨æ³•<a hidden class=anchor aria-hidden=true href=#waitgroupåŸºæœ¬ç”¨æ³•>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Add</span>(delta <span style=color:#ff7b72>int</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span></code></pre></td></tr></table></div></div><ul><li>Addï¼Œç”¨æ¥è®¾ç½® WaitGroup çš„è®¡æ•°å€¼ï¼›</li><li>Doneï¼Œç”¨æ¥å°† WaitGroup çš„è®¡æ•°å€¼å‡ 1ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† Add(-1)ï¼›</li><li>Waitï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ goroutine ä¼šâ¼€ç›´é˜»å¡ï¼Œç›´åˆ° WaitGroup çš„è®¡æ•°å€¼å˜ä¸º 0ã€‚</li></ul><h2 id=waitgroupæ•°æ®ç»“æ„>WaitGroupæ•°æ®ç»“æ„<a hidden class=anchor aria-hidden=true href=#waitgroupæ•°æ®ç»“æ„>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> WaitGroup <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// é¿å…å¤åˆ¶ä½¿ç”¨çš„â¼€ä¸ªæŠ€å·§ï¼Œå¯ä»¥å‘Šè¯‰vetâ¼¯å…·è¿åäº†å¤åˆ¶ä½¿ç”¨çš„è§„åˆ™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		noCopy noCopy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 64bit(8bytes)çš„å€¼åˆ†æˆä¸¤æ®µï¼Œâ¾¼32bitæ˜¯è®¡æ•°å€¼ï¼Œä½32bitæ˜¯waiterçš„è®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// å¦å¤–32bitæ˜¯ç”¨ä½œä¿¡å·é‡çš„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// å› ä¸º64bitå€¼çš„åŸå­æ“ä½œéœ€è¦64bitå¯¹â»¬ï¼Œä½†æ˜¯32bitç¼–è¯‘å™¨ä¸â½€æŒï¼Œæ‰€ä»¥æ•°ç»„ä¸­çš„å…ƒç´ åœ¨ä¸åŒçš„æ¶æ„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// æ€»ä¹‹ï¼Œä¼šæ‰¾åˆ°å¯¹â»¬çš„é‚£64bitä½œä¸ºstateï¼Œå…¶ä½™çš„32bitåšä¿¡å·é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		state1 [<span style=color:#a5d6ff>3</span>]<span style=color:#ff7b72>uint32</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¾—åˆ°stateçš„åœ°å€å’Œä¿¡å·é‡çš„åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>state</span>() (statep <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, semap <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>) {
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> uintptr(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1))<span style=color:#ff7b72;font-weight:700>%</span><span style=color:#a5d6ff>8</span> <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¦‚æœåœ°å€æ˜¯64bitå¯¹â»¬çš„ï¼Œæ•°ç»„å‰ä¸¤ä¸ªå…ƒç´ åšstateï¼Œåâ¼€ä¸ªå…ƒç´ åšä¿¡å·é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>return</span> (<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>)(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1)), <span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>2</span>]
</span></span><span style=display:flex><span>} <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¦‚æœåœ°å€æ˜¯32bitå¯¹â»¬çš„ï¼Œæ•°ç»„åä¸¤ä¸ªå…ƒç´ ç”¨æ¥åšstateï¼Œå®ƒå¯ä»¥ç”¨æ¥åš64bitçš„åŸå­æ“ä½œï¼Œç¬¬
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>return</span> (<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>)(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>1</span>])), <span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>WaitGroup æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚åªè¦ WaitGroup çš„è®¡æ•°å€¼æ¢å¤åˆ°é›¶å€¼çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«çœ‹ä½œæ˜¯æ–°åˆ›å»ºçš„ WaitGroupï¼Œè¢«é‡å¤ä½¿ç”¨</p></blockquote><h2 id=å°ç»“>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“>#</a></h2><ul><li>ä¸é‡ç”¨ WaitGroupã€‚æ–°å»ºâ¼€ä¸ª WaitGroup ä¸ä¼šå¸¦æ¥å¤šâ¼¤çš„èµ„æºå¼€é”€ï¼Œé‡ç”¨åâ½½æ›´å®¹æ˜“å‡º é”™ã€‚</li><li>ä¿è¯æ‰€æœ‰çš„ Add æ–¹æ³•è°ƒç”¨éƒ½åœ¨ Wait ä¹‹å‰ã€‚</li><li>ä¸ä¼ é€’è´Ÿæ•°ç»™ Add æ–¹æ³•ï¼Œåªé€šè¿‡ Done æ¥ç»™è®¡æ•°å€¼å‡ 1ã€‚</li><li>ä¸åšå¤šä½™çš„ Done æ–¹æ³•è°ƒç”¨ï¼Œä¿è¯ Add çš„è®¡æ•°å€¼å’Œ Done æ–¹æ³•è°ƒç”¨çš„æ•°é‡æ˜¯â¼€æ ·çš„ã€‚</li><li>ä¸é—æ¼ Done æ–¹æ³•çš„è°ƒç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ Wait hang ä½â½†æ³•è¿”å›ã€‚</li></ul><h1 id=cond>Cond<a hidden class=anchor aria-hidden=true href=#cond>#</a></h1><p>Go æ ‡å‡†åº“æä¾› Cond åŸè¯­çš„ç›®çš„æ˜¯ï¼Œä¸ºç­‰å¾… / é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›â½€æŒã€‚</p><h2 id=cond-çš„åŸºæœ¬ç”¨æ³•>Cond çš„åŸºæœ¬ç”¨æ³•<a hidden class=anchor aria-hidden=true href=#cond-çš„åŸºæœ¬ç”¨æ³•>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Cond
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>NeWCond</span>(l Locker) <span style=color:#ff7b72;font-weight:700>*</span>Cond
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Broadcast</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Signal</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span></code></pre></td></tr></table></div></div><ul><li>â¾¸å…ˆï¼ŒCond å…³è”çš„ Locker å®ä¾‹å¯ä»¥é€šè¿‡ c.L è®¿é—®ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ç€â¼€ä¸ªå…ˆå…¥å…ˆå‡ºçš„ç­‰å¾…é˜Ÿ åˆ—ã€‚</li><li>Signal æ–¹æ³•ï¼Œå…è®¸è°ƒç”¨è€… Caller å”¤é†’â¼€ä¸ªç­‰å¾…æ­¤ Cond çš„ goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„goroutineï¼Œæ˜¾ç„¶â½†éœ€é€šçŸ¥ waiterï¼›å¦‚æœ Cond ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰â¼€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™éœ€è¦ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç¬¬â¼€ä¸ª goroutine å¹¶æŠŠå®ƒå”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œâ½å¦‚ Java è¯­â¾”ä¸­ï¼ŒSignal æ–¹æ³•ä¹Ÿè¢«å«åš notify æ–¹æ³•ã€‚<ul><li>è°ƒç”¨ Signal æ–¹æ³•æ—¶ï¼Œä¸å¼ºæ±‚ä½ â¼€å®šè¦æŒæœ‰ c.L çš„é”ã€‚</li></ul></li><li>Broadcast æ–¹æ³•ï¼Œå…è®¸è°ƒç”¨è€… Caller å”¤é†’æ‰€æœ‰ç­‰å¾…æ­¤ Cond çš„ goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„ goroutineï¼Œæ˜¾ç„¶â½†éœ€é€šçŸ¥ waiterï¼›å¦‚æœ Cond ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰â¼€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™æ¸…ç©ºæ‰€æœ‰ç­‰å¾…çš„ goroutineï¼Œå¹¶å…¨éƒ¨å”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­â¾”ä¸­ï¼Œâ½å¦‚ Java è¯­â¾”ä¸­ï¼ŒBroadcast æ–¹æ³•ä¹Ÿè¢«å«åš notifyAll æ–¹æ³•ã€‚<ul><li>åŒæ ·åœ°ï¼Œè°ƒç”¨ Broadcast æ–¹æ³•æ—¶ï¼Œä¹Ÿä¸å¼ºæ±‚ä½ â¼€å®šæŒæœ‰ c.L çš„é”ã€‚</li></ul></li><li>Wait æ–¹æ³•ï¼Œä¼šæŠŠè°ƒç”¨è€… Caller æ”¾å…¥ Cond çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶é˜»å¡ï¼Œç›´åˆ°è¢« Signal æˆ–è€…Broadcast çš„æ–¹æ³•ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶å”¤é†’ã€‚<ul><li>è°ƒç”¨ Wait æ–¹æ³•æ—¶å¿…é¡»è¦æŒæœ‰ c.L çš„é”ã€‚</li></ul></li></ul><h2 id=æ¡ˆä¾‹>æ¡ˆä¾‹<a hidden class=anchor aria-hidden=true href=#æ¡ˆä¾‹>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> sync.<span style=color:#d2a8ff;font-weight:700>NewCond</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>sync.Mutex{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>var</span> ready <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt;<span style=color:#a5d6ff>10</span> ; i<span style=color:#ff7b72;font-weight:700>++</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>(i <span style=color:#ff7b72>int</span>) {
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.<span style=color:#d2a8ff;font-weight:700>Duration</span>(rand.<span style=color:#d2a8ff;font-weight:700>Int63n</span>(<span style=color:#a5d6ff>10</span>)) <span style=color:#ff7b72;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// åŠ é”æ›´æ”¹ç­‰å¾…æ¡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			c.L.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>			ready<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>			c.L.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>			log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;è¿åŠ¨å‘˜#%d å‡†å¤‡å°±ç»ª\\n&#34;</span>, i)
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// å¹¿æ’­å”¤é†’æ‰€æœ‰çš„ç­‰å¾…ç€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			c.<span style=color:#d2a8ff;font-weight:700>Broadcast</span>()
</span></span><span style=display:flex><span>		}(i)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	c.L.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> ready<span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#a5d6ff>10</span>{
</span></span><span style=display:flex><span>		c.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>		log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;è£åˆ¤å‘˜è¢«å”¤é†’ä¸€æ¬¡&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	c.L.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// æ‰€æœ‰è¿åŠ¨å‘˜æ˜¯å¦å‡†å¤‡å°±ç»ª
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	log.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;æ‰€æœ‰è¿åŠ¨å‘˜å‡†å¤‡å°±ç»ªï¼Œæ¯”èµ›å¼€å§‹ï¼&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=å°ç»“-1>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“-1>#</a></h2><ul><li>Cond æ˜¯ä¸ºç­‰å¾… / é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›â½€æŒçš„ã€‚å®ƒæä¾›äº†æ¡ä»¶å˜é‡çš„ä¸‰ä¸ªåŸºæœ¬æ–¹æ³•Signalã€Broadcast å’Œ Waitï¼Œä¸ºå¹¶å‘çš„ goroutine æä¾›ç­‰å¾… / é€šçŸ¥æœºåˆ¶ã€‚</li><li>ä½¿ç”¨ Cond ä¹‹æ‰€ä»¥å®¹æ˜“å‡ºé”™ï¼Œå°±æ˜¯ Wait è°ƒç”¨éœ€è¦åŠ é”ï¼Œä»¥åŠè¢«å”¤é†’åâ¼€å®šè¦æ£€æŸ¥æ¡ä»¶æ˜¯å¦çœŸ çš„å·²ç»æ»¡â¾œã€‚ä½ éœ€è¦ç‰¢è®°è¿™ä¸¤ç‚¹ã€‚</li><li>WaitGroupå’Œ Cond çš„åŒºåˆ«ï¼šWaitGroup æ˜¯ä¸» goroutine ç­‰å¾…ç¡®å®šæ•°é‡çš„å­ goroutine å®Œæˆä»»åŠ¡ï¼›â½½ Cond æ˜¯ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡â¾œï¼Œè¿™ä¸ªæ¡ä»¶çš„ä¿®æ”¹å¯ä»¥è¢«ä»»æ„å¤šçš„ goroutine æ›´æ–°ï¼Œâ½½ä¸” Condçš„ Wait ä¸å…³â¼¼ä¹Ÿä¸çŸ¥é“å…¶ä»– goroutine çš„æ•°é‡ï¼Œåªå…³â¼¼ç­‰å¾…æ¡ä»¶ã€‚â½½ä¸” Cond è¿˜æœ‰å•ä¸ªé€šçŸ¥çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ Signal æ–¹æ³•ã€‚</li></ul><h1 id=once>Once<a hidden class=anchor aria-hidden=true href=#once>#</a></h1><p>Onceå¯ä»¥ç”¨æ¥æ‰§è¡Œä¸”ä»…ä»…æ‰§è¡Œâ¼€æ¬¡åŠ¨ä½œï¼Œå¸¸å¸¸ç”¨äºå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–åœºæ™¯ã€‚</p><h2 id=ä½¿ç”¨åœºæ™¯>ä½¿ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨åœºæ™¯>#</a></h2><p>sync.Once åªæš´éœ²äº†â¼€ä¸ªæ–¹æ³• Doï¼Œä½ å¯ä»¥å¤šæ¬¡è°ƒç”¨ Do æ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ç¬¬â¼€æ¬¡è°ƒç”¨ Do æ–¹æ³• æ—¶ f å‚æ•°æ‰ä¼šæ‰§è¡Œï¼Œè¿™â¾¥çš„ f æ˜¯â¼€ä¸ªâ½†å‚æ•°â½†è¿”å›å€¼çš„å‡½æ•°ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span> <span style=color:#ff7b72>func</span> (o <span style=color:#ff7b72;font-weight:700>*</span>Once) <span style=color:#d2a8ff;font-weight:700>Do</span>(f <span style=color:#ff7b72>func</span>())
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Once å¸¸å¸¸ç”¨æ¥åˆå§‹åŒ–å•ä¾‹èµ„æºï¼Œæˆ–è€…å¹¶å‘è®¿é—®åªéœ€åˆå§‹åŒ–â¼€æ¬¡çš„å…±äº«èµ„æºï¼Œæˆ–è€…åœ¨æµ‹è¯•çš„æ—¶å€™åˆå§‹åŒ–â¼€æ¬¡æµ‹è¯•èµ„æºã€‚</p></blockquote><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>var</span> once sync.Once
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	f1<span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#ff7b72>func</span>(){
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;f1 exceï¼&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	once.<span style=color:#d2a8ff;font-weight:700>Do</span>(f1)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	f2 <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;f2 exce&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	once.<span style=color:#d2a8ff;font-weight:700>Do</span>(f2)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=å°ç»“-2>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“-2>#</a></h2><blockquote><p>â¼€æ—¦ä½ é‡åˆ°åªéœ€è¦åˆå§‹åŒ–â¼€æ¬¡çš„åœºæ™¯ï¼Œâ¾¸å…ˆæƒ³åˆ°çš„å°±åº”è¯¥æ˜¯ Once å¹¶å‘åŸè¯­ã€‚</p></blockquote><h1 id=pool>Pool<a hidden class=anchor aria-hidden=true href=#pool>#</a></h1><p>Go æ ‡å‡†åº“ä¸­æä¾›äº†â¼€ä¸ªé€šç”¨çš„ Pool æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ sync.Poolï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒå¯ä»¥åˆ›å»ºæ± åŒ–çš„å¯¹è±¡ã€‚ä½†æ˜¯å®ƒæ± åŒ–çš„å¯¹è±¡å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚</p><ul><li>sync.Pool æ•°æ®ç±»å‹ç”¨æ¥ä¿å­˜â¼€ç»„å¯ç‹¬ç«‹è®¿é—®çš„ä¸´æ—¶å¯¹è±¡ã€‚<ul><li>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ± åŒ–çš„å¯¹è±¡ä¼šåœ¨æœªæ¥çš„æŸä¸ªæ—¶å€™è¢«æ¯«æ— é¢„å…†åœ°ç§»é™¤æ‰ã€‚è€Œä¸”ï¼Œå¦‚æœæ²¡æœ‰åˆ«çš„å¯¹è±¡å¼•ç”¨è¿™ä¸ªè¢«ç§»é™¤çš„å¯¹è±¡çš„è¯ï¼Œè¿™ä¸ªè¢«ç§»é™¤çš„å¯¹è±¡å°±ä¼šè¢«åƒåœ¾å›æ”¶æ‰ã€‚</li></ul></li></ul><h3 id=æ³¨æ„ç‚¹>æ³¨æ„ç‚¹<a hidden class=anchor aria-hidden=true href=#æ³¨æ„ç‚¹>#</a></h3><ul><li><ol><li>sync.Pool æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ª goroutine å¯ä»¥å¹¶å‘åœ°è°ƒç”¨å®ƒçš„æ–¹æ³•å­˜å–å¯¹è±¡ï¼›</li></ol></li><li><ol><li>sync.Pool ä¸å¯åœ¨ä½¿ç”¨ä¹‹åå†å¤åˆ¶ä½¿ç”¨ã€‚</li></ol></li></ul><h2 id=æ–¹æ³•ä»‹ç»>æ–¹æ³•ä»‹ç»<a hidden class=anchor aria-hidden=true href=#æ–¹æ³•ä»‹ç»>#</a></h2><p>1.New</p><ul><li>Pool struct åŒ…å«â¼€ä¸ª New å­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯å‡½æ•° func() interface{}ã€‚å½“è°ƒç”¨ Pool çš„ Get æ–¹æ³•ä»æ± ä¸­è·å–å…ƒç´ ï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²å…ƒç´ å¯è¿”å›æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ª New æ–¹æ³•æ¥åˆ›å»ºæ–° çš„å…ƒç´ ã€‚å¦‚æœä½ æ²¡æœ‰è®¾ç½® New å­—æ®µï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²å…ƒç´ å¯è¿”å›æ—¶ï¼ŒGet æ–¹æ³•å°†è¿”å› nilï¼Œè¡¨ æ˜å½“å‰æ²¡æœ‰å¯ç”¨çš„å…ƒç´ ã€‚ æœ‰è¶£çš„æ˜¯ï¼ŒNew æ˜¯å¯å˜çš„å­—æ®µã€‚è¿™å°±æ„å‘³ç€ï¼Œä½ å¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æ”¹å˜åˆ›å»ºå…ƒç´ çš„æ–¹ æ³•ã€‚å½“ç„¶ï¼Œå¾ˆå°‘æœ‰â¼ˆä¼šè¿™ä¹ˆåšï¼Œå› ä¸ºâ¼€èˆ¬æˆ‘ä»¬åˆ›å»ºå…ƒç´ çš„é€»è¾‘éƒ½æ˜¯â¼€è‡´çš„ï¼Œè¦åˆ›å»ºçš„ä¹Ÿæ˜¯åŒâ¼€ ç±»çš„å…ƒç´ ï¼Œæ‰€ä»¥ä½ åœ¨ä½¿ç”¨ Pool çš„æ—¶å€™ä¹Ÿæ²¡å¿…è¦ç©â¼€äº›â€œèŠ±æ´»â€ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶æ›´æ”¹ New çš„ å€¼ã€‚</li></ul><p>2.Get</p><ul><li>å¦‚æœè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°±ä¼šä» Poolå–â¾›â¼€ä¸ªå…ƒç´ ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ä¸ªå…ƒç´ ä¼šä» Pool ä¸­ç§»é™¤ï¼Œ è¿”å›ç»™è°ƒç”¨è€…ã€‚ä¸è¿‡ï¼Œé™¤äº†è¿”å›å€¼æ˜¯æ­£å¸¸å®ä¾‹åŒ–çš„å…ƒç´ ï¼ŒGet æ–¹æ³•çš„è¿”å›å€¼è¿˜å¯èƒ½ä¼šæ˜¯â¼€ä¸ª nilï¼ˆPool.New å­—æ®µæ²¡æœ‰è®¾ç½®ï¼Œâ¼œæ²¡æœ‰ç©ºé—²å…ƒç´ å¯ä»¥è¿”å›ï¼‰ï¼Œæ‰€ä»¥ä½ åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦ åˆ¤æ–­ã€‚</li></ul><p>3.Put</p><ul><li>è¿™ä¸ªæ–¹æ³•ç”¨äºå°†â¼€ä¸ªå…ƒç´ è¿”è¿˜ç»™ Poolï¼ŒPool ä¼šæŠŠè¿™ä¸ªå…ƒç´ ä¿å­˜åˆ°æ± ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å¤ç”¨ã€‚ä½†å¦‚ æœ Put â¼€ä¸ª nil å€¼ï¼ŒPool å°±ä¼šå¿½ç•¥è¿™ä¸ªå€¼ã€‚</li></ul><h2 id=æ¨èçš„ä¸‰æ–¹pool>æ¨èçš„ä¸‰æ–¹pool<a hidden class=anchor aria-hidden=true href=#æ¨èçš„ä¸‰æ–¹pool>#</a></h2><ul><li><code>gammazero/workerpool</code>ï¼šgammazero/workerpool å¯ä»¥â½†é™åˆ¶åœ°æäº¤ä»»åŠ¡ï¼Œæä¾›äº†æ›´ä¾¿åˆ©çš„ Submit å’Œ SubmitWait æ–¹æ³•æäº¤ä»»åŠ¡ï¼Œè¿˜å¯ä»¥æä¾›å½“å‰çš„ worker æ•°å’Œä»»åŠ¡æ•°ä»¥åŠå…³é—­ Pool çš„åŠŸèƒ½ã€‚</li><li><code>ivpusic/grpool</code>ï¼šgrpool åˆ›å»º Pool çš„æ—¶å€™éœ€è¦æä¾› Worker çš„æ•°é‡å’Œç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„ æœ€â¼¤æ•°é‡ï¼Œä»»åŠ¡çš„æäº¤æ˜¯ç›´æ¥å¾€ Channel æ”¾å…¥ä»»åŠ¡ã€‚</li><li><code>dpaks/goworkers</code>ï¼šdpaks/goworkers æä¾›äº†æ›´ä¾¿åˆ©çš„ Submit æ–¹æ³•æäº¤ä»»åŠ¡ä»¥åŠWorker æ•°ã€ä»»åŠ¡æ•°ç­‰æŸ¥è¯¢æ–¹æ³•ã€å…³é—­ Pool çš„æ–¹æ³•ã€‚å®ƒçš„ä»»åŠ¡çš„æ‰§è¡Œç»“æœéœ€è¦åœ¨ResultChan å’Œ ErrChan ä¸­å»è·å–ï¼Œæ²¡æœ‰æä¾›é˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½® Worker çš„æ•°é‡å’Œä»»åŠ¡æ•°ã€‚</li></ul><h2 id=poolå¯èƒ½é€ æˆçš„é—®é¢˜>poolå¯èƒ½é€ æˆçš„é—®é¢˜<a hidden class=anchor aria-hidden=true href=#poolå¯èƒ½é€ æˆçš„é—®é¢˜>#</a></h2><ul><li>å†…å­˜æ³„æ¼<ul><li>åœ¨ä½¿ç”¨ sync.Pool å›æ”¶ buffer çš„æ—¶å€™ï¼Œâ¼€å®šè¦æ£€æŸ¥å›æ”¶çš„å¯¹è±¡çš„â¼¤â¼©ã€‚å¦‚æœ buffer å¤ªâ¼¤ï¼Œå°± ä¸è¦å›æ”¶äº†ï¼Œå¦åˆ™å°±å¤ªæµªè´¹äº†</li></ul></li><li>å†…å­˜æµªè´¹<ul><li>è¦åšåˆ°ç‰©å°½å…¶ç”¨ï¼Œå°½å¯èƒ½ä¸æµªè´¹çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å°† buffer æ± åˆ†æˆâ¼å±‚</li><li>â¼©äº 512 byteçš„å…ƒç´ çš„ buffer å â¼€ä¸ªæ± å­ï¼›å…¶æ¬¡ï¼Œâ¼©äº 1K byte â¼¤â¼©çš„å…ƒç´ å â¼€ä¸ªæ± å­ï¼›å†æ¬¡ï¼Œâ¼©äº 4Kbyte â¼¤â¼©çš„å…ƒç´ å â¼€ä¸ªæ± å­ã€‚è¿™æ ·åˆ†æˆâ¼ä¸ªæ± å­ä»¥åï¼Œå°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œåˆ°æ‰€éœ€â¼¤â¼©çš„æ± å­ä¸­è·å– buffer äº†ã€‚</li></ul></li></ul><h2 id=å°ç»“-3>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“-3>#</a></h2><ul><li>Pool æ˜¯â¼€ä¸ªé€šç”¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯è§£å†³å¯¹è±¡é‡ç”¨å’Œé¢„å…ˆåˆ†é…çš„â¼€ä¸ªå¸¸ç”¨çš„ä¼˜åŒ–â¼¿æ®µã€‚å³ä½¿ä½ â¾ƒâ¼° æ²¡åœ¨é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨è¿‡ï¼Œä½†è‚¯å®šåœ¨ä½¿ç”¨å…¶å®ƒåº“çš„æ—¶å€™ï¼Œå°±äº«å—åˆ°åº”ç”¨ Pool çš„å¥½å¤„äº†ï¼Œâ½å¦‚æ•° æ®åº“çš„è®¿é—®ã€http API çš„è¯·æ±‚ç­‰ç­‰ã€‚</li><li>æˆ‘ä»¬â¼€èˆ¬ä¸ä¼šåœ¨ç¨‹åºâ¼€å¼€å§‹çš„æ—¶å€™å°±å¼€å§‹è€ƒè™‘ä¼˜åŒ–ï¼Œâ½½æ˜¯ç­‰é¡¹ç›®å¼€å‘åˆ°â¼€ä¸ªé˜¶æ®µï¼Œæˆ–è€…å¿«ç»“æŸ çš„æ—¶å€™ï¼Œæ‰å…¨â¾¯åœ°è€ƒè™‘ç¨‹åºä¸­çš„ä¼˜åŒ–ç‚¹ï¼Œâ½½ Pool å°±æ˜¯å¸¸ç”¨çš„â¼€ä¸ªä¼˜åŒ–â¼¿æ®µã€‚å¦‚æœä½ å‘ç°ç¨‹åº ä¸­æœ‰â¼€ç§ GC è€—æ—¶ç‰¹åˆ«â¾¼ï¼Œæœ‰â¼¤é‡çš„ç›¸åŒç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œä¸æ–­åœ°è¢«åˆ›å»ºé”€æ¯ï¼Œè¿™æ—¶ï¼Œä½ å°±å¯ ä»¥è€ƒè™‘çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡æ± åŒ–çš„â¼¿æ®µé‡ç”¨è¿™äº›å¯¹è±¡ã€‚</li><li>å¦å¤–ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…å¾®æœåŠ¡æ¡†æ¶ä¸­ï¼Œå¯èƒ½ä¼šæœ‰â¼¤é‡çš„å¹¶å‘ Client è¯·æ±‚ï¼Œå¦‚æœ Client çš„è€— æ—¶å â½å¾ˆâ¼¤ï¼Œä½ ä¹Ÿå¯ä»¥è€ƒè™‘æ± åŒ– Clientï¼Œä»¥ä¾¿é‡ç”¨ã€‚</li><li>å¦‚æœä½ å‘ç°ç³»ç»Ÿä¸­çš„ goroutine æ•°é‡â¾®å¸¸å¤šï¼Œç¨‹åºçš„å†…å­˜èµ„æºå ç”¨â½è¾ƒâ¼¤ï¼Œâ½½ä¸”æ•´ä½“ç³»ç»Ÿçš„è€— æ—¶å’Œ GC ä¹Ÿâ½è¾ƒâ¾¼ï¼Œæˆ‘å»ºè®®ä½ çœ‹çœ‹ï¼Œæ˜¯å¦èƒ½å¤Ÿé€šè¿‡ Worker Pool è§£å†³â¼¤é‡ goroutine çš„é—® é¢˜ï¼Œä»â½½é™ä½è¿™äº›æŒ‡æ ‡ã€‚</li></ul><h1 id=contextä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡>Contextï¼šä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡<a hidden class=anchor aria-hidden=true href=#contextä¿¡æ¯ç©¿é€ä¸Šä¸‹æ–‡>#</a></h1><p>åœ¨ APIä¹‹é—´æˆ–è€…æ–¹æ³•è°ƒç”¨ä¹‹é—´ï¼Œæ‰€ä¼ é€’çš„é™¤äº†ä¸šåŠ¡å‚æ•°ä¹‹å¤–çš„é¢å¤–ä¿¡æ¯ã€‚</p><h2 id=contextä½¿ç”¨åœºæ™¯>contextä½¿ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#contextä½¿ç”¨åœºæ™¯>#</a></h2><ul><li>ä¸Šä¸‹â½‚ä¿¡æ¯ä¼ é€’ ï¼ˆrequest-scopedï¼‰ï¼Œâ½å¦‚å¤„ç† http è¯·æ±‚ã€åœ¨è¯·æ±‚å¤„ç†é“¾è·¯ä¸Šä¼ é€’ä¿¡ æ¯ï¼›</li><li>æ§åˆ¶å­ goroutine çš„è¿è¡Œï¼›</li><li>è¶…æ—¶æ§åˆ¶çš„æ–¹æ³•è°ƒç”¨ï¼›</li><li>å¯ä»¥å–æ¶ˆçš„æ–¹æ³•è°ƒç”¨ã€‚</li></ul><h2 id=context-æ¥å£å‡½æ•°>context æ¥å£å‡½æ•°<a hidden class=anchor aria-hidden=true href=#context-æ¥å£å‡½æ•°>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Context <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Deadline</span>() (deadline time.Time, ok <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Done</span>() <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>struct</span>{}
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Err</span>() <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Value</span>(key <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>Deadline æ–¹æ³•ä¼šè¿”å›è¿™ä¸ª Context è¢«å–æ¶ˆçš„æˆªâ½Œâ½‡æœŸã€‚å¦‚æœæ²¡æœ‰è®¾ç½®æˆªâ½Œâ½‡æœŸï¼Œok çš„å€¼æ˜¯ falseã€‚åç»­æ¯æ¬¡è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ Deadline æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè¿”å›å’Œç¬¬â¼€æ¬¡è°ƒç”¨ç›¸åŒçš„ç»“æœã€‚</li><li>Done æ–¹æ³•è¿”å›â¼€ä¸ª Channel å¯¹è±¡ã€‚åœ¨ Context è¢«å–æ¶ˆæ—¶ï¼Œæ­¤ Channel ä¼šè¢« closeï¼Œå¦‚æœæ²¡ è¢«å–æ¶ˆï¼Œå¯èƒ½ä¼šè¿”å› nilã€‚åç»­çš„ Done è°ƒç”¨æ€»æ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚å½“ Done è¢« close çš„æ—¶ å€™ï¼Œä½ å¯ä»¥é€šè¿‡ ctx.Err è·å–é”™è¯¯ä¿¡æ¯ã€‚Done è¿™ä¸ªæ–¹æ³•åå…¶å®èµ·å¾—å¹¶ä¸å¥½ï¼Œå› ä¸ºåå­—å¤ªè¿‡ç¬¼ ç»Ÿï¼Œä¸èƒ½æ˜ç¡®åæ˜  Done è¢« close çš„åŸå› ï¼Œå› ä¸º cancelã€timeoutã€deadline éƒ½å¯èƒ½å¯¼è‡´</li><li>Done è¢« closeï¼Œä¸è¿‡ï¼Œç›®å‰è¿˜æ²¡æœ‰â¼€ä¸ªæ›´åˆé€‚çš„æ–¹æ³•åç§°ã€‚<ul><li>å¦‚æœ Done æ²¡æœ‰è¢« closeï¼ŒErr æ–¹æ³•è¿”å› nilï¼›å¦‚æœ Done è¢« closeï¼ŒErr æ–¹æ³•ä¼šè¿”å› Done è¢« close çš„åŸå› ã€‚</li></ul></li><li>Value è¿”å›æ­¤ ctx ä¸­å’ŒæŒ‡å®šçš„ key ç›¸å…³è”çš„ valueã€‚</li></ul><p>Context ä¸­å®ç°äº† 2 ä¸ªå¸¸ç”¨çš„ç”Ÿæˆé¡¶å±‚ Context çš„æ–¹æ³•ã€‚</p><ul><li><code>context.Background()</code>ï¼šè¿”å›â¼€ä¸ªâ¾® nil çš„ã€ç©ºçš„ Contextï¼Œæ²¡æœ‰ä»»ä½•å€¼ï¼Œä¸ä¼šè¢« cancelï¼Œä¸ä¼šè¶…æ—¶ï¼Œæ²¡æœ‰æˆªâ½Œâ½‡æœŸã€‚â¼€èˆ¬ç”¨åœ¨ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠåˆ›å»ºæ ¹ Context çš„æ—¶å€™</li><li><code>context.TODO()</code>ï¼šè¿”å›â¼€ä¸ªâ¾® nil çš„ã€ç©ºçš„ Contextï¼Œæ²¡æœ‰ä»»ä½•å€¼ï¼Œä¸ä¼šè¢« cancelï¼Œä¸ä¼šè¶…æ—¶ï¼Œæ²¡æœ‰æˆªâ½Œâ½‡æœŸã€‚å½“ä½ ä¸æ¸…æ¥šæ˜¯å¦è¯¥ç”¨ Contextï¼Œæˆ–è€…ç›®å‰è¿˜ä¸çŸ¥é“è¦ä¼ é€’â¼€äº›ä»€ä¹ˆä¸Šä¸‹â½‚ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</li></ul><h2 id=å…³äºcontextçš„ä¸€äº›çº¦å®šè§„å®š>å…³äºContextçš„ä¸€äº›çº¦å®šè§„å®š<a hidden class=anchor aria-hidden=true href=#å…³äºcontextçš„ä¸€äº›çº¦å®šè§„å®š>#</a></h2><ul><li><ol><li>â¼€èˆ¬å‡½æ•°ä½¿ç”¨ Context çš„æ—¶å€™ï¼Œä¼šæŠŠè¿™ä¸ªå‚æ•°æ”¾åœ¨ç¬¬â¼€ä¸ªå‚æ•°çš„ä½ç½®ã€‚ä»æ¥ä¸æŠŠ nil å½“Context ç±»å‹çš„å‚æ•°å€¼ï¼Œå¯ä»¥ä½¿ç”¨ context.Background() åˆ›å»ºâ¼€ä¸ªç©ºçš„ä¸Šä¸‹â½‚å¯¹è±¡ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ nilã€‚</li></ol></li><li>2.Context åªç”¨æ¥ä¸´æ—¶åšå‡½æ•°ä¹‹é—´çš„ä¸Šä¸‹â½‚é€ä¼ ï¼Œä¸èƒ½æŒä¹…åŒ– Context æˆ–è€…æŠŠ Context â»“ä¹…å­˜ã€‚<strong>æŠŠ Context æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€æœ¬åœ°â½‚ä»¶æˆ–è€…å…¨å±€å˜é‡ã€ç¼“å­˜ä¸­éƒ½æ˜¯é”™è¯¯çš„ç”¨æ³•</strong>ã€‚</li><li>3.key çš„ç±»å‹ä¸åº”è¯¥æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…å…¶å®ƒå†…å»ºç±»å‹ï¼Œå¦åˆ™å®¹æ˜“åœ¨åŒ…ä¹‹é—´ä½¿ç”¨ Context æ—¶å€™äº§ç”Ÿå†²çªã€‚ä½¿ç”¨ WithValue æ—¶ï¼Œkey çš„ç±»å‹åº”è¯¥æ˜¯â¾ƒâ¼°å®šä¹‰çš„ç±»å‹ã€‚</li><li>4.å¸¸å¸¸ä½¿ç”¨ struct{}ä½œä¸ºåº•å±‚ç±»å‹å®šä¹‰ key çš„ç±»å‹ã€‚å¯¹äº exported key çš„é™æ€ç±»å‹ï¼Œå¸¸å¸¸æ˜¯æ¥â¼æˆ–è€…æŒ‡é’ˆã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å†…å­˜åˆ†é…ã€‚</li></ul><h2 id=åº”ç”¨åœºæ™¯>åº”ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#åº”ç”¨åœºæ™¯>#</a></h2><p>mainå‡½æ•°è¿”å›æ—¶ï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šè¢«ç›´æ¥æ‰“æ–­ï¼Œç¨‹åºé€€å‡ºã€‚é™¤æ­¤ä¹‹å¤–å¦‚æœæƒ³é€šè¿‡ç¼–ç¨‹çš„æ–¹æ³•è®©ä¸€ä¸ªgoroutineä¸­æ–­å…¶ä»–goroutineçš„æ‰§è¡Œï¼Œåªèƒ½æ˜¯é€šè¿‡åœ¨å¤šä¸ªgoroutineé—´é€šè¿‡contextä¸Šä¸‹æ–‡å¯¹è±¡åŒæ­¥å–æ¶ˆä¿¡å·çš„æ–¹å¼æ¥å®ç°ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>			ctx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithCancel</span>(context.<span style=color:#d2a8ff;font-weight:700>Background</span>())
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>defer</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>			fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;goroutine exit&#34;</span>)
</span></span><span style=display:flex><span>			}()
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>ctx.<span style=color:#d2a8ff;font-weight:700>Done</span>():
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			}()
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(<span style=color:#a5d6ff>2</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><h1 id=atomic-åŸå­æ“ä½œ>atomic åŸå­æ“ä½œ<a hidden class=anchor aria-hidden=true href=#atomic-åŸå­æ“ä½œ>#</a></h1><p>åŸå­æ“ä½œï¼Œæ˜¯å› ä¸ºâ¼€ä¸ªåŸå­åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶å®ƒçº¿ç¨‹ä¸ä¼šçœ‹åˆ°æ‰§è¡Œâ¼€åŠçš„æ“ä½œç»“æœã€‚åœ¨å…¶å®ƒçº¿ç¨‹çœ‹æ¥ï¼ŒåŸå­æ“ä½œè¦ä¹ˆæ‰§è¡Œå®Œäº†ï¼Œè¦ä¹ˆè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œå°±åƒâ¼€ä¸ªæœ€â¼©çš„ç²’å­ - åŸå­â¼€æ ·ï¼Œä¸å¯åˆ†å‰²</p><h2 id=atomic-æä¾›çš„æ–¹æ³•>atomic æä¾›çš„æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#atomic-æä¾›çš„æ–¹æ³•>#</a></h2><ul><li>atomic æ“ä½œçš„å¯¹è±¡æ˜¯â¼€ä¸ªåœ°å€ï¼Œä½ éœ€è¦æŠŠå¯å¯»å€çš„å˜é‡çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ–¹æ³•ï¼Œâ½½ä¸æ˜¯æŠŠå˜é‡çš„å€¼ä¼ é€’ç»™æ–¹æ³•ã€‚</li></ul><h2 id=add>Add<a hidden class=anchor aria-hidden=true href=#add>#</a></h2><p>Add æ–¹æ³•å°±æ˜¯ç»™ç¬¬â¼€ä¸ªå‚æ•°åœ°å€ä¸­çš„å€¼å¢åŠ â¼€ä¸ª delta å€¼</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddInt32 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, delta <span style=color:#ff7b72>int32</span>) (new <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUint32 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// To subtract a signed positive constant value c from x, do AddUint32(&amp;x, ^uint32(c-1)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// In particular, to decrement x, do AddUint32(&amp;x, ^uint32(0)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, delta <span style=color:#ff7b72>uint32</span>) (new <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddInt64 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, delta <span style=color:#ff7b72>int64</span>) (new <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUint64 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// To subtract a signed positive constant value c from x, do AddUint64(&amp;x, ^uint64(c-1)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// In particular, to decrement x, do AddUint64(&amp;x, ^uint64(0)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, delta <span style=color:#ff7b72>uint64</span>) (new <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUintptr atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, delta <span style=color:#ff7b72>uintptr</span>) (new <span style=color:#ff7b72>uintptr</span>
</span></span></code></pre></td></tr></table></div></div><p>CAS ï¼ˆCompareAndSwapï¼‰</p><p>è¿™ä¸ªæ–¹æ³•ä¼šâ½è¾ƒå½“å‰ addr åœ°å€â¾¥çš„å€¼æ˜¯ä¸æ˜¯ oldï¼Œå¦‚æœä¸ç­‰äº oldï¼Œå°±è¿”å› falseï¼›å¦‚æœç­‰äºoldï¼Œå°±æŠŠæ­¤åœ°å€çš„å€¼æ›¿æ¢æˆ new å€¼ï¼Œè¿”å› trueã€‚è¿™å°±ç›¸å½“äºâ€œåˆ¤æ–­ç›¸ç­‰æ‰æ›¿æ¢â€ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, old, new <span style=color:#ff7b72>int32</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapInt64 executes the compare-and-swap operation for an int64 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, old, new <span style=color:#ff7b72>int64</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUint32 executes the compare-and-swap operation for a uint32 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, old, new <span style=color:#ff7b72>uint32</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUint64 executes the compare-and-swap operation for a uint64 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, old, new <span style=color:#ff7b72>uint64</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUintptr executes the compare-and-swap operation for a uintptr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, old, new <span style=color:#ff7b72>uintptr</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapPointer executes the compare-and-swap operation for a unsafe.Pointer value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, old, new unsafe.Pointer) (swapped <span style=color:#ff7b72>bool</span>)
</span></span></code></pre></td></tr></table></div></div><p>æ•ˆæœå¦‚ä¸‹</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>*</span>addr <span style=color:#ff7b72;font-weight:700>==</span> old {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>*</span>addr = new
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=swap>Swap<a hidden class=anchor aria-hidden=true href=#swap>#</a></h2><p>å¦‚æœä¸éœ€è¦â½è¾ƒæ—§å€¼ï¼Œåªæ˜¯â½è¾ƒç²—æš´åœ°æ›¿æ¢çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ Swap æ–¹æ³•ï¼Œå®ƒæ›¿æ¢åè¿˜å¯ä»¥ è¿”å›æ—§å€¼ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapInt32 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, new <span style=color:#ff7b72>int32</span>) (old <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapInt64 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, new <span style=color:#ff7b72>int64</span>) (old <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUint32 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, new <span style=color:#ff7b72>uint32</span>) (old <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUint64 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, new <span style=color:#ff7b72>uint64</span>) (old <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUintptr atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, new <span style=color:#ff7b72>uintptr</span>) (old <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapPointer atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer)
</span></span></code></pre></td></tr></table></div></div><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>old = <span style=color:#ff7b72;font-weight:700>*</span>addr
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>*</span>addr = new
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> old
</span></span></code></pre></td></tr></table></div></div><h2 id=load>Load<a hidden class=anchor aria-hidden=true href=#load>#</a></h2><p>Load æ–¹æ³•ä¼šå–å‡º addr åœ°å€ä¸­çš„å€¼ï¼Œå³ä½¿åœ¨å¤šå¤„ç†å™¨ã€å¤šæ ¸ã€æœ‰ CPU cache çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿèƒ½ä¿è¯ Load æ˜¯â¼€ä¸ªåŸå­æ“ä½œã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadInt32 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>) (val <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadInt64 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>) (val <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUint32 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>) (val <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUint64 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>) (val <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUintptr atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>) (val <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadPointer atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer) (val unsafe.Pointer)
</span></span></code></pre></td></tr></table></div></div><h2 id=store>Store<a hidden class=anchor aria-hidden=true href=#store>#</a></h2><p>Store æ–¹æ³•ä¼šæŠŠâ¼€ä¸ªå€¼å­˜å…¥åˆ°æŒ‡å®šçš„ addr åœ°å€ä¸­ï¼Œå³ä½¿åœ¨å¤šå¤„ç†å™¨ã€å¤šæ ¸ã€æœ‰ CPU cacheçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿèƒ½ä¿è¯ Store æ˜¯â¼€ä¸ªåŸå­æ“ä½œã€‚åˆ«çš„ goroutine é€šè¿‡ Load è¯»å–å‡ºæ¥ï¼Œä¸ä¼šçœ‹åˆ°å­˜å–äº†â¼€åŠçš„å€¼ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreInt32 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, val <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreInt64 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, val <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUint32 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, val <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUint64 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, val <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUintptr atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, val <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StorePointer atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StorePointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, val unsafe.Pointer
</span></span></code></pre></td></tr></table></div></div><h2 id=value-ç±»å‹>Value ç±»å‹<a hidden class=anchor aria-hidden=true href=#value-ç±»å‹>#</a></h2><p>å®ƒå¯ä»¥åŸå­åœ°å­˜å–å¯¹è±¡ç±»å‹ï¼Œä½†ä¹Ÿåªèƒ½å­˜å–ï¼Œä¸èƒ½ CAS å’Œ Swapï¼Œå¸¸å¸¸ç”¨åœ¨é…ç½®å˜æ›´ç­‰åœºæ™¯ä¸­</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// A Value must not be copied after first use.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Value <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	v <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (v <span style=color:#ff7b72;font-weight:700>*</span>Value) <span style=color:#d2a8ff;font-weight:700>Load</span>() (x <span style=color:#ff7b72>interface</span>{}) {<span style=color:#ff7b72;font-weight:700>...</span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (v <span style=color:#ff7b72;font-weight:700>*</span>Value) <span style=color:#d2a8ff;font-weight:700>Store</span>(x <span style=color:#ff7b72>interface</span>{}) {<span style=color:#ff7b72;font-weight:700>...</span>}
</span></span></code></pre></td></tr></table></div></div><h1 id=channelè§£å†³å¹¶å‘é—®é¢˜>Channelï¼šè§£å†³å¹¶å‘é—®é¢˜<a hidden class=anchor aria-hidden=true href=#channelè§£å†³å¹¶å‘é—®é¢˜>#</a></h1><p>CSPå…è®¸ä½¿ç”¨è¿›ç¨‹ç»„ä»¶æ¥æè¿°ç³»ç»Ÿï¼Œå®ƒä»¬ç‹¬â½´è¿è¡Œï¼Œå¹¶ä¸”åªé€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼é€šä¿¡ã€‚</p><h2 id=channel-çš„åº”ç”¨åœºæ™¯>Channel çš„åº”ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#channel-çš„åº”ç”¨åœºæ™¯>#</a></h2><blockquote><p>æ‰§è¡Œä¸šåŠ¡å¤„ç†çš„ goroutine ä¸è¦é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼é€šä¿¡ï¼Œâ½½æ˜¯è¦é€šè¿‡ Channel é€šä¿¡çš„æ–¹å¼åˆ†äº«æ•°æ®</p></blockquote><ul><li>â€œcommunicate by sharing memoryâ€æ˜¯ä¼ ç»Ÿçš„å¹¶å‘ç¼–ç¨‹å¤„ç†æ–¹å¼ï¼Œå°±æ˜¯æŒ‡ï¼Œå…±äº«çš„æ•°æ®éœ€è¦ç”¨é”è¿›è¡Œä¿æŠ¤ï¼Œgoroutine éœ€è¦è·å–åˆ°é”ï¼Œæ‰èƒ½å¹¶å‘è®¿é—®æ•°æ®ã€‚</li><li>â€œshare memory by communicatingâ€åˆ™æ˜¯ç±»ä¼¼äº CSP æ¨¡å‹çš„æ–¹å¼ï¼Œé€šè¿‡é€šä¿¡çš„æ–¹å¼ï¼Œâ¼€ä¸ªgoroutine å¯ä»¥æŠŠæ•°æ®çš„â€œæ‰€æœ‰æƒâ€äº¤ç»™å¦å¤–â¼€ä¸ª goroutineï¼ˆè™½ç„¶ Go ä¸­æ²¡æœ‰â€œæ‰€æœ‰æƒâ€çš„æ¦‚å¿µï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šè¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºæ˜¯æ‰€æœ‰æƒçš„è½¬ç§»ï¼‰ã€‚</li></ul><p>äº”å¤§åº”ç”¨åœºæ™¯</p><ul><li><code>æ•°æ®äº¤æµ</code>ï¼šå½“ä½œå¹¶å‘çš„ buffer æˆ–è€… queueï¼Œè§£å†³ç”Ÿäº§è€… - æ¶ˆè´¹è€…é—®é¢˜ã€‚å¤šä¸ª goroutine å¯ä»¥å¹¶å‘å½“ä½œç”Ÿäº§è€…ï¼ˆProducerï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ã€‚</li><li><code>æ•°æ®ä¼ é€’</code>ï¼šâ¼€ä¸ª goroutine å°†æ•°æ®äº¤ç»™å¦â¼€ä¸ª goroutineï¼Œç›¸å½“äºæŠŠæ•°æ®çš„æ‹¥æœ‰æƒ (å¼•ç”¨)æ‰˜ä»˜å‡ºå»ã€‚</li><li><code>ä¿¡å·é€šçŸ¥</code>ï¼šâ¼€ä¸ª goroutine å¯ä»¥å°†ä¿¡å· (closingã€closedã€data ready ç­‰) ä¼ é€’ç»™å¦â¼€ä¸ªæˆ–è€…å¦â¼€ç»„ goroutine ã€‚</li><li><code>ä»»åŠ¡ç¼–æ’</code>ï¼šå¯ä»¥è®©â¼€ç»„ goroutine æŒ‰ç…§â¼€å®šçš„é¡ºåºå¹¶å‘æˆ–è€…ä¸²è¡Œçš„æ‰§è¡Œï¼Œè¿™å°±æ˜¯ç¼–æ’çš„åŠŸèƒ½ã€‚</li><li><code>é”</code>ï¼šåˆ©ç”¨ Channel ä¹Ÿå¯ä»¥å®ç°äº’æ–¥é”çš„æœºåˆ¶ã€‚</li></ul><h2 id=channel-åŸºæœ¬ç”¨æ³•>channel åŸºæœ¬ç”¨æ³•<a hidden class=anchor aria-hidden=true href=#channel-åŸºæœ¬ç”¨æ³•>#</a></h2><blockquote><p><code>&lt;-</code> væœ‰ä¸ªè§„åˆ™ï¼Œæ€»æ˜¯å°½é‡å’Œå·¦è¾¹çš„ chan ç»“åˆï¼ˆThe &lt;- operator associates with the leftmost chan possible:</p></blockquote><ul><li>nil æ˜¯ chan çš„é›¶å€¼ï¼Œæ˜¯â¼€ç§ç‰¹æ®Šçš„ chanï¼Œå¯¹å€¼æ˜¯ nil çš„ chan çš„å‘é€æ¥æ”¶è°ƒç”¨è€…æ€»æ˜¯ä¼šé˜»å¡</li></ul><h2 id=å…³äºchannelçš„é€‰æ‹©>å…³äºchannelçš„é€‰æ‹©<a hidden class=anchor aria-hidden=true href=#å…³äºchannelçš„é€‰æ‹©>#</a></h2><ul><li><ol><li>å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®ä½¿ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­ï¼›</li></ol></li><li><ol><li>å¤æ‚çš„ä»»åŠ¡ç¼–æ’å’Œæ¶ˆæ¯ä¼ é€’ä½¿ç”¨ Channelï¼›</li></ol></li><li><ol><li>æ¶ˆæ¯é€šçŸ¥æœºåˆ¶ä½¿ç”¨ Channelï¼Œé™¤éåªæƒ³ signal â¼€ä¸ª goroutineï¼Œæ‰ä½¿ç”¨ Condï¼›</li></ol></li><li><ol><li>ç®€å•ç­‰å¾…æ‰€æœ‰ä»»åŠ¡çš„å®Œæˆç”¨ WaitGroupï¼Œä¹Ÿæœ‰ Channel çš„æ¨å´‡è€…ç”¨ Channelï¼Œéƒ½å¯ä»¥ï¼›</li></ol></li><li><ol><li>éœ€è¦å’Œ Select è¯­å¥ç»“åˆï¼Œä½¿ç”¨ Channelï¼›</li></ol></li><li><ol><li>éœ€è¦å’Œè¶…æ—¶é…åˆæ—¶ï¼Œä½¿ç”¨ Channel å’Œ Contextã€‚</li></ol></li></ul><h2 id=chan-çš„ç¼–æ’æ–¹å¼>chan çš„ç¼–æ’æ–¹å¼<a hidden class=anchor aria-hidden=true href=#chan-çš„ç¼–æ’æ–¹å¼>#</a></h2><p>Or-Done æ¨¡å¼ã€æ‰‡å…¥æ¨¡å¼ã€æ‰‡å‡ºæ¨¡å¼ã€Stream å’Œ map-reduce</p><h3 id=or-done-æ¨¡å¼>Or-Done æ¨¡å¼<a hidden class=anchor aria-hidden=true href=#or-done-æ¨¡å¼>#</a></h3><p>Or-Done æ¨¡å¼æ˜¯ä¿¡å·é€šçŸ¥æ¨¡å¼ä¸­æ›´å®½æ³›çš„â¼€ç§æ¨¡å¼</p><p>æˆ‘ä»¬ä¼šä½¿ç”¨â€œä¿¡å·é€šçŸ¥â€å®ç°æŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåçš„é€šçŸ¥æœºåˆ¶ï¼Œåœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªä»»åŠ¡å®šä¹‰ â¼€ä¸ªç±»å‹ä¸º chan struct{}ç±»å‹çš„ done å˜é‡ï¼Œç­‰ä»»åŠ¡ç»“æŸåï¼Œæˆ‘ä»¬å°±å¯ä»¥ close è¿™ä¸ªå˜é‡ï¼Œ ç„¶åï¼Œå…¶å®ƒ receiver å°±ä¼šæ”¶åˆ°è¿™ä¸ªé€šçŸ¥ã€‚ è¿™æ˜¯æœ‰â¼€ä¸ªä»»åŠ¡çš„æƒ…å†µï¼Œå¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ï¼Œåªè¦æœ‰ä»»æ„â¼€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œæˆ‘ä»¬å°±æƒ³è·å¾—è¿™ä¸ªä¿¡ å·ï¼Œè¿™å°±æ˜¯ Or-Done æ¨¡å¼ã€‚</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// or or-done æ¨¡å¼ é€’å½’å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>or</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// ç‰¹æ®Šæƒ…å†µï¼Œåªæœ‰é›¶ä¸ª,1ä¸ªæˆ–2ä¸ª chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#ff7b72>switch</span> len(channels) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>2</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>channels[<span style=color:#a5d6ff>0</span>]:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>channels[<span style=color:#a5d6ff>1</span>]:
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	orDone <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(orDone)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// fmt.Println(&#34;æ‰§è¡Œ&#34;)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>if</span> len(channels) &gt; <span style=color:#a5d6ff>2</span> {
</span></span><span style=display:flex><span>			m <span style=color:#ff7b72;font-weight:700>:=</span> len(channels) <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>or</span>(channels[:m]<span style=color:#ff7b72;font-weight:700>...</span>):
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>or</span>(channels[m:]<span style=color:#ff7b72;font-weight:700>...</span>):
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> orDone
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>sig</span>(after time.Duration) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(after)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// orSelect åå°„â½…å¼ å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>orSelect</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// ç‰¹æ®Šæƒ…å†µï¼Œåªæœ‰é›¶ä¸ª,1ä¸ªæˆ–2ä¸ª chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#ff7b72>switch</span> len(channels) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	orDone <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(orDone)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// åˆ©ç”¨åå°„æ„å»ºSelectCase
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>var</span> cases []reflect.SelectCase
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> _, c <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> channels {
</span></span><span style=display:flex><span>			cases = append(cases, reflect.SelectCase{
</span></span><span style=display:flex><span>				Dir:  reflect.SelectRecv,
</span></span><span style=display:flex><span>				Chan: reflect.<span style=color:#d2a8ff;font-weight:700>ValueOf</span>(c),
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// éšæœºé€‰å–ä¸€ä¸ªå¯ç”¨ case
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		reflect.<span style=color:#d2a8ff;font-weight:700>Select</span>(cases)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> orDone
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>orSelect</span>(
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>10</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>20</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>30</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>40</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>50</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>01</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;done after %v&#34;</span>, time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=æ‰‡å…¥æ¨¡å¼>æ‰‡å…¥æ¨¡å¼<a hidden class=anchor aria-hidden=true href=#æ‰‡å…¥æ¨¡å¼>#</a></h3><p>æ‰‡å…¥å€Ÿé‰´äº†æ•°å­—ç”µè·¯çš„æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†å•ä¸ªé€»è¾‘ä»¬èƒ½å¤Ÿæ¥å—çš„æ•°å­—ä¿¡å·è¾“å…¥æœ€â¼¤é‡çš„æœ¯è¯­ã€‚â¼€ ä¸ªé€»è¾‘ä»¬å¯ä»¥æœ‰å¤šä¸ªè¾“å…¥ï¼Œâ¼€ä¸ªè¾“å‡ºã€‚</p><ul><li>åœ¨è½¯ä»¶â¼¯ç¨‹ä¸­ï¼Œ<strong>æ¨¡å—çš„æ‰‡å…¥æ˜¯æŒ‡æœ‰å¤šå°‘ä¸ªä¸Šçº§æ¨¡å—è°ƒç”¨å®ƒ</strong>ã€‚</li><li>è€Œå¯¹äºæˆ‘ä»¬è¿™é‡Œçš„ <code>Channel</code> æ‰‡å…¥æ¨¡å¼æ¥è¯´ï¼Œå°±æ˜¯æŒ‡æœ‰å¤šä¸ªæº <code>Channel</code> è¾“å…¥ã€â¼€ä¸ªç›®çš„<code> Channel</code> è¾“å‡ºçš„æƒ…å†µã€‚</li></ul><p>æ‰‡å…¥æ¯”å°±æ˜¯æº Channel æ•°é‡æ¯”1ã€‚</p><ul><li>æ¯ä¸ªæº Channel çš„å…ƒç´ éƒ½ä¼šå‘é€ç»™ç›®æ ‡ Channelï¼Œç›¸å½“äºç›®æ ‡ Channel çš„ receiver åªéœ€è¦ ç›‘å¬ç›®æ ‡ Channelï¼Œå°±å¯ä»¥æ¥æ”¶æ‰€æœ‰å‘é€ç»™æº Channel çš„æ•°æ®ã€‚</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ‰‡å…¥æ¨¡å¼ åå°„å®ç°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>fanInReflect</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	out<span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(out)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// æ„é€  SelectCases slice
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>var</span> cases []reflect.SelectCase
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> _, c <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> channels{
</span></span><span style=display:flex><span>			cases = append(cases, reflect.SelectCase{
</span></span><span style=display:flex><span>				Dir:  reflect.SelectRecv,
</span></span><span style=display:flex><span>				Chan: reflect.<span style=color:#d2a8ff;font-weight:700>ValueOf</span>(c),
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// å¾ªç¯ï¼Œä» cases ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>for</span> len(cases)&gt;<span style=color:#a5d6ff>0</span>{
</span></span><span style=display:flex><span>			i,v,ok<span style=color:#ff7b72;font-weight:700>:=</span>reflect.<span style=color:#d2a8ff;font-weight:700>Select</span>(cases)
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> !ok{ <span style=color:#8b949e;font-style:italic>// chan å…³é—­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>				cases = append(cases[:i],cases[i<span style=color:#ff7b72;font-weight:700>+</span><span style=color:#a5d6ff>1</span>:]<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			out <span style=color:#ff7b72;font-weight:700>&lt;-</span>v.<span style=color:#d2a8ff;font-weight:700>Interface</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> out
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}{
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>switch</span> len(channels){
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		c<span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>		close(c)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>2</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(channels[<span style=color:#a5d6ff>0</span>], channels[<span style=color:#a5d6ff>1</span>])
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>		m<span style=color:#ff7b72;font-weight:700>:=</span>len(channels)<span style=color:#ff7b72;font-weight:700>/</span><span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels[:m]<span style=color:#ff7b72;font-weight:700>...</span>),
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels[m:]<span style=color:#ff7b72;font-weight:700>...</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åˆå¹¶ä¸¤ä¸ª chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(a,b <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> a<span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> <span style=color:#ff7b72;font-weight:700>||</span> b <span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#79c0ff>nil</span>{
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span>{
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> v,ok <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>a:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>if</span> !ok { <span style=color:#8b949e;font-style:italic>// a å·²å…³é—­ï¼Œè®¾ç½®ä¸ºnil
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>					a=<span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>					<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				c <span style=color:#ff7b72;font-weight:700>&lt;-</span> v
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> v,ok <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>b:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>if</span> !ok { <span style=color:#8b949e;font-style:italic>// bå·²å…³é—­ï¼Œè®¾ç½®ä¸ºnil
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>				b=<span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				c <span style=color:#ff7b72;font-weight:700>&lt;-</span> v
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>sigs</span>(after time.Duration) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(after)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>fanInReflect</span>(
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>10</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>02</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>03</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>04</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>05</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>01</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;done after %v&#34;</span>, time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start))
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=æ‰‡å‡ºæ¨¡å¼>æ‰‡å‡ºæ¨¡å¼<a hidden class=anchor aria-hidden=true href=#æ‰‡å‡ºæ¨¡å¼>#</a></h3><p>æ‰‡å‡ºæ¨¡å¼æ˜¯å’Œæ‰‡å…¥æ¨¡å¼ç›¸åçš„ã€‚</p><p>æ‰‡å‡ºæ¨¡å¼åªæœ‰â¼€ä¸ªè¾“å…¥æº <code>Channel</code>ï¼Œæœ‰å¤šä¸ªç›®æ ‡ <code>Channel</code>ï¼Œæ‰‡å‡ºæ¯”å°±æ˜¯ 1æ¯”ç›®æ ‡ <code>Channel </code>æ•° çš„å€¼ï¼Œç»å¸¸ç”¨åœ¨è®¾è®¡æ¨¡å¼ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼ˆè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼å®šä¹‰äº†å¯¹è±¡é—´çš„â¼€ç§â¼€å¯¹å¤šçš„ ç»„åˆå…³ç³»ã€‚è¿™æ ·â¼€æ¥ï¼Œâ¼€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘â½£å˜åŒ–æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥å¹¶â¾ƒåŠ¨ åˆ·æ–°ï¼‰ã€‚åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œæ•°æ®å˜åŠ¨åï¼Œå¤šä¸ªè§‚å¯Ÿè€…éƒ½ä¼šæ”¶åˆ°è¿™ä¸ªå˜æ›´ä¿¡å·ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.me/en/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://luenci.me/en/posts/defergoroutine%E8%BF%AD%E4%BB%A3/><span class=title>Â« Prev</span><br><span>golangå¸¸è§é”™è¯¯ä¹‹deferå’Œè¿­ä»£</span>
</a><a class=next href=https://luenci.me/en/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3golang%E4%B8%AD%E7%9A%84nil/><span class=title>Next Â»</span><br><span>golangä¸­çš„nil</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on x" href="https://x.com/intent/tweet/?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&amp;hashtags=Golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&amp;title=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;summary=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;source=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&title=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on whatsapp" href="https://api.whatsapp.com/send?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on telegram" href="https://telegram.me/share/url?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golangå¹¶å‘ç¼–ç¨‹ on ycombinator" href="https://news.ycombinator.com/submitlink?t=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&u=https%3a%2f%2fluenci.me%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="â€”â€” "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>ğŸ‘ï¸â€ğŸ—¨ï¸è®¿å®¢äººæ•°: <span id=busuanzi_value_site_uv></span>|
ğŸŒè®¿é—®é‡: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2024 <a href=https://luenci.me/en/>Luenci</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> ğŸ“–
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="ğŸ•š: "+n+"å¤©"+prefixZero(o)+"å°æ—¶"+prefixZero(a)+"åˆ†"+prefixZero(c)+"ç§’"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>