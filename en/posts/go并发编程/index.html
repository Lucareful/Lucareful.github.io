<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>golang并发编程 | Luenci</title>
<meta name=keywords content="Golang"><meta name=description content="预备知识
unsafe.Pointer

unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。

对unsafe.Pointer 又爱又恨，你会有效使用它吗？

unsafe 是关注 Go 程序操作类型安全的包。

unsafe.Pointer 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：

任何类型的指针都可以转化为一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成任何类型的指针
一个 uintptr 可以转化成一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成一个 uintptr

两种只能借助 unsafe 包才能完成的操作：

使用 unsafe.Pointer 实现两种类型间转换
使用 unsafe.Pointer 处理系统调用。

CAS比较并交换&mdash;-Compare And Swap
Go 的一个 CAS 操作使用场景

在并发执行的多个 routine R1,R2&mldr;Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。


大方向：任务编排用 Channel，共享资源保护用传统并发原语

互斥锁实现机制

使用互斥锁，限定临界区只能同时由一个线程持有。


临界区

在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。





在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。

共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。
任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。
消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。
"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=http://148.135.101.22:3000/script.js data-website-id=ed7c1349-07f6-4e10-b44a-2c8668ff5fb5></script><meta property="og:title" content="golang并发编程"><meta property="og:description" content="预备知识
unsafe.Pointer

unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。

对unsafe.Pointer 又爱又恨，你会有效使用它吗？

unsafe 是关注 Go 程序操作类型安全的包。

unsafe.Pointer 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：

任何类型的指针都可以转化为一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成任何类型的指针
一个 uintptr 可以转化成一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成一个 uintptr

两种只能借助 unsafe 包才能完成的操作：

使用 unsafe.Pointer 实现两种类型间转换
使用 unsafe.Pointer 处理系统调用。

CAS比较并交换&mdash;-Compare And Swap
Go 的一个 CAS 操作使用场景

在并发执行的多个 routine R1,R2&mldr;Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。


大方向：任务编排用 Channel，共享资源保护用传统并发原语

互斥锁实现机制

使用互斥锁，限定临界区只能同时由一个线程持有。


临界区

在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。





在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。

共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。
任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。
消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。
"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="golang并发编程"><meta name=twitter:description content="预备知识
unsafe.Pointer

unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。

对unsafe.Pointer 又爱又恨，你会有效使用它吗？

unsafe 是关注 Go 程序操作类型安全的包。

unsafe.Pointer 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：

任何类型的指针都可以转化为一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成任何类型的指针
一个 uintptr 可以转化成一个 unsafe.Pointer
一个 unsafe.Pointer 可以转化成一个 uintptr

两种只能借助 unsafe 包才能完成的操作：

使用 unsafe.Pointer 实现两种类型间转换
使用 unsafe.Pointer 处理系统调用。

CAS比较并交换&mdash;-Compare And Swap
Go 的一个 CAS 操作使用场景

在并发执行的多个 routine R1,R2&mldr;Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。


大方向：任务编排用 Channel，共享资源保护用传统并发原语

互斥锁实现机制

使用互斥锁，限定临界区只能同时由一个线程持有。


临界区

在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。





在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。

共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。
任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。
消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"golang并发编程","item":"https://luenci.com/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang并发编程","name":"golang并发编程","description":"预备知识 unsafe.Pointer unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。\n对unsafe.Pointer 又爱又恨，你会有效使用它吗？\nunsafe 是关注 Go 程序操作类型安全的包。\nunsafe.Pointer 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：\n任何类型的指针都可以转化为一个 unsafe.Pointer 一个 unsafe.Pointer 可以转化成任何类型的指针 一个 uintptr 可以转化成一个 unsafe.Pointer 一个 unsafe.Pointer 可以转化成一个 uintptr 两种只能借助 unsafe 包才能完成的操作：\n使用 unsafe.Pointer 实现两种类型间转换 使用 unsafe.Pointer 处理系统调用。 CAS比较并交换\u0026mdash;-Compare And Swap Go 的一个 CAS 操作使用场景\n在并发执行的多个 routine R1,R2\u0026hellip;Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。 大方向：任务编排用 Channel，共享资源保护用传统并发原语\n互斥锁实现机制 使用互斥锁，限定临界区只能同时由一个线程持有。\n临界区 在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。 在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。\n共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。 任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。 消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。 ","keywords":["Golang"],"articleBody":"预备知识 unsafe.Pointer unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。\n对unsafe.Pointer 又爱又恨，你会有效使用它吗？\nunsafe 是关注 Go 程序操作类型安全的包。\nunsafe.Pointer 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：\n任何类型的指针都可以转化为一个 unsafe.Pointer 一个 unsafe.Pointer 可以转化成任何类型的指针 一个 uintptr 可以转化成一个 unsafe.Pointer 一个 unsafe.Pointer 可以转化成一个 uintptr 两种只能借助 unsafe 包才能完成的操作：\n使用 unsafe.Pointer 实现两种类型间转换 使用 unsafe.Pointer 处理系统调用。 CAS比较并交换—-Compare And Swap Go 的一个 CAS 操作使用场景\n在并发执行的多个 routine R1,R2…Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。 大方向：任务编排用 Channel，共享资源保护用传统并发原语\n互斥锁实现机制 使用互斥锁，限定临界区只能同时由一个线程持有。\n临界区 在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。 在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。\n共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。 任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。 消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。 简单的计数器例子 Counter 方法一：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import( \"fmt\" \"sync\" ) func main() { var count = 0 // 互斥锁保护计数器 var mu sync.Mutex var wg sync.WaitGroup wg.Add(10) for i := 0; i \u003c 10; i++{ go func() { defer wg.Done() // 对变量 count 进行加法操作 // count++ 不是一个原子操作，它至少包含几个步骤， // 比如读取变量 count 的当前值， // 对这个值加 1，把结果再保存到 count 中。 // 因为不是原子操作，就可能有并发的问题。 for i := 0; i \u003c 10000; i++{ mu.Lock() count++ mu.Unlock() } }() } // 等待 10 个 goroutine 完成 wg.Wait() fmt.Println(\"结果为\", count) } 方法二（推荐）：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 type Counter struct{ id int name string mu sync.Mutex count uint } func(c *Counter)Inc() { c.mu.Lock() c.count++ c.mu.Unlock() } func(c *Counter)Count()uint{ c.mu.Lock() defer c.mu.Unlock() return c.count } func main2() { var counter Counter var wg sync.WaitGroup wg.Add(10) for i := 0; i \u003c 10; i++{ go func() { defer wg.Done() for i := 0; i \u003c 10000; i++{ counter.Inc()// 受到 mutex 保护的方法 } }() } wg.Wait() fmt.Println(\"结果为\", counter.count) } 等待的goroutine们是以FIFO排队的\n1）当Mutex处于正常模式时，若此时没有新goroutine与队头goroutine竞争，则队头goroutine获得。若有新goroutine竞争大概率新goroutine获得。\n2）当队头goroutine竞争锁失败1ms后，它会将Mutex调整为饥饿模式。进入饥饿模式后，锁的所有权会直接从解锁goroutine移交给队头goroutine，此时新来的goroutine直接放入队尾。\n3）当一个goroutine获取锁后，如果发现自己满足下列条件中的任何一个\n它是队列中最后一个 它等待锁的时间少于1ms 将锁切换回正常模式\nmutex 注意点 Unlock 方法可以被任意的 goroutine 调用释放锁，即使是没持有这个互斥锁的 goroutine，也可以进行这个操作。这是因为，Mutex 本身并没有包含持有这把锁的 goroutine 的信息，所以，Unlock 也不会对此进行检查。Mutex 的这个设计一直保持至今。 Mutex常见错误 Mutex 常见的错误场景有 4 类，分别是 Lock/Unlock 不是成对出现、Copy 已使用的 Mutex、重入和死锁。\n可重入的概念\n当一个线程获取锁时，如果没有其它线程拥有这个锁，那么，这个线程就成功获取到这个锁。之后，如果其它线程再请求这个锁，就会处于阻塞等待的状态。但是，如果拥有这把锁的线程再请求这把锁的话，不会阻塞，而是成功返回，所以叫可重入锁（有时候也叫做递归锁）。只要你拥有这把锁，你可以可着劲儿地调用，比如通过递归实现一些算法，调用者不会阻塞或者死锁。 死锁\n两个或两个以上的进程（或线程，goroutine）在执行过程中，因争夺共享资源而处于一种互相等待的状态，如果没有外部干涉，它们都将无法推进下去，此时，我们称系统处于死锁状态或系统产生了死锁。 避免死锁，只要破坏这四个条件中的一个或者几个，就可以了。\n互斥： 至少一个资源是被排他性独享的，其他线程必须处于等待状态，直到资源被释放。 持有和等待：goroutine 持有一个资源，并且还在请求其它 goroutine 持有的资源，也就是咱们常说的“吃着碗里，看着锅里”的意思。 不可剥夺：资源只能由持有它的 goroutine 来释放。 环路等待：一般来说，存在一组等待进程，P={P1，P2，…，PN}，P1 等待 P2 持有的资源，P2 等待 P3 持有的资源，依此类推，最后是 PN 等待 P1 持有的资源，这就形成了一个环路等待的死结。 Mutex小结 RWMutex — 读写锁 标准库中的 RWMutex 是一个 reader/writer 互斥锁。RWMutex在某一时刻只能由任意数量的 reader 持有，或者是只被单个的 writer 持有。RWMutex 的方法也很少，总共有 5 个。\nLock/Unlock：写操作时调用的方法。如果锁已经被 reader 或者 writer 持有，那么，Lock 方法会一直阻塞，直到能获取到锁；Unlock 则是配对的释放锁的方法。\nRLock/RUnlock：读操作时调用的方法。如果锁已经被 writer 持有的话，RLock 方法会一直阻塞，直到能获取到锁，否则就直接返回；而 RUnlock 是 reader 释放锁的方法。\nRLocker：这个方法的作用是为读操作返回一个 Locker 接口的对象。它的 Lock 方法会调用 RWMutex 的 RLock 方法，它的 Unlock 方法会调用 RWMutex 的 RUnlock 方法。\nRWMutex 的零值是未加锁的状态，所以，当你使用 RWMutex 的时候，无论是声明变量，还是嵌入到其它 struct 中，都不必显式地初始化。\n如果你遇到可以明确区分 reader 和 writer goroutine 的场景，且有大量的并发读、少量的并发写，并且有强烈的性能需求，你就可以考虑使用读写锁 RWMutex 替换 Mutex。\nRWMutex 的实现原理 RWMutex 是很常见的并发原语，很多编程语言的库都提供了类似的并发类型。RWMutex 一般都是基于互斥锁、条件变量（condition variables）或者信号量（semaphores）等并发原语来实现。Go 标准库中的 RWMutex 是基于 Mutex 实现的。\nreaders-writers 问题一般有三类，基于对读和写操作的优先级，读写锁的设计和实现也分成三类。Read-preferring：读优先的设计可以提供很高的并发性，但是，在竞争激烈的情况下可能会导致写饥饿。这是因为，如果有大量的读，这种设计会导致只有所有的读都释放了锁之后，写才可能获取到锁。 Write-preferring：写优先的设计意味着，如果已经有一个 writer 在等待请求锁的话，它会阻止新来的请求锁的 reader 获取到锁，所以优先保障 writer。当然，如果有一些 reader 已经请求了锁的话，新请求的 writer 也会等待已经存在的 reader 都释放锁之后才能获取。所以，写优先级设计中的优先权是针对新来的请求而言的。这种设计主要避免了 writer 的饥饿问题。 不指定优先级：这种设计比较简单，不区分 reader 和 writer 优先级，某些场景下这种不指定优先级的设计反而更有效，因为第一类优先级会导致写饥饿，第二类优先级可能会导致读饥饿，这种不指定优先级的访问不再区分读写，大家都是同一个优先级，解决了饥饿的问题。 Go 标准库中的 RWMutex 设计是 Write-preferring 方案。一个正在阻塞的 Lock 调用会排除新的 reader 请求到锁。\nRWMutex的锁 RWMutex 是⼀个多 writer 多 reader 的读写锁，所以同时可能有多个 writer 和 reader。那 么，为了避免 writer 之间的竞争，RWMutex 就会使用⼀个 Mutex 来保证 writer 的互斥。\n在 Lock 方法中，是先获取内部互斥锁，才会修改的其他字段； 在 Unlock 方法中，是先修改的其他字段，才会释放内部互斥锁，这样才能保证字段的修改也受到互斥锁的保护。 使用读写锁最需要注意的⼀点就是尽量避免重入，重入带来的死锁⾮常隐蔽，⽽且难以 诊断。\nWaitGroup：协同等待，任务编排利器 WaitGroup基本用法 1 2 3 func (wg *WaitGroup) Add(delta int) func (wg *WaitGroup) Done() func (wg *WaitGroup) Wait() Add，用来设置 WaitGroup 的计数值； Done，用来将 WaitGroup 的计数值减 1，其实就是调用了 Add(-1)； Wait，调用这个方法的 goroutine 会⼀直阻塞，直到 WaitGroup 的计数值变为 0。 WaitGroup数据结构 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type WaitGroup struct { // 避免复制使用的⼀个技巧，可以告诉vet⼯具违反了复制使用的规则 noCopy noCopy // 64bit(8bytes)的值分成两段，⾼32bit是计数值，低32bit是waiter的计数 // 另外32bit是用作信号量的 // 因为64bit值的原子操作需要64bit对⻬，但是32bit编译器不⽀持，所以数组中的元素在不同的架构 // 总之，会找到对⻬的那64bit作为state，其余的32bit做信号量 state1 [3]uint32 } // 得到state的地址和信号量的地址 func (wg *WaitGroup) state() (statep *uint64, semap *uint32) { if uintptr(unsafe.Pointer(\u0026wg.state1))%8 == 0 { // 如果地址是64bit对⻬的，数组前两个元素做state，后⼀个元素做信号量 return (*uint64)(unsafe.Pointer(\u0026wg.state1)), \u0026wg.state1[2] } else { // 如果地址是32bit对⻬的，数组后两个元素用来做state，它可以用来做64bit的原子操作，第 return (*uint64)(unsafe.Pointer(\u0026wg.state1[1])), \u0026wg.state1[0] } } WaitGroup 是可以重用的。只要 WaitGroup 的计数值恢复到零值的状态，那么它就可以被看作是新创建的 WaitGroup，被重复使用\n小结 不重用 WaitGroup。新建⼀个 WaitGroup 不会带来多⼤的资源开销，重用反⽽更容易出 错。 保证所有的 Add 方法调用都在 Wait 之前。 不传递负数给 Add 方法，只通过 Done 来给计数值减 1。 不做多余的 Done 方法调用，保证 Add 的计数值和 Done 方法调用的数量是⼀样的。 不遗漏 Done 方法的调用，否则会导致 Wait hang 住⽆法返回。 Cond Go 标准库提供 Cond 原语的目的是，为等待 / 通知场景下的并发问题提供⽀持。\nCond 的基本用法 1 2 3 4 5 type Cond func NeWCond(l Locker) *Cond func (c *Cond) Broadcast() func (c *Cond) Signal() func (c *Cond) Wait() ⾸先，Cond 关联的 Locker 实例可以通过 c.L 访问，它内部维护着⼀个先入先出的等待队 列。 Signal 方法，允许调用者 Caller 唤醒⼀个等待此 Cond 的 goroutine。如果此时没有等待的goroutine，显然⽆需通知 waiter；如果 Cond 等待队列中有⼀个或者多个等待的goroutine，则需要从等待队列中移除第⼀个 goroutine 并把它唤醒。在其他编程语言中，⽐如 Java 语⾔中，Signal 方法也被叫做 notify 方法。 调用 Signal 方法时，不强求你⼀定要持有 c.L 的锁。 Broadcast 方法，允许调用者 Caller 唤醒所有等待此 Cond 的 goroutine。如果此时没有等待的 goroutine，显然⽆需通知 waiter；如果 Cond 等待队列中有⼀个或者多个等待的goroutine，则清空所有等待的 goroutine，并全部唤醒。在其他编程语⾔中，⽐如 Java 语⾔中，Broadcast 方法也被叫做 notifyAll 方法。 同样地，调用 Broadcast 方法时，也不强求你⼀定持有 c.L 的锁。 Wait 方法，会把调用者 Caller 放入 Cond 的等待队列中并阻塞，直到被 Signal 或者Broadcast 的方法从等待队列中移除并唤醒。 调用 Wait 方法时必须要持有 c.L 的锁。 案例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package main import ( \"log\" \"math/rand\" \"sync\" \"time\" ) func main() { c := sync.NewCond(\u0026sync.Mutex{}) var ready int for i := 0; i \u003c10 ; i++ { go func(i int) { time.Sleep(time.Duration(rand.Int63n(10)) * time.Second) // 加锁更改等待条件 c.L.Lock() ready++ c.L.Unlock() log.Printf(\"运动员#%d 准备就绪\\\\n\", i) // 广播唤醒所有的等待着 c.Broadcast() }(i) } c.L.Lock() for ready!= 10{ c.Wait() log.Printf(\"裁判员被唤醒一次\") } c.L.Unlock() // 所有运动员是否准备就绪 log.Println(\"所有运动员准备就绪，比赛开始！\") } 小结 Cond 是为等待 / 通知场景下的并发问题提供⽀持的。它提供了条件变量的三个基本方法Signal、Broadcast 和 Wait，为并发的 goroutine 提供等待 / 通知机制。 使用 Cond 之所以容易出错，就是 Wait 调用需要加锁，以及被唤醒后⼀定要检查条件是否真 的已经满⾜。你需要牢记这两点。 WaitGroup和 Cond 的区别：WaitGroup 是主 goroutine 等待确定数量的子 goroutine 完成任务；⽽ Cond 是等待某个条件满⾜，这个条件的修改可以被任意多的 goroutine 更新，⽽且 Cond的 Wait 不关⼼也不知道其他 goroutine 的数量，只关⼼等待条件。⽽且 Cond 还有单个通知的机制，也就是 Signal 方法。 Once Once可以用来执行且仅仅执行⼀次动作，常常用于单例对象的初始化场景。\n使用场景 sync.Once 只暴露了⼀个方法 Do，你可以多次调用 Do 方法，但是只有第⼀次调用 Do 方法 时 f 参数才会执行，这⾥的 f 是⼀个⽆参数⽆返回值的函数。\n1 func (o *Once) Do(f func()) Once 常常用来初始化单例资源，或者并发访问只需初始化⼀次的共享资源，或者在测试的时候初始化⼀次测试资源。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package main import ( \"fmt\" \"sync\" ) func main() { var once sync.Once f1:=func(){ fmt.Println(\"f1 exce！\") } once.Do(f1) f2 := func() { fmt.Println(\"f2 exce\") } once.Do(f2) } 小结 ⼀旦你遇到只需要初始化⼀次的场景，⾸先想到的就应该是 Once 并发原语。\nPool Go 标准库中提供了⼀个通用的 Pool 数据结构，也就是 sync.Pool，我们使用它可以创建池化的对象。但是它池化的对象可能会被垃圾回收掉。\nsync.Pool 数据类型用来保存⼀组可独立访问的临时对象。 也就是说，它池化的对象会在未来的某个时候被毫无预兆地移除掉。而且，如果没有别的对象引用这个被移除的对象的话，这个被移除的对象就会被垃圾回收掉。 注意点 sync.Pool 本身就是线程安全的，多个 goroutine 可以并发地调用它的方法存取对象； sync.Pool 不可在使用之后再复制使用。 方法介绍 1.New\nPool struct 包含⼀个 New 字段，这个字段的类型是函数 func() interface{}。当调用 Pool 的 Get 方法从池中获取元素，没有更多的空闲元素可返回时，就会调用这个 New 方法来创建新 的元素。如果你没有设置 New 字段，没有更多的空闲元素可返回时，Get 方法将返回 nil，表 明当前没有可用的元素。 有趣的是，New 是可变的字段。这就意味着，你可以在程序运行的时候改变创建元素的方 法。当然，很少有⼈会这么做，因为⼀般我们创建元素的逻辑都是⼀致的，要创建的也是同⼀ 类的元素，所以你在使用 Pool 的时候也没必要玩⼀些“花活”，在程序运行时更改 New 的 值。 2.Get\n如果调用这个方法，就会从 Pool取⾛⼀个元素，这也就意味着，这个元素会从 Pool 中移除， 返回给调用者。不过，除了返回值是正常实例化的元素，Get 方法的返回值还可能会是⼀个 nil（Pool.New 字段没有设置，⼜没有空闲元素可以返回），所以你在使用的时候，可能需要 判断。 3.Put\n这个方法用于将⼀个元素返还给 Pool，Pool 会把这个元素保存到池中，并且可以复用。但如 果 Put ⼀个 nil 值，Pool 就会忽略这个值。 推荐的三方pool gammazero/workerpool：gammazero/workerpool 可以⽆限制地提交任务，提供了更便利的 Submit 和 SubmitWait 方法提交任务，还可以提供当前的 worker 数和任务数以及关闭 Pool 的功能。 ivpusic/grpool：grpool 创建 Pool 的时候需要提供 Worker 的数量和等待执行的任务的 最⼤数量，任务的提交是直接往 Channel 放入任务。 dpaks/goworkers：dpaks/goworkers 提供了更便利的 Submit 方法提交任务以及Worker 数、任务数等查询方法、关闭 Pool 的方法。它的任务的执行结果需要在ResultChan 和 ErrChan 中去获取，没有提供阻塞的方法，但是它可以在初始化的时候设置 Worker 的数量和任务数。 pool可能造成的问题 内存泄漏 在使用 sync.Pool 回收 buffer 的时候，⼀定要检查回收的对象的⼤⼩。如果 buffer 太⼤，就 不要回收了，否则就太浪费了 内存浪费 要做到物尽其用，尽可能不浪费的话，我们可以将 buffer 池分成⼏层 ⼩于 512 byte的元素的 buffer 占⼀个池子；其次，⼩于 1K byte ⼤⼩的元素占⼀个池子；再次，⼩于 4Kbyte ⼤⼩的元素占⼀个池子。这样分成⼏个池子以后，就可以根据需要，到所需⼤⼩的池子中获取 buffer 了。 小结 Pool 是⼀个通用的概念，也是解决对象重用和预先分配的⼀个常用的优化⼿段。即使你⾃⼰ 没在项目中直接使用过，但肯定在使用其它库的时候，就享受到应用 Pool 的好处了，⽐如数 据库的访问、http API 的请求等等。 我们⼀般不会在程序⼀开始的时候就开始考虑优化，⽽是等项目开发到⼀个阶段，或者快结束 的时候，才全⾯地考虑程序中的优化点，⽽ Pool 就是常用的⼀个优化⼿段。如果你发现程序 中有⼀种 GC 耗时特别⾼，有⼤量的相同类型的临时对象，不断地被创建销毁，这时，你就可 以考虑看看，是不是可以通过池化的⼿段重用这些对象。 另外，在分布式系统或者微服务框架中，可能会有⼤量的并发 Client 请求，如果 Client 的耗 时占⽐很⼤，你也可以考虑池化 Client，以便重用。 如果你发现系统中的 goroutine 数量⾮常多，程序的内存资源占用⽐较⼤，⽽且整体系统的耗 时和 GC 也⽐较⾼，我建议你看看，是否能够通过 Worker Pool 解决⼤量 goroutine 的问 题，从⽽降低这些指标。 Context：信息穿透上下文 在 API之间或者方法调用之间，所传递的除了业务参数之外的额外信息。\ncontext使用场景 上下⽂信息传递 （request-scoped），⽐如处理 http 请求、在请求处理链路上传递信 息； 控制子 goroutine 的运行； 超时控制的方法调用； 可以取消的方法调用。 context 接口函数 1 2 3 4 5 6 type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error Value(key interface{}) interface{} } Deadline 方法会返回这个 Context 被取消的截⽌⽇期。如果没有设置截⽌⽇期，ok 的值是 false。后续每次调用这个对象的 Deadline 方法时，都会返回和第⼀次调用相同的结果。 Done 方法返回⼀个 Channel 对象。在 Context 被取消时，此 Channel 会被 close，如果没 被取消，可能会返回 nil。后续的 Done 调用总是返回相同的结果。当 Done 被 close 的时 候，你可以通过 ctx.Err 获取错误信息。Done 这个方法名其实起得并不好，因为名字太过笼 统，不能明确反映 Done 被 close 的原因，因为 cancel、timeout、deadline 都可能导致 Done 被 close，不过，目前还没有⼀个更合适的方法名称。 如果 Done 没有被 close，Err 方法返回 nil；如果 Done 被 close，Err 方法会返回 Done 被 close 的原因。 Value 返回此 ctx 中和指定的 key 相关联的 value。 Context 中实现了 2 个常用的生成顶层 Context 的方法。\ncontext.Background()：返回⼀个⾮ nil 的、空的 Context，没有任何值，不会被 cancel，不会超时，没有截⽌⽇期。⼀般用在主函数、初始化、测试以及创建根 Context 的时候 context.TODO()：返回⼀个⾮ nil 的、空的 Context，没有任何值，不会被 cancel，不会超时，没有截⽌⽇期。当你不清楚是否该用 Context，或者目前还不知道要传递⼀些什么上下⽂信息的时候，就可以使用这个方法。 关于Context的一些约定规定 ⼀般函数使用 Context 的时候，会把这个参数放在第⼀个参数的位置。从来不把 nil 当Context 类型的参数值，可以使用 context.Background() 创建⼀个空的上下⽂对象，也不要使用 nil。 2.Context 只用来临时做函数之间的上下⽂透传，不能持久化 Context 或者把 Context ⻓久存。把 Context 持久化到数据库、本地⽂件或者全局变量、缓存中都是错误的用法。 3.key 的类型不应该是字符串类型或者其它内建类型，否则容易在包之间使用 Context 时候产生冲突。使用 WithValue 时，key 的类型应该是⾃⼰定义的类型。 4.常常使用 struct{}作为底层类型定义 key 的类型。对于 exported key 的静态类型，常常是接⼝或者指针。这样可以尽量减少内存分配。 应用场景 main函数返回时，所有的goroutine都会被直接打断，程序退出。除此之外如果想通过编程的方法让一个goroutine中断其他goroutine的执行，只能是通过在多个goroutine间通过context上下文对象同步取消信号的方式来实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { ctx, cancel := context.WithCancel(context.Background()) go func() { defer func() { fmt.Println(\"goroutine exit\") }() for { select { case \u003c-ctx.Done(): return default: time.Sleep(time.Second) } } }() time.Sleep(time.Second) cancel() time.Sleep(2 * time.Second) } atomic 原子操作 原子操作，是因为⼀个原子在执行的时候，其它线程不会看到执行⼀半的操作结果。在其它线程看来，原子操作要么执行完了，要么还没有执行，就像⼀个最⼩的粒子 - 原子⼀样，不可分割\natomic 提供的方法 atomic 操作的对象是⼀个地址，你需要把可寻址的变量的地址作为参数传递给方法，⽽不是把变量的值传递给方法。 Add Add 方法就是给第⼀个参数地址中的值增加⼀个 delta 值\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // AddInt32 atomically adds delta to *addr and returns the new value. func AddInt32(addr *int32, delta int32) (new int32) // AddUint32 atomically adds delta to *addr and returns the new value. // To subtract a signed positive constant value c from x, do AddUint32(\u0026x, ^uint32(c-1)). // In particular, to decrement x, do AddUint32(\u0026x, ^uint32(0)). func AddUint32(addr *uint32, delta uint32) (new uint32) // AddInt64 atomically adds delta to *addr and returns the new value. func AddInt64(addr *int64, delta int64) (new int64) // AddUint64 atomically adds delta to *addr and returns the new value. // To subtract a signed positive constant value c from x, do AddUint64(\u0026x, ^uint64(c-1)). // In particular, to decrement x, do AddUint64(\u0026x, ^uint64(0)). func AddUint64(addr *uint64, delta uint64) (new uint64) // AddUintptr atomically adds delta to *addr and returns the new value. func AddUintptr(addr *uintptr, delta uintptr) (new uintptr CAS （CompareAndSwap）\n这个方法会⽐较当前 addr 地址⾥的值是不是 old，如果不等于 old，就返回 false；如果等于old，就把此地址的值替换成 new 值，返回 true。这就相当于“判断相等才替换”。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value. func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) // CompareAndSwapInt64 executes the compare-and-swap operation for an int64 value. func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool) // CompareAndSwapUint32 executes the compare-and-swap operation for a uint32 value. func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool) // CompareAndSwapUint64 executes the compare-and-swap operation for a uint64 value. func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool) // CompareAndSwapUintptr executes the compare-and-swap operation for a uintptr value. func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool) // CompareAndSwapPointer executes the compare-and-swap operation for a unsafe.Pointer value. func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool) 效果如下\n1 2 3 4 5 if *addr == old { *addr = new return true } return false Swap 如果不需要⽐较旧值，只是⽐较粗暴地替换的话，就可以使用 Swap 方法，它替换后还可以 返回旧值。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // SwapInt32 atomically stores new into *addr and returns the previous *addr value. func SwapInt32(addr *int32, new int32) (old int32) // SwapInt64 atomically stores new into *addr and returns the previous *addr value. func SwapInt64(addr *int64, new int64) (old int64) // SwapUint32 atomically stores new into *addr and returns the previous *addr value. func SwapUint32(addr *uint32, new uint32) (old uint32) // SwapUint64 atomically stores new into *addr and returns the previous *addr value. func SwapUint64(addr *uint64, new uint64) (old uint64) // SwapUintptr atomically stores new into *addr and returns the previous *addr value. func SwapUintptr(addr *uintptr, new uintptr) (old uintptr) // SwapPointer atomically stores new into *addr and returns the previous *addr value. func SwapPointer(addr *unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer) 效果如下：\n1 2 3 old = *addr *addr = new return old Load Load 方法会取出 addr 地址中的值，即使在多处理器、多核、有 CPU cache 的情况下，这个操作也能保证 Load 是⼀个原子操作。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // LoadInt32 atomically loads *addr. func LoadInt32(addr *int32) (val int32) // LoadInt64 atomically loads *addr. func LoadInt64(addr *int64) (val int64) // LoadUint32 atomically loads *addr. func LoadUint32(addr *uint32) (val uint32) // LoadUint64 atomically loads *addr. func LoadUint64(addr *uint64) (val uint64) // LoadUintptr atomically loads *addr. func LoadUintptr(addr *uintptr) (val uintptr) // LoadPointer atomically loads *addr. func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer) Store Store 方法会把⼀个值存入到指定的 addr 地址中，即使在多处理器、多核、有 CPU cache的情况下，这个操作也能保证 Store 是⼀个原子操作。别的 goroutine 通过 Load 读取出来，不会看到存取了⼀半的值。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // StoreInt32 atomically stores val into *addr. func StoreInt32(addr *int32, val int32) // StoreInt64 atomically stores val into *addr. func StoreInt64(addr *int64, val int64) // StoreUint32 atomically stores val into *addr. func StoreUint32(addr *uint32, val uint32) // StoreUint64 atomically stores val into *addr. func StoreUint64(addr *uint64, val uint64) // StoreUintptr atomically stores val into *addr. func StoreUintptr(addr *uintptr, val uintptr) // StorePointer atomically stores val into *addr. func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer Value 类型 它可以原子地存取对象类型，但也只能存取，不能 CAS 和 Swap，常常用在配置变更等场景中\n1 2 3 4 5 6 7 // A Value must not be copied after first use. type Value struct { v interface{} } func (v *Value) Load() (x interface{}) {...} func (v *Value) Store(x interface{}) {...} Channel：解决并发问题 CSP允许使用进程组件来描述系统，它们独⽴运行，并且只通过消息传递的方式通信。\nChannel 的应用场景 执行业务处理的 goroutine 不要通过共享内存的方式通信，⽽是要通过 Channel 通信的方式分享数据\n“communicate by sharing memory”是传统的并发编程处理方式，就是指，共享的数据需要用锁进行保护，goroutine 需要获取到锁，才能并发访问数据。 “share memory by communicating”则是类似于 CSP 模型的方式，通过通信的方式，⼀个goroutine 可以把数据的“所有权”交给另外⼀个 goroutine（虽然 Go 中没有“所有权”的概念，但是从逻辑上说，你可以把它理解为是所有权的转移）。 五大应用场景\n数据交流：当作并发的 buffer 或者 queue，解决生产者 - 消费者问题。多个 goroutine 可以并发当作生产者（Producer）和消费者（Consumer）。 数据传递：⼀个 goroutine 将数据交给另⼀个 goroutine，相当于把数据的拥有权 (引用)托付出去。 信号通知：⼀个 goroutine 可以将信号 (closing、closed、data ready 等) 传递给另⼀个或者另⼀组 goroutine 。 任务编排：可以让⼀组 goroutine 按照⼀定的顺序并发或者串行的执行，这就是编排的功能。 锁：利用 Channel 也可以实现互斥锁的机制。 channel 基本用法 \u003c- v有个规则，总是尽量和左边的 chan 结合（The \u003c- operator associates with the leftmost chan possible:\nnil 是 chan 的零值，是⼀种特殊的 chan，对值是 nil 的 chan 的发送接收调用者总是会阻塞 关于channel的选择 共享资源的并发访问使用传统并发原语； 复杂的任务编排和消息传递使用 Channel； 消息通知机制使用 Channel，除非只想 signal ⼀个 goroutine，才使用 Cond； 简单等待所有任务的完成用 WaitGroup，也有 Channel 的推崇者用 Channel，都可以； 需要和 Select 语句结合，使用 Channel； 需要和超时配合时，使用 Channel 和 Context。 chan 的编排方式 Or-Done 模式、扇入模式、扇出模式、Stream 和 map-reduce\nOr-Done 模式 Or-Done 模式是信号通知模式中更宽泛的⼀种模式\n我们会使用“信号通知”实现某个任务执行完成后的通知机制，在实现时，我们为这个任务定义 ⼀个类型为 chan struct{}类型的 done 变量，等任务结束后，我们就可以 close 这个变量， 然后，其它 receiver 就会收到这个通知。 这是有⼀个任务的情况，如果有多个任务，只要有任意⼀个任务执行完，我们就想获得这个信 号，这就是 Or-Done 模式。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 package main import ( \"fmt\" \"reflect\" \"time\" ) // or or-done 模式 递归实现 func or(channels ...\u003c-chan interface{}) \u003c-chan interface{} { // 特殊情况，只有零个,1个或2个 chan switch len(channels) { case 0: return nil case 1: return channels[0] case 2: select { case \u003c-channels[0]: case \u003c-channels[1]: } } orDone := make(chan interface{}) go func() { defer close(orDone) // fmt.Println(\"执行\") if len(channels) \u003e 2 { m := len(channels) / 2 select { case \u003c-or(channels[:m]...): case \u003c-or(channels[m:]...): } } }() return orDone } func sig(after time.Duration) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) time.Sleep(after) }() return c } // orSelect 反射⽅式 实现 func orSelect(channels ...\u003c-chan interface{}) \u003c-chan interface{} { // 特殊情况，只有零个,1个或2个 chan switch len(channels) { case 0: return nil case 1: return channels[0] } orDone := make(chan interface{}) go func() { defer close(orDone) // 利用反射构建SelectCase var cases []reflect.SelectCase for _, c := range channels { cases = append(cases, reflect.SelectCase{ Dir: reflect.SelectRecv, Chan: reflect.ValueOf(c), }) } // 随机选取一个可用 case reflect.Select(cases) }() return orDone } func main() { start := time.Now() \u003c-orSelect( sig(10*time.Second), sig(20*time.Second), sig(30*time.Second), sig(40*time.Second), sig(50*time.Second), sig(01*time.Second), ) fmt.Printf(\"done after %v\", time.Since(start)) } 扇入模式 扇入借鉴了数字电路的概念，它定义了单个逻辑们能够接受的数字信号输入最⼤量的术语。⼀ 个逻辑们可以有多个输入，⼀个输出。\n在软件⼯程中，模块的扇入是指有多少个上级模块调用它。 而对于我们这里的 Channel 扇入模式来说，就是指有多个源 Channel 输入、⼀个目的 Channel 输出的情况。 扇入比就是源 Channel 数量比1。\n每个源 Channel 的元素都会发送给目标 Channel，相当于目标 Channel 的 receiver 只需要 监听目标 Channel，就可以接收所有发送给源 Channel 的数据。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 package main import ( \"fmt\" \"reflect\" \"time\" ) // 扇入模式 反射实现 func fanInReflect(channels ...\u003c-chan interface{}) \u003c-chan interface{} { out:= make(chan interface{}) go func() { defer close(out) // 构造 SelectCases slice var cases []reflect.SelectCase for _, c := range channels{ cases = append(cases, reflect.SelectCase{ Dir: reflect.SelectRecv, Chan: reflect.ValueOf(c), }) } // 循环，从 cases 中选择一个可用的 for len(cases)\u003e0{ i,v,ok:=reflect.Select(cases) if !ok{ // chan 关闭 cases = append(cases[:i],cases[i+1:]...) continue } out \u003c-v.Interface() } }() return out } func fanInRec(channels ...\u003c-chan interface{}) \u003c-chan interface{}{ switch len(channels){ case 0: c:= make(chan interface{}) close(c) return c case 1: return channels[0] case 2: return mergeTow(channels[0], channels[1]) default: m:=len(channels)/2 return mergeTow( fanInRec(channels[:m]...), fanInRec(channels[m:]...)) } } // 合并两个 chan func mergeTow(a,b \u003c-chan interface{}) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) for a!= nil || b !=nil{ select{ case v,ok := \u003c-a: if !ok { // a 已关闭，设置为nil a=nil continue } c \u003c- v case v,ok := \u003c-b: if !ok { // b已关闭，设置为nil b=nil continue } c \u003c- v } } }() return c } func sigs(after time.Duration) \u003c-chan interface{} { c := make(chan interface{}) go func() { defer close(c) time.Sleep(after) }() return c } func main() { start := time.Now() \u003c-fanInReflect( sigs(10*time.Second), sigs(02*time.Second), sigs(03*time.Second), sigs(04*time.Second), sigs(05*time.Second), sigs(01*time.Second), ) fmt.Printf(\"done after %v\", time.Since(start)) } 扇出模式 扇出模式是和扇入模式相反的。\n扇出模式只有⼀个输入源 Channel，有多个目标 Channel，扇出比就是 1比目标 Channel 数 的值，经常用在设计模式中的观察者模式中（观察者设计模式定义了对象间的⼀种⼀对多的 组合关系。这样⼀来，⼀个对象的状态发⽣变化时，所有依赖于它的对象都会得到通知并⾃动 刷新）。在观察者模式中，数据变动后，多个观察者都会收到这个变更信号。\n","wordCount":"10919","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">golang并发编程</h1><div class=post-meta>22 min&nbsp;·&nbsp;10919 words&nbsp;·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86 aria-label=预备知识>预备知识</a><ul><li><a href=#unsafepointer aria-label=unsafe.Pointer>unsafe.Pointer</a></li><li><a href=#cas%e6%af%94%e8%be%83%e5%b9%b6%e4%ba%a4%e6%8d%a2----compare-and-swap aria-label="CAS比较并交换&mdash;-Compare And Swap">CAS比较并交换&mdash;-Compare And Swap</a></li></ul></li><li><a href=#%e4%ba%92%e6%96%a5%e9%94%81%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6 aria-label=互斥锁实现机制>互斥锁实现机制</a><ul><li><a href=#%e7%ae%80%e5%8d%95%e7%9a%84%e8%ae%a1%e6%95%b0%e5%99%a8%e4%be%8b%e5%ad%90-counter aria-label="简单的计数器例子 Counter">简单的计数器例子 Counter</a></li><li><a href=#mutex-%e6%b3%a8%e6%84%8f%e7%82%b9 aria-label="mutex 注意点">mutex 注意点</a></li><li><a href=#mutex%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af aria-label=Mutex常见错误>Mutex常见错误</a></li><li><a href=#mutex%e5%b0%8f%e7%bb%93 aria-label=Mutex小结>Mutex小结</a></li><li><a href=#rwmutex--%e8%af%bb%e5%86%99%e9%94%81 aria-label="RWMutex — 读写锁">RWMutex — 读写锁</a></li><li><a href=#rwmutex-%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 aria-label="RWMutex 的实现原理">RWMutex 的实现原理</a></li><li><a href=#rwmutex%e7%9a%84%e9%94%81 aria-label=RWMutex的锁>RWMutex的锁</a></li></ul></li><li><a href=#waitgroup%e5%8d%8f%e5%90%8c%e7%ad%89%e5%be%85%e4%bb%bb%e5%8a%a1%e7%bc%96%e6%8e%92%e5%88%a9%e5%99%a8 aria-label=WaitGroup：协同等待，任务编排利器>WaitGroup：协同等待，任务编排利器</a><ul><li><a href=#waitgroup%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label=WaitGroup基本用法>WaitGroup基本用法</a></li><li><a href=#waitgroup%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label=WaitGroup数据结构>WaitGroup数据结构</a></li><li><a href=#%e5%b0%8f%e7%bb%93 aria-label=小结>小结</a></li></ul></li><li><a href=#cond aria-label=Cond>Cond</a><ul><li><a href=#cond-%e7%9a%84%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label="Cond 的基本用法">Cond 的基本用法</a></li><li><a href=#%e6%a1%88%e4%be%8b aria-label=案例>案例</a></li><li><a href=#%e5%b0%8f%e7%bb%93-1 aria-label=小结>小结</a></li></ul></li><li><a href=#once aria-label=Once>Once</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label=使用场景>使用场景</a></li><li><a href=#%e5%b0%8f%e7%bb%93-2 aria-label=小结>小结</a></li></ul></li><li><a href=#pool aria-label=Pool>Pool</a><ul><ul><li><a href=#%e6%b3%a8%e6%84%8f%e7%82%b9 aria-label=注意点>注意点</a></li></ul><li><a href=#%e6%96%b9%e6%b3%95%e4%bb%8b%e7%bb%8d aria-label=方法介绍>方法介绍</a></li><li><a href=#%e6%8e%a8%e8%8d%90%e7%9a%84%e4%b8%89%e6%96%b9pool aria-label=推荐的三方pool>推荐的三方pool</a></li><li><a href=#pool%e5%8f%af%e8%83%bd%e9%80%a0%e6%88%90%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=pool可能造成的问题>pool可能造成的问题</a></li><li><a href=#%e5%b0%8f%e7%bb%93-3 aria-label=小结>小结</a></li></ul></li><li><a href=#context%e4%bf%a1%e6%81%af%e7%a9%bf%e9%80%8f%e4%b8%8a%e4%b8%8b%e6%96%87 aria-label=Context：信息穿透上下文>Context：信息穿透上下文</a><ul><li><a href=#context%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label=context使用场景>context使用场景</a></li><li><a href=#context-%e6%8e%a5%e5%8f%a3%e5%87%bd%e6%95%b0 aria-label="context 接口函数">context 接口函数</a></li><li><a href=#%e5%85%b3%e4%ba%8econtext%e7%9a%84%e4%b8%80%e4%ba%9b%e7%ba%a6%e5%ae%9a%e8%a7%84%e5%ae%9a aria-label=关于Context的一些约定规定>关于Context的一些约定规定</a></li><li><a href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label=应用场景>应用场景</a></li></ul></li><li><a href=#atomic-%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c aria-label="atomic 原子操作">atomic 原子操作</a><ul><li><a href=#atomic-%e6%8f%90%e4%be%9b%e7%9a%84%e6%96%b9%e6%b3%95 aria-label="atomic 提供的方法">atomic 提供的方法</a></li><li><a href=#add aria-label=Add>Add</a></li><li><a href=#swap aria-label=Swap>Swap</a></li><li><a href=#load aria-label=Load>Load</a></li><li><a href=#store aria-label=Store>Store</a></li><li><a href=#value-%e7%b1%bb%e5%9e%8b aria-label="Value 类型">Value 类型</a></li></ul></li><li><a href=#channel%e8%a7%a3%e5%86%b3%e5%b9%b6%e5%8f%91%e9%97%ae%e9%a2%98 aria-label=Channel：解决并发问题>Channel：解决并发问题</a><ul><li><a href=#channel-%e7%9a%84%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label="Channel 的应用场景">Channel 的应用场景</a></li><li><a href=#channel-%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95 aria-label="channel 基本用法">channel 基本用法</a></li><li><a href=#%e5%85%b3%e4%ba%8echannel%e7%9a%84%e9%80%89%e6%8b%a9 aria-label=关于channel的选择>关于channel的选择</a></li><li><a href=#chan-%e7%9a%84%e7%bc%96%e6%8e%92%e6%96%b9%e5%bc%8f aria-label="chan 的编排方式">chan 的编排方式</a><ul><li><a href=#or-done-%e6%a8%a1%e5%bc%8f aria-label="Or-Done 模式">Or-Done 模式</a></li><li><a href=#%e6%89%87%e5%85%a5%e6%a8%a1%e5%bc%8f aria-label=扇入模式>扇入模式</a></li><li><a href=#%e6%89%87%e5%87%ba%e6%a8%a1%e5%bc%8f aria-label=扇出模式>扇出模式</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=预备知识>预备知识<a hidden class=anchor aria-hidden=true href=#预备知识>#</a></h1><h2 id=unsafepointer>unsafe.Pointer<a hidden class=anchor aria-hidden=true href=#unsafepointer>#</a></h2><blockquote><p>unsafe.Pointer 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 C 语言里的 void* 指针，全能型的。</p></blockquote><p><a href=https://zhuanlan.zhihu.com/p/137060307>对unsafe.Pointer 又爱又恨，你会有效使用它吗？</a></p><blockquote><p>unsafe 是关注 Go 程序操作类型安全的包。</p></blockquote><p><code>unsafe.Pointer</code> 可以让你无视 Go 的类型系统，完成任何类型与内建的 uintptr 类型之间的转化。根据文档，unsafe.Pointer 可以实现四种其他类型不能的操作：</p><ul><li>任何类型的指针都可以转化为一个 unsafe.Pointer</li><li>一个 unsafe.Pointer 可以转化成任何类型的指针</li><li>一个 uintptr 可以转化成一个 unsafe.Pointer</li><li>一个 unsafe.Pointer 可以转化成一个 uintptr</li></ul><p>两种只能借助 unsafe 包才能完成的操作：</p><ul><li>使用 unsafe.Pointer 实现两种类型间转换</li><li>使用 unsafe.Pointer 处理系统调用。</li></ul><h2 id=cas比较并交换----compare-and-swap>CAS比较并交换&mdash;-Compare And Swap<a hidden class=anchor aria-hidden=true href=#cas比较并交换----compare-and-swap>#</a></h2><p><a href=https://studygolang.com/articles/23289>Go 的一个 CAS 操作使用场景</a></p><ul><li>在并发执行的多个 routine R1,R2&mldr;Rn 的中，同一时间只允许唯一一个 routine 执行某一个操作，并且其他 routine 需要非阻塞的知道自己无权操作并返回的时候，可以使用 CAS 操作。</li></ul><blockquote><p>大方向：任务编排用 <code>Channel</code>，共享资源保护用传统<code>并发原语</code></p></blockquote><h1 id=互斥锁实现机制>互斥锁实现机制<a hidden class=anchor aria-hidden=true href=#互斥锁实现机制>#</a></h1><blockquote><p>使用互斥锁，限定临界区只能同时由一个线程持有。</p></blockquote><ul><li>临界区<ul><li>在并发编程中，如果程序中的一部分会被并发访问或修改，那么，为了避免并发访问导致的意想不到的结果，这部分程序需要被保护起来，这部分被保护起来的程序，就叫做临界区。</li></ul></li></ul><p><img loading=lazy src=https://gitee.com/luenci/RepoImg/raw/master/img/202108281355882.png alt=image-20210828135504575></p><p>在 Go 标准库中，它提供了 Mutex 来实现互斥锁这个功能。</p><ul><li>共享资源。并发地读写共享资源，会出现数据竞争（data race）的问题，所以需要 Mutex、RWMutex 这样的并发原语来保护。</li><li>任务编排。需要 goroutine 按照一定的规律执行，而 goroutine 之间有相互等待或者依赖的顺序关系，我们常常使用 WaitGroup 或者 Channel 来实现。</li><li>消息传递。信息交流以及不同的 goroutine 之间的线程安全的数据交流，常常使用 Channel 来实现。</li></ul><h2 id=简单的计数器例子-counter>简单的计数器例子 Counter<a hidden class=anchor aria-hidden=true href=#简单的计数器例子-counter>#</a></h2><p>方法一：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span>(
</span></span><span style=display:flex><span><span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> count = <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>   <span style=color:#8b949e;font-style:italic>// 互斥锁保护计数器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>   <span style=color:#ff7b72>var</span> mu sync.Mutex
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>var</span> wg sync.WaitGroup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   wg.<span style=color:#d2a8ff;font-weight:700>Add</span>(<span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span><span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> wg.<span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 对变量 count 进行加法操作
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// count++ 不是一个原子操作，它至少包含几个步骤，
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// 比如读取变量 count 的当前值，
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// 对这个值加 1，把结果再保存到 count 中。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#8b949e;font-style:italic>// 因为不是原子操作，就可能有并发的问题。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>         <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10000</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span>mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>count<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>            mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 等待 10 个 goroutine 完成
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>   wg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;结果为&#34;</span>, count)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>方法二（推荐）：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Counter <span style=color:#ff7b72>struct</span>{
</span></span><span style=display:flex><span>	 id    <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>   name  <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>   mu    sync.Mutex
</span></span><span style=display:flex><span>   count <span style=color:#ff7b72>uint</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span>(c <span style=color:#ff7b72;font-weight:700>*</span>Counter)<span style=color:#d2a8ff;font-weight:700>Inc</span>() {
</span></span><span style=display:flex><span>c.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>c.count<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>   c.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span>(c <span style=color:#ff7b72;font-weight:700>*</span>Counter)<span style=color:#d2a8ff;font-weight:700>Count</span>()<span style=color:#ff7b72>uint</span>{
</span></span><span style=display:flex><span>c.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> c.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> c.count
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main2</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> counter Counter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>var</span> wg sync.WaitGroup
</span></span><span style=display:flex><span>   wg.<span style=color:#d2a8ff;font-weight:700>Add</span>(<span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span><span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span><span style=color:#ff7b72>defer</span> wg.<span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>10000</span>; i<span style=color:#ff7b72;font-weight:700>++</span>{
</span></span><span style=display:flex><span>counter.<span style=color:#d2a8ff;font-weight:700>Inc</span>()<span style=color:#8b949e;font-style:italic>// 受到 mutex 保护的方法
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>}
</span></span><span style=display:flex><span>}()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>wg.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;结果为&#34;</span>, counter.count)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>等待的goroutine们是以FIFO排队的</p><ul><li><p>1）当Mutex处于正常模式时，若此时没有新goroutine与队头goroutine竞争，则队头goroutine获得。若有新goroutine竞争大概率新goroutine获得。</p></li><li><p>2）当队头goroutine竞争锁失败1ms后，它会将Mutex调整为饥饿模式。进入饥饿模式后，锁的所有权会直接从解锁goroutine移交给队头goroutine，此时新来的goroutine直接放入队尾。</p></li><li><p>3）当一个goroutine获取锁后，如果发现自己满足下列条件中的任何一个</p><ul><li>它是队列中最后一个</li><li>它等待锁的时间少于1ms</li></ul><p>将锁切换回正常模式</p></li></ul><h2 id=mutex-注意点>mutex 注意点<a hidden class=anchor aria-hidden=true href=#mutex-注意点>#</a></h2><ul><li>Unlock 方法可以被任意的 goroutine 调用释放锁，即使是没持有这个互斥锁的 goroutine，也可以进行这个操作。这是因为，Mutex 本身并没有包含持有这把锁的 goroutine 的信息，所以，Unlock 也不会对此进行检查。Mutex 的这个设计一直保持至今。</li></ul><h2 id=mutex常见错误>Mutex常见错误<a hidden class=anchor aria-hidden=true href=#mutex常见错误>#</a></h2><blockquote><p>Mutex 常见的错误场景有 4 类，分别是 Lock/Unlock 不是成对出现、Copy 已使用的 Mutex、重入和死锁。</p></blockquote><p>可重入的概念</p><ul><li>当一个线程获取锁时，如果没有其它线程拥有这个锁，那么，这个线程就成功获取到这个锁。之后，如果其它线程再请求这个锁，就会处于阻塞等待的状态。但是，如果拥有这把锁的线程再请求这把锁的话，不会阻塞，而是成功返回，所以叫可重入锁（有时候也叫做递归锁）。只要你拥有这把锁，你可以可着劲儿地调用，比如通过递归实现一些算法，调用者不会阻塞或者死锁。</li></ul><p>死锁</p><ul><li>两个或两个以上的进程（或线程，goroutine）在执行过程中，因争夺共享资源而处于一种互相等待的状态，如果没有外部干涉，它们都将无法推进下去，此时，我们称系统处于死锁状态或系统产生了死锁。</li></ul><p>避免死锁，只要破坏这四个条件中的一个或者几个，就可以了。</p><ul><li>互斥： 至少一个资源是被排他性独享的，其他线程必须处于等待状态，直到资源被释放。</li><li>持有和等待：goroutine 持有一个资源，并且还在请求其它 goroutine 持有的资源，也就是咱们常说的“吃着碗里，看着锅里”的意思。</li><li>不可剥夺：资源只能由持有它的 goroutine 来释放。</li><li>环路等待：一般来说，存在一组等待进程，P={P1，P2，…，PN}，P1 等待 P2 持有的资源，P2 等待 P3 持有的资源，依此类推，最后是 PN 等待 P1 持有的资源，这就形成了一个环路等待的死结。</li></ul><p><img loading=lazy src=https://gitee.com/luenci/RepoImg/raw/master/img/202108281347706.png alt=image-20210828135540673></p><h2 id=mutex小结>Mutex小结<a hidden class=anchor aria-hidden=true href=#mutex小结>#</a></h2><h2 id=rwmutex--读写锁>RWMutex — 读写锁<a hidden class=anchor aria-hidden=true href=#rwmutex--读写锁>#</a></h2><p>标准库中的 RWMutex 是一个 <code>reader/writer</code> 互斥锁。RWMutex在某一时刻只能由任意数量的 reader 持有，或者是只被单个的 writer 持有。RWMutex 的方法也很少，总共有 5 个。</p><ul><li><p>Lock/Unlock：写操作时调用的方法。如果锁已经被 reader 或者 writer 持有，那么，Lock 方法会一直阻塞，直到能获取到锁；Unlock 则是配对的释放锁的方法。</p></li><li><p>RLock/RUnlock：读操作时调用的方法。如果锁已经被 writer 持有的话，RLock 方法会一直阻塞，直到能获取到锁，否则就直接返回；而 RUnlock 是 reader 释放锁的方法。</p></li><li><p>RLocker：这个方法的作用是为读操作返回一个 Locker 接口的对象。它的 Lock 方法会调用 RWMutex 的 RLock 方法，它的 Unlock 方法会调用 RWMutex 的 RUnlock 方法。</p><p>RWMutex 的零值是未加锁的状态，所以，当你使用 RWMutex 的时候，无论是声明变量，还是嵌入到其它 struct 中，都不必显式地初始化。</p></li></ul><blockquote><p>如果你遇到可以明确区分 reader 和 writer goroutine 的场景，且有大量的并发读、少量的并发写，并且有强烈的性能需求，你就可以考虑使用读写锁 RWMutex 替换 Mutex。</p></blockquote><h2 id=rwmutex-的实现原理>RWMutex 的实现原理<a hidden class=anchor aria-hidden=true href=#rwmutex-的实现原理>#</a></h2><p>RWMutex 是很常见的并发原语，很多编程语言的库都提供了类似的并发类型。RWMutex 一般都是基于互斥锁、条件变量（condition variables）或者信号量（semaphores）等并发原语来实现。Go 标准库中的 RWMutex 是基于 Mutex 实现的。</p><ul><li>readers-writers 问题一般有三类，基于对读和写操作的优先级，读写锁的设计和实现也分成三类。Read-preferring：读优先的设计可以提供很高的并发性，但是，在竞争激烈的情况下可能会导致写饥饿。这是因为，如果有大量的读，这种设计会导致只有所有的读都释放了锁之后，写才可能获取到锁。</li><li>Write-preferring：写优先的设计意味着，如果已经有一个 writer 在等待请求锁的话，它会阻止新来的请求锁的 reader 获取到锁，所以优先保障 writer。当然，如果有一些 reader 已经请求了锁的话，新请求的 writer 也会等待已经存在的 reader 都释放锁之后才能获取。所以，写优先级设计中的优先权是针对新来的请求而言的。这种设计主要避免了 writer 的饥饿问题。</li><li>不指定优先级：这种设计比较简单，不区分 reader 和 writer 优先级，某些场景下这种不指定优先级的设计反而更有效，因为第一类优先级会导致写饥饿，第二类优先级可能会导致读饥饿，这种不指定优先级的访问不再区分读写，大家都是同一个优先级，解决了饥饿的问题。</li></ul><p>Go 标准库中的 RWMutex 设计是 Write-preferring 方案。一个正在阻塞的 Lock 调用会排除新的 reader 请求到锁。</p><h2 id=rwmutex的锁>RWMutex的锁<a hidden class=anchor aria-hidden=true href=#rwmutex的锁>#</a></h2><p>RWMutex 是⼀个多 writer 多 reader 的读写锁，所以同时可能有多个 writer 和 reader。那 么，为了避免 writer 之间的竞争，RWMutex 就会使用⼀个 Mutex 来保证 writer 的互斥。</p><ul><li>在 Lock 方法中，是先获取内部互斥锁，才会修改的其他字段；</li><li>在 Unlock 方法中，是先修改的其他字段，才会释放内部互斥锁，这样才能保证字段的修改也受到互斥锁的保护。</li></ul><blockquote><p>使用读写锁最需要注意的⼀点就是尽量避免重入，重入带来的死锁⾮常隐蔽，⽽且难以 诊断。</p></blockquote><h1 id=waitgroup协同等待任务编排利器>WaitGroup：协同等待，任务编排利器<a hidden class=anchor aria-hidden=true href=#waitgroup协同等待任务编排利器>#</a></h1><h2 id=waitgroup基本用法>WaitGroup基本用法<a hidden class=anchor aria-hidden=true href=#waitgroup基本用法>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Add</span>(delta <span style=color:#ff7b72>int</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Done</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span></code></pre></td></tr></table></div></div><ul><li>Add，用来设置 WaitGroup 的计数值；</li><li>Done，用来将 WaitGroup 的计数值减 1，其实就是调用了 Add(-1)；</li><li>Wait，调用这个方法的 goroutine 会⼀直阻塞，直到 WaitGroup 的计数值变为 0。</li></ul><h2 id=waitgroup数据结构>WaitGroup数据结构<a hidden class=anchor aria-hidden=true href=#waitgroup数据结构>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> WaitGroup <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 避免复制使用的⼀个技巧，可以告诉vet⼯具违反了复制使用的规则
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		noCopy noCopy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 64bit(8bytes)的值分成两段，⾼32bit是计数值，低32bit是waiter的计数
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// 另外32bit是用作信号量的
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// 因为64bit值的原子操作需要64bit对⻬，但是32bit编译器不⽀持，所以数组中的元素在不同的架构
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// 总之，会找到对⻬的那64bit作为state，其余的32bit做信号量
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		state1 [<span style=color:#a5d6ff>3</span>]<span style=color:#ff7b72>uint32</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 得到state的地址和信号量的地址
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> (wg <span style=color:#ff7b72;font-weight:700>*</span>WaitGroup) <span style=color:#d2a8ff;font-weight:700>state</span>() (statep <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, semap <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>) {
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> uintptr(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1))<span style=color:#ff7b72;font-weight:700>%</span><span style=color:#a5d6ff>8</span> <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 如果地址是64bit对⻬的，数组前两个元素做state，后⼀个元素做信号量
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>return</span> (<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>)(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1)), <span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>2</span>]
</span></span><span style=display:flex><span>} <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 如果地址是32bit对⻬的，数组后两个元素用来做state，它可以用来做64bit的原子操作，第
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>return</span> (<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>)(unsafe.<span style=color:#d2a8ff;font-weight:700>Pointer</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>1</span>])), <span style=color:#ff7b72;font-weight:700>&amp;</span>wg.state1[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>WaitGroup 是可以重用的。只要 WaitGroup 的计数值恢复到零值的状态，那么它就可以被看作是新创建的 WaitGroup，被重复使用</p></blockquote><h2 id=小结>小结<a hidden class=anchor aria-hidden=true href=#小结>#</a></h2><ul><li>不重用 WaitGroup。新建⼀个 WaitGroup 不会带来多⼤的资源开销，重用反⽽更容易出 错。</li><li>保证所有的 Add 方法调用都在 Wait 之前。</li><li>不传递负数给 Add 方法，只通过 Done 来给计数值减 1。</li><li>不做多余的 Done 方法调用，保证 Add 的计数值和 Done 方法调用的数量是⼀样的。</li><li>不遗漏 Done 方法的调用，否则会导致 Wait hang 住⽆法返回。</li></ul><h1 id=cond>Cond<a hidden class=anchor aria-hidden=true href=#cond>#</a></h1><p>Go 标准库提供 Cond 原语的目的是，为等待 / 通知场景下的并发问题提供⽀持。</p><h2 id=cond-的基本用法>Cond 的基本用法<a hidden class=anchor aria-hidden=true href=#cond-的基本用法>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Cond
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>NeWCond</span>(l Locker) <span style=color:#ff7b72;font-weight:700>*</span>Cond
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Broadcast</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Signal</span>()
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>Cond) <span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span></code></pre></td></tr></table></div></div><ul><li>⾸先，Cond 关联的 Locker 实例可以通过 c.L 访问，它内部维护着⼀个先入先出的等待队 列。</li><li>Signal 方法，允许调用者 Caller 唤醒⼀个等待此 Cond 的 goroutine。如果此时没有等待的goroutine，显然⽆需通知 waiter；如果 Cond 等待队列中有⼀个或者多个等待的goroutine，则需要从等待队列中移除第⼀个 goroutine 并把它唤醒。在其他编程语言中，⽐如 Java 语⾔中，Signal 方法也被叫做 notify 方法。<ul><li>调用 Signal 方法时，不强求你⼀定要持有 c.L 的锁。</li></ul></li><li>Broadcast 方法，允许调用者 Caller 唤醒所有等待此 Cond 的 goroutine。如果此时没有等待的 goroutine，显然⽆需通知 waiter；如果 Cond 等待队列中有⼀个或者多个等待的goroutine，则清空所有等待的 goroutine，并全部唤醒。在其他编程语⾔中，⽐如 Java 语⾔中，Broadcast 方法也被叫做 notifyAll 方法。<ul><li>同样地，调用 Broadcast 方法时，也不强求你⼀定持有 c.L 的锁。</li></ul></li><li>Wait 方法，会把调用者 Caller 放入 Cond 的等待队列中并阻塞，直到被 Signal 或者Broadcast 的方法从等待队列中移除并唤醒。<ul><li>调用 Wait 方法时必须要持有 c.L 的锁。</li></ul></li></ul><h2 id=案例>案例<a hidden class=anchor aria-hidden=true href=#案例>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> sync.<span style=color:#d2a8ff;font-weight:700>NewCond</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>sync.Mutex{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>var</span> ready <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt;<span style=color:#a5d6ff>10</span> ; i<span style=color:#ff7b72;font-weight:700>++</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>(i <span style=color:#ff7b72>int</span>) {
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.<span style=color:#d2a8ff;font-weight:700>Duration</span>(rand.<span style=color:#d2a8ff;font-weight:700>Int63n</span>(<span style=color:#a5d6ff>10</span>)) <span style=color:#ff7b72;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// 加锁更改等待条件
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			c.L.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>			ready<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>			c.L.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>			log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;运动员#%d 准备就绪\\n&#34;</span>, i)
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// 广播唤醒所有的等待着
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			c.<span style=color:#d2a8ff;font-weight:700>Broadcast</span>()
</span></span><span style=display:flex><span>		}(i)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	c.L.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> ready<span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#a5d6ff>10</span>{
</span></span><span style=display:flex><span>		c.<span style=color:#d2a8ff;font-weight:700>Wait</span>()
</span></span><span style=display:flex><span>		log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;裁判员被唤醒一次&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	c.L.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 所有运动员是否准备就绪
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	log.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;所有运动员准备就绪，比赛开始！&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=小结-1>小结<a hidden class=anchor aria-hidden=true href=#小结-1>#</a></h2><ul><li>Cond 是为等待 / 通知场景下的并发问题提供⽀持的。它提供了条件变量的三个基本方法Signal、Broadcast 和 Wait，为并发的 goroutine 提供等待 / 通知机制。</li><li>使用 Cond 之所以容易出错，就是 Wait 调用需要加锁，以及被唤醒后⼀定要检查条件是否真 的已经满⾜。你需要牢记这两点。</li><li>WaitGroup和 Cond 的区别：WaitGroup 是主 goroutine 等待确定数量的子 goroutine 完成任务；⽽ Cond 是等待某个条件满⾜，这个条件的修改可以被任意多的 goroutine 更新，⽽且 Cond的 Wait 不关⼼也不知道其他 goroutine 的数量，只关⼼等待条件。⽽且 Cond 还有单个通知的机制，也就是 Signal 方法。</li></ul><h1 id=once>Once<a hidden class=anchor aria-hidden=true href=#once>#</a></h1><p>Once可以用来执行且仅仅执行⼀次动作，常常用于单例对象的初始化场景。</p><h2 id=使用场景>使用场景<a hidden class=anchor aria-hidden=true href=#使用场景>#</a></h2><p>sync.Once 只暴露了⼀个方法 Do，你可以多次调用 Do 方法，但是只有第⼀次调用 Do 方法 时 f 参数才会执行，这⾥的 f 是⼀个⽆参数⽆返回值的函数。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span> <span style=color:#ff7b72>func</span> (o <span style=color:#ff7b72;font-weight:700>*</span>Once) <span style=color:#d2a8ff;font-weight:700>Do</span>(f <span style=color:#ff7b72>func</span>())
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Once 常常用来初始化单例资源，或者并发访问只需初始化⼀次的共享资源，或者在测试的时候初始化⼀次测试资源。</p></blockquote><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>var</span> once sync.Once
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	f1<span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#ff7b72>func</span>(){
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;f1 exce！&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	once.<span style=color:#d2a8ff;font-weight:700>Do</span>(f1)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	f2 <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;f2 exce&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	once.<span style=color:#d2a8ff;font-weight:700>Do</span>(f2)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=小结-2>小结<a hidden class=anchor aria-hidden=true href=#小结-2>#</a></h2><blockquote><p>⼀旦你遇到只需要初始化⼀次的场景，⾸先想到的就应该是 Once 并发原语。</p></blockquote><h1 id=pool>Pool<a hidden class=anchor aria-hidden=true href=#pool>#</a></h1><p>Go 标准库中提供了⼀个通用的 Pool 数据结构，也就是 sync.Pool，我们使用它可以创建池化的对象。但是它池化的对象可能会被垃圾回收掉。</p><ul><li>sync.Pool 数据类型用来保存⼀组可独立访问的临时对象。<ul><li>也就是说，它池化的对象会在未来的某个时候被毫无预兆地移除掉。而且，如果没有别的对象引用这个被移除的对象的话，这个被移除的对象就会被垃圾回收掉。</li></ul></li></ul><h3 id=注意点>注意点<a hidden class=anchor aria-hidden=true href=#注意点>#</a></h3><ul><li><ol><li>sync.Pool 本身就是线程安全的，多个 goroutine 可以并发地调用它的方法存取对象；</li></ol></li><li><ol><li>sync.Pool 不可在使用之后再复制使用。</li></ol></li></ul><h2 id=方法介绍>方法介绍<a hidden class=anchor aria-hidden=true href=#方法介绍>#</a></h2><p>1.New</p><ul><li>Pool struct 包含⼀个 New 字段，这个字段的类型是函数 func() interface{}。当调用 Pool 的 Get 方法从池中获取元素，没有更多的空闲元素可返回时，就会调用这个 New 方法来创建新 的元素。如果你没有设置 New 字段，没有更多的空闲元素可返回时，Get 方法将返回 nil，表 明当前没有可用的元素。 有趣的是，New 是可变的字段。这就意味着，你可以在程序运行的时候改变创建元素的方 法。当然，很少有⼈会这么做，因为⼀般我们创建元素的逻辑都是⼀致的，要创建的也是同⼀ 类的元素，所以你在使用 Pool 的时候也没必要玩⼀些“花活”，在程序运行时更改 New 的 值。</li></ul><p>2.Get</p><ul><li>如果调用这个方法，就会从 Pool取⾛⼀个元素，这也就意味着，这个元素会从 Pool 中移除， 返回给调用者。不过，除了返回值是正常实例化的元素，Get 方法的返回值还可能会是⼀个 nil（Pool.New 字段没有设置，⼜没有空闲元素可以返回），所以你在使用的时候，可能需要 判断。</li></ul><p>3.Put</p><ul><li>这个方法用于将⼀个元素返还给 Pool，Pool 会把这个元素保存到池中，并且可以复用。但如 果 Put ⼀个 nil 值，Pool 就会忽略这个值。</li></ul><h2 id=推荐的三方pool>推荐的三方pool<a hidden class=anchor aria-hidden=true href=#推荐的三方pool>#</a></h2><ul><li><code>gammazero/workerpool</code>：gammazero/workerpool 可以⽆限制地提交任务，提供了更便利的 Submit 和 SubmitWait 方法提交任务，还可以提供当前的 worker 数和任务数以及关闭 Pool 的功能。</li><li><code>ivpusic/grpool</code>：grpool 创建 Pool 的时候需要提供 Worker 的数量和等待执行的任务的 最⼤数量，任务的提交是直接往 Channel 放入任务。</li><li><code>dpaks/goworkers</code>：dpaks/goworkers 提供了更便利的 Submit 方法提交任务以及Worker 数、任务数等查询方法、关闭 Pool 的方法。它的任务的执行结果需要在ResultChan 和 ErrChan 中去获取，没有提供阻塞的方法，但是它可以在初始化的时候设置 Worker 的数量和任务数。</li></ul><h2 id=pool可能造成的问题>pool可能造成的问题<a hidden class=anchor aria-hidden=true href=#pool可能造成的问题>#</a></h2><ul><li>内存泄漏<ul><li>在使用 sync.Pool 回收 buffer 的时候，⼀定要检查回收的对象的⼤⼩。如果 buffer 太⼤，就 不要回收了，否则就太浪费了</li></ul></li><li>内存浪费<ul><li>要做到物尽其用，尽可能不浪费的话，我们可以将 buffer 池分成⼏层</li><li>⼩于 512 byte的元素的 buffer 占⼀个池子；其次，⼩于 1K byte ⼤⼩的元素占⼀个池子；再次，⼩于 4Kbyte ⼤⼩的元素占⼀个池子。这样分成⼏个池子以后，就可以根据需要，到所需⼤⼩的池子中获取 buffer 了。</li></ul></li></ul><h2 id=小结-3>小结<a hidden class=anchor aria-hidden=true href=#小结-3>#</a></h2><ul><li>Pool 是⼀个通用的概念，也是解决对象重用和预先分配的⼀个常用的优化⼿段。即使你⾃⼰ 没在项目中直接使用过，但肯定在使用其它库的时候，就享受到应用 Pool 的好处了，⽐如数 据库的访问、http API 的请求等等。</li><li>我们⼀般不会在程序⼀开始的时候就开始考虑优化，⽽是等项目开发到⼀个阶段，或者快结束 的时候，才全⾯地考虑程序中的优化点，⽽ Pool 就是常用的⼀个优化⼿段。如果你发现程序 中有⼀种 GC 耗时特别⾼，有⼤量的相同类型的临时对象，不断地被创建销毁，这时，你就可 以考虑看看，是不是可以通过池化的⼿段重用这些对象。</li><li>另外，在分布式系统或者微服务框架中，可能会有⼤量的并发 Client 请求，如果 Client 的耗 时占⽐很⼤，你也可以考虑池化 Client，以便重用。</li><li>如果你发现系统中的 goroutine 数量⾮常多，程序的内存资源占用⽐较⼤，⽽且整体系统的耗 时和 GC 也⽐较⾼，我建议你看看，是否能够通过 Worker Pool 解决⼤量 goroutine 的问 题，从⽽降低这些指标。</li></ul><h1 id=context信息穿透上下文>Context：信息穿透上下文<a hidden class=anchor aria-hidden=true href=#context信息穿透上下文>#</a></h1><p>在 API之间或者方法调用之间，所传递的除了业务参数之外的额外信息。</p><h2 id=context使用场景>context使用场景<a hidden class=anchor aria-hidden=true href=#context使用场景>#</a></h2><ul><li>上下⽂信息传递 （request-scoped），⽐如处理 http 请求、在请求处理链路上传递信 息；</li><li>控制子 goroutine 的运行；</li><li>超时控制的方法调用；</li><li>可以取消的方法调用。</li></ul><h2 id=context-接口函数>context 接口函数<a hidden class=anchor aria-hidden=true href=#context-接口函数>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Context <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Deadline</span>() (deadline time.Time, ok <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Done</span>() <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>struct</span>{}
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Err</span>() <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>Value</span>(key <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>Deadline 方法会返回这个 Context 被取消的截⽌⽇期。如果没有设置截⽌⽇期，ok 的值是 false。后续每次调用这个对象的 Deadline 方法时，都会返回和第⼀次调用相同的结果。</li><li>Done 方法返回⼀个 Channel 对象。在 Context 被取消时，此 Channel 会被 close，如果没 被取消，可能会返回 nil。后续的 Done 调用总是返回相同的结果。当 Done 被 close 的时 候，你可以通过 ctx.Err 获取错误信息。Done 这个方法名其实起得并不好，因为名字太过笼 统，不能明确反映 Done 被 close 的原因，因为 cancel、timeout、deadline 都可能导致</li><li>Done 被 close，不过，目前还没有⼀个更合适的方法名称。<ul><li>如果 Done 没有被 close，Err 方法返回 nil；如果 Done 被 close，Err 方法会返回 Done 被 close 的原因。</li></ul></li><li>Value 返回此 ctx 中和指定的 key 相关联的 value。</li></ul><p>Context 中实现了 2 个常用的生成顶层 Context 的方法。</p><ul><li><code>context.Background()</code>：返回⼀个⾮ nil 的、空的 Context，没有任何值，不会被 cancel，不会超时，没有截⽌⽇期。⼀般用在主函数、初始化、测试以及创建根 Context 的时候</li><li><code>context.TODO()</code>：返回⼀个⾮ nil 的、空的 Context，没有任何值，不会被 cancel，不会超时，没有截⽌⽇期。当你不清楚是否该用 Context，或者目前还不知道要传递⼀些什么上下⽂信息的时候，就可以使用这个方法。</li></ul><h2 id=关于context的一些约定规定>关于Context的一些约定规定<a hidden class=anchor aria-hidden=true href=#关于context的一些约定规定>#</a></h2><ul><li><ol><li>⼀般函数使用 Context 的时候，会把这个参数放在第⼀个参数的位置。从来不把 nil 当Context 类型的参数值，可以使用 context.Background() 创建⼀个空的上下⽂对象，也不要使用 nil。</li></ol></li><li>2.Context 只用来临时做函数之间的上下⽂透传，不能持久化 Context 或者把 Context ⻓久存。<strong>把 Context 持久化到数据库、本地⽂件或者全局变量、缓存中都是错误的用法</strong>。</li><li>3.key 的类型不应该是字符串类型或者其它内建类型，否则容易在包之间使用 Context 时候产生冲突。使用 WithValue 时，key 的类型应该是⾃⼰定义的类型。</li><li>4.常常使用 struct{}作为底层类型定义 key 的类型。对于 exported key 的静态类型，常常是接⼝或者指针。这样可以尽量减少内存分配。</li></ul><h2 id=应用场景>应用场景<a hidden class=anchor aria-hidden=true href=#应用场景>#</a></h2><p>main函数返回时，所有的goroutine都会被直接打断，程序退出。除此之外如果想通过编程的方法让一个goroutine中断其他goroutine的执行，只能是通过在多个goroutine间通过context上下文对象同步取消信号的方式来实现。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>			ctx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithCancel</span>(context.<span style=color:#d2a8ff;font-weight:700>Background</span>())
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>defer</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>			fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;goroutine exit&#34;</span>)
</span></span><span style=display:flex><span>			}()
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>ctx.<span style=color:#d2a8ff;font-weight:700>Done</span>():
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			}()
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(time.Second)
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>			time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(<span style=color:#a5d6ff>2</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><h1 id=atomic-原子操作>atomic 原子操作<a hidden class=anchor aria-hidden=true href=#atomic-原子操作>#</a></h1><p>原子操作，是因为⼀个原子在执行的时候，其它线程不会看到执行⼀半的操作结果。在其它线程看来，原子操作要么执行完了，要么还没有执行，就像⼀个最⼩的粒子 - 原子⼀样，不可分割</p><h2 id=atomic-提供的方法>atomic 提供的方法<a hidden class=anchor aria-hidden=true href=#atomic-提供的方法>#</a></h2><ul><li>atomic 操作的对象是⼀个地址，你需要把可寻址的变量的地址作为参数传递给方法，⽽不是把变量的值传递给方法。</li></ul><h2 id=add>Add<a hidden class=anchor aria-hidden=true href=#add>#</a></h2><p>Add 方法就是给第⼀个参数地址中的值增加⼀个 delta 值</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddInt32 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, delta <span style=color:#ff7b72>int32</span>) (new <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUint32 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// To subtract a signed positive constant value c from x, do AddUint32(&amp;x, ^uint32(c-1)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// In particular, to decrement x, do AddUint32(&amp;x, ^uint32(0)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, delta <span style=color:#ff7b72>uint32</span>) (new <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddInt64 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, delta <span style=color:#ff7b72>int64</span>) (new <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUint64 atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// To subtract a signed positive constant value c from x, do AddUint64(&amp;x, ^uint64(c-1)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// In particular, to decrement x, do AddUint64(&amp;x, ^uint64(0)).
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, delta <span style=color:#ff7b72>uint64</span>) (new <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// AddUintptr atomically adds delta to *addr and returns the new value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>AddUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, delta <span style=color:#ff7b72>uintptr</span>) (new <span style=color:#ff7b72>uintptr</span>
</span></span></code></pre></td></tr></table></div></div><p>CAS （CompareAndSwap）</p><p>这个方法会⽐较当前 addr 地址⾥的值是不是 old，如果不等于 old，就返回 false；如果等于old，就把此地址的值替换成 new 值，返回 true。这就相当于“判断相等才替换”。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapInt32 executes the compare-and-swap operation for an int32 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, old, new <span style=color:#ff7b72>int32</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapInt64 executes the compare-and-swap operation for an int64 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, old, new <span style=color:#ff7b72>int64</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUint32 executes the compare-and-swap operation for a uint32 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, old, new <span style=color:#ff7b72>uint32</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUint64 executes the compare-and-swap operation for a uint64 value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, old, new <span style=color:#ff7b72>uint64</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapUintptr executes the compare-and-swap operation for a uintptr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, old, new <span style=color:#ff7b72>uintptr</span>) (swapped <span style=color:#ff7b72>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CompareAndSwapPointer executes the compare-and-swap operation for a unsafe.Pointer value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CompareAndSwapPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, old, new unsafe.Pointer) (swapped <span style=color:#ff7b72>bool</span>)
</span></span></code></pre></td></tr></table></div></div><p>效果如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>*</span>addr <span style=color:#ff7b72;font-weight:700>==</span> old {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>*</span>addr = new
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=swap>Swap<a hidden class=anchor aria-hidden=true href=#swap>#</a></h2><p>如果不需要⽐较旧值，只是⽐较粗暴地替换的话，就可以使用 Swap 方法，它替换后还可以 返回旧值。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapInt32 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, new <span style=color:#ff7b72>int32</span>) (old <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapInt64 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, new <span style=color:#ff7b72>int64</span>) (old <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUint32 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, new <span style=color:#ff7b72>uint32</span>) (old <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUint64 atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, new <span style=color:#ff7b72>uint64</span>) (old <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapUintptr atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, new <span style=color:#ff7b72>uintptr</span>) (old <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SwapPointer atomically stores new into *addr and returns the previous *addr value.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SwapPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer)
</span></span></code></pre></td></tr></table></div></div><p>效果如下：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>old = <span style=color:#ff7b72;font-weight:700>*</span>addr
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>*</span>addr = new
</span></span><span style=display:flex><span><span style=color:#ff7b72>return</span> old
</span></span></code></pre></td></tr></table></div></div><h2 id=load>Load<a hidden class=anchor aria-hidden=true href=#load>#</a></h2><p>Load 方法会取出 addr 地址中的值，即使在多处理器、多核、有 CPU cache 的情况下，这个操作也能保证 Load 是⼀个原子操作。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadInt32 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>) (val <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadInt64 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>) (val <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUint32 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>) (val <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUint64 atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>) (val <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadUintptr atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>) (val <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// LoadPointer atomically loads *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>LoadPointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer) (val unsafe.Pointer)
</span></span></code></pre></td></tr></table></div></div><h2 id=store>Store<a hidden class=anchor aria-hidden=true href=#store>#</a></h2><p>Store 方法会把⼀个值存入到指定的 addr 地址中，即使在多处理器、多核、有 CPU cache的情况下，这个操作也能保证 Store 是⼀个原子操作。别的 goroutine 通过 Load 读取出来，不会看到存取了⼀半的值。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreInt32 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreInt32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int32</span>, val <span style=color:#ff7b72>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreInt64 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreInt64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>int64</span>, val <span style=color:#ff7b72>int64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUint32 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUint32</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint32</span>, val <span style=color:#ff7b72>uint32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUint64 atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUint64</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uint64</span>, val <span style=color:#ff7b72>uint64</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StoreUintptr atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StoreUintptr</span>(addr <span style=color:#ff7b72;font-weight:700>*</span><span style=color:#ff7b72>uintptr</span>, val <span style=color:#ff7b72>uintptr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// StorePointer atomically stores val into *addr.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>StorePointer</span>(addr <span style=color:#ff7b72;font-weight:700>*</span>unsafe.Pointer, val unsafe.Pointer
</span></span></code></pre></td></tr></table></div></div><h2 id=value-类型>Value 类型<a hidden class=anchor aria-hidden=true href=#value-类型>#</a></h2><p>它可以原子地存取对象类型，但也只能存取，不能 CAS 和 Swap，常常用在配置变更等场景中</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// A Value must not be copied after first use.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Value <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	v <span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (v <span style=color:#ff7b72;font-weight:700>*</span>Value) <span style=color:#d2a8ff;font-weight:700>Load</span>() (x <span style=color:#ff7b72>interface</span>{}) {<span style=color:#ff7b72;font-weight:700>...</span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (v <span style=color:#ff7b72;font-weight:700>*</span>Value) <span style=color:#d2a8ff;font-weight:700>Store</span>(x <span style=color:#ff7b72>interface</span>{}) {<span style=color:#ff7b72;font-weight:700>...</span>}
</span></span></code></pre></td></tr></table></div></div><h1 id=channel解决并发问题>Channel：解决并发问题<a hidden class=anchor aria-hidden=true href=#channel解决并发问题>#</a></h1><p>CSP允许使用进程组件来描述系统，它们独⽴运行，并且只通过消息传递的方式通信。</p><h2 id=channel-的应用场景>Channel 的应用场景<a hidden class=anchor aria-hidden=true href=#channel-的应用场景>#</a></h2><blockquote><p>执行业务处理的 goroutine 不要通过共享内存的方式通信，⽽是要通过 Channel 通信的方式分享数据</p></blockquote><ul><li>“communicate by sharing memory”是传统的并发编程处理方式，就是指，共享的数据需要用锁进行保护，goroutine 需要获取到锁，才能并发访问数据。</li><li>“share memory by communicating”则是类似于 CSP 模型的方式，通过通信的方式，⼀个goroutine 可以把数据的“所有权”交给另外⼀个 goroutine（虽然 Go 中没有“所有权”的概念，但是从逻辑上说，你可以把它理解为是所有权的转移）。</li></ul><p>五大应用场景</p><ul><li><code>数据交流</code>：当作并发的 buffer 或者 queue，解决生产者 - 消费者问题。多个 goroutine 可以并发当作生产者（Producer）和消费者（Consumer）。</li><li><code>数据传递</code>：⼀个 goroutine 将数据交给另⼀个 goroutine，相当于把数据的拥有权 (引用)托付出去。</li><li><code>信号通知</code>：⼀个 goroutine 可以将信号 (closing、closed、data ready 等) 传递给另⼀个或者另⼀组 goroutine 。</li><li><code>任务编排</code>：可以让⼀组 goroutine 按照⼀定的顺序并发或者串行的执行，这就是编排的功能。</li><li><code>锁</code>：利用 Channel 也可以实现互斥锁的机制。</li></ul><h2 id=channel-基本用法>channel 基本用法<a hidden class=anchor aria-hidden=true href=#channel-基本用法>#</a></h2><blockquote><p><code>&lt;-</code> v有个规则，总是尽量和左边的 chan 结合（The &lt;- operator associates with the leftmost chan possible:</p></blockquote><ul><li>nil 是 chan 的零值，是⼀种特殊的 chan，对值是 nil 的 chan 的发送接收调用者总是会阻塞</li></ul><h2 id=关于channel的选择>关于channel的选择<a hidden class=anchor aria-hidden=true href=#关于channel的选择>#</a></h2><ul><li><ol><li>共享资源的并发访问使用传统并发原语；</li></ol></li><li><ol><li>复杂的任务编排和消息传递使用 Channel；</li></ol></li><li><ol><li>消息通知机制使用 Channel，除非只想 signal ⼀个 goroutine，才使用 Cond；</li></ol></li><li><ol><li>简单等待所有任务的完成用 WaitGroup，也有 Channel 的推崇者用 Channel，都可以；</li></ol></li><li><ol><li>需要和 Select 语句结合，使用 Channel；</li></ol></li><li><ol><li>需要和超时配合时，使用 Channel 和 Context。</li></ol></li></ul><h2 id=chan-的编排方式>chan 的编排方式<a hidden class=anchor aria-hidden=true href=#chan-的编排方式>#</a></h2><p>Or-Done 模式、扇入模式、扇出模式、Stream 和 map-reduce</p><h3 id=or-done-模式>Or-Done 模式<a hidden class=anchor aria-hidden=true href=#or-done-模式>#</a></h3><p>Or-Done 模式是信号通知模式中更宽泛的⼀种模式</p><p>我们会使用“信号通知”实现某个任务执行完成后的通知机制，在实现时，我们为这个任务定义 ⼀个类型为 chan struct{}类型的 done 变量，等任务结束后，我们就可以 close 这个变量， 然后，其它 receiver 就会收到这个通知。 这是有⼀个任务的情况，如果有多个任务，只要有任意⼀个任务执行完，我们就想获得这个信 号，这就是 Or-Done 模式。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// or or-done 模式 递归实现
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>or</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 特殊情况，只有零个,1个或2个 chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#ff7b72>switch</span> len(channels) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>2</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>channels[<span style=color:#a5d6ff>0</span>]:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>channels[<span style=color:#a5d6ff>1</span>]:
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	orDone <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(orDone)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// fmt.Println(&#34;执行&#34;)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>if</span> len(channels) &gt; <span style=color:#a5d6ff>2</span> {
</span></span><span style=display:flex><span>			m <span style=color:#ff7b72;font-weight:700>:=</span> len(channels) <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>or</span>(channels[:m]<span style=color:#ff7b72;font-weight:700>...</span>):
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>or</span>(channels[m:]<span style=color:#ff7b72;font-weight:700>...</span>):
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> orDone
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>sig</span>(after time.Duration) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(after)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// orSelect 反射⽅式 实现
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>orSelect</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 特殊情况，只有零个,1个或2个 chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#ff7b72>switch</span> len(channels) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	orDone <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(orDone)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 利用反射构建SelectCase
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>var</span> cases []reflect.SelectCase
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> _, c <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> channels {
</span></span><span style=display:flex><span>			cases = append(cases, reflect.SelectCase{
</span></span><span style=display:flex><span>				Dir:  reflect.SelectRecv,
</span></span><span style=display:flex><span>				Chan: reflect.<span style=color:#d2a8ff;font-weight:700>ValueOf</span>(c),
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 随机选取一个可用 case
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		reflect.<span style=color:#d2a8ff;font-weight:700>Select</span>(cases)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> orDone
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>orSelect</span>(
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>10</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>20</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>30</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>40</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>50</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sig</span>(<span style=color:#a5d6ff>01</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;done after %v&#34;</span>, time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=扇入模式>扇入模式<a hidden class=anchor aria-hidden=true href=#扇入模式>#</a></h3><p>扇入借鉴了数字电路的概念，它定义了单个逻辑们能够接受的数字信号输入最⼤量的术语。⼀ 个逻辑们可以有多个输入，⼀个输出。</p><ul><li>在软件⼯程中，<strong>模块的扇入是指有多少个上级模块调用它</strong>。</li><li>而对于我们这里的 <code>Channel</code> 扇入模式来说，就是指有多个源 <code>Channel</code> 输入、⼀个目的<code> Channel</code> 输出的情况。</li></ul><p>扇入比就是源 Channel 数量比1。</p><ul><li>每个源 Channel 的元素都会发送给目标 Channel，相当于目标 Channel 的 receiver 只需要 监听目标 Channel，就可以接收所有发送给源 Channel 的数据。</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 扇入模式 反射实现
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>fanInReflect</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	out<span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(out)
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 构造 SelectCases slice
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>var</span> cases []reflect.SelectCase
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> _, c <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> channels{
</span></span><span style=display:flex><span>			cases = append(cases, reflect.SelectCase{
</span></span><span style=display:flex><span>				Dir:  reflect.SelectRecv,
</span></span><span style=display:flex><span>				Chan: reflect.<span style=color:#d2a8ff;font-weight:700>ValueOf</span>(c),
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 循环，从 cases 中选择一个可用的
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>for</span> len(cases)&gt;<span style=color:#a5d6ff>0</span>{
</span></span><span style=display:flex><span>			i,v,ok<span style=color:#ff7b72;font-weight:700>:=</span>reflect.<span style=color:#d2a8ff;font-weight:700>Select</span>(cases)
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> !ok{ <span style=color:#8b949e;font-style:italic>// chan 关闭
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>				cases = append(cases[:i],cases[i<span style=color:#ff7b72;font-weight:700>+</span><span style=color:#a5d6ff>1</span>:]<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			out <span style=color:#ff7b72;font-weight:700>&lt;-</span>v.<span style=color:#d2a8ff;font-weight:700>Interface</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> out
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels <span style=color:#ff7b72;font-weight:700>...&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}{
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>switch</span> len(channels){
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		c<span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>		close(c)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>1</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> channels[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>2</span>:
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(channels[<span style=color:#a5d6ff>0</span>], channels[<span style=color:#a5d6ff>1</span>])
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>		m<span style=color:#ff7b72;font-weight:700>:=</span>len(channels)<span style=color:#ff7b72;font-weight:700>/</span><span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels[:m]<span style=color:#ff7b72;font-weight:700>...</span>),
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>fanInRec</span>(channels[m:]<span style=color:#ff7b72;font-weight:700>...</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 合并两个 chan
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>mergeTow</span>(a,b <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{}) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>for</span> a<span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> <span style=color:#ff7b72;font-weight:700>||</span> b <span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#79c0ff>nil</span>{
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>select</span>{
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> v,ok <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>a:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>if</span> !ok { <span style=color:#8b949e;font-style:italic>// a 已关闭，设置为nil
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>					a=<span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>					<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				c <span style=color:#ff7b72;font-weight:700>&lt;-</span> v
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> v,ok <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>b:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>if</span> !ok { <span style=color:#8b949e;font-style:italic>// b已关闭，设置为nil
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>				b=<span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				c <span style=color:#ff7b72;font-weight:700>&lt;-</span> v
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>sigs</span>(after time.Duration) <span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{} {
</span></span><span style=display:flex><span>	c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> <span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>defer</span> close(c)
</span></span><span style=display:flex><span>		time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(after)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> c
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>&lt;-</span><span style=color:#d2a8ff;font-weight:700>fanInReflect</span>(
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>10</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>02</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>03</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>04</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>05</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>		<span style=color:#d2a8ff;font-weight:700>sigs</span>(<span style=color:#a5d6ff>01</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;done after %v&#34;</span>, time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start))
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=扇出模式>扇出模式<a hidden class=anchor aria-hidden=true href=#扇出模式>#</a></h3><p>扇出模式是和扇入模式相反的。</p><p>扇出模式只有⼀个输入源 <code>Channel</code>，有多个目标 <code>Channel</code>，扇出比就是 1比目标 <code>Channel </code>数 的值，经常用在设计模式中的观察者模式中（观察者设计模式定义了对象间的⼀种⼀对多的 组合关系。这样⼀来，⼀个对象的状态发⽣变化时，所有依赖于它的对象都会得到通知并⾃动 刷新）。在观察者模式中，数据变动后，多个观察者都会收到这个变更信号。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.com/en/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/defergoroutine%E8%BF%AD%E4%BB%A3/><span class=title>« Prev</span><br><span>golang常见错误之defer和迭代</span>
</a><a class=next href=https://luenci.com/en/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3golang%E4%B8%AD%E7%9A%84nil/><span class=title>Next »</span><br><span>golang中的nil</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on x" href="https://x.com/intent/tweet/?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&amp;hashtags=Golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&amp;title=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;summary=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f&title=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on whatsapp" href="https://api.whatsapp.com/send?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on telegram" href="https://telegram.me/share/url?text=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share golang并发编程 on ycombinator" href="https://news.ycombinator.com/submitlink?t=golang%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgo%25E5%25B9%25B6%25E5%258F%2591%25E7%25BC%2596%25E7%25A8%258B%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2024 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>