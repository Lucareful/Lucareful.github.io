<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python的asyncio(协程) | Luenci</title>
<meta name=keywords content="协程"><meta name=description content="
本文转载自:https://pythonav.com/wiki/detail/6/91/
1.协程
协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	print(1)    
	...
	print(2)

def func2():    
	print(3)    
	...    
	print(4)

func1()
func2()


上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：1、2、3、4。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：1、3、2、4 。
在Python中有多种方式可以实现协程，例如：

greenlet，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现）
yield，生成器，借助生成器的特点也可以实现协程代码。
asyncio，在Python3.4中引入的模块用于编写协程代码。
async & awiat，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。

1.1 greenlet
greentlet是一个第三方模块，需要提前安装 pip3 install greenlet才能使用。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


from greenlet import greenlet
def func1():    
	print(1)        # 第1步：输出 1    
	gr2.switch()    # 第3步：切换到 func2 函数    
	print(2)        # 第6步：输出 2    
	gr2.switch()    # 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行

def func2():    
	print(3)        # 第4步：输出 3    
	gr1.switch()    # 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行    
	print(4)        # 第8步：输出 4
gr1 = greenlet(func1)
gr2 = greenlet(func2)

gr1.switch() # 第1步：去执行 func1 函数


注意：switch中也可以传递参数用于在切换执行时相互传递值。
1.2 yield
基于Python的生成器的yield和yield form关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	yield 1    
	yield from func2()    
	yield 2

def func2():    
	yield 3    
	yield 4

f1 = func1()
for item in f1:    
	print(item)


注意：yield form关键字是在Python3.3中引入的。
1.3 asyncio
在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在Python3.4发布后官方正式支持协程，即：asyncio模块。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17


import asyncio

@asyncio.coroutine
def func1():    
	print(1)    
	yield from asyncio.sleep(2)  # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(2)

@asyncio.coroutine
def func2():    
	print(3)    
	yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(4)

tasks = [asyncio.ensure_future( func1() ),    asyncio.ensure_future( func2() )]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。
1.4 async & awit
async & awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。
Python3.8之后 @asyncio.coroutine 装饰器就会被移除，推荐使用async & awit 关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14


import asyncio
async def func1():    
	print(1)    
	await asyncio.sleep(2)    
	print(2)

async def func2():    
	print(3)    
	await asyncio.sleep(2)    
	print(4)

tasks = [ asyncio.ensure_future(func1()),    asyncio.ensure_future(func2())]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


1.5 小结
关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async&amp;await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。
接下来，我们也会针对 asyncio模块 + async & await 关键字进行更加详细的讲解。"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/python%E4%B9%8Basyncio%E5%8D%8F%E7%A8%8B/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/python%E4%B9%8Basyncio%E5%8D%8F%E7%A8%8B/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://umami.luenci.com/script.js data-website-id=b0a9e971-b470-43a2-bda9-182c654377f4></script><meta property="og:title" content="Python的asyncio(协程)"><meta property="og:description" content="
本文转载自:https://pythonav.com/wiki/detail/6/91/
1.协程
协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	print(1)    
	...
	print(2)

def func2():    
	print(3)    
	...    
	print(4)

func1()
func2()


上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：1、2、3、4。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：1、3、2、4 。
在Python中有多种方式可以实现协程，例如：

greenlet，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现）
yield，生成器，借助生成器的特点也可以实现协程代码。
asyncio，在Python3.4中引入的模块用于编写协程代码。
async & awiat，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。

1.1 greenlet
greentlet是一个第三方模块，需要提前安装 pip3 install greenlet才能使用。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


from greenlet import greenlet
def func1():    
	print(1)        # 第1步：输出 1    
	gr2.switch()    # 第3步：切换到 func2 函数    
	print(2)        # 第6步：输出 2    
	gr2.switch()    # 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行

def func2():    
	print(3)        # 第4步：输出 3    
	gr1.switch()    # 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行    
	print(4)        # 第8步：输出 4
gr1 = greenlet(func1)
gr2 = greenlet(func2)

gr1.switch() # 第1步：去执行 func1 函数


注意：switch中也可以传递参数用于在切换执行时相互传递值。
1.2 yield
基于Python的生成器的yield和yield form关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	yield 1    
	yield from func2()    
	yield 2

def func2():    
	yield 3    
	yield 4

f1 = func1()
for item in f1:    
	print(item)


注意：yield form关键字是在Python3.3中引入的。
1.3 asyncio
在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在Python3.4发布后官方正式支持协程，即：asyncio模块。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17


import asyncio

@asyncio.coroutine
def func1():    
	print(1)    
	yield from asyncio.sleep(2)  # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(2)

@asyncio.coroutine
def func2():    
	print(3)    
	yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(4)

tasks = [asyncio.ensure_future( func1() ),    asyncio.ensure_future( func2() )]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。
1.4 async & awit
async & awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。
Python3.8之后 @asyncio.coroutine 装饰器就会被移除，推荐使用async & awit 关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14


import asyncio
async def func1():    
	print(1)    
	await asyncio.sleep(2)    
	print(2)

async def func2():    
	print(3)    
	await asyncio.sleep(2)    
	print(4)

tasks = [ asyncio.ensure_future(func1()),    asyncio.ensure_future(func2())]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


1.5 小结
关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async&amp;await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。
接下来，我们也会针对 asyncio模块 + async & await 关键字进行更加详细的讲解。"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/python%E4%B9%8Basyncio%E5%8D%8F%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python的asyncio(协程)"><meta name=twitter:description content="
本文转载自:https://pythonav.com/wiki/detail/6/91/
1.协程
协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	print(1)    
	...
	print(2)

def func2():    
	print(3)    
	...    
	print(4)

func1()
func2()


上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：1、2、3、4。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：1、3、2、4 。
在Python中有多种方式可以实现协程，例如：

greenlet，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现）
yield，生成器，借助生成器的特点也可以实现协程代码。
asyncio，在Python3.4中引入的模块用于编写协程代码。
async & awiat，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。

1.1 greenlet
greentlet是一个第三方模块，需要提前安装 pip3 install greenlet才能使用。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


from greenlet import greenlet
def func1():    
	print(1)        # 第1步：输出 1    
	gr2.switch()    # 第3步：切换到 func2 函数    
	print(2)        # 第6步：输出 2    
	gr2.switch()    # 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行

def func2():    
	print(3)        # 第4步：输出 3    
	gr1.switch()    # 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行    
	print(4)        # 第8步：输出 4
gr1 = greenlet(func1)
gr2 = greenlet(func2)

gr1.switch() # 第1步：去执行 func1 函数


注意：switch中也可以传递参数用于在切换执行时相互传递值。
1.2 yield
基于Python的生成器的yield和yield form关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


def func1():    
	yield 1    
	yield from func2()    
	yield 2

def func2():    
	yield 3    
	yield 4

f1 = func1()
for item in f1:    
	print(item)


注意：yield form关键字是在Python3.3中引入的。
1.3 asyncio
在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在Python3.4发布后官方正式支持协程，即：asyncio模块。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17


import asyncio

@asyncio.coroutine
def func1():    
	print(1)    
	yield from asyncio.sleep(2)  # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(2)

@asyncio.coroutine
def func2():    
	print(3)    
	yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务    
	print(4)

tasks = [asyncio.ensure_future( func1() ),    asyncio.ensure_future( func2() )]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。
1.4 async & awit
async & awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。
Python3.8之后 @asyncio.coroutine 装饰器就会被移除，推荐使用async & awit 关键字实现协程代码。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14


import asyncio
async def func1():    
	print(1)    
	await asyncio.sleep(2)    
	print(2)

async def func2():    
	print(3)    
	await asyncio.sleep(2)    
	print(4)

tasks = [ asyncio.ensure_future(func1()),    asyncio.ensure_future(func2())]

loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks))


1.5 小结
关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async&amp;await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。
接下来，我们也会针对 asyncio模块 + async & await 关键字进行更加详细的讲解。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"Python的asyncio(协程)","item":"https://luenci.com/en/posts/python%E4%B9%8Basyncio%E5%8D%8F%E7%A8%8B/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python的asyncio(协程)","name":"Python的asyncio(协程)","description":" 本文转载自:https://pythonav.com/wiki/detail/6/91/\n1.协程 协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 def func1(): print(1) ... print(2) def func2(): print(3) ... print(4) func1() func2() 上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：1、2、3、4。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：1、3、2、4 。\n在Python中有多种方式可以实现协程，例如：\ngreenlet，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现） yield，生成器，借助生成器的特点也可以实现协程代码。 asyncio，在Python3.4中引入的模块用于编写协程代码。 async \u0026amp; awiat，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。 1.1 greenlet greentlet是一个第三方模块，需要提前安装 pip3 install greenlet才能使用。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from greenlet import greenlet def func1(): print(1) # 第1步：输出 1 gr2.switch() # 第3步：切换到 func2 函数 print(2) # 第6步：输出 2 gr2.switch() # 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行 def func2(): print(3) # 第4步：输出 3 gr1.switch() # 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行 print(4) # 第8步：输出 4 gr1 = greenlet(func1) gr2 = greenlet(func2) gr1.switch() # 第1步：去执行 func1 函数 注意：switch中也可以传递参数用于在切换执行时相互传递值。\n1.2 yield 基于Python的生成器的yield和yield form关键字实现协程代码。\n1 2 3 4 5 6 7 8 9 10 11 12 def func1(): yield 1 yield from func2() yield 2 def func2(): yield 3 yield 4 f1 = func1() for item in f1: print(item) 注意：yield form关键字是在Python3.3中引入的。\n1.3 asyncio 在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在Python3.4发布后官方正式支持协程，即：asyncio模块。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import asyncio @asyncio.coroutine def func1(): print(1) yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(2) @asyncio.coroutine def func2(): print(3) yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(4) tasks = [asyncio.ensure_future( func1() ), asyncio.ensure_future( func2() )] loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks)) 注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。\n1.4 async \u0026amp; awit async \u0026amp; awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。\nPython3.8之后 @asyncio.coroutine 装饰器就会被移除，推荐使用async \u0026amp; awit 关键字实现协程代码。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import asyncio async def func1(): print(1) await asyncio.sleep(2) print(2) async def func2(): print(3) await asyncio.sleep(2) print(4) tasks = [ asyncio.ensure_future(func1()), asyncio.ensure_future(func2())] loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks)) 1.5 小结 关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async\u0026amp;await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。\n接下来，我们也会针对 asyncio模块 + async \u0026amp; await 关键字进行更加详细的讲解。\n","keywords":["协程"],"articleBody":" 本文转载自:https://pythonav.com/wiki/detail/6/91/\n1.协程 协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 def func1(): print(1) ... print(2) def func2(): print(3) ... print(4) func1() func2() 上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：1、2、3、4。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：1、3、2、4 。\n在Python中有多种方式可以实现协程，例如：\ngreenlet，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现） yield，生成器，借助生成器的特点也可以实现协程代码。 asyncio，在Python3.4中引入的模块用于编写协程代码。 async \u0026 awiat，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。 1.1 greenlet greentlet是一个第三方模块，需要提前安装 pip3 install greenlet才能使用。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from greenlet import greenlet def func1(): print(1) # 第1步：输出 1 gr2.switch() # 第3步：切换到 func2 函数 print(2) # 第6步：输出 2 gr2.switch() # 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行 def func2(): print(3) # 第4步：输出 3 gr1.switch() # 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行 print(4) # 第8步：输出 4 gr1 = greenlet(func1) gr2 = greenlet(func2) gr1.switch() # 第1步：去执行 func1 函数 注意：switch中也可以传递参数用于在切换执行时相互传递值。\n1.2 yield 基于Python的生成器的yield和yield form关键字实现协程代码。\n1 2 3 4 5 6 7 8 9 10 11 12 def func1(): yield 1 yield from func2() yield 2 def func2(): yield 3 yield 4 f1 = func1() for item in f1: print(item) 注意：yield form关键字是在Python3.3中引入的。\n1.3 asyncio 在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在Python3.4发布后官方正式支持协程，即：asyncio模块。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import asyncio @asyncio.coroutine def func1(): print(1) yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(2) @asyncio.coroutine def func2(): print(3) yield from asyncio.sleep(2) # 遇到IO耗时操作，自动化切换到tasks中的其他任务 print(4) tasks = [asyncio.ensure_future( func1() ), asyncio.ensure_future( func2() )] loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks)) 注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。\n1.4 async \u0026 awit async \u0026 awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。\nPython3.8之后 @asyncio.coroutine 装饰器就会被移除，推荐使用async \u0026 awit 关键字实现协程代码。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import asyncio async def func1(): print(1) await asyncio.sleep(2) print(2) async def func2(): print(3) await asyncio.sleep(2) print(4) tasks = [ asyncio.ensure_future(func1()), asyncio.ensure_future(func2())] loop = asyncio.get_event_loop()loop.run_until_complete(asyncio.wait(tasks)) 1.5 小结 关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async\u0026await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。\n接下来，我们也会针对 asyncio模块 + async \u0026 await 关键字进行更加详细的讲解。\n2.协程的意义 通过学习，我们已经了解到协程可以通过一个线程在多个上下文中进行来回切换执行。\n但是，协程来回切换执行的意义何在呢？（网上看到很多文章舔协程，协程牛逼之处是哪里呢？）\n1 2 计算型的操作，利用协程来回切换执行，没有任何意义，来回切换并保存状态 反倒会降低性能。 IO型的操作，利用协程在IO等待时间就去切换执行其他任务，当IO操作结束后再自动回调，那么就会大大节省资源并提供性能，从而实现异步编程（不等待任务结束就可以去执行其他代码）。 2.1 爬虫案例 例如：用代码实现下载 url_list 中的图片。\n方式一：同步编程实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \"\"\"下载图片使用第三方模块requests，请提前安装：pip3 install requests\"\"\" import requests def download_image(url): print(\"开始下载:\",url) # 发送网络请求，下载图片 response = requests.get(url) print(\"下载完成\") # 图片保存到本地文件 file_name = url.rsplit('_')[-1] with open(file_name, mode='wb') as file_object: file_object.write(response.content) if __name__ == '__main__': url_list = [ 'https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg', 'https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg', 'https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg' ] for item in url_list: download_image(item) 方式二：基于协程的异步编程实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \"\"\"下载图片使用第三方模块aiohttp，请提前安装：pip3 install aiohttp\"\"\" #!/usr/bin/env python# -*- coding:utf-8 -*- import aiohttp import asyncio async def fetch(session, url): print(\"发送请求：\", url) async with session.get(url, verify_ssl=False) as response: content = await response.content.read() file_name = url.rsplit('_')[-1] with open(file_name, mode='wb') as file_object: file_object.write(content)async def main(): async with aiohttp.ClientSession() as session: url_list = [ 'https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg', 'https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg', 'https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg' ] tasks = [asyncio.create_task(fetch(session, url)) for url in url_list] await asyncio.wait(tasks) if __name__ == '__main__': asyncio.run(main()) 上述两种的执行对比之后会发现，基于协程的异步编程 要比 同步编程的效率高了很多。因为：\n同步编程，按照顺序逐一排队执行，如果图片下载时间为2分钟，那么全部执行完则需要6分钟。 异步编程，几乎同时发出了3个下载任务的请求（遇到IO请求自动切换去发送其他任务请求），如果图片下载时间为2分钟，那么全部执行完毕也大概需要2分钟左右就可以了。 2.2 小结 协程一般应用在有IO操作的程序中，因为协程可以利用IO等待的时间去执行一些其他的代码，从而提升代码执行效率。\n生活中不也是这样的么，假设 你是一家制造汽车的老板，员工点击设备的【开始】按钮之后，在设备前需等待30分钟，然后点击【结束】按钮，此时作为老板的你一定希望这个员工在等待的那30分钟的时间去做点其他的工作。\n3.异步编程 基于async \u0026 await关键字的协程可以实现异步编程，这也是目前python异步相关的主流技术。\n想要真正的了解Python中内置的异步编程，根据下文的顺序一点点来看。\n3.1 事件循环 事件循环，可以把他当做是一个while循环，这个while循环在周期性的运行并执行一些任务，在特定条件下终止循环。\n1 2 3 4 5 6 7 8 # 伪代码任务列表 = [ 任务1, 任务2, 任务3,... ] while True: 可执行的任务列表，已完成的任务列表 = 去任务列表中检查所有的任务，将'可执行'和'已完成'的任务返回 for 就绪任务 in 已准备就绪的任务列表: 执行已就绪的任务 for 已完成的任务 in 已完成的任务列表: 在任务列表中移除 已完成的任务 如果 任务列表 中的任务都已完成，则终止循环 在编写程序时候可以通过如下代码来获取和创建事件循环。\n1 import asyncioloop = asyncio.get_event_loop() 3.2 协程和异步编程 协程函数，定义形式为 async def 的函数。\n协程对象，调用 协程函数 所返回的对象。\n1 2 3 4 5 6 # 定义一个协程函数 async def func(): pass # 调用协程函数，返回一个协程对象\tresult = func() 注意：调用协程函数时，函数内部代码不会执行，只是会返回一个协程对象。\n3.2.1 基本应用 程序中，如果想要执行协程函数的内部代码，需要 事件循环 和 协程对象 配合才能实现，如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import asyncio async def func(): print(\"协程内部代码\") # 调用协程函数，返回一个协程对象。 result = func() # 方式一 # loop = asyncio.get_event_loop() # 创建一个事件循环 # loop.run_until_complete(result) # 将协程当做任务提交到事件循环的任务列表中，协程执行完成之后终止。 # 方式二 # 本质上方式一是一样的，内部先 创建事件循环 然后执行 run_until_complete，一个简便的写法。 # asyncio.run 函数在 Python 3.7 中加入 asyncio 模块， asyncio.run(result) 这个过程可以简单理解为：将协程当做任务添加到 事件循环 的任务列表，然后事件循环检测列表中的协程是否 已准备就绪（默认可理解为就绪状态），如果准备就绪则执行其内部代码。\n3.2.2 await await是一个只能在协程函数中使用的关键字，用于遇到IO操作时挂起 当前协程（任务），当前协程（任务）挂起过程中 事件循环可以去执行其他的协程（任务），当前协程IO处理完成时，可以再次切换回来执行await之后的代码。代码如下：\n示例1：\n1 2 3 4 5 6 7 8 9 10 import asyncio async def func(): print(\"执行协程函数内部代码\") # 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。 # 当前协程挂起时，事件循环可以去执行其他协程（任务）。 response = await asyncio.sleep(2) print(\"IO请求结束，结果为：\", response) result = func()asyncio.run(result) 示例2：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import asyncio async def others(): print(\"start\") await asyncio.sleep(2) print('end') return '返回值' async def func(): print(\"执行协程函数内部代码\") # 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。 response = await others() print(\"IO请求结束，结果为：\", response) asyncio.run( func() ) 示例3：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import asyncio async def others(): print(\"start\") await asyncio.sleep(2) print('end') return '返回值' async def func(): print(\"执行协程函数内部代码\") # 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。 response1 = await others() print(\"IO请求结束，结果为：\", response1) response2 = await others() print(\"IO请求结束，结果为：\", response2) asyncio.run( func() ) 上述的所有示例都只是创建了一个任务，即：事件循环的任务列表中只有一个任务，所以在IO等待时无法演示切换到其他任务效果。\n在程序想要创建多个任务对象，需要使用Task对象来实现。\n3.2.3 Task对象 Tasks are used to schedule coroutines concurrently.\nWhen a coroutine is wrapped into a Task with functions like asyncio.create_task() the coroutine is automatically scheduled to run soon。\nTasks用于并发调度协程，通过asyncio.create_task(协程对象)的方式创建Task对象，这样可以让协程加入事件循环中等待被调度执行。除了使用 asyncio.create_task() 函数以外，还可以用低层级的 loop.create_task() 或 ensure_future() 函数。不建议手动实例化 Task 对象。\n本质上是将协程对象封装成task对象，并将协程立即加入事件循环，同时追踪协程的状态。\n注意：asyncio.create_task() 函数在 Python 3.7 中被加入。在 Python 3.7 之前，可以改用低层级的 asyncio.ensure_future() 函数。\n示例1：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import asyncio async def func(): print(1) await asyncio.sleep(2) print(2) return \"返回值\" async def main(): print(\"main开始\") # 创建协程，将协程封装到一个Task对象中并立即添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。 task1 = asyncio.create_task(func()) # 创建协程，将协程封装到一个Task对象中并立即添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。 task2 = asyncio.create_task(func()) print(\"main结束\") # 当执行某协程遇到IO操作时，会自动化切换执行其他任务。 # 此处的await是等待相对应的协程全都执行完毕并获取结果 ret1 = await task1 ret2 = await task2 print(ret1, ret2) asyncio.run(main()) 示例2：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import asyncio async def func(): print(1) await asyncio.sleep(2) print(2) return \"返回值\" async def main(): print(\"main开始\") # 创建协程，将协程封装到Task对象中并添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。 # 在调用 task_list = [ asyncio.create_task(func(), name=\"n1\"), asyncio.create_task(func(), name=\"n2\")] print(\"main结束\") # 当执行某协程遇到IO操作时，会自动化切换执行其他任务。 # 此处的await是等待所有协程执行完毕，并将所有协程的返回值保存到done # 如果设置了timeout值，则意味着此处最多等待的秒，完成的协程返回值写入到done中，未完成则写到pending中。 done, pending = await asyncio.wait(task_list, timeout=None) print(done, pending) asyncio.run(main()) 注意：asyncio.wait 源码内部会对列表中的每个协程执行ensure_future从而封装为Task对象，所以在和wait配合使用时task_list的值为[func(),func()] 也是可以的。\n示例3：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import asyncio async def func(): print(\"执行协程函数内部代码\") # 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。 response = await asyncio.sleep(2) print(\"IO请求结束，结果为：\", response) coroutine_list = [func(), func()] # 错误：coroutine_list = [ asyncio.create_task(func()), asyncio.create_task(func()) ] # 此处不能直接 asyncio.create_task，因为将Task立即加入到事件循环的任务列表， # 但此时事件循环还未创建，所以会报错。 # 使用asyncio.wait将列表封装为一个协程，并调用asyncio.run实现执行两个协程 # asyncio.wait内部会对列表中的每个协程执行ensure_future，封装为Task对象。 done,pending = asyncio.run( asyncio.wait(coroutine_list) ) 3.2.4 asyncio.Future对象 A Futureis a special low-level awaitable object that represents an eventual result of an asynchronous operation.\nasyncio中的Future对象是一个相对更偏向底层的可对象，通常我们不会直接用到这个对象，而是直接使用Task对象来完成任务的并和状态的追踪。（ Task 是 Futrue的子类 ）\nFuture为我们提供了异步编程中的 最终结果 的处理（Task类也具备状态处理的功能）。\n示例1：\n1 2 3 4 5 6 7 8 async def main(): # 获取当前事件循环 loop = asyncio.get_running_loop() # # 创建一个任务（Future对象），这个任务什么都不干。 fut = loop.create_future() # 等待任务最终结果（Future对象），没有结果则会一直等下去。 await futasyncio.run(main()) 示例2：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import asyncio async def set_after(fut): await asyncio.sleep(2) fut.set_result(\"666\") async def main(): # 获取当前事件循环 loop = asyncio.get_running_loop() # 创建一个任务（Future对象），没绑定任何行为，则这个任务永远不知道什么时候结束。 fut = loop.create_future() # 创建一个任务（Task对象），绑定了set_after函数，函数内部在2s之后，会给fut赋值。 # 即手动设置future任务的最终结果，那么fut就可以结束了。 await loop.create_task(set_after(fut)) # 等待 Future对象获取 最终结果，否则一直等下去 data = await fut print(data) asyncio.run(main()) Future对象本身函数进行绑定，所以想要让事件循环获取Future的结果，则需要手动设置。而Task对象继承了Future对象，其实就对Future进行扩展，他可以实现在对应绑定的函数执行完成之后，自动执行set_result，从而实现自动结束。\n虽然，平时使用的是Task对象，但对于结果的处理本质是基于Future对象来实现的。\n扩展：支持 await 对象语 法的对象课成为可等待对象，所以 协程对象、Task对象、Future对象 都可以被成为可等待对象。\n3.2.5 futures.Future对象 在Python的concurrent.futures模块中也有一个Future对象，这个对象是基于线程池和进程池实现异步操作时使用的对象。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import time from concurrent.futures import Future from concurrent.futures.thread import ThreadPoolExecutor from concurrent.futures.process import ProcessPoolExecutor def func(value): time.sleep(1) print(value) pool = ThreadPoolExecutor(max_workers=5) # 或 pool = ProcessPoolExecutor(max_workers=5) for i in range(10): fut = pool.submit(func, i) print(fut) 两个Future对象是不同的，他们是为不同的应用场景而设计，例如：concurrent.futures.Future不支持await语法 等。\n官方提示两对象之间不同：\nunlike asyncio Futures, concurrent.futures.Future instances cannot be awaited. asyncio.Future.result() and asyncio.Future.exception() do not accept the timeout argument. asyncio.Future.result() and asyncio.Future.exception() raise an InvalidStateError exception when the Future is not done. Callbacks registered with asyncio.Future.add_done_callback() are not called immediately. They are scheduled with loop.call_soon() instead. asyncio Future is not compatible with the concurrent.futures.wait() and concurrent.futures.as_completed() functions. 在Python提供了一个将futures.Future 对象包装成asyncio.Future对象的函数 asynic.wrap_future。\n接下里你肯定问：为什么python会提供这种功能？\n其实，一般在程序开发中我们要么统一使用 asycio 的协程实现异步操作、要么都使用进程池和线程池实现异步操作。但如果 协程的异步和 进程池/线程池的异步 混搭时，那么就会用到此功能了。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import time import asyncio import concurrent.futures def func1(): # 某个耗时操作 time.sleep(2) return \"SB\" async def main(): loop = asyncio.get_running_loop() # 1. Run in the default loop's executor ( 默认ThreadPoolExecutor ) # 第一步：内部会先调用 ThreadPoolExecutor 的 submit 方法去线程池中申请一个线程去执行func1函数，并返回一个concurrent.futures.Future对象 # 第二步：调用asyncio.wrap_future将concurrent.futures.Future对象包装为asycio.Future对象。 # 因为concurrent.futures.Future对象不支持await语法，所以需要包装为 asycio.Future对象 才能使用。 fut = loop.run_in_executor(None, func1) result = await fut print('default thread pool', result) # 2. Run in a custom thread pool: # with concurrent.futures.ThreadPoolExecutor() as pool: # result = await loop.run_in_executor( # pool, func1) # print('custom thread pool', result) # 3. Run in a custom process pool: # with concurrent.futures.ProcessPoolExecutor() as pool: # result = await loop.run_in_executor( # pool, func1) # print('custom process pool', result) asyncio.run(main()) 应用场景：当项目以协程式的异步编程开发时，如果要使用一个第三方模块，而第三方模块不支持协程方式异步编程时，就需要用到这个功能，例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import asyncio import requests async def download_image(url): # 发送网络请求，下载图片（遇到网络下载图片的IO请求，自动化切换到其他任务） print(\"开始下载:\", url) loop = asyncio.get_event_loop() # requests模块默认不支持异步操作，所以就使用线程池来配合实现了。 future = loop.run_in_executor(None, requests.get, url) response = await future print('下载完成') # 图片保存到本地文件 file_name = url.rsplit('_')[-1] with open(file_name, mode='wb') as file_object: file_object.write(response.content) if __name__ == '__main__': url_list = [ 'https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg', 'https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg', 'https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg' ] tasks = [download_image(url) for url in url_list] loop = asyncio.get_event_loop() loop.run_until_complete( asyncio.wait(tasks) ) 3.2.6 异步迭代器 什么是异步迭代器\n实现了 __aiter__() 和 __anext__() 方法的对象。__anext__ 必须返回一个 awaitable 对象。async for 会处理异步迭代器的 __anext__() 方法所返回的可等待对象，直到其引发一个 SweightAsyncIteration 异常。由 PEP 492 引入。\n什么是异步可迭代对象？\n可在 async for 语句中被使用的对象。必须通过它的 __aiter__() 方法返回一个 asynchronous iterator。由 PEP 492 引入。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 import asyncio class Reader(object): \"\"\" 自定义异步迭代器（同时也是异步可迭代对象） \"\"\" def __init__(self): self.count = 0 async def readline(self): # await asyncio.sleep(1) self.count += 1 if self.count == 100: return None return self.count def __aiter__(self): return self async def __anext__(self): val = await self.readline() if val == None: raise SweightAsyncIteration return val async def func(): # 创建异步可迭代对象 async_iter = Reader() # async for 必须要放在async def函数内，否则语法错误。 async for item in async_iter: print(item) asyncio.run(func()) 异步迭代器其实没什么太大的作用，只是支持了async for语法而已。\n3.2.6 异步上下文管理器 此种对象通过定义 __aenter__() 和 __aexit__() 方法来对 async with 语句中的环境进行控制。由 PEP 492 引入。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import asyncio class AsyncContextManager: def __init__(self): self.conn = None async def do_something(self): # 异步操作数据库 return 666 async def __aenter__(self): # 异步链接数据库 self.conn = await asyncio.sleep(1) return self async def __aexit__(self, exc_type, exc, tb): # 异步关闭数据库链接 await asyncio.sleep(1) async def func(): async with AsyncContextManager() as f: result = await f.do_something() print(result) asyncio.run(func()) 这个异步的上下文管理器还是比较有用的，平时在开发过程中 打开、处理、关闭 操作时，就可以用这种方式来处理。\n3.3 小结 在程序中只要看到async和await关键字，其内部就是基于协程实现的异步编程，这种异步编程是通过一个线程在IO等待时间去执行其他任务，从而实现并发。\n以上就是异步编程的常见操作，内容参考官方文档。\n中文版：https://docs.python.org/zh-cn/3.8/library/asyncio.html 英文本：https://docs.python.org/3.8/library/asyncio.html 4. uvloop Python标准库中提供了asyncio模块，用于支持基于协程的异步编程。\nuvloop是 asyncio 中的事件循环的替代方案，替换后可以使得asyncio性能提高。事实上，uvloop要比nodejs、gevent等其他python异步框架至少要快2倍，性能可以比肩Go语言。\n安装uvloop\n1 pip3 install uvloop 在项目中想要使用uvloop替换asyncio的事件循环也非常简单，只要在代码中这么做就行。\n1 2 3 4 5 6 7 8 import asyncio import uvloop asyncio.set_event_loop_policy(uvloop.EventLoopPolicy()) # 编写asyncio的代码，与之前写的代码一致。 # 内部的事件循环自动化会变为 uvloopasyncio.run(...) 注意：知名的asgi uvicorn内部就是使用的uvloop的事件循环。\n5.实战案例 为了更好理解，上述所有示例的IO情况都是以 asyncio.sleep 为例，而真实的项目开发中会用到很多IO的情况。\n5.1 异步Redis 当通过python去操作redis时，链接、设置值、获取值 这些都涉及网络IO请求，使用asycio异步的方式可以在IO等待时去做一些其他任务，从而提升性能。\n安装Python异步操作redis模块\n1 pip3 install aioredis 示例1：异步操作redis。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/usr/bin/env python # -*- coding:utf-8 -*- import asyncio import aioredis async def execute(address, password): print(\"开始执行\", address) # 网络IO操作：创建redis连接 redis = await aioredis.create_redis(address, password=password) # 网络IO操作：在redis中设置哈希值car，内部在设三个键值对，即： redis = { car:{key1:1,key2:2,key3:3}} await redis.hmset_dict('car', key1=1, key2=2, key3=3) # 网络IO操作：去redis中获取值 result = await redis.hgetall('car', encoding='utf-8') print(result) redis.close() # 网络IO操作：关闭redis连接 await redis.wait_closed() print(\"结束\", address) asyncio.run(execute('redis://47.93.4.198:6379', \"root!2345\")) 示例2：连接多个redis做操作（遇到IO会切换其他任务，提供了性能）。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import asyncio import aioredis async def execute(address, password): print(\"开始执行\", address) # 网络IO操作：先去连接 47.93.4.197:6379，遇到IO则自动切换任务，去连接47.93.4.198:6379 redis = await aioredis.create_redis_pool(address, password=password) # 网络IO操作：遇到IO会自动切换任务 await redis.hmset_dict('car', key1=1, key2=2, key3=3) # 网络IO操作：遇到IO会自动切换任务 result = await redis.hgetall('car', encoding='utf-8') print(result) redis.close() # 网络IO操作：遇到IO会自动切换任务 await redis.wait_closed() print(\"结束\", address) task_list = [execute('redis://47.93.4.197:6379', \"root!2345\"),execute('redis://47.93.4.198:6379', \"root!2345\")] asyncio.run(asyncio.wait(task_list)) 更多redis操作参考aioredis官网：https://aioredis.readthedocs.io/en/v1.3.0/start.html\n5.2 异步MySQL 当通过python去操作MySQL时，连接、执行SQL、关闭都涉及网络IO请求，使用asycio异步的方式可以在IO等待时去做一些其他任务，从而提升性能。\n安装Python异步操作redis模块\n1 pip3 install aiomysql 示例1：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import asyncio import aiomysql async def execute(): # 网络IO操作：连接MySQL conn = await aiomysql.connect(host='127.0.0.1', port=3306, user='root', password='123', db='mysql', ) # 网络IO操作：创建CURSOR cur = await conn.cursor() # 网络IO操作：执行SQL await cur.execute(\"SELECT Host,User FROM user\") # 网络IO操作：获取SQL结果 result = await cur.fetchall() print(result) # 网络IO操作：关闭链接 await cur.close() conn.close() asyncio.run(execute()) 示例2：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #!/usr/bin/env python # -*- coding:utf-8 -*- import asyncio import aiomysql async def execute(host, password): print(\"开始\", host) # 网络IO操作：先去连接 47.93.40.197，遇到IO则自动切换任务，去连接47.93.40.198:6379 conn = await aiomysql.connect(host=host, port=3306, user='root', password=password, db='mysql') # 网络IO操作：遇到IO会自动切换任务 cur = await conn.cursor() # 网络IO操作：遇到IO会自动切换任务 await cur.execute(\"SELECT Host,User FROM user\") # 网络IO操作：遇到IO会自动切换任务 result = await cur.fetchall() print(result) # 网络IO操作：遇到IO会自动切换任务 await cur.close() conn.close() print(\"结束\", host) task_list = [execute('47.93.40.197', \"root!2345\"),execute('47.93.40.197', \"root!2345\")] asyncio.run(asyncio.wait(task_list)) 5.3 FastAPI框架 FastAPI是一款用于构建API的高性能web框架，框架基于Python3.6+的 type hints搭建。\n接下里的异步示例以FastAPI和uvicorn来讲解（uvicorn是一个支持异步的asgi）。\n安装FastAPI web 框架，\n1 pip3 install fastapi 安装uvicorn，本质上为web提供socket server的支持的asgi（一般支持异步称asgi、不支持异步称wsgi）\n1 pip3 install uvicorn 示例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 #!/usr/bin/env python # -*- coding:utf-8 -*- import asyncio import uvicorn import aioredis from aioredis import Redis from fastapi import FastAPI app = FastAPI() REDIS_POOL = aioredis.ConnectionsPool('redis://47.193.14.198:6379', password=\"root123\", minsize=1, maxsize=10) @app.get(\"/\") def index(): \"\"\" 普通操作接口 \"\"\" return {\"message\": \"Hello World\"} @app.get(\"/red\") async def red(): \"\"\" 异步操作接口 \"\"\" print(\"请求来了\") await asyncio.sleep(3) # 连接池获取一个连接 conn = await REDIS_POOL.acquire() redis = Redis(conn) # 设置值 await redis.hmset_dict('car', key1=1, key2=2, key3=3) # 读取值 result = await redis.hgetall('car', encoding='utf-8') print(result) # 连接归还连接池 REDIS_POOL.release(conn) return result if __name__ == '__main__': uvicorn.run(\"luffy:app\", host=\"127.0.0.1\", port=5000, log_level=\"info\") 在有多个用户并发请求的情况下，异步方式来编写的接口可以在IO等待过程中去处理其他的请求，提供性能。\n例如：同时有两个用户并发来向接口 http://127.0.0.1:5000/red 发送请求，服务端只有一个线程，同一时刻只有一个请求被处理。 异步处理可以提供并发是因为：当视图函数在处理第一个请求时，第二个请求此时是等待被处理的状态，当第一个请求遇到IO等待时，会自动切换去接收并处理第二个请求，当遇到IO时自动化切换至其他请求，一旦有请求IO执行完毕，则会再次回到指定请求向下继续执行其功能代码。\n基于上下文管理，来实现自动化管理的案例： 示例1：redis\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/usr/bin/env python # -*- coding:utf-8 -*- import asyncio import uvicorn import aioredis from aioredis import Redis from fastapi import FastAPI app = FastAPI() REDIS_POOL = aioredis.ConnectionsPool('redis://47.193.14.198:6379', password=\"root123\", minsize=1, maxsize=10) @app.get(\"/\") def index(): \"\"\" 普通操作接口 \"\"\" return {\"message\": \"Hello World\"} @app.get(\"/red\") async def red(): \"\"\" 异步操作接口 \"\"\" print(\"请求来了\") async with REDIS_POOL.get() as conn: redis = Redis(conn) # 设置值 await redis.hmset_dict('car', key1=1, key2=2, key3=3) # 读取值 result = await redis.hgetall('car', encoding='utf-8') print(result) return result if __name__ == '__main__': uvicorn.run(\"fast3:app\", host=\"127.0.0.1\", port=5000, log_level=\"info\") 示例2：mysql\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #!/usr/bin/env python # -*- coding:utf-8 -*- import asyncio import uvicorn from fastapi import FastAPI import aiomysql app = FastAPI() # 创建数据库连接池 pool = aiomysql.Pool(host='127.0.0.1', port=3306, user='root', password='123', db='mysql', minsize=1, maxsize=10, echo=False, pool_recycle=-1, loop=asyncio.get_event_loop()) @app.get(\"/red\") async def red(): \"\"\" 异步操作接口 \"\"\" # 去数据库连接池申请链接 async with pool.acquire() as conn: async with conn.cursor() as cur: # 网络IO操作：执行SQL await cur.execute(\"SELECT Host,User FROM user\") # 网络IO操作：获取SQL结果 result = await cur.fetchall() print(result) # 网络IO操作：关闭链接 return {\"result\": \"ok\"} if __name__ == '__main__': uvicorn.run(\"fast2:app\", host=\"127.0.0.1\", port=5000, log_level=\"info\") 5.4 爬虫 在编写爬虫应用时，需要通过网络IO去请求目标数据，这种情况适合使用异步编程来提升性能，接下来我们使用支持异步编程的aiohttp模块来实现。\n安装aiohttp模块\n1 pip3 install aiohttp 示例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import aiohttp import asyncio async def fetch(session, url): print(\"发送请求：\", url) async with session.get(url, verify_ssl=False) as response: text = await response.text() print(\"得到结果：\", url, len(text)) async def main(): async with aiohttp.ClientSession() as session: url_list = ['https://python.org','https://www.baidu.com','https://www.pythonav.com'] tasks = [asyncio.create_task(fetch(session, url)) for url in url_list] await asyncio.wait(tasks) if __name__ == '__main__': asyncio.run(main()) 总结 为了提升性能越来越多的框架都在向异步编程靠拢，例如：sanic、tornado、django3.0、django channels组件 等，用更少资源可以做处理更多的事，何乐而不为呢。\n","wordCount":"10099","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/python%E4%B9%8Basyncio%E5%8D%8F%E7%A8%8B/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Python的asyncio(协程)</h1><div class=post-meta>📅最后更新:&nbsp;0001-01-01&nbsp|&nbsp⏲︎时长: 21 min&nbsp|&nbsp📖字数: 10099 words&nbsp;|&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1%e5%8d%8f%e7%a8%8b aria-label=1.协程>1.协程</a><ul><li><a href=#11-greenlet aria-label="1.1 greenlet">1.1 greenlet</a></li><li><a href=#12-yield aria-label="1.2 yield">1.2 yield</a></li><li><a href=#13-asyncio aria-label="1.3 asyncio">1.3 asyncio</a></li><li><a href=#14-async--awit aria-label="1.4 async & awit">1.4 async & awit</a></li><li><a href=#15-%e5%b0%8f%e7%bb%93 aria-label="1.5 小结">1.5 小结</a></li></ul></li><li><a href=#2%e5%8d%8f%e7%a8%8b%e7%9a%84%e6%84%8f%e4%b9%89 aria-label=2.协程的意义>2.协程的意义</a><ul><li><a href=#21-%e7%88%ac%e8%99%ab%e6%a1%88%e4%be%8b aria-label="2.1 爬虫案例">2.1 爬虫案例</a></li><li><a href=#22-%e5%b0%8f%e7%bb%93 aria-label="2.2 小结">2.2 小结</a></li></ul></li><li><a href=#3%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b aria-label=3.异步编程>3.异步编程</a><ul><li><a href=#31-%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af aria-label="3.1 事件循环">3.1 事件循环</a></li><li><a href=#32-%e5%8d%8f%e7%a8%8b%e5%92%8c%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b aria-label="3.2 协程和异步编程">3.2 协程和异步编程</a><ul><li><a href=#321-%e5%9f%ba%e6%9c%ac%e5%ba%94%e7%94%a8 aria-label="3.2.1 基本应用">3.2.1 基本应用</a></li><li><a href=#322-await aria-label="3.2.2 await">3.2.2 await</a></li><li><a href=#323-task%e5%af%b9%e8%b1%a1 aria-label="3.2.3 Task对象">3.2.3 Task对象</a></li><li><a href=#324-asynciofuture%e5%af%b9%e8%b1%a1 aria-label="3.2.4 asyncio.Future对象">3.2.4 asyncio.Future对象</a></li><li><a href=#325-futuresfuture%e5%af%b9%e8%b1%a1 aria-label="3.2.5 futures.Future对象">3.2.5 futures.Future对象</a></li><li><a href=#326-%e5%bc%82%e6%ad%a5%e8%bf%ad%e4%bb%a3%e5%99%a8 aria-label="3.2.6 异步迭代器">3.2.6 异步迭代器</a></li><li><a href=#326-%e5%bc%82%e6%ad%a5%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%99%a8 aria-label="3.2.6 异步上下文管理器">3.2.6 异步上下文管理器</a></li></ul></li><li><a href=#33-%e5%b0%8f%e7%bb%93 aria-label="3.3 小结">3.3 小结</a></li></ul></li><li><a href=#4-uvloop aria-label="4. uvloop">4. uvloop</a></li><li><a href=#5%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8b aria-label=5.实战案例>5.实战案例</a><ul><li><a href=#51-%e5%bc%82%e6%ad%a5redis aria-label="5.1 异步Redis">5.1 异步Redis</a></li><li><a href=#52-%e5%bc%82%e6%ad%a5mysql aria-label="5.2 异步MySQL">5.2 异步MySQL</a></li><li><a href=#53-fastapi%e6%a1%86%e6%9e%b6 aria-label="5.3 FastAPI框架">5.3 FastAPI框架</a></li><li><a href=#54-%e7%88%ac%e8%99%ab aria-label="5.4 爬虫">5.4 爬虫</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>本文转载自:https://pythonav.com/wiki/detail/6/91/</p></blockquote><h2 id=1协程>1.协程<a hidden class=anchor aria-hidden=true href=#1协程>#</a></h2><p>协程（Coroutine），也可以被称为微线程，是一种用户态内的上下文切换技术。简而言之，其实就是通过一个线程实现代码块相互切换执行。例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>...</span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func2</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>3</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>...</span>    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func1()
</span></span><span style=display:flex><span>func2()
</span></span></code></pre></td></tr></table></div></div><p>上述代码是普通的函数定义和执行，按流程分别执行两个函数中的代码，并先后会输出：<code>1、2、3、4</code>。但如果介入协程技术那么就可以实现函数见代码切换执行，最终输入：<code>1、3、2、4</code> 。</p><p>在Python中有多种方式可以实现协程，例如：</p><ul><li><code>greenlet</code>，是一个第三方模块，用于实现协程代码（Gevent协程就是基于greenlet实现）</li><li><code>yield</code>，生成器，借助生成器的特点也可以实现协程代码。</li><li><code>asyncio</code>，在Python3.4中引入的模块用于编写协程代码。</li><li><code>async & awiat</code>，在Python3.5中引入的两个关键字，结合asyncio模块可以更方便的编写协程代码。</li></ul><h3 id=11-greenlet>1.1 greenlet<a hidden class=anchor aria-hidden=true href=#11-greenlet>#</a></h3><p>greentlet是一个第三方模块，需要提前安装 <code>pip3 install greenlet</code>才能使用。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>greenlet</span> <span style=color:#ff7b72>import</span> greenlet
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)        <span style=color:#8b949e;font-style:italic># 第1步：输出 1    </span>
</span></span><span style=display:flex><span>	gr2<span style=color:#ff7b72;font-weight:700>.</span>switch()    <span style=color:#8b949e;font-style:italic># 第3步：切换到 func2 函数    </span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>2</span>)        <span style=color:#8b949e;font-style:italic># 第6步：输出 2    </span>
</span></span><span style=display:flex><span>	gr2<span style=color:#ff7b72;font-weight:700>.</span>switch()    <span style=color:#8b949e;font-style:italic># 第7步：切换到 func2 函数，从上一次执行的位置继续向后执行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func2</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>3</span>)        <span style=color:#8b949e;font-style:italic># 第4步：输出 3    </span>
</span></span><span style=display:flex><span>	gr1<span style=color:#ff7b72;font-weight:700>.</span>switch()    <span style=color:#8b949e;font-style:italic># 第5步：切换到 func1 函数，从上一次执行的位置继续向后执行    </span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>4</span>)        <span style=color:#8b949e;font-style:italic># 第8步：输出 4</span>
</span></span><span style=display:flex><span>gr1 <span style=color:#ff7b72;font-weight:700>=</span> greenlet(func1)
</span></span><span style=display:flex><span>gr2 <span style=color:#ff7b72;font-weight:700>=</span> greenlet(func2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gr1<span style=color:#ff7b72;font-weight:700>.</span>switch() <span style=color:#8b949e;font-style:italic># 第1步：去执行 func1 函数</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：switch中也可以传递参数用于在切换执行时相互传递值。</p><h3 id=12-yield>1.2 yield<a hidden class=anchor aria-hidden=true href=#12-yield>#</a></h3><p>基于Python的生成器的yield和yield form关键字实现协程代码。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield</span> <span style=color:#a5d6ff>1</span>    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield from</span> func2()    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield</span> <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func2</span>():    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield</span> <span style=color:#a5d6ff>3</span>    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield</span> <span style=color:#a5d6ff>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>f1 <span style=color:#ff7b72;font-weight:700>=</span> func1()
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> f1:    
</span></span><span style=display:flex><span>	print(item)
</span></span></code></pre></td></tr></table></div></div><p>注意：yield form关键字是在Python3.3中引入的。</p><h3 id=13-asyncio>1.3 asyncio<a hidden class=anchor aria-hidden=true href=#13-asyncio>#</a></h3><p>在Python3.4之前官方未提供协程的类库，一般大家都是使用greenlet等其他来实现。在<code>Python3.4</code>发布后官方正式支持协程，即：asyncio模块。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@asyncio.coroutine</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield from</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)  <span style=color:#8b949e;font-style:italic># 遇到IO耗时操作，自动化切换到tasks中的其他任务    </span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@asyncio.coroutine</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func2</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>3</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>yield from</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>) <span style=color:#8b949e;font-style:italic># 遇到IO耗时操作，自动化切换到tasks中的其他任务    </span>
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks <span style=color:#ff7b72;font-weight:700>=</span> [asyncio<span style=color:#ff7b72;font-weight:700>.</span>ensure_future( func1() ),    asyncio<span style=color:#ff7b72;font-weight:700>.</span>ensure_future( func2() )]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop()loop<span style=color:#ff7b72;font-weight:700>.</span>run_until_complete(asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(tasks))
</span></span></code></pre></td></tr></table></div></div><p>注意：基于asyncio模块实现的协程比之前的要更厉害，因为他的内部还集成了遇到IO耗时操作自动切花的功能。</p><h3 id=14-async--awit>1.4 async & awit<a hidden class=anchor aria-hidden=true href=#14-async--awit>#</a></h3><p>async & awit 关键字在Python3.5版本中正式引入，基于他编写的协程代码其实就是 上一示例 的加强版，让代码可以更加简便。</p><p>Python3.8之后 <code>@asyncio.coroutine</code> 装饰器就会被移除，推荐使用async & awit 关键字实现协程代码。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func2</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>3</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks <span style=color:#ff7b72;font-weight:700>=</span> [ asyncio<span style=color:#ff7b72;font-weight:700>.</span>ensure_future(func1()),    asyncio<span style=color:#ff7b72;font-weight:700>.</span>ensure_future(func2())]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop()loop<span style=color:#ff7b72;font-weight:700>.</span>run_until_complete(asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(tasks))
</span></span></code></pre></td></tr></table></div></div><h3 id=15-小结>1.5 小结<a hidden class=anchor aria-hidden=true href=#15-小结>#</a></h3><p>关于协程有多种实现方式，目前主流使用是Python官方推荐的asyncio模块和async&amp;await关键字的方式，例如：在tonado、sanic、fastapi、django3 中均已支持。</p><p>接下来，我们也会针对 <code>asyncio模块</code> + <code>async & await</code> 关键字进行更加详细的讲解。</p><h2 id=2协程的意义>2.协程的意义<a hidden class=anchor aria-hidden=true href=#2协程的意义>#</a></h2><p>通过学习，我们已经了解到协程可以通过一个线程在多个上下文中进行来回切换执行。</p><p><strong>但是</strong>，协程来回切换执行的意义何在呢？（网上看到很多文章舔协程，协程牛逼之处是哪里呢？）</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>计算型的操作，利用协程来回切换执行，没有任何意义，来回切换并保存状态 反倒会降低性能。
</span></span><span style=display:flex><span>IO型的操作，利用协程在IO等待时间就去切换执行其他任务，当IO操作结束后再自动回调，那么就会大大节省资源并提供性能，从而实现异步编程（不等待任务结束就可以去执行其他代码）。
</span></span></code></pre></td></tr></table></div></div><h3 id=21-爬虫案例>2.1 爬虫案例<a hidden class=anchor aria-hidden=true href=#21-爬虫案例>#</a></h3><p>例如：用代码实现下载 <code>url_list</code> 中的图片。</p><ul><li><p>方式一：同步编程实现</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a5d6ff>&#34;&#34;&#34;下载图片使用第三方模块requests，请提前安装：pip3 install requests&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>download_image</span>(url):    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;开始下载:&#34;</span>,url)    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 发送网络请求，下载图片    </span>
</span></span><span style=display:flex><span>	response <span style=color:#ff7b72;font-weight:700>=</span> requests<span style=color:#ff7b72;font-weight:700>.</span>get(url)    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;下载完成&#34;</span>)    
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 图片保存到本地文件    </span>
</span></span><span style=display:flex><span>	file_name <span style=color:#ff7b72;font-weight:700>=</span> url<span style=color:#ff7b72;font-weight:700>.</span>rsplit(<span style=color:#a5d6ff>&#39;_&#39;</span>)[<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>]    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>with</span> open(file_name, mode<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;wb&#39;</span>) <span style=color:#ff7b72>as</span> file_object:
</span></span><span style=display:flex><span>    	file_object<span style=color:#ff7b72;font-weight:700>.</span>write(response<span style=color:#ff7b72;font-weight:700>.</span>content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:    
</span></span><span style=display:flex><span> 	url_list <span style=color:#ff7b72;font-weight:700>=</span> [        <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg&#39;</span>,        <span style=color:#a5d6ff>&#39;https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg&#39;</span>,        <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg&#39;</span>    ]    
</span></span><span style=display:flex><span> 	<span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> url_list:        
</span></span><span style=display:flex><span> 		download_image(item)
</span></span></code></pre></td></tr></table></div></div></li><li><p>方式二：基于协程的异步编程实现</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a5d6ff>&#34;&#34;&#34;下载图片使用第三方模块aiohttp，请提前安装：pip3 install aiohttp&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python# </span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>-*-</span> coding:utf<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>8</span> <span style=color:#ff7b72;font-weight:700>-*-</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aiohttp</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>fetch</span>(session, url):    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;发送请求：&#34;</span>, url)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> session<span style=color:#ff7b72;font-weight:700>.</span>get(url, verify_ssl<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>) <span style=color:#ff7b72>as</span> response:
</span></span><span style=display:flex><span>    	content <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> response<span style=color:#ff7b72;font-weight:700>.</span>content<span style=color:#ff7b72;font-weight:700>.</span>read()        
</span></span><span style=display:flex><span>    file_name <span style=color:#ff7b72;font-weight:700>=</span> url<span style=color:#ff7b72;font-weight:700>.</span>rsplit(<span style=color:#a5d6ff>&#39;_&#39;</span>)[<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>]        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>with</span> open(file_name, mode<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;wb&#39;</span>) <span style=color:#ff7b72>as</span> file_object:
</span></span><span style=display:flex><span>    	file_object<span style=color:#ff7b72;font-weight:700>.</span>write(content)<span style=color:#ff7b72>async</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> aiohttp<span style=color:#ff7b72;font-weight:700>.</span>ClientSession() <span style=color:#ff7b72>as</span> session:
</span></span><span style=display:flex><span>    	url_list <span style=color:#ff7b72;font-weight:700>=</span> [            <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg&#39;</span>,            <span style=color:#a5d6ff>&#39;https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg&#39;</span>,            <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg&#39;</span>        ]        
</span></span><span style=display:flex><span>    	tasks <span style=color:#ff7b72;font-weight:700>=</span> [asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(fetch(session, url)) <span style=color:#ff7b72>for</span> url <span style=color:#ff7b72;font-weight:700>in</span> url_list]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(tasks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:    
</span></span><span style=display:flex><span>	asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div></li></ul><p>上述两种的执行对比之后会发现，<code>基于协程的异步编程</code> 要比 <code>同步编程</code>的效率高了很多。因为：</p><ul><li>同步编程，按照顺序逐一排队执行，如果图片下载时间为2分钟，那么全部执行完则需要6分钟。</li><li>异步编程，几乎同时发出了3个下载任务的请求（遇到IO请求自动切换去发送其他任务请求），如果图片下载时间为2分钟，那么全部执行完毕也大概需要2分钟左右就可以了。</li></ul><h3 id=22-小结>2.2 小结<a hidden class=anchor aria-hidden=true href=#22-小结>#</a></h3><p>协程一般应用在有IO操作的程序中，因为协程可以利用IO等待的时间去执行一些其他的代码，从而提升代码执行效率。</p><p>生活中不也是这样的么，假设 你是一家制造汽车的老板，员工点击设备的【开始】按钮之后，在设备前需等待30分钟，然后点击【结束】按钮，此时作为老板的你一定希望这个员工在等待的那30分钟的时间去做点其他的工作。</p><h2 id=3异步编程>3.异步编程<a hidden class=anchor aria-hidden=true href=#3异步编程>#</a></h2><p>基于<code>async</code> & <code>await</code>关键字的协程可以实现异步编程，这也是目前python异步相关的主流技术。</p><p>想要真正的了解Python中内置的异步编程，根据下文的顺序一点点来看。</p><h3 id=31-事件循环>3.1 事件循环<a hidden class=anchor aria-hidden=true href=#31-事件循环>#</a></h3><p>事件循环，可以把他当做是一个while循环，这个while循环在周期性的运行并执行一些<code>任务</code>，在特定条件下终止循环。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 伪代码任务列表 = [ 任务1, 任务2, 任务3,... ]</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>while</span> <span style=color:#79c0ff>True</span>:    
</span></span><span style=display:flex><span>	可执行的任务列表<span style=color:#f85149>，</span>已完成的任务列表 <span style=color:#ff7b72;font-weight:700>=</span> 去任务列表中检查所有的任务<span style=color:#f85149>，</span>将<span style=color:#a5d6ff>&#39;可执行&#39;</span>和<span style=color:#a5d6ff>&#39;已完成&#39;</span>的任务返回    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> 就绪任务 <span style=color:#ff7b72;font-weight:700>in</span> 已准备就绪的任务列表:
</span></span><span style=display:flex><span>    	执行已就绪的任务    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> 已完成的任务 <span style=color:#ff7b72;font-weight:700>in</span> 已完成的任务列表:
</span></span><span style=display:flex><span>        在任务列表中移除 已完成的任务
</span></span><span style=display:flex><span>    	如果 任务列表 中的任务都已完成<span style=color:#f85149>，</span>则终止循环
</span></span></code></pre></td></tr></table></div></div><p>在编写程序时候可以通过如下代码来获取和创建事件循环。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncioloop</span> <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop()
</span></span></code></pre></td></tr></table></div></div><h3 id=32-协程和异步编程>3.2 协程和异步编程<a hidden class=anchor aria-hidden=true href=#32-协程和异步编程>#</a></h3><p>协程函数，定义形式为 <a href=https://docs.python.org/zh-cn/3.8/reference/compound_stmts.html#async-def><code>async def</code></a> 的函数。</p><p>协程对象，调用 <em>协程函数</em> 所返回的对象。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 定义一个协程函数</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 调用协程函数，返回一个协程对象	</span>
</span></span><span style=display:flex><span>result <span style=color:#ff7b72;font-weight:700>=</span> func()
</span></span></code></pre></td></tr></table></div></div><p><strong>注意</strong>：调用协程函数时，函数内部代码不会执行，只是会返回一个协程对象。</p><h4 id=321-基本应用>3.2.1 基本应用<a hidden class=anchor aria-hidden=true href=#321-基本应用>#</a></h4><p>程序中，如果想要执行协程函数的内部代码，需要 <code>事件循环</code> 和 <code>协程对象</code> 配合才能实现，如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;协程内部代码&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 调用协程函数，返回一个协程对象。</span>
</span></span><span style=display:flex><span>	result <span style=color:#ff7b72;font-weight:700>=</span> func()
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 方式一</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># loop = asyncio.get_event_loop() # 创建一个事件循环</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># loop.run_until_complete(result) # 将协程当做任务提交到事件循环的任务列表中，协程执行完成之后终止。</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 方式二</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 本质上方式一是一样的，内部先 创建事件循环 然后执行 run_until_complete，一个简便的写法。</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># asyncio.run 函数在 Python 3.7 中加入 asyncio 模块，</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(result)
</span></span></code></pre></td></tr></table></div></div><p>这个过程可以简单理解为：将<code>协程</code>当做任务添加到 <code>事件循环</code> 的任务列表，然后事件循环检测列表中的<code>协程</code>是否 已准备就绪（默认可理解为就绪状态），如果准备就绪则执行其内部代码。</p><h4 id=322-await>3.2.2 await<a hidden class=anchor aria-hidden=true href=#322-await>#</a></h4><p>await是一个只能在协程函数中使用的关键字，用于遇到IO操作时挂起 当前协程（任务），当前协程（任务）挂起过程中 事件循环可以去执行其他的协程（任务），当前协程IO处理完成时，可以再次切换回来执行await之后的代码。代码如下：</p><p><strong>示例1：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;执行协程函数内部代码&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 当前协程挂起时，事件循环可以去执行其他协程（任务）。</span>
</span></span><span style=display:flex><span>    response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)    
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;IO请求结束，结果为：&#34;</span>, response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>result <span style=color:#ff7b72;font-weight:700>=</span> func()asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(result)
</span></span></code></pre></td></tr></table></div></div><p><strong>示例2：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>others</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;start&#34;</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#39;end&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;返回值&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;执行协程函数内部代码&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。    	  </span>
</span></span><span style=display:flex><span>    response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> others()
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;IO请求结束，结果为：&#34;</span>, response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run( func() )
</span></span></code></pre></td></tr></table></div></div><p><strong>示例3：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>others</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;start&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#39;end&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;返回值&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;执行协程函数内部代码&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。    	  </span>
</span></span><span style=display:flex><span>    response1 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> others()
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;IO请求结束，结果为：&#34;</span>, response1)
</span></span><span style=display:flex><span>    response2 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> others()    
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;IO请求结束，结果为：&#34;</span>, response2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run( func() )
</span></span></code></pre></td></tr></table></div></div><p>上述的所有示例都只是创建了一个任务，即：事件循环的任务列表中只有一个任务，所以在IO等待时无法演示切换到其他任务效果。</p><p>在程序想要创建多个任务对象，需要使用Task对象来实现。</p><h4 id=323-task对象>3.2.3 Task对象<a hidden class=anchor aria-hidden=true href=#323-task对象>#</a></h4><blockquote><p><em>Tasks</em> are used to schedule coroutines <em>concurrently</em>.</p><p>When a coroutine is wrapped into a <em>Task</em> with functions like <a href=https://docs.python.org/3.8/library/asyncio-task.html#asyncio.create_task><code>asyncio.create_task()</code></a> the coroutine is automatically scheduled to run soon。</p></blockquote><p>Tasks用于并发调度协程，通过<code>asyncio.create_task(协程对象)</code>的方式创建Task对象，这样可以让协程加入事件循环中等待被调度执行。除了使用 <code>asyncio.create_task()</code> 函数以外，还可以用低层级的 <code>loop.create_task()</code> 或 <code>ensure_future()</code> 函数。不建议手动实例化 Task 对象。</p><p>本质上是将协程对象封装成task对象，并将协程立即加入事件循环，同时追踪协程的状态。</p><p>注意：<code>asyncio.create_task()</code> 函数在 Python 3.7 中被加入。在 Python 3.7 之前，可以改用低层级的 <code>asyncio.ensure_future()</code> 函数。</p><p><strong>示例1：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#34;返回值&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;main开始&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建协程，将协程封装到一个Task对象中并立即添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。</span>
</span></span><span style=display:flex><span>    task1 <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(func())
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建协程，将协程封装到一个Task对象中并立即添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。</span>
</span></span><span style=display:flex><span>    task2 <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(func())
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;main结束&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 当执行某协程遇到IO操作时，会自动化切换执行其他任务。</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 此处的await是等待相对应的协程全都执行完毕并获取结果</span>
</span></span><span style=display:flex><span>    ret1 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> task1    
</span></span><span style=display:flex><span>    ret2 <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> task2    
</span></span><span style=display:flex><span>    print(ret1, ret2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><p><strong>示例2：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>1</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)    
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>2</span>)    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#34;返回值&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;main开始&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建协程，将协程封装到Task对象中并添加到事件循环的任务列表中，等待事件循环去执行（默认是就绪状态）。</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 在调用    </span>
</span></span><span style=display:flex><span>    task_list <span style=color:#ff7b72;font-weight:700>=</span> [ asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(func(), name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;n1&#34;</span>), asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(func(), name<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;n2&#34;</span>)]    			
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;main结束&#34;</span>)    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 当执行某协程遇到IO操作时，会自动化切换执行其他任务。    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 此处的await是等待所有协程执行完毕，并将所有协程的返回值保存到done    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 如果设置了timeout值，则意味着此处最多等待的秒，完成的协程返回值写入到done中，未完成则写到pending中。    </span>
</span></span><span style=display:flex><span>    done, pending <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(task_list, timeout<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>None</span>)    
</span></span><span style=display:flex><span>    print(done, pending)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><p>注意：<code>asyncio.wait</code> 源码内部会对列表中的每个协程执行ensure_future从而封装为Task对象，所以在和wait配合使用时task_list的值为<code>[func(),func()]</code> 也是可以的。</p><p><strong>示例3：</strong></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;执行协程函数内部代码&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 遇到IO操作挂起当前协程（任务），等IO操作完成之后再继续往下执行。当前协程挂起时，事件循环可以去执行其他协程（任务）。    	  </span>
</span></span><span style=display:flex><span>    response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;IO请求结束，结果为：&#34;</span>, response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>coroutine_list <span style=color:#ff7b72;font-weight:700>=</span> [func(), func()]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 错误：coroutine_list = [ asyncio.create_task(func()), asyncio.create_task(func()) ]  </span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 此处不能直接 asyncio.create_task，因为将Task立即加入到事件循环的任务列表，</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 但此时事件循环还未创建，所以会报错。</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 使用asyncio.wait将列表封装为一个协程，并调用asyncio.run实现执行两个协程</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># asyncio.wait内部会对列表中的每个协程执行ensure_future，封装为Task对象。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>done,pending <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>run( asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(coroutine_list) )
</span></span></code></pre></td></tr></table></div></div><h4 id=324-asynciofuture对象>3.2.4 asyncio.Future对象<a hidden class=anchor aria-hidden=true href=#324-asynciofuture对象>#</a></h4><blockquote><p>A <code>Future</code>is a special <strong>low-level</strong> awaitable object that represents an <strong>eventual result</strong> of an asynchronous operation.</p></blockquote><p>asyncio中的Future对象是一个相对更偏向底层的可对象，通常我们不会直接用到这个对象，而是直接使用Task对象来完成任务的并和状态的追踪。（ Task 是 Futrue的子类 ）</p><p>Future为我们提供了异步编程中的 最终结果 的处理（Task类也具备状态处理的功能）。</p><p>示例1：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():    
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 获取当前事件循环</span>
</span></span><span style=display:flex><span>    loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_running_loop()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># # 创建一个任务（Future对象），这个任务什么都不干。</span>
</span></span><span style=display:flex><span>    fut <span style=color:#ff7b72;font-weight:700>=</span> loop<span style=color:#ff7b72;font-weight:700>.</span>create_future()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 等待任务最终结果（Future对象），没有结果则会一直等下去。    </span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> futasyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><p>示例2：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>set_after</span>(fut):
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    fut<span style=color:#ff7b72;font-weight:700>.</span>set_result(<span style=color:#a5d6ff>&#34;666&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 获取当前事件循环</span>
</span></span><span style=display:flex><span>    loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_running_loop()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建一个任务（Future对象），没绑定任何行为，则这个任务永远不知道什么时候结束。</span>
</span></span><span style=display:flex><span>    fut <span style=color:#ff7b72;font-weight:700>=</span> loop<span style=color:#ff7b72;font-weight:700>.</span>create_future()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建一个任务（Task对象），绑定了set_after函数，函数内部在2s之后，会给fut赋值。</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 即手动设置future任务的最终结果，那么fut就可以结束了。</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> loop<span style=color:#ff7b72;font-weight:700>.</span>create_task(set_after(fut))
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 等待 Future对象获取 最终结果，否则一直等下去</span>
</span></span><span style=display:flex><span>    data <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fut    
</span></span><span style=display:flex><span>    print(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><p>Future对象本身函数进行绑定，所以想要让事件循环获取Future的结果，则需要手动设置。而Task对象继承了Future对象，其实就对Future进行扩展，他可以实现在对应绑定的函数执行完成之后，自动执行<code>set_result</code>，从而实现自动结束。</p><p>虽然，平时使用的是Task对象，但对于结果的处理本质是基于Future对象来实现的。</p><p>扩展：支持 <code>await 对象</code>语 法的对象课成为可等待对象，所以 <code>协程对象</code>、<code>Task对象</code>、<code>Future对象</code> 都可以被成为可等待对象。</p><h4 id=325-futuresfuture对象>3.2.5 futures.Future对象<a hidden class=anchor aria-hidden=true href=#325-futuresfuture对象>#</a></h4><p>在Python的<code>concurrent.futures</code>模块中也有一个Future对象，这个对象是基于线程池和进程池实现异步操作时使用的对象。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>time</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>concurrent.futures</span> <span style=color:#ff7b72>import</span> Future
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>concurrent.futures.thread</span> <span style=color:#ff7b72>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>concurrent.futures.process</span> <span style=color:#ff7b72>import</span> ProcessPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>(value):    
</span></span><span style=display:flex><span>	time<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>1</span>)    
</span></span><span style=display:flex><span>	print(value)
</span></span><span style=display:flex><span>    pool <span style=color:#ff7b72;font-weight:700>=</span> ThreadPoolExecutor(max_workers<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5</span>)
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 或 pool = ProcessPoolExecutor(max_workers=5)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(<span style=color:#a5d6ff>10</span>):
</span></span><span style=display:flex><span>    fut <span style=color:#ff7b72;font-weight:700>=</span> pool<span style=color:#ff7b72;font-weight:700>.</span>submit(func, i)
</span></span><span style=display:flex><span>    print(fut)
</span></span></code></pre></td></tr></table></div></div><p>两个Future对象是不同的，他们是为不同的应用场景而设计，例如：<code>concurrent.futures.Future</code>不支持await语法 等。</p><p>官方提示两对象之间不同：</p><ul><li>unlike asyncio Futures, <a href=https://docs.python.org/3.8/library/concurrent.futures.html#concurrent.futures.Future><code>concurrent.futures.Future</code></a> instances cannot be awaited.</li><li><a href=https://docs.python.org/3.8/library/asyncio-future.html#asyncio.Future.result><code>asyncio.Future.result()</code></a> and <a href=https://docs.python.org/3.8/library/asyncio-future.html#asyncio.Future.exception><code>asyncio.Future.exception()</code></a> do not accept the <em>timeout</em> argument.</li><li><a href=https://docs.python.org/3.8/library/asyncio-future.html#asyncio.Future.result><code>asyncio.Future.result()</code></a> and <a href=https://docs.python.org/3.8/library/asyncio-future.html#asyncio.Future.exception><code>asyncio.Future.exception()</code></a> raise an <a href=https://docs.python.org/3.8/library/asyncio-exceptions.html#asyncio.InvalidStateError><code>InvalidStateError</code></a> exception when the Future is not <em>done</em>.</li><li>Callbacks registered with <a href=https://docs.python.org/3.8/library/asyncio-future.html#asyncio.Future.add_done_callback><code>asyncio.Future.add_done_callback()</code></a> are not called immediately. They are scheduled with <a href=https://docs.python.org/3.8/library/asyncio-eventloop.html#asyncio.loop.call_soon><code>loop.call_soon()</code></a> instead.</li><li>asyncio Future is not compatible with the <a href=https://docs.python.org/3.8/library/concurrent.futures.html#concurrent.futures.wait><code>concurrent.futures.wait()</code></a> and <a href=https://docs.python.org/3.8/library/concurrent.futures.html#concurrent.futures.as_completed><code>concurrent.futures.as_completed()</code></a> functions.</li></ul><p>在Python提供了一个将<code>futures.Future</code> 对象包装成<code>asyncio.Future</code>对象的函数 <code>asynic.wrap_future</code>。</p><p>接下里你肯定问：为什么python会提供这种功能？</p><p>其实，一般在程序开发中我们要么统一使用 asycio 的协程实现异步操作、要么都使用进程池和线程池实现异步操作。但如果 <code>协程的异步</code>和 <code>进程池/线程池的异步</code> 混搭时，那么就会用到此功能了。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>time</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>concurrent.futures</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func1</span>():
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 某个耗时操作</span>
</span></span><span style=display:flex><span>    time<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#34;SB&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():
</span></span><span style=display:flex><span>	loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_running_loop()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 1. Run in the default loop&#39;s executor ( 默认ThreadPoolExecutor )</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 第一步：内部会先调用 ThreadPoolExecutor 的 submit 方法去线程池中申请一个线程去执行func1函数，并返回一个concurrent.futures.Future对象    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 第二步：调用asyncio.wrap_future将concurrent.futures.Future对象包装为asycio.Future对象。</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 因为concurrent.futures.Future对象不支持await语法，所以需要包装为 asycio.Future对象 才能使用。</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    fut <span style=color:#ff7b72;font-weight:700>=</span> loop<span style=color:#ff7b72;font-weight:700>.</span>run_in_executor(<span style=color:#79c0ff>None</span>, func1)
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fut
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#39;default thread pool&#39;</span>, result)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 2. Run in a custom thread pool:</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># with concurrent.futures.ThreadPoolExecutor() as pool:</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#     result = await loop.run_in_executor(    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#     pool, func1)</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#     print(&#39;custom thread pool&#39;, result)    </span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 3. Run in a custom process pool:    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># with concurrent.futures.ProcessPoolExecutor() as pool:</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#     result = await loop.run_in_executor(    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#         pool, func1)    </span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>#     print(&#39;custom process pool&#39;, result)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><p>应用场景：当项目以协程式的异步编程开发时，如果要使用一个第三方模块，而第三方模块不支持协程方式异步编程时，就需要用到这个功能，例如：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>download_image</span>(url):
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 发送网络请求，下载图片（遇到网络下载图片的IO请求，自动化切换到其他任务）</span>
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;开始下载:&#34;</span>, url)
</span></span><span style=display:flex><span>    loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># requests模块默认不支持异步操作，所以就使用线程池来配合实现了。</span>
</span></span><span style=display:flex><span>    future <span style=color:#ff7b72;font-weight:700>=</span> loop<span style=color:#ff7b72;font-weight:700>.</span>run_in_executor(<span style=color:#79c0ff>None</span>, requests<span style=color:#ff7b72;font-weight:700>.</span>get, url)
</span></span><span style=display:flex><span>    response <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> future
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#39;下载完成&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 图片保存到本地文件</span>
</span></span><span style=display:flex><span>    file_name <span style=color:#ff7b72;font-weight:700>=</span> url<span style=color:#ff7b72;font-weight:700>.</span>rsplit(<span style=color:#a5d6ff>&#39;_&#39;</span>)[<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>with</span> open(file_name, mode<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;wb&#39;</span>) <span style=color:#ff7b72>as</span> file_object:
</span></span><span style=display:flex><span>    	file_object<span style=color:#ff7b72;font-weight:700>.</span>write(response<span style=color:#ff7b72;font-weight:700>.</span>content)
</span></span><span style=display:flex><span>    	
</span></span><span style=display:flex><span> <span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span> 	url_list <span style=color:#ff7b72;font-weight:700>=</span> [        <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M02/35/A9/120x90_0_autohomecar__ChsEe12AXQ6AOOH_AAFocMs8nzU621.jpg&#39;</span>,        <span style=color:#a5d6ff>&#39;https://www2.autoimg.cn/newsdfs/g30/M01/3C/E2/120x90_0_autohomecar__ChcCSV2BBICAUntfAADjJFd6800429.jpg&#39;</span>,        <span style=color:#a5d6ff>&#39;https://www3.autoimg.cn/newsdfs/g26/M0B/3C/65/120x90_0_autohomecar__ChcCP12BFCmAIO83AAGq7vK0sGY193.jpg&#39;</span>    ]    
</span></span><span style=display:flex><span> 	tasks <span style=color:#ff7b72;font-weight:700>=</span> [download_image(url) <span style=color:#ff7b72>for</span> url <span style=color:#ff7b72;font-weight:700>in</span> url_list]    
</span></span><span style=display:flex><span> 	
</span></span><span style=display:flex><span> 	loop <span style=color:#ff7b72;font-weight:700>=</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop()    
</span></span><span style=display:flex><span> 	loop<span style=color:#ff7b72;font-weight:700>.</span>run_until_complete( asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(tasks) )
</span></span></code></pre></td></tr></table></div></div><h4 id=326-异步迭代器>3.2.6 异步迭代器<a hidden class=anchor aria-hidden=true href=#326-异步迭代器>#</a></h4><p><strong>什么是异步迭代器</strong></p><p>实现了 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__aiter__><code>__aiter__()</code></a> 和 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__anext__><code>__anext__()</code></a> 方法的对象。<code>__anext__</code> 必须返回一个 <a href=https://docs.python.org/zh-cn/3.8/glossary.html#term-awaitable>awaitable</a> 对象。<a href=https://docs.python.org/zh-cn/3.8/reference/compound_stmts.html#async-for><code>async for</code></a> 会处理异步迭代器的 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__anext__><code>__anext__()</code></a> 方法所返回的可等待对象，直到其引发一个 <a href=https://docs.python.org/zh-cn/3.8/library/exceptions.html#SweightAsyncIteration><code>SweightAsyncIteration</code></a> 异常。由 <a href=https://www.python.org/dev/peps/pep-0492><strong>PEP 492</strong></a> 引入。</p><p><strong>什么是异步可迭代对象？</strong></p><p>可在 <a href=https://docs.python.org/zh-cn/3.8/reference/compound_stmts.html#async-for><code>async for</code></a> 语句中被使用的对象。必须通过它的 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__aiter__><code>__aiter__()</code></a> 方法返回一个 <a href=https://docs.python.org/zh-cn/3.8/glossary.html#term-asynchronous-iterator>asynchronous iterator</a>。由 <a href=https://www.python.org/dev/peps/pep-0492><strong>PEP 492</strong></a> 引入。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Reader</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34; 自定义异步迭代器（同时也是异步可迭代对象） &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> __init__(self):
</span></span><span style=display:flex><span>    	self<span style=color:#ff7b72;font-weight:700>.</span>count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>readline</span>(self):
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic># await asyncio.sleep(1)</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>count <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>count <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>100</span>:
</span></span><span style=display:flex><span>        	<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>count
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> __aiter__(self):
</span></span><span style=display:flex><span>    	<span style=color:#ff7b72>return</span> self
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> __anext__(self):
</span></span><span style=display:flex><span>    	val <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> self<span style=color:#ff7b72;font-weight:700>.</span>readline()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> val <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>        	<span style=color:#ff7b72>raise</span> SweightAsyncIteration
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> val
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 创建异步可迭代对象</span>
</span></span><span style=display:flex><span>    async_iter <span style=color:#ff7b72;font-weight:700>=</span> Reader()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># async for 必须要放在async def函数内，否则语法错误。</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>for</span> item <span style=color:#ff7b72;font-weight:700>in</span> async_iter:
</span></span><span style=display:flex><span>    	print(item)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(func())
</span></span></code></pre></td></tr></table></div></div><p>异步迭代器其实没什么太大的作用，只是支持了async for语法而已。</p><h4 id=326-异步上下文管理器>3.2.6 异步上下文管理器<a hidden class=anchor aria-hidden=true href=#326-异步上下文管理器>#</a></h4><p>此种对象通过定义 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__aenter__><code>__aenter__()</code></a> 和 <a href=https://docs.python.org/zh-cn/3.8/reference/datamodel.html#object.__aexit__><code>__aexit__()</code></a> 方法来对 <a href=https://docs.python.org/zh-cn/3.8/reference/compound_stmts.html#async-with><code>async with</code></a> 语句中的环境进行控制。由 <a href=https://www.python.org/dev/peps/pep-0492><strong>PEP 492</strong></a> 引入。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AsyncContextManager</span>:
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>def</span> __init__(self):
</span></span><span style=display:flex><span>    	self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>do_something</span>(self):
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic># 异步操作数据库</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>666</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> __aenter__(self):
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic># 异步链接数据库</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>conn <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> __aexit__(self, exc_type, exc, tb):
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic># 异步关闭数据库链接</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span> <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>func</span>():
</span></span><span style=display:flex><span> 	<span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> AsyncContextManager() <span style=color:#ff7b72>as</span> f:
</span></span><span style=display:flex><span>    	result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> f<span style=color:#ff7b72;font-weight:700>.</span>do_something()
</span></span><span style=display:flex><span>        print(result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(func())
</span></span></code></pre></td></tr></table></div></div><p>这个异步的上下文管理器还是比较有用的，平时在开发过程中 打开、处理、关闭 操作时，就可以用这种方式来处理。</p><h3 id=33-小结>3.3 小结<a hidden class=anchor aria-hidden=true href=#33-小结>#</a></h3><p>在程序中只要看到<code>async</code>和<code>await</code>关键字，其内部就是基于协程实现的异步编程，这种异步编程是通过一个线程在IO等待时间去执行其他任务，从而实现并发。</p><p>以上就是异步编程的常见操作，内容参考官方文档。</p><ul><li>中文版：https://docs.python.org/zh-cn/3.8/library/asyncio.html</li><li>英文本：https://docs.python.org/3.8/library/asyncio.html</li></ul><h2 id=4-uvloop>4. uvloop<a hidden class=anchor aria-hidden=true href=#4-uvloop>#</a></h2><p>Python标准库中提供了<code>asyncio</code>模块，用于支持基于协程的异步编程。</p><p>uvloop是 asyncio 中的事件循环的替代方案，替换后可以使得asyncio性能提高。事实上，uvloop要比nodejs、gevent等其他python异步框架至少要快2倍，性能可以比肩Go语言。</p><p>安装uvloop</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install uvloop
</span></span></code></pre></td></tr></table></div></div><p>在项目中想要使用uvloop替换asyncio的事件循环也非常简单，只要在代码中这么做就行。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>uvloop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>set_event_loop_policy(uvloop<span style=color:#ff7b72;font-weight:700>.</span>EventLoopPolicy())
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 编写asyncio的代码，与之前写的代码一致。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 内部的事件循环自动化会变为</span>
</span></span><span style=display:flex><span>uvloopasyncio<span style=color:#ff7b72;font-weight:700>.</span>run(<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span></code></pre></td></tr></table></div></div><p>注意：知名的asgi uvicorn内部就是使用的uvloop的事件循环。</p><h2 id=5实战案例>5.实战案例<a hidden class=anchor aria-hidden=true href=#5实战案例>#</a></h2><p>为了更好理解，上述所有示例的IO情况都是以 <code>asyncio.sleep</code> 为例，而真实的项目开发中会用到很多IO的情况。</p><h3 id=51-异步redis>5.1 异步Redis<a hidden class=anchor aria-hidden=true href=#51-异步redis>#</a></h3><p>当通过python去操作redis时，链接、设置值、获取值 这些都涉及网络IO请求，使用asycio异步的方式可以在IO等待时去做一些其他任务，从而提升性能。</p><p>安装Python异步操作redis模块</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install aioredis
</span></span></code></pre></td></tr></table></div></div><p>示例1：异步操作redis。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aioredis</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(address, password):
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;开始执行&#34;</span>, address)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：创建redis连接</span>
</span></span><span style=display:flex><span>    redis <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> aioredis<span style=color:#ff7b72;font-weight:700>.</span>create_redis(address, password<span style=color:#ff7b72;font-weight:700>=</span>password)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：在redis中设置哈希值car，内部在设三个键值对，即： redis = { car:{key1:1,key2:2,key3:3}}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hmset_dict(<span style=color:#a5d6ff>&#39;car&#39;</span>, key1<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, key2<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>, key3<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)    <span style=color:#8b949e;font-style:italic># 网络IO操作：去redis中获取值    </span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hgetall(<span style=color:#a5d6ff>&#39;car&#39;</span>, encoding<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;utf-8&#39;</span>)    
</span></span><span style=display:flex><span>    print(result)    
</span></span><span style=display:flex><span>    redis<span style=color:#ff7b72;font-weight:700>.</span>close()    <span style=color:#8b949e;font-style:italic># 网络IO操作：关闭redis连接    </span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>wait_closed()    
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;结束&#34;</span>, address)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(execute(<span style=color:#a5d6ff>&#39;redis://47.93.4.198:6379&#39;</span>, <span style=color:#a5d6ff>&#34;root!2345&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><p>示例2：连接多个redis做操作（遇到IO会切换其他任务，提供了性能）。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aioredis</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(address, password):
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;开始执行&#34;</span>, address)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：先去连接 47.93.4.197:6379，遇到IO则自动切换任务，去连接47.93.4.198:6379</span>
</span></span><span style=display:flex><span>    redis <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> aioredis<span style=color:#ff7b72;font-weight:700>.</span>create_redis_pool(address, password<span style=color:#ff7b72;font-weight:700>=</span>password)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hmset_dict(<span style=color:#a5d6ff>&#39;car&#39;</span>, key1<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, key2<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>, key3<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务    </span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hgetall(<span style=color:#a5d6ff>&#39;car&#39;</span>, encoding<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    print(result)
</span></span><span style=display:flex><span>    redis<span style=color:#ff7b72;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务    </span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>wait_closed()
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;结束&#34;</span>, address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>task_list <span style=color:#ff7b72;font-weight:700>=</span> [execute(<span style=color:#a5d6ff>&#39;redis://47.93.4.197:6379&#39;</span>, <span style=color:#a5d6ff>&#34;root!2345&#34;</span>),execute(<span style=color:#a5d6ff>&#39;redis://47.93.4.198:6379&#39;</span>, <span style=color:#a5d6ff>&#34;root!2345&#34;</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(task_list))
</span></span></code></pre></td></tr></table></div></div><p>更多redis操作参考aioredis官网：https://aioredis.readthedocs.io/en/v1.3.0/start.html</p><h3 id=52-异步mysql>5.2 异步MySQL<a hidden class=anchor aria-hidden=true href=#52-异步mysql>#</a></h3><p>当通过python去操作MySQL时，连接、执行SQL、关闭都涉及网络IO请求，使用asycio异步的方式可以在IO等待时去做一些其他任务，从而提升性能。</p><p>安装Python异步操作redis模块</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install aiomysql
</span></span></code></pre></td></tr></table></div></div><p>示例1：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aiomysql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>():
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic># 网络IO操作：连接MySQL</span>
</span></span><span style=display:flex><span>    conn <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> aiomysql<span style=color:#ff7b72;font-weight:700>.</span>connect(host<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;127.0.0.1&#39;</span>, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3306</span>, user<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;root&#39;</span>, password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;123&#39;</span>, db<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;mysql&#39;</span>, )
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：创建CURSOR</span>
</span></span><span style=display:flex><span>    cur <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：执行SQL</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SELECT Host,User FROM user&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：获取SQL结果</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>    print(result)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：关闭链接</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    conn<span style=color:#ff7b72;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(execute())
</span></span></code></pre></td></tr></table></div></div><p>示例2：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aiomysql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>execute</span>(host, password):
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;开始&#34;</span>, host)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：先去连接 47.93.40.197，遇到IO则自动切换任务，去连接47.93.40.198:6379</span>
</span></span><span style=display:flex><span>    conn <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> aiomysql<span style=color:#ff7b72;font-weight:700>.</span>connect(host<span style=color:#ff7b72;font-weight:700>=</span>host, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3306</span>, user<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;root&#39;</span>, password<span style=color:#ff7b72;font-weight:700>=</span>password, db<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;mysql&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务</span>
</span></span><span style=display:flex><span>    cur <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SELECT Host,User FROM user&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>    print(result)    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 网络IO操作：遇到IO会自动切换任务</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    conn<span style=color:#ff7b72;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;结束&#34;</span>, host)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>task_list <span style=color:#ff7b72;font-weight:700>=</span> [execute(<span style=color:#a5d6ff>&#39;47.93.40.197&#39;</span>, <span style=color:#a5d6ff>&#34;root!2345&#34;</span>),execute(<span style=color:#a5d6ff>&#39;47.93.40.197&#39;</span>, <span style=color:#a5d6ff>&#34;root!2345&#34;</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(task_list))
</span></span></code></pre></td></tr></table></div></div><h3 id=53-fastapi框架>5.3 FastAPI框架<a hidden class=anchor aria-hidden=true href=#53-fastapi框架>#</a></h3><p>FastAPI是一款用于构建API的高性能web框架，框架基于Python3.6+的 <code>type hints</code>搭建。</p><p>接下里的异步示例以<code>FastAPI</code>和<code>uvicorn</code>来讲解（uvicorn是一个支持异步的asgi）。</p><p>安装FastAPI web 框架，</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install fastapi
</span></span></code></pre></td></tr></table></div></div><p>安装uvicorn，本质上为web提供socket server的支持的asgi（一般支持异步称asgi、不支持异步称wsgi）</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install uvicorn
</span></span></code></pre></td></tr></table></div></div><p>示例：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>uvicorn</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aioredis</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>aioredis</span> 
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> Redis
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>fastapi</span> <span style=color:#ff7b72>import</span> FastAPI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff7b72;font-weight:700>=</span> FastAPI()
</span></span><span style=display:flex><span>REDIS_POOL <span style=color:#ff7b72;font-weight:700>=</span> aioredis<span style=color:#ff7b72;font-weight:700>.</span>ConnectionsPool(<span style=color:#a5d6ff>&#39;redis://47.193.14.198:6379&#39;</span>, password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;root123&#34;</span>, minsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, maxsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@app.get</span>(<span style=color:#a5d6ff>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>index</span>():
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;&#34;&#34; 普通操作接口 &#34;&#34;&#34;</span>    
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;message&#34;</span>: <span style=color:#a5d6ff>&#34;Hello World&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@app.get</span>(<span style=color:#a5d6ff>&#34;/red&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>red</span>():
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;&#34;&#34; 异步操作接口 &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;请求来了&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>sleep(<span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 连接池获取一个连接</span>
</span></span><span style=display:flex><span>    conn <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> REDIS_POOL<span style=color:#ff7b72;font-weight:700>.</span>acquire()
</span></span><span style=display:flex><span>    redis <span style=color:#ff7b72;font-weight:700>=</span> Redis(conn)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 设置值</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hmset_dict(<span style=color:#a5d6ff>&#39;car&#39;</span>, key1<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, key2<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>, key3<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 读取值</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hgetall(<span style=color:#a5d6ff>&#39;car&#39;</span>, encoding<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    print(result)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 连接归还连接池</span>
</span></span><span style=display:flex><span>    REDIS_POOL<span style=color:#ff7b72;font-weight:700>.</span>release(conn)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>	uvicorn<span style=color:#ff7b72;font-weight:700>.</span>run(<span style=color:#a5d6ff>&#34;luffy:app&#34;</span>, host<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;127.0.0.1&#34;</span>, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5000</span>, log_level<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;info&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>在有多个用户并发请求的情况下，异步方式来编写的接口可以在IO等待过程中去处理其他的请求，提供性能。</p><p>例如：同时有两个用户并发来向接口 <code>http://127.0.0.1:5000/red</code> 发送请求，服务端只有一个线程，同一时刻只有一个请求被处理。 异步处理可以提供并发是因为：当视图函数在处理第一个请求时，第二个请求此时是等待被处理的状态，当第一个请求遇到IO等待时，会自动切换去接收并处理第二个请求，当遇到IO时自动化切换至其他请求，一旦有请求IO执行完毕，则会再次回到指定请求向下继续执行其功能代码。</p><p>基于上下文管理，来实现自动化管理的案例：
示例1：redis</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>uvicorn</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aioredis</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>aioredis</span> 
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> Redis
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>fastapi</span> <span style=color:#ff7b72>import</span> FastAPI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff7b72;font-weight:700>=</span> FastAPI()
</span></span><span style=display:flex><span>REDIS_POOL <span style=color:#ff7b72;font-weight:700>=</span> aioredis<span style=color:#ff7b72;font-weight:700>.</span>ConnectionsPool(<span style=color:#a5d6ff>&#39;redis://47.193.14.198:6379&#39;</span>, password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;root123&#34;</span>, minsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, maxsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@app.get</span>(<span style=color:#a5d6ff>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>index</span>():
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;&#34;&#34; 普通操作接口 &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;message&#34;</span>: <span style=color:#a5d6ff>&#34;Hello World&#34;</span>}
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@app.get</span>(<span style=color:#a5d6ff>&#34;/red&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>red</span>():
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;&#34;&#34; 异步操作接口 &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;请求来了&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> REDIS_POOL<span style=color:#ff7b72;font-weight:700>.</span>get() <span style=color:#ff7b72>as</span> conn:
</span></span><span style=display:flex><span>    redis <span style=color:#ff7b72;font-weight:700>=</span> Redis(conn)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 设置值</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hmset_dict(<span style=color:#a5d6ff>&#39;car&#39;</span>, key1<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, key2<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>, key3<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 读取值 </span>
</span></span><span style=display:flex><span>    result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis<span style=color:#ff7b72;font-weight:700>.</span>hgetall(<span style=color:#a5d6ff>&#39;car&#39;</span>, encoding<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    print(result)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> result
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>	uvicorn<span style=color:#ff7b72;font-weight:700>.</span>run(<span style=color:#a5d6ff>&#34;fast3:app&#34;</span>, host<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;127.0.0.1&#34;</span>, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5000</span>, log_level<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;info&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>示例2：mysql</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>uvicorn</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>from</span> <span style=color:#ff7b72>fastapi</span> <span style=color:#ff7b72>import</span> FastAPI
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aiomysql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff7b72;font-weight:700>=</span> FastAPI()
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 创建数据库连接池</span>
</span></span><span style=display:flex><span>pool <span style=color:#ff7b72;font-weight:700>=</span> aiomysql<span style=color:#ff7b72;font-weight:700>.</span>Pool(host<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;127.0.0.1&#39;</span>, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3306</span>, user<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;root&#39;</span>, password<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;123&#39;</span>, db<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#39;mysql&#39;</span>,                     minsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>, maxsize<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>, echo<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>, pool_recycle<span style=color:#ff7b72;font-weight:700>=-</span><span style=color:#a5d6ff>1</span>, loop<span style=color:#ff7b72;font-weight:700>=</span>asyncio<span style=color:#ff7b72;font-weight:700>.</span>get_event_loop())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@app.get</span>(<span style=color:#a5d6ff>&#34;/red&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>red</span>():
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;&#34;&#34; 异步操作接口 &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 去数据库连接池申请链接</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> pool<span style=color:#ff7b72;font-weight:700>.</span>acquire() <span style=color:#ff7b72>as</span> conn:
</span></span><span style=display:flex><span>    	<span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> conn<span style=color:#ff7b72;font-weight:700>.</span>cursor() <span style=color:#ff7b72>as</span> cur:
</span></span><span style=display:flex><span>        	<span style=color:#8b949e;font-style:italic># 网络IO操作：执行SQL</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>execute(<span style=color:#a5d6ff>&#34;SELECT Host,User FROM user&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 网络IO操作：获取SQL结果</span>
</span></span><span style=display:flex><span>            result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> cur<span style=color:#ff7b72;font-weight:700>.</span>fetchall()
</span></span><span style=display:flex><span>            print(result)
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># 网络IO操作：关闭链接</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {<span style=color:#a5d6ff>&#34;result&#34;</span>: <span style=color:#a5d6ff>&#34;ok&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>	uvicorn<span style=color:#ff7b72;font-weight:700>.</span>run(<span style=color:#a5d6ff>&#34;fast2:app&#34;</span>, host<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;127.0.0.1&#34;</span>, port<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>5000</span>, log_level<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;info&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=54-爬虫>5.4 爬虫<a hidden class=anchor aria-hidden=true href=#54-爬虫>#</a></h3><p>在编写爬虫应用时，需要通过网络IO去请求目标数据，这种情况适合使用异步编程来提升性能，接下来我们使用支持异步编程的aiohttp模块来实现。</p><p>安装aiohttp模块</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip3 install aiohttp
</span></span></code></pre></td></tr></table></div></div><p>示例：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>aiohttp</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>fetch</span>(session, url):
</span></span><span style=display:flex><span>	print(<span style=color:#a5d6ff>&#34;发送请求：&#34;</span>, url)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> session<span style=color:#ff7b72;font-weight:700>.</span>get(url, verify_ssl<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>) <span style=color:#ff7b72>as</span> response:
</span></span><span style=display:flex><span>    	text <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> response<span style=color:#ff7b72;font-weight:700>.</span>text()
</span></span><span style=display:flex><span>        print(<span style=color:#a5d6ff>&#34;得到结果：&#34;</span>, url, len(text))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>main</span>():
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>async</span> <span style=color:#ff7b72>with</span> aiohttp<span style=color:#ff7b72;font-weight:700>.</span>ClientSession() <span style=color:#ff7b72>as</span> session:
</span></span><span style=display:flex><span>    	url_list <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#39;https://python.org&#39;</span>,<span style=color:#a5d6ff>&#39;https://www.baidu.com&#39;</span>,<span style=color:#a5d6ff>&#39;https://www.pythonav.com&#39;</span>]
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        tasks <span style=color:#ff7b72;font-weight:700>=</span> [asyncio<span style=color:#ff7b72;font-weight:700>.</span>create_task(fetch(session, url)) <span style=color:#ff7b72>for</span> url <span style=color:#ff7b72;font-weight:700>in</span> url_list]
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> asyncio<span style=color:#ff7b72;font-weight:700>.</span>wait(tasks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> __name__ <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>	asyncio<span style=color:#ff7b72;font-weight:700>.</span>run(main())
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>为了提升性能越来越多的框架都在向异步编程靠拢，例如：sanic、tornado、django3.0、django channels组件 等，用更少资源可以做处理更多的事，何乐而不为呢。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.com/en/tags/%E5%8D%8F%E7%A8%8B/>协程</a></li></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/%E5%A4%9A%E7%BA%BF%E7%A8%8B/><span class=title>« Prev</span><br><span>python多线程，并发和锁</span>
</a><a class=next href=https://luenci.com/en/posts/python%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC%E6%8E%A2%E7%A9%B6/><span class=title>Next »</span><br><span>python的值传递和引用传递</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on x" href="https://x.com/intent/tweet/?text=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f&amp;hashtags=%e5%8d%8f%e7%a8%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f&amp;title=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29&amp;summary=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f&title=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on whatsapp" href="https://api.whatsapp.com/send?text=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on telegram" href="https://telegram.me/share/url?text=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Python的asyncio(协程) on ycombinator" href="https://news.ycombinator.com/submitlink?t=Python%e7%9a%84asyncio%28%e5%8d%8f%e7%a8%8b%29&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fpython%25E4%25B9%258Basyncio%25E5%258D%258F%25E7%25A8%258B%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2025 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>