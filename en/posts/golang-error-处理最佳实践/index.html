<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Golang error 处理最佳实践 | Luenci</title>
<meta name=keywords content="错误处理"><meta name=description content='golang error 处理最佳实践
错误类型定义

Go 中error 类型是一个接口类型



1
2
3


type error interface {
    Error() string
}


基本上，error 是实现该接口任何内容，它将错误消息作为字符串返回。
构造错误
​    可以使用 Go 的内置或包动态构造错误。
​    例如，以下函数使用包返回带有静态错误消息的新错误：errors fmt errors


1
2
3
4
5
6
7


package main

import "errors"

func DoSomething() error {
    return errors.New("something didn&#39;t work")
}


​	同样，该包可用于向错误添加动态数据。
​	例如：fmt int string error


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


package main

import "fmt"

func Divide(a, b int) (int, error) {
    if b == 0 {
        return 0, fmt.Errorf("can&#39;t divide &#39;%d&#39; by zero", a)
    }
    return a / b, nil
}


请注意，当用于用格式动词包装另一个错误时，这将非常有用 fmt.Errorf %w
在上面的示例中，还有其他一些重要事项需要注意。

错误可以返回为nil ，它是 Go 中 error 的默认值或零值。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。if err != nil 
错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 int和 nil 。
当我们返回错误时，函数返回的其他参数通常作为其默认的零值返回。函数的用户可能期望，如果返回非nil 错误，则返回的其他参数不相关。
最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。
'><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/golang-error-%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/golang-error-%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://umami.luenci.com/script.js data-website-id=b0a9e971-b470-43a2-bda9-182c654377f4></script><meta property="og:title" content="Golang error 处理最佳实践"><meta property="og:description" content='golang error 处理最佳实践
错误类型定义

Go 中error 类型是一个接口类型



1
2
3


type error interface {
    Error() string
}


基本上，error 是实现该接口任何内容，它将错误消息作为字符串返回。
构造错误
​    可以使用 Go 的内置或包动态构造错误。
​    例如，以下函数使用包返回带有静态错误消息的新错误：errors fmt errors


1
2
3
4
5
6
7


package main

import "errors"

func DoSomething() error {
    return errors.New("something didn&#39;t work")
}


​	同样，该包可用于向错误添加动态数据。
​	例如：fmt int string error


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


package main

import "fmt"

func Divide(a, b int) (int, error) {
    if b == 0 {
        return 0, fmt.Errorf("can&#39;t divide &#39;%d&#39; by zero", a)
    }
    return a / b, nil
}


请注意，当用于用格式动词包装另一个错误时，这将非常有用 fmt.Errorf %w
在上面的示例中，还有其他一些重要事项需要注意。

错误可以返回为nil ，它是 Go 中 error 的默认值或零值。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。if err != nil 
错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 int和 nil 。
当我们返回错误时，函数返回的其他参数通常作为其默认的零值返回。函数的用户可能期望，如果返回非nil 错误，则返回的其他参数不相关。
最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。
'><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/golang-error-%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"><meta property="article:section" content="posts"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang error 处理最佳实践"><meta name=twitter:description content='golang error 处理最佳实践
错误类型定义

Go 中error 类型是一个接口类型



1
2
3


type error interface {
    Error() string
}


基本上，error 是实现该接口任何内容，它将错误消息作为字符串返回。
构造错误
​    可以使用 Go 的内置或包动态构造错误。
​    例如，以下函数使用包返回带有静态错误消息的新错误：errors fmt errors


1
2
3
4
5
6
7


package main

import "errors"

func DoSomething() error {
    return errors.New("something didn&#39;t work")
}


​	同样，该包可用于向错误添加动态数据。
​	例如：fmt int string error


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


package main

import "fmt"

func Divide(a, b int) (int, error) {
    if b == 0 {
        return 0, fmt.Errorf("can&#39;t divide &#39;%d&#39; by zero", a)
    }
    return a / b, nil
}


请注意，当用于用格式动词包装另一个错误时，这将非常有用 fmt.Errorf %w
在上面的示例中，还有其他一些重要事项需要注意。

错误可以返回为nil ，它是 Go 中 error 的默认值或零值。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。if err != nil 
错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 int和 nil 。
当我们返回错误时，函数返回的其他参数通常作为其默认的零值返回。函数的用户可能期望，如果返回非nil 错误，则返回的其他参数不相关。
最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。
'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"Golang error 处理最佳实践","item":"https://luenci.com/en/posts/golang-error-%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golang error 处理最佳实践","name":"Golang error 处理最佳实践","description":"golang error 处理最佳实践 错误类型定义 Go 中error 类型是一个接口类型 1 2 3 type error interface { Error() string } 基本上，error 是实现该接口任何内容，它将错误消息作为字符串返回。\n构造错误 ​ 可以使用 Go 的内置或包动态构造错误。\n​ 例如，以下函数使用包返回带有静态错误消息的新错误：errors fmt errors\n1 2 3 4 5 6 7 package main import \u0026#34;errors\u0026#34; func DoSomething() error { return errors.New(\u0026#34;something didn\u0026#39;t work\u0026#34;) } ​\t同样，该包可用于向错误添加动态数据。\n​\t例如：fmt int string error\n1 2 3 4 5 6 7 8 9 10 package main import \u0026#34;fmt\u0026#34; func Divide(a, b int) (int, error) { if b == 0 { return 0, fmt.Errorf(\u0026#34;can\u0026#39;t divide \u0026#39;%d\u0026#39; by zero\u0026#34;, a) } return a / b, nil } 请注意，当用于用格式动词包装另一个错误时，这将非常有用 fmt.Errorf %w\n在上面的示例中，还有其他一些重要事项需要注意。\n错误可以返回为nil ，它是 Go 中 error 的默认值或零值。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。if err != nil 错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 int和 nil 。 当我们返回错误时，函数返回的其他参数通常作为其默认的零值返回。函数的用户可能期望，如果返回非nil 错误，则返回的其他参数不相关。 最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。 ","keywords":["错误处理"],"articleBody":"golang error 处理最佳实践 错误类型定义 Go 中error 类型是一个接口类型 1 2 3 type error interface { Error() string } 基本上，error 是实现该接口任何内容，它将错误消息作为字符串返回。\n构造错误 ​ 可以使用 Go 的内置或包动态构造错误。\n​ 例如，以下函数使用包返回带有静态错误消息的新错误：errors fmt errors\n1 2 3 4 5 6 7 package main import \"errors\" func DoSomething() error { return errors.New(\"something didn't work\") } ​\t同样，该包可用于向错误添加动态数据。\n​\t例如：fmt int string error\n1 2 3 4 5 6 7 8 9 10 package main import \"fmt\" func Divide(a, b int) (int, error) { if b == 0 { return 0, fmt.Errorf(\"can't divide '%d' by zero\", a) } return a / b, nil } 请注意，当用于用格式动词包装另一个错误时，这将非常有用 fmt.Errorf %w\n在上面的示例中，还有其他一些重要事项需要注意。\n错误可以返回为nil ，它是 Go 中 error 的默认值或零值。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。if err != nil 错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 int和 nil 。 当我们返回错误时，函数返回的其他参数通常作为其默认的零值返回。函数的用户可能期望，如果返回非nil 错误，则返回的其他参数不相关。 最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。 定义预期错误 ​ Go 中的另一个重要技术是定义预期的错误，以便可以在代码的其他部分中显式检查它们。当遇到某种类型的错误时需要执行不同的代码分支时，这将非常有用。\n关于 errors.Is() 和 errors.As() 如果我们想检查给定错误是否与另一个特定错误匹配，我们需要使用包中Is()的函数errors。如果我们对错误是否属于给定类型感兴趣，我们应该调用该As()函数。errors.Is()\nerrors.Is()功能 此函数适合没有经过包装的错误\n​ 在下面的示例中，我们可以看到该函数validateInput为badInput. 此错误ErrBadInput包含在由fmt.Errorf().\n​ 使用该Is(err, target error) bool函数，我们可以检测到ErrBadInput它是否被包装，因为该函数检查包装错误链中的任何错误是否与目标匹配。\n因此，这种形式应该比if err == ErrBadInput更可取。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package main import ( \"errors\" \"fmt\" ) const badInput = \"abc\" var ErrBadInput = errors.New(\"bad input\") func validateInput(input string) error { if input == badInput { return fmt.Errorf(\"validateInput: %w\", ErrBadInput) } return nil } func main() { input := badInput err := validateInput(input) if errors.Is(err, ErrBadInput) { fmt.Println(\"bad input error\") } } 输出：\n1 bad input error 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import ( \"errors\" \"fmt\" ) var ErrorString1 = errors.New(\"test b\") func main() { err := func() error { return fmt.Errorf(\"I am %w\", ErrorString1) }() if errors.Is(err, ErrorString1) { fmt.Println(\"err b\") } } 输出：\n1 err b errors.As()功能 此函数将错误进行了包装\n​ 与 类似Is()，As(err error, target interface{}) bool检查包装错误链中的任何错误是否与目标匹配。不同之处在于此函数检查错误是否具有特定类型，不像Is()，它检查它是否是特定的错误对象。\n因为As考虑到整个错误链，它应该比类型断言更可取if e, ok := err.(*BadInputError); ok。\ntarget函数的参数``As(err error, target interface{}) bool应该是指向错误类型的指针，在这种情况下是*BadInputError\n复制\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package main import ( \"errors\" \"fmt\" ) const badInput = \"abc\" type BadInputError struct { input string } func (e *BadInputError) Error() string { return fmt.Sprintf(\"bad input: %s\", e.input) } func validateInput(input string) error { if input == badInput { return fmt.Errorf(\"validateInput: %w\", \u0026BadInputError{input: input}) } return nil } func main() { input := badInput err := validateInput(input) var badInputErr *BadInputError if errors.As(err, \u0026badInputErr) { fmt.Printf(\"bad input error occured: %s\\n\", badInputErr) } } 定义哨兵错误 ​ 基于前面的函数，我们可以通过预先定义Sentinel错误来改进错误信令。调用函数可以使用以下命令显式检查此错误：errors.Is\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package main import ( \"errors\" \"fmt\" ) var ErrDivideByZero = errors.New(\"divide by zero\") func Divide(a, b int) (int, error) { if b == 0 { return 0, ErrDivideByZero } return a / b, nil } func main() { a, b := 10, 0 result, err := Divide(a, b) if err != nil { switch { case errors.Is(err, ErrDivideByZero): fmt.Println(\"divide by zero error\") default: fmt.Printf(\"unexpected division error: %s\\n\", err) } return } fmt.Printf(\"%d / %d = %d\\n\", a, b, result) } 定义自定义错误类型 使用上述策略可以涵盖许多错误处理用例，但是，有时您可能需要更多功能。也许您希望错误携带其他数据字段，或者错误的消息在打印时应使用动态值填充自身。这些可以通过自定义错误类型实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 import ( \"errors\" \"fmt\" ) type DivisionError struct { IntA int IntB int Msg string } func (e *DivisionError) Error() string { return e.Msg } func Divide(a, b int) (int, error) { if b == 0 { return 0, \u0026DivisionError{ Msg: fmt.Sprintf(\"cannot divide '%d' by zero\", a), IntA: a, IntB: b, } } return a / b, nil } func main() { a, b := 10, 0 result, err := Divide(a, b) if err != nil { var divErr *DivisionError switch { case errors.As(err, \u0026divErr): fmt.Printf(\"%d / %d is not mathematically valid: %s\\n\", divErr.IntA, divErr.IntB, divErr.Error()) default: fmt.Printf(\"unexpected division error: %s\\n\", err) } return } fmt.Printf(\"%d / %d = %d\\n\", a, b, result) } error are value 无论你做什么，都要始终检查你的错误！\nbufio的设计 1 2 3 4 5 6 7 8 scanner := bufio.NewScanner(input) for scanner.Scan() { token := scanner.Text() // process token } if err := scanner.Err(); err != nil { // process the error } 1 func (s *Scanner) Scan() (token []byte, error) 1 2 3 4 5 6 7 8 scanner := bufio.NewScanner(input) for { token, err := scanner.Scan() if err != nil { return err // or maybe break } // process token } 文件error处理 ​ 改进前\n1 2 3 4 5 6 7 8 9 10 11 12 13 _, err = fd.Write(p0[a:b]) if err != nil { return err } _, err = fd.Write(p1[c:d]) if err != nil { return err } _, err = fd.Write(p2[e:f]) if err != nil { return err } // and so on ​ 改进方法1\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type errWriter struct { w io.Writer err error } func (ew *errWriter) write(buf []byte) { if ew.err != nil { return } _, ew.err = ew.w.Write(buf) } ew := \u0026errWriter{w: fd} ew.write(p0[a:b]) ew.write(p1[c:d]) ew.write(p2[e:f]) // and so on if ew.err != nil { return ew.err } ​ 改进方法2(bufio的设计)\n1 2 3 4 5 6 7 8 b := bufio.NewWriter(fd) b.Write(p0[a:b]) b.Write(p1[c:d]) b.Write(p2[e:f]) // and so on if b.Flush() != nil { return b.Flush() } Error handling and Go 合理的对错误进行包装，给错误一个模板（参考定义预期错误）\n简化重复的错误处理 ​ 原始程序\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func init() { http.HandleFunc(\"/view\", viewRecord) } func viewRecord(w http.ResponseWriter, r *http.Request) { c := appengine.NewContext(r) key := datastore.NewKey(c, \"Record\", r.FormValue(\"id\"), 0, nil) record := new(Record) if err := datastore.Get(c, key, record); err != nil { http.Error(w, err.Error(), 500) return } if err := viewTemplate.Execute(w, record); err != nil { http.Error(w, err.Error(), 500) } } 封装函数对错误处理\n1 2 3 4 5 6 7 8 9 10 11 12 13 func viewRecord(w http.ResponseWriter, r *http.Request) error { c := appengine.NewContext(r) key := datastore.NewKey(c, \"Record\", r.FormValue(\"id\"), 0, nil) record := new(Record) if err := datastore.Get(c, key, record); err != nil { return err } return viewTemplate.Execute(w, record) } 外层对重复错误的处理\n1 2 3 4 5 func (fn appHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { if err := fn(w, r); err != nil { http.Error(w, err.Error(), 500) } } 一个http服务的错误封装 1 2 3 4 5 type appError struct { Error error Message string Code int } 1 type appHandler func(http.ResponseWriter, *http.Request) *appError 1 2 3 4 5 6 7 func (fn appHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { if e := fn(w, r); e != nil { // e is *appError, not os.Error. c := appengine.NewContext(r) c.Errorf(\"%v\", e.Error) http.Error(w, e.Message, e.Code) } } 1 2 3 4 5 6 7 8 9 10 11 12 func viewRecord(w http.ResponseWriter, r *http.Request) *appError { c := appengine.NewContext(r) key := datastore.NewKey(c, \"Record\", r.FormValue(\"id\"), 0, nil) record := new(Record) if err := datastore.Get(c, key, record); err != nil { return \u0026appError{err, \"Record not found\", 404} } if err := viewTemplate.Execute(w, record); err != nil { return \u0026appError{err, \"Can't display record\", 500} } return nil } 毛剑老师的课程的建议 panic 在程序启动的时候，如果有强依赖的服务出现故障时 panic 退出 在程序启动的时候，如果发现有配置明显不符合要求， 可以 panic 退出（防御编程） 其他情况下只要不是不可恢复的程序错误，都不应该直接 panic 应该返回 error 在程序入口处，例如 gin 中间件需要使用 recover 预防 panic 程序退出 在程序中我们应该避免使用野生的 goroutine 如果是在请求中需要执行异步任务，应该使用异步 worker ，消息通知的方式进行处理，避免请求量大时大量 goroutine 创建 如果需要使用 goroutine 时，应该使用同一的 Go 函数进行创建，这个函数中会进行 recover ，避免因为野生 goroutine panic 导致主进程退出 1 2 3 4 5 6 7 8 9 10 11 func Go(f func()){ go func(){ defer func(){ if err := recover(); err != nil { log.Printf(\"panic: %+v\", err) } }() f() }() } error 我们在应用程序中使用 github.com/pkg/errors 处理应用错误，注意在公共库当中，我们一般不使用这个\nerror应该是函数的最后一个返回值，当error不为nil 时，函数的其他返回值是不可用的状态，不应该对其他返回值做任何期待\nfunc f() (io.Reader, *S1, error) 在这里，我们不知道 io.Reader 中是否有数据，可能有，也有可能有一部分 错误处理的时候应该先判断错误， if err != nil 出现错误及时返回，使代码是一条流畅的直线，避免过多的嵌套.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // good case func f() error { a, err := A() if err != nil { return err } // ... 其他逻辑 return nil } // bad case func f() error { a, err := A() if err == nil { // 其他逻辑 } return err } 在应用程序中出现错误时，使用 errors.New 或者 errors.Errorf 返回错误\n1 2 3 4 5 6 7 8 func (u *usecese) usecase1() error { money := u.repo.getMoney(uid) if money \u003c 10 { errors.Errorf(\"用户余额不足, uid: %d, money: %d\", uid, money) } // 其他逻辑 return nil } 如果是调用应用程序的其他函数出现错误，请直接返回，如果需要携带信息，请使用 errors.WithMessage 1 2 3 4 5 6 7 8 9 func (u *usecese) usecase2() error { name, err := u.repo.getUserName(uid) if err != nil { return errors.WithMessage(err, \"其他附加信息\") } // 其他逻辑 return nil } 如果是调用其他库（标准库、企业公共库、开源第三方库等）获取到错误时，请使用errors.Wrap添加堆栈信息 切记，不要每个地方都是用 errors.Wrap 只需要在错误第一次出现时进行 errors.Wrap 即可 根据场景进行判断是否需要将其他库的原始错误吞掉，例如可以把 repository 层的数据库相关错误吞掉，返回业务错误码，避免后续我们分割微服务或者更换 ORM 库时需要去修改上层代码 注意我们在基础库，被大量引入的第三方库编写时一般不使用 errors.Wrap 避免堆栈信息重复 1 2 3 4 5 6 7 8 9 func f() error { err := json.Unmashal(\u0026a, data) if err != nil { return errors.Wrap(err, \"其他附加信息\") } // 其他逻辑 return nil } 禁止每个出错的地方都打日志，只需要在进程的最开始的地方使用 %+v 进行统一打印，例如 http/rpc 服务的中间件 错误判断使用 errors.Is 进行比较 1 2 3 4 5 6 7 8 9 func f() error { err := A() if errors.Is(err, io.EOF){ return nil } // 其他逻辑 return nil } 错误类型判断，使用 errors.As 进行赋值 1 2 3 4 5 6 7 8 9 10 11 func f() error { err := A() var errA errorA if errors.As(err, \u0026errA){ // ... } // 其他逻辑 return nil } 如何判定错误的信息是否足够，想一想当你的代码出现问题需要排查的时候你的错误信息是否可以帮助你快速的定位问题，例如我们在请求中一般会输出参数信息，用于辅助判断错误 对于业务错误，推荐在一个统一的地方创建一个错误字典，错误字典里面应该包含错误的 code，并且在日志中作为独立字段打印，方便做业务告警的判断，错误必须有清晰的错误文档 不需要返回，被忽略的错误必须输出日志信息 同一个地方不停的报错，最好不要不停输出错误日志，这样可能会导致被大量的错误日志信息淹没，无法排查问题，比较好的做法是打印一次错误详情，然后打印出错误出现的次数 对同一个类型的错误，采用相同的模式，例如参数错误，不要有的返回 404 有的返回 200 处理错误的时候，需要处理已分配的资源，使用 defer 进行清理，例如文件句柄 panic or error 在 Go 中 panic 会导致程序直接退出，是一个致命的错误，如果使用 panic,recover 进行处理的话，会存在很多问题 性能问题，频繁 panic, recover 性能不好 容易导致程序异常退出，只要有一个地方没有处理到就会导致程序进程整个退出 不可控，一旦 panic 就将处理逻辑移交给了外部，我们并不能预设外部包一定会进行处理 什么时候使用 panic 呢？ 对于真正意外的情况，那些表示不可恢复的程序错误，例如索引越界、不可恢复的环境问题、栈溢出，我们才使用 panic 使用 error 处理有哪些好处？ 简单。 考虑失败，而不是成功(Plan for failure, not success)。 没有隐藏的控制流。 完全交给你来控制 error。 Error are values。 参考链接 Errors are values - The Go Programming Language\nError handling and Go - The Go Programming Language\nhttps://lailin.xyz/post/go-training-03.html\n","wordCount":"4119","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/golang-error-%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Golang error 处理最佳实践</h1><div class=post-meta>9 min&nbsp;·&nbsp;4119 words&nbsp;·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#golang-error-%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="golang error 处理最佳实践">golang error 处理最佳实践</a><ul><li><a href=#%e9%94%99%e8%af%af%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89 aria-label=错误类型定义>错误类型定义</a></li><li><a href=#%e6%9e%84%e9%80%a0%e9%94%99%e8%af%af aria-label=构造错误>构造错误</a></li><li><a href=#%e5%ae%9a%e4%b9%89%e9%a2%84%e6%9c%9f%e9%94%99%e8%af%af aria-label=定义预期错误>定义预期错误</a><ul><li><a href=#%e5%85%b3%e4%ba%8e--errorsis-%e5%92%8c-errorsas aria-label="关于 errors.Is() 和 errors.As() ">关于 <code>errors.Is()</code> 和 <code>errors.As()</code></a><ul><li><a href=#errorsis%e5%8a%9f%e8%83%bd aria-label=errors.Is()功能><code>errors.Is()</code>功能</a></li><li><a href=#errorsas%e5%8a%9f%e8%83%bd aria-label=errors.As()功能><code>errors.As()</code>功能</a></li></ul></li><li><a href=#%e5%ae%9a%e4%b9%89%e5%93%a8%e5%85%b5%e9%94%99%e8%af%af aria-label=定义哨兵错误>定义哨兵错误</a></li><li><a href=#%e5%ae%9a%e4%b9%89%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e7%b1%bb%e5%9e%8b aria-label=定义自定义错误类型>定义自定义错误类型</a></li></ul></li><li><a href=#error-are-value aria-label="error are value">error are value</a><ul><li><a href=#bufio%e7%9a%84%e8%ae%be%e8%ae%a1 aria-label=bufio的设计><code>bufio</code>的设计</a></li><li><a href=#%e6%96%87%e4%bb%b6error%e5%a4%84%e7%90%86 aria-label=文件error处理>文件<code>error</code>处理</a></li></ul></li><li><a href=#error-handling-and-go aria-label="Error handling and Go">Error handling and Go</a></li><li><a href=#%e7%ae%80%e5%8c%96%e9%87%8d%e5%a4%8d%e7%9a%84%e9%94%99%e8%af%af%e5%a4%84%e7%90%86 aria-label=简化重复的错误处理>简化重复的错误处理</a><ul><ul><li><a href=#%e4%b8%80%e4%b8%aahttp%e6%9c%8d%e5%8a%a1%e7%9a%84%e9%94%99%e8%af%af%e5%b0%81%e8%a3%85 aria-label=一个http服务的错误封装>一个<code>http</code>服务的错误封装</a></li></ul></ul></li><li><a href=#%e6%af%9b%e5%89%91%e8%80%81%e5%b8%88%e7%9a%84%e8%af%be%e7%a8%8b%e7%9a%84%e5%bb%ba%e8%ae%ae aria-label=毛剑老师的课程的建议>毛剑老师的课程的建议</a><ul><li><a href=#panic aria-label=panic>panic</a></li><li><a href=#error aria-label=error>error</a></li><li><a href=#panic-or-error aria-label="panic or error">panic or error</a></li></ul></li></ul></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=golang-error-处理最佳实践>golang error 处理最佳实践<a hidden class=anchor aria-hidden=true href=#golang-error-处理最佳实践>#</a></h1><h2 id=错误类型定义>错误类型定义<a hidden class=anchor aria-hidden=true href=#错误类型定义>#</a></h2><ul><li>Go 中<code>error</code> 类型是一个接口类型</li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> <span style=color:#ff7b72>error</span> <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>Error</span>() <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>基本上，<code>error</code> 是实现该接口任何内容，它将错误消息作为字符串返回。</p><h2 id=构造错误>构造错误<a hidden class=anchor aria-hidden=true href=#构造错误>#</a></h2><p>​ 可以使用 Go 的内置或包动态构造错误。</p><p>​ 例如，以下函数使用包返回带有静态错误消息的新错误：<code>errors fmt errors</code></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>DoSomething</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> errors.<span style=color:#d2a8ff;font-weight:700>New</span>(<span style=color:#a5d6ff>&#34;something didn&#39;t work&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 同样，该包可用于向错误添加动态数据。</p><p>​ 例如：<code>fmt int string error</code></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>Divide</span>(a, b <span style=color:#ff7b72>int</span>) (<span style=color:#ff7b72>int</span>, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> b <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;can&#39;t divide &#39;%d&#39; by zero&#34;</span>, a)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> a <span style=color:#ff7b72;font-weight:700>/</span> b, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>请注意，当用于用格式动词包装另一个错误时，这将非常有用 <code>fmt.Errorf %w</code></p><p>在上面的示例中，还有其他一些重要事项需要注意。</p><ul><li>错误可以返回为<code>nil</code> ，它是 Go 中 <code>error</code> 的默认值或<code>零值</code>。这很重要，因为检查是确定是否遇到错误的惯用方法（替换您可能在其他编程语言中熟悉的 / 语句）。<code>if err != nil</code></li><li>错误通常作为函数中的最后一个参数返回。因此，在上面的示例中，我们按该顺序返回 <code>int</code>和 <code>nil</code> 。</li><li>当我们返回错误时，函数返回的其他参数通常作为其默认的<code>零值</code>返回。函数的用户可能期望，如果返回非<code>nil</code> 错误，则返回的其他参数不相关。</li><li>最后，错误消息通常以小写形式编写，不以标点符号结尾。但是可以例外，例如，当包含专有名词，以大写字母开头的函数名称等。</li></ul><h2 id=定义预期错误>定义预期错误<a hidden class=anchor aria-hidden=true href=#定义预期错误>#</a></h2><p>​ <code>Go</code> 中的另一个重要技术是定义预期的错误，以便可以在代码的其他部分中显式检查它们。当遇到某种类型的错误时需要执行不同的代码分支时，这将非常有用。</p><h3 id=关于--errorsis-和-errorsas>关于 <code>errors.Is()</code> 和 <code>errors.As() </code><a hidden class=anchor aria-hidden=true href=#关于--errorsis-和-errorsas>#</a></h3><blockquote><p>如果我们想检查给定错误是否与另一个特定错误匹配，我们需要使用包中<code>Is()</code>的函数<code>errors</code>。如果我们对错误是否属于给定类型感兴趣，我们应该调用该<code>As()</code>函数。<code>errors.Is()</code></p></blockquote><h4 id=errorsis功能><code>errors.Is()</code>功能<a hidden class=anchor aria-hidden=true href=#errorsis功能>#</a></h4><blockquote><p>此函数适合没有经过包装的错误</p></blockquote><p>​ 在下面的示例中，我们可以看到该函数<code>validateInput</code>为<code>badInput</code>. 此错误<code>ErrBadInput</code>包含在由<code>fmt.Errorf()</code>.</p><p>​ 使用该<code>Is(err, target error) bool</code>函数，我们可以检测到<code>ErrBadInput</code>它是否被包装，因为该函数检查包装错误链中的任何错误是否与目标匹配。</p><p>因此，这种形式应该比<code>if err == ErrBadInput</code>更可取。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> badInput = <span style=color:#a5d6ff>&#34;abc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> ErrBadInput = errors.<span style=color:#d2a8ff;font-weight:700>New</span>(<span style=color:#a5d6ff>&#34;bad input&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>validateInput</span>(input <span style=color:#ff7b72>string</span>) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> input <span style=color:#ff7b72;font-weight:700>==</span> badInput {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;validateInput: %w&#34;</span>, ErrBadInput)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    input <span style=color:#ff7b72;font-weight:700>:=</span> badInput
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>validateInput</span>(input)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> errors.<span style=color:#d2a8ff;font-weight:700>Is</span>(err, ErrBadInput) {
</span></span><span style=display:flex><span>        fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;bad input error&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bad input error
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> ErrorString1 = errors.<span style=color:#d2a8ff;font-weight:700>New</span>(<span style=color:#a5d6ff>&#34;test b&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>func</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;I am %w&#34;</span>, ErrorString1)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> errors.<span style=color:#d2a8ff;font-weight:700>Is</span>(err, ErrorString1) {
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;err b&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>err b
</span></span></code></pre></td></tr></table></div></div><h4 id=errorsas功能><code>errors.As()</code>功能<a hidden class=anchor aria-hidden=true href=#errorsas功能>#</a></h4><blockquote><p>此函数将错误进行了包装</p></blockquote><p>​ 与 类似<code>Is()</code>，<code>As(err error, target interface{}) bool</code>检查包装错误链中的任何错误是否与目标匹配。不同之处在于此函数检查错误是否具有特定类型，不像<code>Is()</code>，它检查它是否是特定的错误对象。</p><p>因为<code>As</code>考虑到整个错误链，它应该比类型断言更可取<code>if e, ok := err.(*BadInputError); ok</code>。</p><blockquote><p>target<code>函数的参数``As(err error, target interface{}) bool</code>应该<strong>是指向错误类型的指针</strong>，在这种情况下是<code>*BadInputError</code></p></blockquote><p>复制</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> badInput = <span style=color:#a5d6ff>&#34;abc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> BadInputError <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    input <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (e <span style=color:#ff7b72;font-weight:700>*</span>BadInputError) <span style=color:#d2a8ff;font-weight:700>Error</span>() <span style=color:#ff7b72>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;bad input: %s&#34;</span>, e.input)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>validateInput</span>(input <span style=color:#ff7b72>string</span>) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> input <span style=color:#ff7b72;font-weight:700>==</span> badInput {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;validateInput: %w&#34;</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>BadInputError{input: input})
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    input <span style=color:#ff7b72;font-weight:700>:=</span> badInput
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>validateInput</span>(input)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>var</span> badInputErr <span style=color:#ff7b72;font-weight:700>*</span>BadInputError
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> errors.<span style=color:#d2a8ff;font-weight:700>As</span>(err, <span style=color:#ff7b72;font-weight:700>&amp;</span>badInputErr) {
</span></span><span style=display:flex><span>        fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;bad input error occured: %s\n&#34;</span>, badInputErr)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=定义哨兵错误>定义哨兵错误<a hidden class=anchor aria-hidden=true href=#定义哨兵错误>#</a></h3><p>​ 基于前面的函数，我们可以通过预先定义<code>Sentinel</code>错误来改进错误信令。调用函数可以使用以下命令显式检查此错误：<code>errors.Is</code></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> ErrDivideByZero = errors.<span style=color:#d2a8ff;font-weight:700>New</span>(<span style=color:#a5d6ff>&#34;divide by zero&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>Divide</span>(a, b <span style=color:#ff7b72>int</span>) (<span style=color:#ff7b72>int</span>, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> b <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>, ErrDivideByZero
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> a <span style=color:#ff7b72;font-weight:700>/</span> b, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    a, b <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>10</span>, <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    result, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>Divide</span>(a, b)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>switch</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> errors.<span style=color:#d2a8ff;font-weight:700>Is</span>(err, ErrDivideByZero):
</span></span><span style=display:flex><span>            fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;divide by zero error&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>            fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;unexpected division error: %s\n&#34;</span>, err)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;%d / %d = %d\n&#34;</span>, a, b, result)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=定义自定义错误类型>定义自定义错误类型<a hidden class=anchor aria-hidden=true href=#定义自定义错误类型>#</a></h3><p>使用上述策略可以涵盖许多错误处理用例，但是，有时您可能需要更多功能。也许您希望错误携带其他数据字段，或者错误的消息在打印时应使用动态值填充自身。这些可以通过自定义错误类型实现</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> DivisionError <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    IntA <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>    IntB <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>    Msg  <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (e <span style=color:#ff7b72;font-weight:700>*</span>DivisionError) <span style=color:#d2a8ff;font-weight:700>Error</span>() <span style=color:#ff7b72>string</span> { 
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> e.Msg
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>Divide</span>(a, b <span style=color:#ff7b72>int</span>) (<span style=color:#ff7b72>int</span>, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> b <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>DivisionError{
</span></span><span style=display:flex><span>            Msg: fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;cannot divide &#39;%d&#39; by zero&#34;</span>, a),
</span></span><span style=display:flex><span>            IntA: a, IntB: b,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> a <span style=color:#ff7b72;font-weight:700>/</span> b, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    a, b <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>10</span>, <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    result, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>Divide</span>(a, b)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>var</span> divErr <span style=color:#ff7b72;font-weight:700>*</span>DivisionError
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>switch</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> errors.<span style=color:#d2a8ff;font-weight:700>As</span>(err, <span style=color:#ff7b72;font-weight:700>&amp;</span>divErr):
</span></span><span style=display:flex><span>            fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;%d / %d is not mathematically valid: %s\n&#34;</span>,
</span></span><span style=display:flex><span>              divErr.IntA, divErr.IntB, divErr.<span style=color:#d2a8ff;font-weight:700>Error</span>())
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>            fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;unexpected division error: %s\n&#34;</span>, err)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;%d / %d = %d\n&#34;</span>, a, b, result)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=error-are-value>error are value<a hidden class=anchor aria-hidden=true href=#error-are-value>#</a></h2><blockquote><p>无论你做什么，都要始终检查你的错误！</p></blockquote><h3 id=bufio的设计><code>bufio</code>的设计<a hidden class=anchor aria-hidden=true href=#bufio的设计>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>scanner <span style=color:#ff7b72;font-weight:700>:=</span> bufio.<span style=color:#d2a8ff;font-weight:700>NewScanner</span>(input)
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> scanner.<span style=color:#d2a8ff;font-weight:700>Scan</span>() {
</span></span><span style=display:flex><span>    token <span style=color:#ff7b72;font-weight:700>:=</span> scanner.<span style=color:#d2a8ff;font-weight:700>Text</span>()
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// process token</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> scanner.<span style=color:#d2a8ff;font-weight:700>Err</span>(); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// process the error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Scanner) <span style=color:#d2a8ff;font-weight:700>Scan</span>() (token []<span style=color:#ff7b72>byte</span>, <span style=color:#ff7b72>error</span>)
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>scanner <span style=color:#ff7b72;font-weight:700>:=</span> bufio.<span style=color:#d2a8ff;font-weight:700>NewScanner</span>(input)
</span></span><span style=display:flex><span><span style=color:#ff7b72>for</span> {
</span></span><span style=display:flex><span>    token, err <span style=color:#ff7b72;font-weight:700>:=</span> scanner.<span style=color:#d2a8ff;font-weight:700>Scan</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err <span style=color:#8b949e;font-style:italic>// or maybe break</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// process token</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=文件error处理>文件<code>error</code>处理<a hidden class=anchor aria-hidden=true href=#文件error处理>#</a></h3><p>​ 改进前</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>_, err = fd.<span style=color:#d2a8ff;font-weight:700>Write</span>(p0[a:b])
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>_, err = fd.<span style=color:#d2a8ff;font-weight:700>Write</span>(p1[c:d])
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>_, err = fd.<span style=color:#d2a8ff;font-weight:700>Write</span>(p2[e:f])
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// and so on</span>
</span></span></code></pre></td></tr></table></div></div><p>​ 改进方法1</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> errWriter <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    w   io.Writer
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (ew <span style=color:#ff7b72;font-weight:700>*</span>errWriter) <span style=color:#d2a8ff;font-weight:700>write</span>(buf []<span style=color:#ff7b72>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> ew.err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    _, ew.err = ew.w.<span style=color:#d2a8ff;font-weight:700>Write</span>(buf)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ew <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>errWriter{w: fd}
</span></span><span style=display:flex><span>ew.<span style=color:#d2a8ff;font-weight:700>write</span>(p0[a:b])
</span></span><span style=display:flex><span>ew.<span style=color:#d2a8ff;font-weight:700>write</span>(p1[c:d])
</span></span><span style=display:flex><span>ew.<span style=color:#d2a8ff;font-weight:700>write</span>(p2[e:f])
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// and so on</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> ew.err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> ew.err
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 改进方法2(<code>bufio</code>的设计)</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>b <span style=color:#ff7b72;font-weight:700>:=</span> bufio.<span style=color:#d2a8ff;font-weight:700>NewWriter</span>(fd)
</span></span><span style=display:flex><span>b.<span style=color:#d2a8ff;font-weight:700>Write</span>(p0[a:b])
</span></span><span style=display:flex><span>b.<span style=color:#d2a8ff;font-weight:700>Write</span>(p1[c:d])
</span></span><span style=display:flex><span>b.<span style=color:#d2a8ff;font-weight:700>Write</span>(p2[e:f])
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// and so on</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> b.<span style=color:#d2a8ff;font-weight:700>Flush</span>() <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> b.<span style=color:#d2a8ff;font-weight:700>Flush</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=error-handling-and-go>Error handling and Go<a hidden class=anchor aria-hidden=true href=#error-handling-and-go>#</a></h2><blockquote><p>合理的对错误进行包装，给错误一个模板（参考定义预期错误）</p></blockquote><h2 id=简化重复的错误处理>简化重复的错误处理<a hidden class=anchor aria-hidden=true href=#简化重复的错误处理>#</a></h2><p>​ 原始程序</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>init</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>HandleFunc</span>(<span style=color:#a5d6ff>&#34;/view&#34;</span>, viewRecord)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>viewRecord</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    c <span style=color:#ff7b72;font-weight:700>:=</span> appengine.<span style=color:#d2a8ff;font-weight:700>NewContext</span>(r)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    key <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>NewKey</span>(c, <span style=color:#a5d6ff>&#34;Record&#34;</span>, r.<span style=color:#d2a8ff;font-weight:700>FormValue</span>(<span style=color:#a5d6ff>&#34;id&#34;</span>), <span style=color:#a5d6ff>0</span>, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>    record <span style=color:#ff7b72;font-weight:700>:=</span> new(Record)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>Get</span>(c, key, record); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        http.<span style=color:#d2a8ff;font-weight:700>Error</span>(w, err.<span style=color:#d2a8ff;font-weight:700>Error</span>(), <span style=color:#a5d6ff>500</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> viewTemplate.<span style=color:#d2a8ff;font-weight:700>Execute</span>(w, record); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        http.<span style=color:#d2a8ff;font-weight:700>Error</span>(w, err.<span style=color:#d2a8ff;font-weight:700>Error</span>(), <span style=color:#a5d6ff>500</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>封装函数对错误处理</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>viewRecord</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    c <span style=color:#ff7b72;font-weight:700>:=</span> appengine.<span style=color:#d2a8ff;font-weight:700>NewContext</span>(r)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    key <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>NewKey</span>(c, <span style=color:#a5d6ff>&#34;Record&#34;</span>, r.<span style=color:#d2a8ff;font-weight:700>FormValue</span>(<span style=color:#a5d6ff>&#34;id&#34;</span>), <span style=color:#a5d6ff>0</span>, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    record <span style=color:#ff7b72;font-weight:700>:=</span> new(Record)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>Get</span>(c, key, record); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> viewTemplate.<span style=color:#d2a8ff;font-weight:700>Execute</span>(w, record)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>外层对重复错误的处理</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (fn appHandler) <span style=color:#d2a8ff;font-weight:700>ServeHTTP</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>fn</span>(w, r); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        http.<span style=color:#d2a8ff;font-weight:700>Error</span>(w, err.<span style=color:#d2a8ff;font-weight:700>Error</span>(), <span style=color:#a5d6ff>500</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=一个http服务的错误封装>一个<code>http</code>服务的错误封装<a hidden class=anchor aria-hidden=true href=#一个http服务的错误封装>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> appError <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    Error   <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>    Message <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>    Code    <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> appHandler <span style=color:#ff7b72>func</span>(http.ResponseWriter, <span style=color:#ff7b72;font-weight:700>*</span>http.Request) <span style=color:#ff7b72;font-weight:700>*</span>appError
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (fn appHandler) <span style=color:#d2a8ff;font-weight:700>ServeHTTP</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> e <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>fn</span>(w, r); e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> { <span style=color:#8b949e;font-style:italic>// e is *appError, not os.Error.</span>
</span></span><span style=display:flex><span>        c <span style=color:#ff7b72;font-weight:700>:=</span> appengine.<span style=color:#d2a8ff;font-weight:700>NewContext</span>(r)
</span></span><span style=display:flex><span>        c.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;%v&#34;</span>, e.Error)
</span></span><span style=display:flex><span>        http.<span style=color:#d2a8ff;font-weight:700>Error</span>(w, e.Message, e.Code)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>viewRecord</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) <span style=color:#ff7b72;font-weight:700>*</span>appError {
</span></span><span style=display:flex><span>    c <span style=color:#ff7b72;font-weight:700>:=</span> appengine.<span style=color:#d2a8ff;font-weight:700>NewContext</span>(r)
</span></span><span style=display:flex><span>    key <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>NewKey</span>(c, <span style=color:#a5d6ff>&#34;Record&#34;</span>, r.<span style=color:#d2a8ff;font-weight:700>FormValue</span>(<span style=color:#a5d6ff>&#34;id&#34;</span>), <span style=color:#a5d6ff>0</span>, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>    record <span style=color:#ff7b72;font-weight:700>:=</span> new(Record)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> datastore.<span style=color:#d2a8ff;font-weight:700>Get</span>(c, key, record); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>appError{err, <span style=color:#a5d6ff>&#34;Record not found&#34;</span>, <span style=color:#a5d6ff>404</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> viewTemplate.<span style=color:#d2a8ff;font-weight:700>Execute</span>(w, record); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>appError{err, <span style=color:#a5d6ff>&#34;Can&#39;t display record&#34;</span>, <span style=color:#a5d6ff>500</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=毛剑老师的课程的建议>毛剑老师的课程的建议<a hidden class=anchor aria-hidden=true href=#毛剑老师的课程的建议>#</a></h2><h3 id=panic>panic<a hidden class=anchor aria-hidden=true href=#panic>#</a></h3><ul><li>在程序启动的时候，如果有强依赖的服务出现故障时 <code>panic</code> 退出</li><li>在程序启动的时候，如果发现有配置明显不符合要求， 可以 <code>panic</code> 退出（防御编程）</li><li>其他情况下只要不是不可恢复的程序错误，都不应该直接 <code>panic</code> 应该返回 <code>error</code></li><li>在程序入口处，例如 <code>gin</code> 中间件需要使用 <code>recover</code> 预防 <code>panic</code> 程序退出</li><li>在程序中我们应该避免使用野生的 <code>goroutine</code><ul><li>如果是在请求中需要执行异步任务，应该使用异步 <code>worker</code> ，消息通知的方式进行处理，避免请求量大时大量 <code>goroutine</code> 创建</li><li>如果需要使用 <code>goroutine</code> 时，应该使用同一的 <code>Go</code> 函数进行创建，这个函数中会进行 <code>recover</code> ，避免因为野生 <code>goroutine</code> panic 导致主进程退出</li></ul></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>Go</span>(f <span style=color:#ff7b72>func</span>()){
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>(){
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>defer</span> <span style=color:#ff7b72>func</span>(){
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> recover(); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>                log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;panic: %+v&#34;</span>, err)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>f</span>()
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=error>error<a hidden class=anchor aria-hidden=true href=#error>#</a></h3><ol><li><p>我们在应用程序中使用 <code>github.com/pkg/errors</code> 处理应用错误，<strong>注意在公共库当中，我们一般不使用这个</strong></p></li><li><p><code>error</code>应该是函数的最后一个返回值，当<code>error</code>不为<code>nil</code> 时，函数的其他返回值是不可用的状态，不应该对其他返回值做任何期待</p><ol><li><code>func f() (io.Reader, *S1, error)</code> 在这里，我们不知道 <code>io.Reader</code> 中是否有数据，可能有，也有可能有一部分</li></ol></li><li><p>错误处理的时候应该先判断错误， <code>if err != nil</code> 出现错误及时返回，使代码是一条流畅的直线，避免过多的嵌套.</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// good case</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>f</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    a, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>A</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ... 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// bad case</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>f</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    a, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>A</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>在<strong>应用程序</strong>中出现错误时，使用 <code>errors.New</code> 或者 <code>errors.Errorf</code> 返回错误</p></li></ol><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (u <span style=color:#ff7b72;font-weight:700>*</span>usecese) <span style=color:#d2a8ff;font-weight:700>usecase1</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    money <span style=color:#ff7b72;font-weight:700>:=</span> u.repo.<span style=color:#d2a8ff;font-weight:700>getMoney</span>(uid)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> money &lt; <span style=color:#a5d6ff>10</span> {
</span></span><span style=display:flex><span>        errors.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;用户余额不足, uid: %d, money: %d&#34;</span>, uid, money)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>如果是调用<strong>应用程序的</strong>其他函数出现错误，请直接返回，如果需要携带信息，请使用 <code>errors.WithMessage</code></li></ol><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (u <span style=color:#ff7b72;font-weight:700>*</span>usecese) <span style=color:#d2a8ff;font-weight:700>usecase2</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    name, err <span style=color:#ff7b72;font-weight:700>:=</span> u.repo.<span style=color:#d2a8ff;font-weight:700>getUserName</span>(uid)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> errors.<span style=color:#d2a8ff;font-weight:700>WithMessage</span>(err, <span style=color:#a5d6ff>&#34;其他附加信息&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=6><li>如果是调用其他库（标准库、企业公共库、开源第三方库等）获取到错误时，请使用<code>errors.Wrap</code>添加堆栈信息<ol><li>切记，不要每个地方都是用 <code>errors.Wrap</code> 只需要在错误第一次出现时进行 <code>errors.Wrap</code> 即可</li><li>根据场景进行判断是否需要将其他库的原始错误吞掉，例如可以把 <code>repository</code> 层的数据库相关错误吞掉，返回业务错误码，避免后续我们分割微服务或者更换 <code>ORM</code> 库时需要去修改上层代码</li><li>注意我们在基础库，被大量引入的第三方库编写时一般不使用 <code>errors.Wrap</code> 避免堆栈信息重复</li></ol></li></ol><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>f</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72;font-weight:700>:=</span> json.<span style=color:#d2a8ff;font-weight:700>Unmashal</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>a, data)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> errors.<span style=color:#d2a8ff;font-weight:700>Wrap</span>(err, <span style=color:#a5d6ff>&#34;其他附加信息&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=7><li><strong>禁止</strong>每个出错的地方都打日志，<strong>只需要</strong>在进程的最开始的地方使用 <code>%+v</code> 进行统一打印，例如 <code>http/rpc </code>服务的中间件</li><li>错误判断使用 <code>errors.Is</code> 进行比较</li></ol><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>f</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>A</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> errors.<span style=color:#d2a8ff;font-weight:700>Is</span>(err, io.EOF){
</span></span><span style=display:flex><span>    	<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=9><li>错误类型判断，使用 <code>errors.As</code> 进行赋值</li></ol><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>f</span>() <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>A</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>var</span> errA errorA
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> errors.<span style=color:#d2a8ff;font-weight:700>As</span>(err, <span style=color:#ff7b72;font-weight:700>&amp;</span>errA){
</span></span><span style=display:flex><span>    	<span style=color:#8b949e;font-style:italic>// ...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 其他逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=10><li>如何判定错误的信息是否足够，想一想当你的代码出现问题需要排查的时候你的错误信息是否可以帮助你快速的定位问题，例如我们在请求中一般会输出参数信息，用于辅助判断错误</li><li>对于业务错误，推荐在一个统一的地方创建一个错误字典，错误字典里面应该包含错误的 code，并且在日志中作为独立字段打印，方便做业务告警的判断，错误必须有清晰的错误文档</li><li>不需要返回，<strong>被忽略的错误必须输出日志信息</strong></li><li>同一个地方不停的报错，最好不要不停输出错误日志，这样可能会导致被大量的错误日志信息淹没，无法排查问题，比较好的做法是打印一次错误详情，然后打印出错误出现的次数</li><li>对同一个类型的错误，采用相同的模式，例如参数错误，不要有的返回 404 有的返回 200</li><li>处理错误的时候，需要处理已分配的资源，使用 <code>defer</code> 进行清理，例如文件句柄</li></ol><h3 id=panic-or-error>panic or error<a hidden class=anchor aria-hidden=true href=#panic-or-error>#</a></h3><ol><li>在 Go 中 panic 会导致程序直接退出，是一个致命的错误，如果使用 <code>panic</code>,<code>recover</code> 进行处理的话，会存在很多问题<ol><li>性能问题，频繁 <code>panic</code>, <code>recover</code> 性能不好</li><li>容易导致程序异常退出，只要有一个地方没有处理到就会导致程序进程整个退出</li><li>不可控，一旦 panic 就将处理逻辑移交给了外部，我们并不能预设外部包一定会进行处理</li></ol></li><li>什么时候使用 panic 呢？<ol><li>对于真正意外的情况，那些表示不可恢复的程序错误，例如索引越界、不可恢复的环境问题、栈溢出，我们才使用 panic</li></ol></li><li>使用 error 处理有哪些好处？<ol><li>简单。</li><li>考虑失败，而不是成功(Plan for failure, not success)。</li><li>没有隐藏的控制流。</li><li>完全交给你来控制 error。</li><li>Error are values。</li></ol></li></ol><h1 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h1><ul><li><p><a href=https://go.dev/blog/errors-are-values>Errors are values - The Go Programming Language</a></p></li><li><p><a href=https://go.dev/blog/error-handling-and-go>Error handling and Go - The Go Programming Language</a></p></li><li><p><a href=https://lailin.xyz/post/go-training-03.html>https://lailin.xyz/post/go-training-03.html</a></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.com/en/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/>错误处理</a></li></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/servicemesh%E6%B5%85%E6%9E%90/><span class=title>« Prev</span><br><span>Service Mesh 介绍</span>
</a><a class=next href=https://luenci.com/en/posts/golang-%E5%90%8E%E7%AB%AF%E7%A8%8B%E5%BA%8F%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/><span class=title>Next »</span><br><span>Go Project Layout 最佳实践</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on x" href="https://x.com/intent/tweet/?text=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f&amp;hashtags=%e9%94%99%e8%af%af%e5%a4%84%e7%90%86"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f&amp;title=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;summary=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f&title=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on whatsapp" href="https://api.whatsapp.com/send?text=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on telegram" href="https://telegram.me/share/url?text=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang error 处理最佳实践 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Golang%20error%20%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-error-%25E5%25A4%2584%25E7%2590%2586%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2025 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>