<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>k8s核心数据结构（2） | Luenci</title>
<meta name=keywords content="k8s"><meta name=description content="K8s 核心数据结构（2）

参考书籍：《Kubernetes源码剖析-郑旭东著》

Kubernetes 内置资源概览



资源组
资源种类
说明




apiextensions.k8s.io
CustomResourceDefinition
自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型


apiregistration.k8s.io
APIService
聚合资源类型，由 AggregatorServer 负责管理该资源类


admissionregistration.k8s.io
MutatingWebhookConfiguration
变更准入控制器资源类型( Webhook)



ValidatingWebhookConfiguration
验证准入控制器资源类型 ( Webhook)


apps
ControllerRevision
记录资源对象所有的历史版本的资源类型



DaemonSet
在 Pod 资源对象的基础上提供守护进程的资源类型



Deployment
在 Pod资源对象的基础上提供支持无状态服务的资源类型



ReplicaSet
在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型



StatefulSet
在 Pod资源对象的基础上提供支持有状态服务的资源类型


auditregistration.k8s.io
AuditSink
审计资源类型


authentication.k8s.io
TokenReview
认证资源类型


authorization.k8s.io
LocalSubjectAccessReview
授权检查用户是否可以在指定的命名空间中执行操作



SelfSubjectAccessReview
授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作）



SelfSubjectRulesReview
授权枚举用户可以在指定的命名空间中执行一组操作



SubjectAccessReview
授 权检查用户是否可以执行操作


autoscaling
HorizontalPodAutoscaler
在 Pod 资源对象的基础上提供水平自动伸缩资源类型


batch
Job
提供一次性任务的资源类型



CronJob
提供定时任务的资源类型


certificates.k8s.io
CertificateSigningRequest
提供证书管理的资源类型


coordination.k8s.io
Leases
提供领导者选举机制的资源类型


core
ComponentStatus
该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型



ConfigMap
提供容器内应用程序配置管理的资源类型



Endpoints
提供将外部服务器映射为内部服务的资源类型



Event
提供 Kubernetes 集群事件管理的资源类型



LimitRange
为命名空间中的每种资源对象设置资源(硬件资源)使 用限制



Namespace
提供资源对象所在的命名空间的资源类型



Node
提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符



PersistentVolume
提供 PV 存储的资源类型



PersistentVolumeClaim
提供 PVC 存储的资源类型



Pod
提供容器集合管理的资源类型



PodTemplate
提供用于描述预定义 Pod 资源对象副本数模板的资源类型



ReplicationController
在 Pod资源对象的基础上提供副本数保持不变的资源类型



ResourceQuota
提供每个命名空间配额限制的资源类型



Secret
提供存储密码 、Token 、密钥等敏感数据的资源类型



Service
提供负载均衡器为 Pod 资源对象的代理服务的资源类型



ServiceAccount
提供 ServiceAccount 认证的资源类型


events.k8s.io
Event
提供Kuberetes集群事件管理的资源类型


networking.k8s.io
RuntimeClass
提供容器运行时功能的资源类型



Ingress
提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型


node.k8s.io
RuntimeClass
提供容器运行时功能的资源类型


policy
Evictions
在 Pod 资源对象的基础上提供驱逐策略的资源类型



PodDisruptionBudget
提供限制同时中断 Pod 的数量 ，以保证集群的高可用性



PodSecurityPolicy
提供控制 Pod 资源安全相关策略的资源类型


rbac.authorization.k8s.io
ClusterRole
提供 RBAC 集群角色的资源类型



ClusterRoleBinding
提供 RBAC 集群角色鄉定的资源类型



Role
提供 RBAC 角色的资源类型



RoleBinding
提供 RBAC 角色绑定的资源类型


scheduling.k8s.io
PriorityClass
提供 Pod 资源对象优先级管理的资源类型


settings.k8s.10
PodPreset
在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中


storage.k8s.io
StorageClass
提供动态设置PV存储参数的资源类



VolumeAttachment
供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型


"><meta name=author content="Luenci"><link rel=canonical href=https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%842/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.me/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.me/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.me/images/L.png><link rel=apple-touch-icon href=https://luenci.me/L.png><link rel=mask-icon href=https://luenci.me/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%842/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="k8s核心数据结构（2）"><meta property="og:description" content="K8s 核心数据结构（2）

参考书籍：《Kubernetes源码剖析-郑旭东著》

Kubernetes 内置资源概览



资源组
资源种类
说明




apiextensions.k8s.io
CustomResourceDefinition
自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型


apiregistration.k8s.io
APIService
聚合资源类型，由 AggregatorServer 负责管理该资源类


admissionregistration.k8s.io
MutatingWebhookConfiguration
变更准入控制器资源类型( Webhook)



ValidatingWebhookConfiguration
验证准入控制器资源类型 ( Webhook)


apps
ControllerRevision
记录资源对象所有的历史版本的资源类型



DaemonSet
在 Pod 资源对象的基础上提供守护进程的资源类型



Deployment
在 Pod资源对象的基础上提供支持无状态服务的资源类型



ReplicaSet
在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型



StatefulSet
在 Pod资源对象的基础上提供支持有状态服务的资源类型


auditregistration.k8s.io
AuditSink
审计资源类型


authentication.k8s.io
TokenReview
认证资源类型


authorization.k8s.io
LocalSubjectAccessReview
授权检查用户是否可以在指定的命名空间中执行操作



SelfSubjectAccessReview
授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作）



SelfSubjectRulesReview
授权枚举用户可以在指定的命名空间中执行一组操作



SubjectAccessReview
授 权检查用户是否可以执行操作


autoscaling
HorizontalPodAutoscaler
在 Pod 资源对象的基础上提供水平自动伸缩资源类型


batch
Job
提供一次性任务的资源类型



CronJob
提供定时任务的资源类型


certificates.k8s.io
CertificateSigningRequest
提供证书管理的资源类型


coordination.k8s.io
Leases
提供领导者选举机制的资源类型


core
ComponentStatus
该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型



ConfigMap
提供容器内应用程序配置管理的资源类型



Endpoints
提供将外部服务器映射为内部服务的资源类型



Event
提供 Kubernetes 集群事件管理的资源类型



LimitRange
为命名空间中的每种资源对象设置资源(硬件资源)使 用限制



Namespace
提供资源对象所在的命名空间的资源类型



Node
提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符



PersistentVolume
提供 PV 存储的资源类型



PersistentVolumeClaim
提供 PVC 存储的资源类型



Pod
提供容器集合管理的资源类型



PodTemplate
提供用于描述预定义 Pod 资源对象副本数模板的资源类型



ReplicationController
在 Pod资源对象的基础上提供副本数保持不变的资源类型



ResourceQuota
提供每个命名空间配额限制的资源类型



Secret
提供存储密码 、Token 、密钥等敏感数据的资源类型



Service
提供负载均衡器为 Pod 资源对象的代理服务的资源类型



ServiceAccount
提供 ServiceAccount 认证的资源类型


events.k8s.io
Event
提供Kuberetes集群事件管理的资源类型


networking.k8s.io
RuntimeClass
提供容器运行时功能的资源类型



Ingress
提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型


node.k8s.io
RuntimeClass
提供容器运行时功能的资源类型


policy
Evictions
在 Pod 资源对象的基础上提供驱逐策略的资源类型



PodDisruptionBudget
提供限制同时中断 Pod 的数量 ，以保证集群的高可用性



PodSecurityPolicy
提供控制 Pod 资源安全相关策略的资源类型


rbac.authorization.k8s.io
ClusterRole
提供 RBAC 集群角色的资源类型



ClusterRoleBinding
提供 RBAC 集群角色鄉定的资源类型



Role
提供 RBAC 角色的资源类型



RoleBinding
提供 RBAC 角色绑定的资源类型


scheduling.k8s.io
PriorityClass
提供 Pod 资源对象优先级管理的资源类型


settings.k8s.10
PodPreset
在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中


storage.k8s.io
StorageClass
提供动态设置PV存储参数的资源类



VolumeAttachment
供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型


"><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%842/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-20T00:00:00+00:00"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="k8s核心数据结构（2）"><meta name=twitter:description content="K8s 核心数据结构（2）

参考书籍：《Kubernetes源码剖析-郑旭东著》

Kubernetes 内置资源概览



资源组
资源种类
说明




apiextensions.k8s.io
CustomResourceDefinition
自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型


apiregistration.k8s.io
APIService
聚合资源类型，由 AggregatorServer 负责管理该资源类


admissionregistration.k8s.io
MutatingWebhookConfiguration
变更准入控制器资源类型( Webhook)



ValidatingWebhookConfiguration
验证准入控制器资源类型 ( Webhook)


apps
ControllerRevision
记录资源对象所有的历史版本的资源类型



DaemonSet
在 Pod 资源对象的基础上提供守护进程的资源类型



Deployment
在 Pod资源对象的基础上提供支持无状态服务的资源类型



ReplicaSet
在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型



StatefulSet
在 Pod资源对象的基础上提供支持有状态服务的资源类型


auditregistration.k8s.io
AuditSink
审计资源类型


authentication.k8s.io
TokenReview
认证资源类型


authorization.k8s.io
LocalSubjectAccessReview
授权检查用户是否可以在指定的命名空间中执行操作



SelfSubjectAccessReview
授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作）



SelfSubjectRulesReview
授权枚举用户可以在指定的命名空间中执行一组操作



SubjectAccessReview
授 权检查用户是否可以执行操作


autoscaling
HorizontalPodAutoscaler
在 Pod 资源对象的基础上提供水平自动伸缩资源类型


batch
Job
提供一次性任务的资源类型



CronJob
提供定时任务的资源类型


certificates.k8s.io
CertificateSigningRequest
提供证书管理的资源类型


coordination.k8s.io
Leases
提供领导者选举机制的资源类型


core
ComponentStatus
该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型



ConfigMap
提供容器内应用程序配置管理的资源类型



Endpoints
提供将外部服务器映射为内部服务的资源类型



Event
提供 Kubernetes 集群事件管理的资源类型



LimitRange
为命名空间中的每种资源对象设置资源(硬件资源)使 用限制



Namespace
提供资源对象所在的命名空间的资源类型



Node
提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符



PersistentVolume
提供 PV 存储的资源类型



PersistentVolumeClaim
提供 PVC 存储的资源类型



Pod
提供容器集合管理的资源类型



PodTemplate
提供用于描述预定义 Pod 资源对象副本数模板的资源类型



ReplicationController
在 Pod资源对象的基础上提供副本数保持不变的资源类型



ResourceQuota
提供每个命名空间配额限制的资源类型



Secret
提供存储密码 、Token 、密钥等敏感数据的资源类型



Service
提供负载均衡器为 Pod 资源对象的代理服务的资源类型



ServiceAccount
提供 ServiceAccount 认证的资源类型


events.k8s.io
Event
提供Kuberetes集群事件管理的资源类型


networking.k8s.io
RuntimeClass
提供容器运行时功能的资源类型



Ingress
提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型


node.k8s.io
RuntimeClass
提供容器运行时功能的资源类型


policy
Evictions
在 Pod 资源对象的基础上提供驱逐策略的资源类型



PodDisruptionBudget
提供限制同时中断 Pod 的数量 ，以保证集群的高可用性



PodSecurityPolicy
提供控制 Pod 资源安全相关策略的资源类型


rbac.authorization.k8s.io
ClusterRole
提供 RBAC 集群角色的资源类型



ClusterRoleBinding
提供 RBAC 集群角色鄉定的资源类型



Role
提供 RBAC 角色的资源类型



RoleBinding
提供 RBAC 角色绑定的资源类型


scheduling.k8s.io
PriorityClass
提供 Pod 资源对象优先级管理的资源类型


settings.k8s.10
PodPreset
在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中


storage.k8s.io
StorageClass
提供动态设置PV存储参数的资源类



VolumeAttachment
供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型


"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.me/en/posts/"},{"@type":"ListItem","position":2,"name":"k8s核心数据结构（2）","item":"https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%842/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"k8s核心数据结构（2）","name":"k8s核心数据结构（2）","description":"K8s 核心数据结构（2） 参考书籍：《Kubernetes源码剖析-郑旭东著》\nKubernetes 内置资源概览 资源组 资源种类 说明 apiextensions.k8s.io CustomResourceDefinition 自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型 apiregistration.k8s.io APIService 聚合资源类型，由 AggregatorServer 负责管理该资源类 admissionregistration.k8s.io MutatingWebhookConfiguration 变更准入控制器资源类型( Webhook) ValidatingWebhookConfiguration 验证准入控制器资源类型 ( Webhook) apps ControllerRevision 记录资源对象所有的历史版本的资源类型 DaemonSet 在 Pod 资源对象的基础上提供守护进程的资源类型 Deployment 在 Pod资源对象的基础上提供支持无状态服务的资源类型 ReplicaSet 在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型 StatefulSet 在 Pod资源对象的基础上提供支持有状态服务的资源类型 auditregistration.k8s.io AuditSink 审计资源类型 authentication.k8s.io TokenReview 认证资源类型 authorization.k8s.io LocalSubjectAccessReview 授权检查用户是否可以在指定的命名空间中执行操作 SelfSubjectAccessReview 授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作） SelfSubjectRulesReview 授权枚举用户可以在指定的命名空间中执行一组操作 SubjectAccessReview 授 权检查用户是否可以执行操作 autoscaling HorizontalPodAutoscaler 在 Pod 资源对象的基础上提供水平自动伸缩资源类型 batch Job 提供一次性任务的资源类型 CronJob 提供定时任务的资源类型 certificates.k8s.io CertificateSigningRequest 提供证书管理的资源类型 coordination.k8s.io Leases 提供领导者选举机制的资源类型 core ComponentStatus 该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型 ConfigMap 提供容器内应用程序配置管理的资源类型 Endpoints 提供将外部服务器映射为内部服务的资源类型 Event 提供 Kubernetes 集群事件管理的资源类型 LimitRange 为命名空间中的每种资源对象设置资源(硬件资源)使 用限制 Namespace 提供资源对象所在的命名空间的资源类型 Node 提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符 PersistentVolume 提供 PV 存储的资源类型 PersistentVolumeClaim 提供 PVC 存储的资源类型 Pod 提供容器集合管理的资源类型 PodTemplate 提供用于描述预定义 Pod 资源对象副本数模板的资源类型 ReplicationController 在 Pod资源对象的基础上提供副本数保持不变的资源类型 ResourceQuota 提供每个命名空间配额限制的资源类型 Secret 提供存储密码 、Token 、密钥等敏感数据的资源类型 Service 提供负载均衡器为 Pod 资源对象的代理服务的资源类型 ServiceAccount 提供 ServiceAccount 认证的资源类型 events.k8s.io Event 提供Kuberetes集群事件管理的资源类型 networking.k8s.io RuntimeClass 提供容器运行时功能的资源类型 Ingress 提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型 node.k8s.io RuntimeClass 提供容器运行时功能的资源类型 policy Evictions 在 Pod 资源对象的基础上提供驱逐策略的资源类型 PodDisruptionBudget 提供限制同时中断 Pod 的数量 ，以保证集群的高可用性 PodSecurityPolicy 提供控制 Pod 资源安全相关策略的资源类型 rbac.authorization.k8s.io ClusterRole 提供 RBAC 集群角色的资源类型 ClusterRoleBinding 提供 RBAC 集群角色鄉定的资源类型 Role 提供 RBAC 角色的资源类型 RoleBinding 提供 RBAC 角色绑定的资源类型 scheduling.k8s.io PriorityClass 提供 Pod 资源对象优先级管理的资源类型 settings.k8s.10 PodPreset 在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中 storage.k8s.io StorageClass 提供动态设置PV存储参数的资源类 VolumeAttachment 供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型 ","keywords":["k8s"],"articleBody":"K8s 核心数据结构（2） 参考书籍：《Kubernetes源码剖析-郑旭东著》\nKubernetes 内置资源概览 资源组 资源种类 说明 apiextensions.k8s.io CustomResourceDefinition 自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型 apiregistration.k8s.io APIService 聚合资源类型，由 AggregatorServer 负责管理该资源类 admissionregistration.k8s.io MutatingWebhookConfiguration 变更准入控制器资源类型( Webhook) ValidatingWebhookConfiguration 验证准入控制器资源类型 ( Webhook) apps ControllerRevision 记录资源对象所有的历史版本的资源类型 DaemonSet 在 Pod 资源对象的基础上提供守护进程的资源类型 Deployment 在 Pod资源对象的基础上提供支持无状态服务的资源类型 ReplicaSet 在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型 StatefulSet 在 Pod资源对象的基础上提供支持有状态服务的资源类型 auditregistration.k8s.io AuditSink 审计资源类型 authentication.k8s.io TokenReview 认证资源类型 authorization.k8s.io LocalSubjectAccessReview 授权检查用户是否可以在指定的命名空间中执行操作 SelfSubjectAccessReview 授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作） SelfSubjectRulesReview 授权枚举用户可以在指定的命名空间中执行一组操作 SubjectAccessReview 授 权检查用户是否可以执行操作 autoscaling HorizontalPodAutoscaler 在 Pod 资源对象的基础上提供水平自动伸缩资源类型 batch Job 提供一次性任务的资源类型 CronJob 提供定时任务的资源类型 certificates.k8s.io CertificateSigningRequest 提供证书管理的资源类型 coordination.k8s.io Leases 提供领导者选举机制的资源类型 core ComponentStatus 该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型 ConfigMap 提供容器内应用程序配置管理的资源类型 Endpoints 提供将外部服务器映射为内部服务的资源类型 Event 提供 Kubernetes 集群事件管理的资源类型 LimitRange 为命名空间中的每种资源对象设置资源(硬件资源)使 用限制 Namespace 提供资源对象所在的命名空间的资源类型 Node 提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符 PersistentVolume 提供 PV 存储的资源类型 PersistentVolumeClaim 提供 PVC 存储的资源类型 Pod 提供容器集合管理的资源类型 PodTemplate 提供用于描述预定义 Pod 资源对象副本数模板的资源类型 ReplicationController 在 Pod资源对象的基础上提供副本数保持不变的资源类型 ResourceQuota 提供每个命名空间配额限制的资源类型 Secret 提供存储密码 、Token 、密钥等敏感数据的资源类型 Service 提供负载均衡器为 Pod 资源对象的代理服务的资源类型 ServiceAccount 提供 ServiceAccount 认证的资源类型 events.k8s.io Event 提供Kuberetes集群事件管理的资源类型 networking.k8s.io RuntimeClass 提供容器运行时功能的资源类型 Ingress 提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型 node.k8s.io RuntimeClass 提供容器运行时功能的资源类型 policy Evictions 在 Pod 资源对象的基础上提供驱逐策略的资源类型 PodDisruptionBudget 提供限制同时中断 Pod 的数量 ，以保证集群的高可用性 PodSecurityPolicy 提供控制 Pod 资源安全相关策略的资源类型 rbac.authorization.k8s.io ClusterRole 提供 RBAC 集群角色的资源类型 ClusterRoleBinding 提供 RBAC 集群角色鄉定的资源类型 Role 提供 RBAC 角色的资源类型 RoleBinding 提供 RBAC 角色绑定的资源类型 scheduling.k8s.io PriorityClass 提供 Pod 资源对象优先级管理的资源类型 settings.k8s.10 PodPreset 在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中 storage.k8s.io StorageClass 提供动态设置PV存储参数的资源类 VolumeAttachment 供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型 runtime.Object 类型基石 ​\truntime.Object 是Kubernetes 类型系统的基石。Kubernetes 上的所有资源对象 ( Resource 0bject ) 实际上就是一种 Go 语言的 Struct 类型 ， 相当于一种数据结构 ，它们都有一个共同的结构叫runtime.Object。runtime.Object 被设计为 Interface 接口类型， 作为资源对象的通用资源对象，runtime.Obejct 类型基石如图\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // 对象接口必须被在 Scheme 注册的所有 API 类型支持。由于方案中的对象是 // 预期被序列化到线路，对象必须提供给 Scheme 的接口允许 // 用于设置对象表示的种类、版本和组的序列化程序。对象可以选择 // 在不希望序列化的情况下返回无操作 ObjectKindAccessor。 type Object interface { GetObjectKind() schema.ObjectKind DeepCopyObject() Object } type ObjectKind interface { // SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil // should clear the current setting. SetGroupVersionKind(kind GroupVersionKind) // GroupVersionKind returns the stored group, version, and kind of an object, or an empty struct // if the object does not expose or provide these fields. GroupVersionKind() GroupVersionKind } runtime.Object 提供了两个方法 ，分别是 GetObjectKind 和 DeepCopyObject。\nGetObjectKind : 用于设置并返回 GroupVersionKind。\nDeepCopyObject: 用于深复制当前资源对象并返回 。\n深复制相当于将数据结构克隆一份，因此它不与原始对象共享任何内容。它使代码在不修改原始对象的情况下可以改变克隆对象的任何属性。\n那么，如何确认一个资源对象是否可以转换成runtime.Object 通用资源对象呢?\n这时需要确认该资源对象是否拥有 GetobjectKind 和 DeepCopyobjeot 方法。Kubernetes 的每一个资源对象都嵌入了metav1.TypeMeta 类型，metav1.TypeMeta 类型实现了GetObjectkind 方法，所以资源对象拥有该方法。 另外，Kubernetes 的每一 个资源对象都实现了 DeepCopyobject 方法，该方法一般被定义在 zz_generated.deepcopy.go 文件中。因此，可以认为该资源对象能够转换成 runtime.Object 通用资源对象。\n​\t所以，Kubernetes 的任意资源对象都可以通过 runtime.Object 存储它的类型并允许深复制操作。通过 runtime.Object Example 代码示例，可以将资源对象转换成通用资源对象并再次转换回资源对象。runtime.Object Example 代码示例如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime\" \"k8s.io/kubernetes/pkg/apis/core\" \"reflect\" ) func main() { pod := \u0026core.Pod{ TypeMeta: metav1.TypeMeta{ Kind: \"Pod\", }, ObjectMeta: metav1.ObjectMeta{ Labels: map[string]string{\"name\": \"foo\"}, }, } obj := runtime.Object(pod) pod2, ok := obj.(*core.Pod) if !ok { panic(\"unexpected\") } if !reflect.DeepEqual(pod, pod2) { panic(\"unexpected\") } } ​\t在以上代码示例中，首先实例化 Pod 资源, 得到 Pod 资源对象, 通过 runtime.object 将 Pod 资源对象转换成通用资源对象(得到 obj )。然后通过断言的方式，将obj 通用资源对象转换成 Pod 资源对象(得到 pod2 )。最终通过 reflect (反射，来验证转换之前和转换之后的资源对象是否相等。\nUnstructured数据 ​\t数据可以分为结构化数据 (StructuredData )和非结构化数据 ( Unstructured Data ) 。 Kubernetes 内部会经常处理这两种数据。\n1. 结构化数据 预先知道数据结构的数据类型是结构化数据。例如，JSON 数据: 1 2 3 4 { \"id\": 1 \"name\": \"Derek\" } 要使用这种数据，需要创建一个struct 数据结构，其具有id 和name 属性:\n1 2 3 4 type Student struct{ ID int Name string } 2. 非结构化数据 ​\t无法预知数据结构的数据类型或属性名称不确定的数据类型是非结构化数据， 其无法通过构建预定的struct 数据结构来序列化或反序列化数据。例如\n1 2 3 4 5 { \"id\": 1, \"name\": \"Derek\", \"description\": ... } ​\t我们无法事先得知description 的数据类型，它可能是字符串，也可能是数组嵌套等。原因在于Go 语言是强类型语言，它需要预先知道数据类型，Go 语言在处理JSON 数据时 不如动态语言那样便捷。 当无法预知数据结构的数据类型或属性名称不确定时，通过如 下结构来解决问题\n1 var result map[string]interface{} ​\t每个字符串对应一 JSON 属性，其映射 interface{} 类型对应值 ，可以是任何类型。使用 interface 字段时，通过 Go 语言断言的方式进行类型转换:\n1 2 3 if description, ok := result[\"description\"].(string);ok{ fmt.Println(description) } 3. Kubernetes 非结构化数据处理 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // staging/src/k8s.io/apimachinery/pkg/runtime/interfaces.go // Unstructured objects store values as map[string]interface{}, with only values that can be serialized // to JSON allowed. type Unstructured interface { Object // NewEmptyInstance returns a new instance of the concrete type containing only kind/apiVersion and no other data. // This should be called instead of reflect.New() for unstructured types because the go type alone does not preserve kind/apiVersion info. NewEmptyInstance() Unstructured // UnstructuredContent returns a non-nil map with this object's contents. Values may be // []interface{}, map[string]interface{}, or any primitive type. Contents are typically serialized to // and from JSON. SetUnstructuredContent should be used to mutate the contents. UnstructuredContent() map[string]interface{} // SetUnstructuredContent updates the object content to match the provided map. SetUnstructuredContent(map[string]interface{}) // IsList returns true if this type is a list or matches the list convention - has an array called \"items\". IsList() bool // EachListItem should pass a single item out of the list as an Object to the provided function. Any // error should terminate the iteration. If IsList() returns false, this method should return an error // instead of calling the provided function. EachListItem(func(Object) error) error } // staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/unstructured/unstructured.go type Unstructured struct { // Object is a JSON compatible map with string, float, int, bool, []interface{}, or // map[string]interface{} // children. Object map[string]interface{} } ​\t在上述代码中，Kubernetes 非结构化数据通过 map[string]interface{} 表达，并提供接口。在 client-go 编程式交互的 DynamicClient 内部，实现了 Unstructured 类型， 用于处理非结构化数据。\nScheme 资源注册表 ​\t大家在使用Windows 操作系统时都应该听说过， 当在操作系统上安装应用程序 时， 该程序 的一些信息会注册到注册表中; 当从操作系统 上卸载应用程序时， 会从 注册表中删除该程序的相关信息。而 KubernetesScheme 资源注册表类似于Windows 操作系统上的注册表，只不过注册的是资源类型。\n​\tKuberetes 系统拥有众多资源，每一种资源就是一个资源类型，这些资源类型需要有统一的注册 、 存储 、 查询 、 管理等机制 。目前 Kuberetes 系统中的所有资源类型都已注册到 Scheme 资源注册表中，其是 一个内存型的资源注册表，拥有如下特点。\n支持注册多种资源类型，包括内部版本和外部版本。 支持多种版 本转换机制。 支持不同资源的序列化/反序列化机制。 ​\tScheme 资源注册表支持两种资源类型( Type )的注册，分别是 UnversionedType 和KnownType 资源类型，分别介绍如下\nUnversionedType: 无版本资源类型，这是一个早期 Kubernetes 系统中的概 念， 它主要应用于某些没有版本的资源类型，该类型的资源对象并不需要进行转换。在目前的 Kubernetes 发行版本中，无版本类型已被弱化，几乎所有的资源对象都拥有版本， 但在 metav1 元数据中还有部分类型 ，它们既属于 meta.k8s.io/v1 又属于 UnversionedType 无版本资源类型，例如 metav1.Status, metav1.APIVersions、metav1.APIGroupList、metavI.APIGroup、metav1.APIResourceList. KnownType: 是目前Kubernetes 最常用的资源类型，也可称其为“ 拥有版本的资源类型” Schema 资源注册表数据结构 ​\tScheme资源注册表数据结构主要由4 个map结构组成，它们分别是. gvkToType、typeToGVK、unversionedTypes、unversionedKinds.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eme struct { // gvkToType allows one to figure out the go type of an object with // the given version and name. gvkToType map[schema.GroupVersionKind]reflect.Type // typeToGVK allows one to find metadata for a given go object. // The reflect.Type we index by should *not* be a pointer. typeToGVK map[reflect.Type][]schema.GroupVersionKind // unversionedTypes are transformed without conversion in ConvertToVersion. unversionedTypes map[reflect.Type]schema.GroupVersionKind // unversionedKinds are the names of kinds that can be created in the context of any group // or version // TODO: resolve the status of unversioned types. unversionedKinds map[string]reflect.Type ... } ​\tScheme 资源注册表结构字段说明如下。\ngVkToType: 存储 GVK 与 Type 的映射关系。\ntypeToGVK: 存储 Type 与 GVK 的映射关系,一个 Type 会对应一个或多个 GVK。\nunversionedTypes: 存储 UnversionedType 与 GVK 的映射关系。\nunversionedKinds: 存储 Kind (资源种类)名称与UnversionedType 的映射关系。\nScheme 资源注册表通过Go 语言的map结构实现映射关系，这些映射关系可以 实现高效的正向和反向检索，从 Scheme 资源注册表中检索某个 GVK 的Type， 它的时间复杂度为O（1）。\n​\tScheme 资源注册表在 Kubernetes 系统体系中属于非常核心的数据结构。示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package main import ( appsv1 \"k8s.io/api/apps/v1\" corev1 \"k8s.io/api/core/v1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime\" \"k8s.io/apimachinery/pkg/runtime/schema\" ) func main() { // KnownType external coreGV := schema.GroupVersion{Group: \"\", Version: \"v1\"} extensionsGV := schema.GroupVersion{Group: \"extensions\", Version: \"v1beta1\"} // KnownType internal coreInternalGV := schema.GroupVersion{Group: \"\", Version: runtime.APIVersionInternal} // UnversionedType Unversioned := schema.GroupVersion{Group: \"\", Version: \"v1\"} scheme := runtime.NewScheme() scheme.AddKnownTypes(coreGV, \u0026corev1.Pod{}) scheme.AddKnownTypes(extensionsGV, \u0026appsv1.DaemonSet{}) scheme.AddKnownTypes(coreInternalGV, \u0026corev1.Pod{}) scheme.AddUnversionedTypes(Unversioned, \u0026metav1.Status{}) } ​\t在上述代码中，首先定义了两种类型的GV( 资源组、资源版本)，KnownType 类型有 coreGV、extensionsGV、coreInternalGV 对象，其中 corelnternalGV 对象属于内部版本(即runtime.APIVersioninternal )，而 UnversionedType 类型有 Unversioned 对象。 ​\t通过 runtime.NewScheme 实例化一个新的Scheme资源注册表。注册资源类型到 Scheme 资源注册表有两种方式，第一种通过scheme.AddKnownTypes 方法注册 KnownType 类型的对象，第二种通过 scheme. AddUnversionedTypes 方法注册 UnversionedType 类型的对象。\n​\t在 Scheme Example 代码示例中，我们往 Scheme 资源注册表中分别注册了Pod、 DaemonSet、Pod ( 内部版本)及 Status (无版本资源类型)类型对象，那么这些资源的映射关系，如图\n​\tGVK(资源组、资源版本、资源种类)在Scheme资源注册表中以/, Kind =的形式存在，其中对于 Kind ( 资源种类)字段，在注册时如果不指定该 字段的名称，那么默认使用类型的名称，例如corev1.Pod 类型，通过reflect 机制获 取资源类型的名称，那么它的资源种类 Kind-Pod。 ​\t资源类型在Scheme 资源注册表中以 Go Type (通过 reflect 机制获取)形式存在。\n​\t另外， 需要注意的是，UnversionedType 类型的对象在通过 scheme.AddUnversionedTypes 方法注册时，会同时存在于4个map 结构中，代码示例如\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /* AddUnversionedTypes 将提供的类型注册为“未版本化”，这意味着它们遵循特殊规则。 每当序列化此类型的对象时，它都会使用提供的组版本进行序列化，而不是 转换。因此，未版本化的对象应该永远保持向后兼容，就好像它们在一个永远不会更新的 API 组和版本。 */ func (s *Scheme) AddUnversionedTypes(version schema.GroupVersion, types ...Object) { s.addObservedVersion(version) s.AddKnownTypes(version, types...) for _, obj := range types { t := reflect.TypeOf(obj).Elem() gvk := version.WithKind(t.Name()) s.unversionedTypes[t] = gvk if old, ok := s.unversionedKinds[gvk.Kind]; ok \u0026\u0026 t != old { panic(fmt.Sprintf(\"%v.%v has already been registered as unversioned kind %q - kind name must be unique in scheme %q\", old.PkgPath(), old.Name(), gvk, s.schemeName)) } s.unversionedKinds[gvk.Kind] = t } } 资源注册表注册方法 ​\t在Scheme 资源 注册表中，不同的资源类型使用的注册方法不同，分别介绍如下。\nscheme. AddUnversionedTypes: 注册 UnversionedType 资源类型。 scheme. AddKnownTypes: 注册 KnownType 资源类型。 scheme. AddKnownTypewithName: 注册KnownType 资源类型，须指定资源的 Kind 资源种类名 ​ 以 scheme. AddKnownTypes 方法为例，在注册资源类型时，无须指定 Kind 名称， 而是通过 reflect 机制获取资源类型的名称作为资源种类名称，代码示例如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /* AddKnownTypes 将“types”中传递的所有类型注册为版本“version”的成员。 传递给类型的所有对象都应该是指向结构的指针。去报道的名字 该结构在编码时成为“种类”字段。版本不能为空 - 使用 APIVersionInternal 常数，如果你有一个没有正式版本的类型 */ func (s *Scheme) AddKnownTypes(gv schema.GroupVersion, types ...Object) { s.addObservedVersion(gv) for _, obj := range types { t := reflect.TypeOf(obj) if t.Kind() != reflect.Pointer { panic(\"All types must be pointers to structs.\") } t = t.Elem() s.AddKnownTypeWithName(gv.WithKind(t.Name()), obj) } } 资源注册表查询方法 ​\t在运行过程中，kube-apiserver 组件常对 Scheme 资源注册表进行查询，它提供了如下方法。\nscheme.KnownTypes: 查询注册表中指定GV 下的资源类型。 scheme. AlKnownTypes: 查询注册表中所有GVK 下的资源类型。 scheme.ObjectKinds: 查询资源对象所对应的GVK， 一个资源对象可能存在多个GVK。 scheme.New: 查询GVK 所对应的资源对象。 scheme.IsGroupRegistered: 判断指定的资源组是否已经注册。 scheme.IsVersionRegistered : 判断指定的 G V 是否己经注册。 scheme.Recognizes: 判断指定的GVK 是否己经注册。 scheme.IsUnversioned: 判断指定的资源对象是否属于 UnversionedType 类型。 Codec 编解码器 ​\t在详解 Codec 编解码器之前，先认识下 Codec 编解码器与 Serializer 序列化器之间的差异。\nSerializer: 序列化器，包含序列化操作与反序列化操作。序列化操作是将数据 (例如数组 、对象或结构体等 ) 转换为宇符串的过程 ， 反序列化操作是将字符串转换为数据的过程，因此可以轻松地维护数据结构 并存储或传输数据\nCodee: 编解码器，包含编码器与解码器。编解码器是一个通用术语，指的是可以表示数据的任何格式，或者将数据转换为特定格式的过程。所以，可以将 Serializer 序列化器也理解为 Codec 编解码器的一种 。\nCodec 编解码器通用接又定义如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Decoder interface { Decode(data []byte, defaults *schema.GroupVersionKind, into Object) (Object, *schema.GroupVersionKind, error) } type Encoder interface { Encode(obj Object, w io.Writer) error Identifier() Identifier } type Serializer interface { Encoder Decoder } // Codec is a Serializer that deals with the details of versioning objects. It offers the same // interface as Serializer, so this is a marker to consumers that care about the version of the objects // they receive. type Codec Serializer ​\t从Codec 编解码器通用接又的定义可以看出，Serializer 序列化器属于Codec 编解码器的一种，这是因为每种序列化器都实现了Encoder 与 Decoder 方法。我们可以认为，只要实现了Encoder 与Decoder 方法的数据结构，就是序列化器。Kubernetes 目前支持 3 种主要的序列化器。Codec 编解码器如图\n​\tCodec 编解码器包含了种序列化器 ， 在进行编解码操作时 ，每一种序列化器都对资源对象的 metav1.TypeMeta (即 APIVersion 和Kind 字段)进行验证，如果资源对象未提供这些字段，就会返回错误。每种序列化器分别实现了 Encode 序列化方法与 Decode 反序列化方法 ，分别介绍如下\njsonSerializer: JSON 格式序列化/反序列化器。它使用 application/json的 ContentType 作为标识 yamlSerializer: YAML 格式化格式序列化/反序列化器。它使用 application/yaml的 ContentType 作为标识 protobufSerializer： Protobuf 格式化格式序列化/反序列化器。它使用 application/vnd.kubernetes.protobuf的 ContentType 作为标识 Codec 编解码器将 Eted 集群中的数据进行编解码操作。\nCodec 编解码实例化 ​\tCodec 编码器通过 NewCodecFactory 函数实例化，在实例化的过程中会将 jsonSerializer、yamlSerializer、protobufSerializer 序列化器全部实例化，NewCodecFactory -\u003e newSerializersForScheme ，示例代码如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 func newSerializersForScheme(scheme *runtime.Scheme, mf json.MetaFactory, options CodecFactoryOptions) []serializerType { jsonSerializer := json.NewSerializerWithOptions( mf, scheme, scheme, json.SerializerOptions{Yaml: false, Pretty: false, Strict: options.Strict}, ) jsonSerializerType := serializerType{ AcceptContentTypes: []string{runtime.ContentTypeJSON}, ContentType: runtime.ContentTypeJSON, FileExtensions: []string{\"json\"}, EncodesAsText: true, Serializer: jsonSerializer, Framer: json.Framer, StreamSerializer: jsonSerializer, } if options.Pretty { jsonSerializerType.PrettySerializer = json.NewSerializerWithOptions( mf, scheme, scheme, json.SerializerOptions{Yaml: false, Pretty: true, Strict: options.Strict}, ) } strictJSONSerializer := json.NewSerializerWithOptions( mf, scheme, scheme, json.SerializerOptions{Yaml: false, Pretty: false, Strict: true}, ) jsonSerializerType.StrictSerializer = strictJSONSerializer yamlSerializer := json.NewSerializerWithOptions( mf, scheme, scheme, json.SerializerOptions{Yaml: true, Pretty: false, Strict: options.Strict}, ) strictYAMLSerializer := json.NewSerializerWithOptions( mf, scheme, scheme, json.SerializerOptions{Yaml: true, Pretty: false, Strict: true}, ) protoSerializer := protobuf.NewSerializer(scheme, scheme) protoRawSerializer := protobuf.NewRawSerializer(scheme, scheme) serializers := []serializerType{ jsonSerializerType, { AcceptContentTypes: []string{runtime.ContentTypeYAML}, ContentType: runtime.ContentTypeYAML, FileExtensions: []string{\"yaml\"}, EncodesAsText: true, Serializer: yamlSerializer, StrictSerializer: strictYAMLSerializer, }, { AcceptContentTypes: []string{runtime.ContentTypeProtobuf}, ContentType: runtime.ContentTypeProtobuf, FileExtensions: []string{\"pb\"}, Serializer: protoSerializer, // note, strict decoding is unsupported for protobuf, // fall back to regular serializing StrictSerializer: protoSerializer, Framer: protobuf.LengthDelimitedFramer, StreamSerializer: protoRawSerializer, }, } for _, fn := range serializerExtensions { if serializer, ok := fn(scheme); ok { serializers = append(serializers, serializer) } } return serializers } ​\tjsonSerializer 与 yamlSerializer 分别通过json.NewSerializer 和 json.NewYAMLSerializer 函数进行实例化，jsonSerializer通过 application/json 的ContentType 标识， 文件扩展名为 json，而yamlSerializer 通过application/yaml 的 ContentType 标识，文件扩展名 为 yaml。protobufserializer 通过 protobuf.NewSerializer 函数进行实例化，它通过 application/ vnd.kubernetes.protobuf 的ContentType 标识，文件扩展名为pb\njsonSerializer 与 yamlSerializer 序列化器 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 // staging/src/k8s.io/apimachinery/pkg/runtime/serializer/json/json.go func (s *Serializer) Decode(originalData []byte, gvk *schema.GroupVersionKind, into runtime.Object) (runtime.Object, *schema.GroupVersionKind, error) { data := originalData if s.options.Yaml { altered, err := yaml.YAMLToJSON(data) if err != nil { return nil, nil, err } data = altered } actual, err := s.meta.Interpret(data) if err != nil { return nil, nil, err } if gvk != nil { *actual = gvkWithDefaults(*actual, *gvk) } if unk, ok := into.(*runtime.Unknown); ok \u0026\u0026 unk != nil { unk.Raw = originalData unk.ContentType = runtime.ContentTypeJSON unk.GetObjectKind().SetGroupVersionKind(*actual) return unk, actual, nil } if into != nil { _, isUnstructured := into.(runtime.Unstructured) types, _, err := s.typer.ObjectKinds(into) switch { case runtime.IsNotRegisteredError(err), isUnstructured: strictErrs, err := s.unmarshal(into, data, originalData) if err != nil { return nil, actual, err } // when decoding directly into a provided unstructured object, // extract the actual gvk decoded from the provided data, // and ensure it is non-empty. if isUnstructured { *actual = into.GetObjectKind().GroupVersionKind() if len(actual.Kind) == 0 { return nil, actual, runtime.NewMissingKindErr(string(originalData)) } // TODO(109023): require apiVersion here as well once unstructuredJSONScheme#Decode does } if len(strictErrs) \u003e 0 { return into, actual, runtime.NewStrictDecodingError(strictErrs) } return into, actual, nil case err != nil: return nil, actual, err default: *actual = gvkWithDefaults(*actual, types[0]) } } if len(actual.Kind) == 0 { return nil, actual, runtime.NewMissingKindErr(string(originalData)) } if len(actual.Version) == 0 { return nil, actual, runtime.NewMissingVersionErr(string(originalData)) } // use the target if necessary obj, err := runtime.UseOrCreateObject(s.typer, s.creater, *actual, into) if err != nil { return nil, actual, err } strictErrs, err := s.unmarshal(obj, data, originalData) if err != nil { return nil, actual, err } else if len(strictErrs) \u003e 0 { return obj, actual, runtime.NewStrictDecodingError(strictErrs) } return obj, actual, nil } ​\tDecode 两数支持两种格式的反序列化操作 ，分别是 YAML 格式和 JSON格式。\n​\t如果是 YAML 格式，则通过 yaml.YAMLTOJSON 两数将 JSON 格式数据转换为资源对象并填充到data 字段中。此时，无论反序列化操作的是YAML格式还是JSON 格式，data 字段中都是JSON格式数据。按着通过s.meta.Interpret 函数从JSON格式 数据中提取出资源对象的metav1.TypeMeta (即 APIVersion 和Kind 字段)。最后通过 caseSensitiveJsonlterator.Unmarshal 函数 (即json-iterator )将JSON 数据反序列化并返回。\nprotobufSerializer 序列化器 ​\tProtobuf (Google Protocol Buffer )是Google 公司内部的混合语言数据标准， Protocol Buffers是一种轻便、高效的结构化数据存储格式，可以用于结构化数据序列 化。它很适合做数据存储或成为 RPC 数据交换格式。它可用于通信协议、数据存储等领域，与语言无关、与平台无关、可扩展的序列化结构数据格式。\n1 2 3 4 5 6 7 8 package lm; message helloworld { required int32 id = 1; required string str = 2; optional int32 opt = 3; } ​\tProtobuf 序列化器使用 proto 库来实现序列化和反序列操作\n1. 序列化操作 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 func (s *Serializer) doEncode(obj runtime.Object, w io.Writer, memAlloc runtime.MemoryAllocator) error { if memAlloc == nil { klog.Error(\"a mandatory memory allocator wasn't provided, this might have a negative impact on performance, check invocations of EncodeWithAllocator method, falling back on runtime.SimpleAllocator\") memAlloc = \u0026runtime.SimpleAllocator{} } prefixSize := uint64(len(s.prefix)) var unk runtime.Unknown switch t := obj.(type) { case *runtime.Unknown: estimatedSize := prefixSize + uint64(t.Size()) data := memAlloc.Allocate(estimatedSize) i, err := t.MarshalTo(data[prefixSize:]) if err != nil { return err } copy(data, s.prefix) _, err = w.Write(data[:prefixSize+uint64(i)]) return err default: kind := obj.GetObjectKind().GroupVersionKind() unk = runtime.Unknown{ TypeMeta: runtime.TypeMeta{ Kind: kind.Kind, APIVersion: kind.GroupVersion().String(), }, } } switch t := obj.(type) { case bufferedMarshaller: // this path performs a single allocation during write only when the Allocator wasn't provided // it also requires the caller to implement the more efficient Size and MarshalToSizedBuffer methods encodedSize := uint64(t.Size()) estimatedSize := prefixSize + estimateUnknownSize(\u0026unk, encodedSize) data := memAlloc.Allocate(estimatedSize) i, err := unk.NestedMarshalTo(data[prefixSize:], t, encodedSize) if err != nil { return err } copy(data, s.prefix) _, err = w.Write(data[:prefixSize+uint64(i)]) return err case proto.Marshaler: // this path performs extra allocations data, err := t.Marshal() if err != nil { return err } unk.Raw = data estimatedSize := prefixSize + uint64(unk.Size()) data = memAlloc.Allocate(estimatedSize) i, err := unk.MarshalTo(data[prefixSize:]) if err != nil { return err } copy(data, s.prefix) _, err = w.Write(data[:prefixSize+uint64(i)]) return err default: // TODO: marshal with a different content type and serializer (JSON for third party objects) return errNotMarshalable{reflect.TypeOf(obj)} } } ​\tEncode 函数首先验证资源对象 proto.Marshaler类型，proto.Marshaler是一个interface接又类型，该接又专门留给对象自定义实现的序列化操作。如果资源对象为proto.Marshaler类型，则通过t.Marshal序列化函数进行编码。 ​\t而且，通过unk.MarshalTo两数在编码后的数据前加上protoEncodingPrefix前缀，前缀为magic-number特殊标识，其用于标识一个包的完整性。所有通过protobufSerializer序列化器编码的数据都会有前缀。前缀数据共4字节，分别是0x6b、0x38、0x73、0x00，其中第4个字节是为编码样式保留的。\n2. 反序列化操作 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 func (s *Serializer) Decode(originalData []byte, gvk *schema.GroupVersionKind, into runtime.Object) (runtime.Object, *schema.GroupVersionKind, error) { prefixLen := len(s.prefix) switch { case len(originalData) == 0: // TODO: treat like decoding {} from JSON with defaulting return nil, nil, fmt.Errorf(\"empty data\") case len(originalData) \u003c prefixLen || !bytes.Equal(s.prefix, originalData[:prefixLen]): return nil, nil, fmt.Errorf(\"provided data does not appear to be a protobuf message, expected prefix %v\", s.prefix) case len(originalData) == prefixLen: // TODO: treat like decoding {} from JSON with defaulting return nil, nil, fmt.Errorf(\"empty body\") } data := originalData[prefixLen:] unk := runtime.Unknown{} if err := unk.Unmarshal(data); err != nil { return nil, nil, err } actual := unk.GroupVersionKind() copyKindDefaults(\u0026actual, gvk) if intoUnknown, ok := into.(*runtime.Unknown); ok \u0026\u0026 intoUnknown != nil { *intoUnknown = unk if ok, _, _ := s.RecognizesData(unk.Raw); ok { intoUnknown.ContentType = runtime.ContentTypeProtobuf } return intoUnknown, \u0026actual, nil } if into != nil { types, _, err := s.typer.ObjectKinds(into) switch { case runtime.IsNotRegisteredError(err): pb, ok := into.(proto.Message) if !ok { return nil, \u0026actual, errNotMarshalable{reflect.TypeOf(into)} } if err := proto.Unmarshal(unk.Raw, pb); err != nil { return nil, \u0026actual, err } return into, \u0026actual, nil case err != nil: return nil, \u0026actual, err default: copyKindDefaults(\u0026actual, \u0026types[0]) // if the result of defaulting did not set a version or group, ensure that at least group is set // (copyKindDefaults will not assign Group if version is already set). This guarantees that the group // of into is set if there is no better information from the caller or object. if len(actual.Version) == 0 \u0026\u0026 len(actual.Group) == 0 { actual.Group = types[0].Group } } } if len(actual.Kind) == 0 { return nil, \u0026actual, runtime.NewMissingKindErr(fmt.Sprintf(\"%#v\", unk.TypeMeta)) } if len(actual.Version) == 0 { return nil, \u0026actual, runtime.NewMissingVersionErr(fmt.Sprintf(\"%#v\", unk.TypeMeta)) } return unmarshalToObject(s.typer, s.creater, \u0026actual, into, unk.Raw) } ​\tDecode两数首先验证protoEncodingPrefix前缀，前级为magic-number特殊标识，其用于标识一个包的完整性，然后验证资源对象是否为proto.Mesage类型，最后通过 proto.Unmarshal 反序列化函数进行解码。\nConverter 资源版本转换器 ​\t在Kubernetes 系统中，同一资源拥有多个资源版本，Kubernetes 系统允许同一资 源的不同资源版本进行转换，例如Deployment 资源对象， 当前运行的是v1beta1 资 源版本，但vlbetal 资源版本的某些功能或字段不如v1资源版本完善，则可以将 Deployment 资源对象的v1beta1 资源版本转换为 v1 版本。可通过kubectl convert 命 令进行资源版本转换，执行命令如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: apps/v1beta1 kind: Deployment metadata: name:nginx-deployment spec: replicas: 1 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort:80 1 kubectl convert -f vlbeta1Deployment.yami --output-version=apps/v1 ​\t首先，定义一个 YAML Manifest File 资源描述文件，该文件中定义Deployment 资源版本为v1beta1。通过执行kubect convert 命令，–output -ver sion 将 资源版本转换 为指定的资源版本v1。如果指定的资源版本不在Scheme 资源注册表中，则会报错。 如果不指定资源版本，则默认转换为资源的首选版本。\n​\tConverter 资源版本转换器主要用于解决多资源版本转换问题，Kubernetes 系统 中的一 个资源支持多个资源版本，如果要在每个资源版本之间转换，最直接的方式是，每个资源版本都支持其他资源版本的转换，但这样处理起来非常麻烦。例如，某个资源对象支持 3 个资源版本，那么就需要提前定义一个资源版本转换到其他两个资源版本(vI– vlalphal,vI- vlbetal)、(vlalphal-v1,vlalphal-v1beta1)及( v1beta1-v1, vlbetal–vlalphal)，随着资源版本的增加，资源版本转换的定义会越来越多。\n​\t为了解决这个问题，Kubernetes通过内部版本(InternalVersion)机制实现资源版本转换，Converter 资源版本转换过程如图\n​\t当需要在两个资源版本之间转换时，例如 vlalphal–vlbetal 或 vlalphal–v1。 Converter 资源版本转换器先将第 一个资源版本转换为_ internal 内部版本，再转换为相应的资源版本。每个资源只要能支持内部版本，就能与其他任何资源版本进行间接的资源版本转换\nConverter 转换器数据结构 ​\tConverter转换器数据结构主要存放转换函数(即Conversion Funcs)。Converter 转换器数据结构代码示例如下\n1 2 3 4 5 6 7 8 9 10 // Converter knows how to convert one type to another. type Converter struct { // Map from the conversion pair to a function which can // do the conversion. conversionFuncs ConversionFuncs generatedConversionFuncs ConversionFuncs // Set of conversions that should be treated as a no-op ignoredUntypedConversions map[typePair]struct{} } conversionFuncs: 默认转换两数。这些转换西数 一般定义在资源目录下的 conversion.go 代码文件中。 generatedConversionFuncs: 自动生成的转换两数。这些转换函数 一般定 义在资源目录下的 zz_generated.conversion.go 代码文件中，是由代码生成器自动生成的转换函数。 ignoredConversions: 若资源对象注册到此字段，则忽略此资源对象的转换操作。 ​ Converter转换器数据结构中存放的转换两数(即ConversionFuncs)可以分为两类，分别为默认的转换两数(即conversionFuncs字段)和自动生成的转换函数(即generatedConversionFuncs字段)。它们都通过ConversionFuncs来管理转换函数，代码示例如下\n1 2 3 4 5 6 7 8 9 10 11 type ConversionFuncs struct { untyped map[typePair]ConversionFunc } type typePair struct { source reflect.Type dest reflect.Type } type ConversionFunc func(a, b interface{}, scope Scope) error ​\tConversionFunc 类型函数(即Type Function )定义了转换函数实现的结构，将资 源对象a转换为资源对象b。a 参数定义了转换源(即source)的资源类型，b 参数定义 了转换目标(即dest)的资源类型。scope 定义了多次转换机制(即递归调用转换函数)。\nConversionFunc 类型函数的资源对象传参必须是指针，否则无法进 行转换并抛出异常\nConverter 注册转换函数 ​\tConverter 转换函数需要通过注册才能在Kubernetes 内部使用，目前 Kubernetes 支持 5 个注册转换西数，分别介绍如下。\nscheme. AddlgnoredConversionType :注册忽略的资源类型，不会执行转换操作，忽略资源对象的转换操作。 scheme. AddConversionFuncs: 注册多个Conversion Func 转换函数 scheme.AddConversionFunc: 注册单个Conversion Func转换函数 scheme. AddGeneratedConversionFunc: 注册自动生成的转换函数 scheme.AddFieldLabelConversionFune: 注册字段标签 ( FieldLabel )的转换函数 ​ 以apps/v1资源组、资源版本为例，通过scheme.AddConversionFuncs函数注册所有资源的转换函数，代码示例如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // v1版本好像已经弃用了 func addConversionFuncs(scheme *runtime.Scheme) error { // Add field label conversions for kinds having selectable nothing but ObjectMeta fields. if err := scheme.AddFieldLabelConversionFunc(SchemeGroupVersion.WithKind(\"StatefulSet\"), func(label, value string) (string, string, error) { switch label { case \"metadata.name\", \"metadata.namespace\", \"status.successful\": return label, value, nil default: return \"\", \"\", fmt.Errorf(\"field label not supported for appsv1beta2.StatefulSet: %s\", label) } }); err != nil { return err } return nil } Converter 资源版本转换原理 ​\tConverter 转换器在 Kubernetes 源码中实际应用非常广泛，例如 Deployment 资源对象，起初使用 v1beta1 资源版本，而 v1 资源版本更稳定，则会将 v1beta1 资源版本转换为v1资源版本 。Converter 资源版本转换过程如图\n代码示例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // ! 版本转换在1.7中废弃，此代码在最新版本中转换失败 package main import ( \"fmt\" appsv1 \"k8s.io/api/apps/v1\" appsv1beta1 \"k8s.io/api/apps/v1beta1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime\" \"k8s.io/kubernetes/pkg/apis/apps\" ) func main() { // KnownType external scheme := runtime.NewScheme() scheme.AddKnownTypes(appsv1beta1.SchemeGroupVersion, \u0026appsv1beta1.Deployment{}) scheme.AddKnownTypes(appsv1.SchemeGroupVersion, \u0026appsv1.Deployment{}) scheme.AddKnownTypes(apps.SchemeGroupVersion, \u0026appsv1.Deployment{}) metav1.AddToGroupVersion(scheme, appsv1beta1.SchemeGroupVersion) metav1.AddToGroupVersion(scheme, appsv1.SchemeGroupVersion) v1betalDeployment := \u0026appsv1beta1.Deployment{TypeMeta: metav1.TypeMeta{Kind: \"Deployment\", APIVersion: \"apps/v1beta1\"}} // v1beta1 - internal objInternal, err := scheme.ConvertToVersion(v1betalDeployment, apps.SchemeGroupVersion) if err != nil { panic(err) } fmt.Println(\"GVK:\", objInternal.GetObjectKind().GroupVersionKind().String()) // internal - v1 objV1, err := scheme.ConvertToVersion(objInternal, appsv1.SchemeGroupVersion) if err != nil { panic(err) } v1Deployment, ok := objV1.(*appsv1.Deployment) if !ok { panic(\"not a Deployment\") } fmt.Println(\"GVK:\", v1Deployment.GetObjectKind().GroupVersionKind().String()) } 代码分析：\n第 1 部分 ： 实例化一个空的 scheme 资源注册表 ， 将 v1beta1 资源版本 、 v1 资源版本及内部版本 （ internal ） 的 Deployment 资源注册到 scheme 资源注册表中 。\n第 2 部分 ： 实例化 v1beta1 Deployment 资源对象 ， 通过 scheme.ConvefiToVersion 将其转换为目标资源版本（ 即 internale 版本 ），得到 objlnternal资源对象 ， objlnternal 资源对象的 GVK 输出为 “ / ， Kind= ”\n第 3 部分 ： 将 obj lnternal 资源对象通过 scheme.ConvertToVersion 转换为目标资源版本 （ 即 v1 资源版本 ） ， 得到 objV1资源对象 ， 并通过断言的方式来验证是否转换成功 ， objV1 资源对象的 GVK 输出为 “ apps/v 1 ， Kind=Deployment \" 。\n在 converter Example 代码示例的第 2 部分中 ， 将 vlbetal 资源版本转换为内部版本 （ 即 internal 版本 ） ， 得到转换后资源对象的 GVK 为 “ / ， Kind= ” 。 在这里 ， 读者肯定会产生疑问 ， 为什么 vlbetal 资源版本转换为内部版本以后得到的 GVK 为 “ / ，Kind= ” 而不是 “ apps/__internal ， Kmd=Deployment ” 。 下面带着疑问来看看 Kubernetes源码实现 。 scheme 资源注册表可以通过两种方式进行版本转换 ， 分别介绍如下 。 scheme.ConvertToVersion ： 将传入的 (in) 资源对象转换成目标 （ target ）资源版本 ，在版本转换之前 ，会将资源对象深复制一份后再执行转换操作 ，相当于安全的内存对象转换操作 。与 scheme.ConvertToVersion 功能相同 ， scheme.UnsafeConvcrtToVersion ：但在转换过程中不会深复制资源对象 ， 而是直接对原资源对象进行转换操作 ， 尽可能高效地实现转换 。但该操作是非安全的内存对象转换操作 。 scheme.ConvertToVersion 与 scheme.UnsafeConveftToVersion 资源版本转换功能都依赖于 s.convertToVersion 函数来实现 ， Converter 转换器流程图如图\n1.获取传入的资源对象的反射类型 ​\t资源版本转换的类型可以是 runtime.ObJect 或 runtime.Unstructured ， 它们都属于Go 语言里的 struct 数据结构 ， 通过 Go 语言标准库 reflect 机制获取该资源类型的反射类型 ， 因为在 scheme 资源注册表中是以反射类型注册资源的 。 获取传入的资源对象的反射类型 。\n2.从资源注册表中查找到传入的资源对象的 GVK 从 scheme 资源注册表中查找到传入的资源对象的所有 GVK ， 验证传入的资源对象是否己经注册 ， 如果未曾注册 ， 则返回错误.\n3.从个 GVK 中选出与目标资源对象相匹配的 GVK ​\ttarget.KindForGroupVersionKinds 函数从多个可转换的 GVK 中选出与目标资源对象相匹配的 GVK 。 这里有一个优化点 ， 转换过程是相对耗时的 ， 大量的相同资源之间进行版本转换的耗时会比较长 。 在 Kubemetes 源码中判断 ， 如果目标资源对象的 GVK 在可转换的 G VK 列表中 ， 则直接将传入的资源对象的 G VK 设置为目标资源对象的 GVK ， 而无须执行转换操作 ， 缩短部分耗时 。\n4.判断传入的资源对象是否属于 Unversioned 类型 ​\t对于 Unversioned 类型 ， 前面曾介绍过 ， 即无版本类型 （ UnversionedType) 。 属于该类型的资源对象并不需要进行转换操作 ， 而是直接将传入的资源对象的 GVK 设置为目标资源对象的 GVK 。\n5.执行转换操作 在执行转换操作之前 ， 先判断是否需要对传入的资源对象执行深复制操作 ， 然后通过 s.converter.Convert 转换函数执行转换操作.\n​\t实际的转换函数是通过 doconversion 函数执行的 ， 执行过程如下 。\n从默认转换函数列表 （ 即 c.conversionFuncs ） 中查找出 pair 对应的转换函数 ， 如果存在则执行该转换函数 （ 即fn ） 并返回 。 从自动生成的转换函数列表 （ 即 generatedConversionFuncs ） 中查找出 pair 对应的转换函数 ， 如果存在则执行该转换函数 （ 即fn ） 并返回 。 如果默认转换函数列表和自动生成的转换函数列表中都不存在当前资源对象的转换函数 ， 则使用 doconversion 函数传入的转换函数 （ 即 f) 。 调用 f 之前 ， 需要将 s rc 与 dest 资源对象通过 EnforcePtr 函数取指针的值 ， 因为函数传入的转换函数接收的是非指针资源对象 。 6.设置转换后资源对象的 GVK ​\t在代码示例的第 2 部分中 ， 将 v1beta1 资源版本转换为内部版本 （ 即 internal 版本 ），得到转换后资源对象的 GVK 为 “ / ， Kind= ” 。 原因在于 setTargetKind 函数 ， 转换操作执行完成以后 ， 通过 setTargetKind 函数设置转换后资源对象的 GVK ， 判断当前资源对象是否为内部版本 （ 即 APIVersion1nternal) ， 是内部版本则设置 GVK 为 schema.GroupVersionKind{}\n","wordCount":"11761","inLanguage":"en","datePublished":"2024-05-20T00:00:00Z","dateModified":"2024-05-20T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%842/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.me/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.me/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.me/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.me/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.me/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.me/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.me/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.me/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.me/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.me/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.me/en/index.xml title=🪧RSS><span>🪧RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.me/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.me/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">k8s核心数据结构（2）</h1><div class=post-meta><span title='2024-05-20 00:00:00 +0000 UTC'>2024-05-20</span>&nbsp;·&nbsp;24 min&nbsp;·&nbsp;11761 words&nbsp;·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#k8s-%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%842 aria-label="K8s 核心数据结构（2）">K8s 核心数据结构（2）</a><ul><li><a href=#kubernetes-%e5%86%85%e7%bd%ae%e8%b5%84%e6%ba%90%e6%a6%82%e8%a7%88 aria-label="Kubernetes 内置资源概览">Kubernetes 内置资源概览</a></li><li><a href=#runtimeobject-%e7%b1%bb%e5%9e%8b%e5%9f%ba%e7%9f%b3 aria-label="runtime.Object 类型基石"><code>runtime.Object</code> 类型基石</a></li><li><a href=#unstructured%e6%95%b0%e6%8d%ae aria-label=Unstructured数据>Unstructured数据</a><ul><ul><li><a href=#1-%e7%bb%93%e6%9e%84%e5%8c%96%e6%95%b0%e6%8d%ae aria-label="1. 结构化数据">1. 结构化数据</a></li><li><a href=#2-%e9%9d%9e%e7%bb%93%e6%9e%84%e5%8c%96%e6%95%b0%e6%8d%ae aria-label="2. 非结构化数据">2. 非结构化数据</a></li><li><a href=#3-kubernetes-%e9%9d%9e%e7%bb%93%e6%9e%84%e5%8c%96%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86 aria-label="3. Kubernetes 非结构化数据处理">3. Kubernetes 非结构化数据处理</a></li></ul></ul></li><li><a href=#scheme-%e8%b5%84%e6%ba%90%e6%b3%a8%e5%86%8c%e8%a1%a8 aria-label="Scheme 资源注册表">Scheme 资源注册表</a><ul><li><a href=#schema-%e8%b5%84%e6%ba%90%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label="Schema 资源注册表数据结构">Schema 资源注册表数据结构</a></li><li><a href=#%e8%b5%84%e6%ba%90%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%b3%a8%e5%86%8c%e6%96%b9%e6%b3%95 aria-label=资源注册表注册方法>资源注册表注册方法</a></li><li><a href=#%e8%b5%84%e6%ba%90%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%9f%a5%e8%af%a2%e6%96%b9%e6%b3%95 aria-label=资源注册表查询方法>资源注册表查询方法</a></li></ul></li><li><a href=#codec-%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8 aria-label="Codec 编解码器">Codec 编解码器</a><ul><li><a href=#codec-%e7%bc%96%e8%a7%a3%e7%a0%81%e5%ae%9e%e4%be%8b%e5%8c%96 aria-label="Codec 编解码实例化">Codec 编解码实例化</a></li><li><a href=#jsonserializer-%e4%b8%8e-yamlserializer-%e5%ba%8f%e5%88%97%e5%8c%96%e5%99%a8 aria-label="jsonSerializer 与 yamlSerializer 序列化器">jsonSerializer 与 yamlSerializer 序列化器</a></li><li><a href=#protobufserializer-%e5%ba%8f%e5%88%97%e5%8c%96%e5%99%a8 aria-label="protobufSerializer 序列化器">protobufSerializer 序列化器</a><ul><li><a href=#1-%e5%ba%8f%e5%88%97%e5%8c%96%e6%93%8d%e4%bd%9c aria-label="1. 序列化操作">1. 序列化操作</a></li><li><a href=#2-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%93%8d%e4%bd%9c aria-label="2. 反序列化操作">2. 反序列化操作</a></li></ul></li></ul></li><li><a href=#converter-%e8%b5%84%e6%ba%90%e7%89%88%e6%9c%ac%e8%bd%ac%e6%8d%a2%e5%99%a8 aria-label="Converter 资源版本转换器">Converter 资源版本转换器</a><ul><li><a href=#converter-%e8%bd%ac%e6%8d%a2%e5%99%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label="Converter 转换器数据结构">Converter 转换器数据结构</a></li><li><a href=#converter-%e6%b3%a8%e5%86%8c%e8%bd%ac%e6%8d%a2%e5%87%bd%e6%95%b0 aria-label="Converter 注册转换函数">Converter 注册转换函数</a></li><li><a href=#converter-%e8%b5%84%e6%ba%90%e7%89%88%e6%9c%ac%e8%bd%ac%e6%8d%a2%e5%8e%9f%e7%90%86 aria-label="Converter 资源版本转换原理">Converter 资源版本转换原理</a><ul><li><a href=#1%e8%8e%b7%e5%8f%96%e4%bc%a0%e5%85%a5%e7%9a%84%e8%b5%84%e6%ba%90%e5%af%b9%e8%b1%a1%e7%9a%84%e5%8f%8d%e5%b0%84%e7%b1%bb%e5%9e%8b aria-label=1.获取传入的资源对象的反射类型>1.获取传入的资源对象的反射类型</a></li><li><a href=#2%e4%bb%8e%e8%b5%84%e6%ba%90%e6%b3%a8%e5%86%8c%e8%a1%a8%e4%b8%ad%e6%9f%a5%e6%89%be%e5%88%b0%e4%bc%a0%e5%85%a5%e7%9a%84%e8%b5%84%e6%ba%90%e5%af%b9%e8%b1%a1%e7%9a%84-gvk aria-label="2.从资源注册表中查找到传入的资源对象的 GVK">2.从资源注册表中查找到传入的资源对象的 GVK</a></li><li><a href=#3%e4%bb%8e%e4%b8%aa-gvk-%e4%b8%ad%e9%80%89%e5%87%ba%e4%b8%8e%e7%9b%ae%e6%a0%87%e8%b5%84%e6%ba%90%e5%af%b9%e8%b1%a1%e7%9b%b8%e5%8c%b9%e9%85%8d%e7%9a%84-gvk aria-label="3.从个 GVK 中选出与目标资源对象相匹配的 GVK">3.从个 GVK 中选出与目标资源对象相匹配的 GVK</a></li><li><a href=#4%e5%88%a4%e6%96%ad%e4%bc%a0%e5%85%a5%e7%9a%84%e8%b5%84%e6%ba%90%e5%af%b9%e8%b1%a1%e6%98%af%e5%90%a6%e5%b1%9e%e4%ba%8e-unversioned-%e7%b1%bb%e5%9e%8b aria-label="4.判断传入的资源对象是否属于 Unversioned 类型">4.判断传入的资源对象是否属于 Unversioned 类型</a></li><li><a href=#5%e6%89%a7%e8%a1%8c%e8%bd%ac%e6%8d%a2%e6%93%8d%e4%bd%9c aria-label=5.执行转换操作>5.执行转换操作</a></li><li><a href=#6%e8%ae%be%e7%bd%ae%e8%bd%ac%e6%8d%a2%e5%90%8e%e8%b5%84%e6%ba%90%e5%af%b9%e8%b1%a1%e7%9a%84-gvk aria-label="6.设置转换后资源对象的 GVK">6.设置转换后资源对象的 GVK</a></li></ul></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=k8s-核心数据结构2>K8s 核心数据结构（2）<a hidden class=anchor aria-hidden=true href=#k8s-核心数据结构2>#</a></h1><blockquote><p>参考书籍：《Kubernetes源码剖析-郑旭东著》</p></blockquote><h2 id=kubernetes-内置资源概览>Kubernetes 内置资源概览<a hidden class=anchor aria-hidden=true href=#kubernetes-内置资源概览>#</a></h2><table><thead><tr><th>资源组</th><th>资源种类</th><th>说明</th></tr></thead><tbody><tr><td>apiextensions.k8s.io</td><td>CustomResourceDefinition</td><td>自定义资源类型 ， 由 APIExtensions Server 负责管理该资源类型</td></tr><tr><td>apiregistration.k8s.io</td><td>APIService</td><td>聚合资源类型，由 AggregatorServer 负责管理该资源类</td></tr><tr><td>admissionregistration.k8s.io</td><td>MutatingWebhookConfiguration</td><td>变更准入控制器资源类型( Webhook)</td></tr><tr><td></td><td>ValidatingWebhookConfiguration</td><td>验证准入控制器资源类型 ( Webhook)</td></tr><tr><td>apps</td><td>ControllerRevision</td><td>记录资源对象所有的历史版本的资源类型</td></tr><tr><td></td><td>DaemonSet</td><td>在 Pod 资源对象的基础上提供守护进程的资源类型</td></tr><tr><td></td><td>Deployment</td><td>在 Pod资源对象的基础上提供支持无状态服务的资源类型</td></tr><tr><td></td><td>ReplicaSet</td><td>在 Pod 资源对象的基础上提供一组 Pod 副本的资源类型</td></tr><tr><td></td><td>StatefulSet</td><td>在 Pod资源对象的基础上提供支持有状态服务的资源类型</td></tr><tr><td>auditregistration.k8s.io</td><td>AuditSink</td><td>审计资源类型</td></tr><tr><td>authentication.k8s.io</td><td>TokenReview</td><td>认证资源类型</td></tr><tr><td>authorization.k8s.io</td><td>LocalSubjectAccessReview</td><td>授权检查用户是否可以在指定的命名空间中执行操作</td></tr><tr><td></td><td>SelfSubjectAccessReview</td><td>授权检查用户是否可以执行操作(若不指定 spec.namespace，则在所有的命名空间中执行操作）</td></tr><tr><td></td><td>SelfSubjectRulesReview</td><td>授权枚举用户可以在指定的命名空间中执行一组操作</td></tr><tr><td></td><td>SubjectAccessReview</td><td>授 权检查用户是否可以执行操作</td></tr><tr><td>autoscaling</td><td>HorizontalPodAutoscaler</td><td>在 Pod 资源对象的基础上提供水平自动伸缩资源类型</td></tr><tr><td>batch</td><td>Job</td><td>提供一次性任务的资源类型</td></tr><tr><td></td><td>CronJob</td><td>提供定时任务的资源类型</td></tr><tr><td>certificates.k8s.io</td><td>CertificateSigningRequest</td><td>提供证书管理的资源类型</td></tr><tr><td>coordination.k8s.io</td><td>Leases</td><td>提供领导者选举机制的资源类型</td></tr><tr><td>core</td><td>ComponentStatus</td><td>该资源类型已被奔用，其用于提供获取 Kuberetes 组件运行状况的资源类型</td></tr><tr><td></td><td>ConfigMap</td><td>提供容器内应用程序配置管理的资源类型</td></tr><tr><td></td><td>Endpoints</td><td>提供将外部服务器映射为内部服务的资源类型</td></tr><tr><td></td><td>Event</td><td>提供 Kubernetes 集群事件管理的资源类型</td></tr><tr><td></td><td>LimitRange</td><td>为命名空间中的每种资源对象设置资源(硬件资源)使 用限制</td></tr><tr><td></td><td>Namespace</td><td>提供资源对象所在的命名空间的资源类型</td></tr><tr><td></td><td>Node</td><td>提供 Kubernetes 集群中管理工作节点的资源类型。每个节点都有一个唯一标识符</td></tr><tr><td></td><td>PersistentVolume</td><td>提供 PV 存储的资源类型</td></tr><tr><td></td><td>PersistentVolumeClaim</td><td>提供 PVC 存储的资源类型</td></tr><tr><td></td><td>Pod</td><td>提供容器集合管理的资源类型</td></tr><tr><td></td><td>PodTemplate</td><td>提供用于描述预定义 Pod 资源对象副本数模板的资源类型</td></tr><tr><td></td><td>ReplicationController</td><td>在 Pod资源对象的基础上提供副本数保持不变的资源类型</td></tr><tr><td></td><td>ResourceQuota</td><td>提供每个命名空间配额限制的资源类型</td></tr><tr><td></td><td>Secret</td><td>提供存储密码 、Token 、密钥等敏感数据的资源类型</td></tr><tr><td></td><td>Service</td><td>提供负载均衡器为 Pod 资源对象的代理服务的资源类型</td></tr><tr><td></td><td>ServiceAccount</td><td>提供 ServiceAccount 认证的资源类型</td></tr><tr><td>events.k8s.io</td><td>Event</td><td>提供Kuberetes集群事件管理的资源类型</td></tr><tr><td>networking.k8s.io</td><td>RuntimeClass</td><td>提供容器运行时功能的资源类型</td></tr><tr><td></td><td>Ingress</td><td>提供 从Kubernetes 集群外部访问集群内部服务管理的资源类型</td></tr><tr><td>node.k8s.io</td><td>RuntimeClass</td><td>提供容器运行时功能的资源类型</td></tr><tr><td>policy</td><td>Evictions</td><td>在 Pod 资源对象的基础上提供驱逐策略的资源类型</td></tr><tr><td></td><td>PodDisruptionBudget</td><td>提供限制同时中断 Pod 的数量 ，以保证集群的高可用性</td></tr><tr><td></td><td>PodSecurityPolicy</td><td>提供控制 Pod 资源安全相关策略的资源类型</td></tr><tr><td>rbac.authorization.k8s.io</td><td>ClusterRole</td><td>提供 RBAC 集群角色的资源类型</td></tr><tr><td></td><td>ClusterRoleBinding</td><td>提供 RBAC 集群角色鄉定的资源类型</td></tr><tr><td></td><td>Role</td><td>提供 RBAC 角色的资源类型</td></tr><tr><td></td><td>RoleBinding</td><td>提供 RBAC 角色绑定的资源类型</td></tr><tr><td>scheduling.k8s.io</td><td>PriorityClass</td><td>提供 Pod 资源对象优先级管理的资源类型</td></tr><tr><td>settings.k8s.10</td><td>PodPreset</td><td>在创建 Pod 资源对象时，可以将特定信息注入 Pod 资源对象中</td></tr><tr><td>storage.k8s.io</td><td>StorageClass</td><td>提供动态设置PV存储参数的资源类</td></tr><tr><td></td><td>VolumeAttachment</td><td>供触发 CSI ControllerPublish 和 ControllerUnpublish 操作的资源类型</td></tr></tbody></table><h2 id=runtimeobject-类型基石><code>runtime.Object</code> 类型基石<a hidden class=anchor aria-hidden=true href=#runtimeobject-类型基石>#</a></h2><p>​ <code>runtime.Object</code> 是Kubernetes 类型系统的基石。Kubernetes 上的所有资源对象 ( Resource 0bject ) 实际上就是一种 Go 语言的 Struct 类型 ， 相当于一种数据结构 ，它们都有一个共同的结构叫<code>runtime.Object</code>。<code>runtime.Object</code> 被设计为 Interface 接口类型， 作为资源对象的通用资源对象，<code>runtime.Obejct</code> 类型基石如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230418174437181.png alt=image-20230418174437181></p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 对象接口必须被在 Scheme 注册的所有 API 类型支持。由于方案中的对象是
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 预期被序列化到线路，对象必须提供给 Scheme 的接口允许
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 用于设置对象表示的种类、版本和组的序列化程序。对象可以选择
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 在不希望序列化的情况下返回无操作 ObjectKindAccessor。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Object <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>() schema.ObjectKind
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>DeepCopyObject</span>() Object
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> ObjectKind <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// should clear the current setting.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>SetGroupVersionKind</span>(kind GroupVersionKind)
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// GroupVersionKind returns the stored group, version, and kind of an object, or an empty struct
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// if the object does not expose or provide these fields.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>() GroupVersionKind
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>runtime.Object 提供了两个方法 ，分别是 GetObjectKind 和 DeepCopyObject。</p><ul><li><p>GetObjectKind : 用于设置并返回 GroupVersionKind。</p></li><li><p>DeepCopyObject: 用于深复制当前资源对象并返回 。</p><p>深复制相当于将数据结构克隆一份，因此它不与原始对象共享任何内容。它使代码在不修改原始对象的情况下可以改变克隆对象的任何属性。</p></li></ul><p>那么，如何确认一个资源对象是否可以转换成runtime.Object 通用资源对象呢?</p><p>这时需要确认该资源对象是否拥有 GetobjectKind 和 DeepCopyobjeot 方法。Kubernetes 的每一个资源对象都嵌入了metav1.TypeMeta 类型，metav1.TypeMeta 类型实现了GetObjectkind 方法，所以资源对象拥有该方法。 另外，Kubernetes 的每一 个资源对象都实现了 DeepCopyobject 方法，该方法一般被定义在 <code>zz_generated.deepcopy.go</code> 文件中。因此，可以认为该资源对象能够转换成 runtime.Object 通用资源对象。</p><p>​ 所以，Kubernetes 的任意资源对象都可以通过 runtime.Object 存储它的类型并允许深复制操作。通过 runtime.Object Example 代码示例，可以将资源对象转换成通用资源对象并再次转换回资源对象。runtime.Object Example 代码示例如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	metav1 <span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/kubernetes/pkg/apis/core&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	pod <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>core.Pod{
</span></span><span style=display:flex><span>		TypeMeta: metav1.TypeMeta{
</span></span><span style=display:flex><span>			Kind: <span style=color:#a5d6ff>&#34;Pod&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		ObjectMeta: metav1.ObjectMeta{
</span></span><span style=display:flex><span>			Labels: <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;name&#34;</span>: <span style=color:#a5d6ff>&#34;foo&#34;</span>},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	obj <span style=color:#ff7b72;font-weight:700>:=</span> runtime.<span style=color:#d2a8ff;font-weight:700>Object</span>(pod)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	pod2, ok <span style=color:#ff7b72;font-weight:700>:=</span> obj.(<span style=color:#ff7b72;font-weight:700>*</span>core.Pod)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> !ok {
</span></span><span style=display:flex><span>		panic(<span style=color:#a5d6ff>&#34;unexpected&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> !reflect.<span style=color:#d2a8ff;font-weight:700>DeepEqual</span>(pod, pod2) {
</span></span><span style=display:flex><span>		panic(<span style=color:#a5d6ff>&#34;unexpected&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在以上代码示例中，首先实例化 Pod 资源, 得到 Pod 资源对象, 通过 <code>runtime.object</code> 将 Pod 资源对象转换成通用资源对象(得到 obj )。然后通过断言的方式，将obj 通用资源对象转换成 Pod 资源对象(得到 pod2 )。最终通过 reflect (反射，来验证转换之前和转换之后的资源对象是否相等。</p><h2 id=unstructured数据>Unstructured数据<a hidden class=anchor aria-hidden=true href=#unstructured数据>#</a></h2><p>​ 数据可以分为结构化数据 (StructuredData )和非结构化数据 ( Unstructured Data ) 。 Kubernetes 内部会经常处理这两种数据。</p><h4 id=1-结构化数据>1. 结构化数据<a hidden class=anchor aria-hidden=true href=#1-结构化数据>#</a></h4><pre><code>预先知道数据结构的数据类型是结构化数据。例如，JSON 数据:
</code></pre><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;id&#34;</span>: <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;name&#34;</span>: <span style=color:#a5d6ff>&#34;Derek&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>要使用这种数据，需要创建一个struct 数据结构，其具有id 和name 属性:</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> Student <span style=color:#ff7b72>struct</span>{
</span></span><span style=display:flex><span>  ID <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>  Name <span style=color:#ff7b72>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=2-非结构化数据>2. 非结构化数据<a hidden class=anchor aria-hidden=true href=#2-非结构化数据>#</a></h4><p>​ 无法预知数据结构的数据类型或属性名称不确定的数据类型是非结构化数据， 其无法通过构建预定的struct 数据结构来序列化或反序列化数据。例如</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&#34;id&#34;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&#34;name&#34;</span>: <span style=color:#a5d6ff>&#34;Derek&#34;</span>, 
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;description&#34;</span>: <span style=color:#f85149>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 我们无法事先得知description 的数据类型，它可能是字符串，也可能是数组嵌套等。原因在于Go 语言是强类型语言，它需要预先知道数据类型，Go 语言在处理JSON 数据时 不如动态语言那样便捷。 当无法预知数据结构的数据类型或属性名称不确定时，通过如 下结构来解决问题</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>var</span> result <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>interface</span>{}
</span></span></code></pre></td></tr></table></div></div><p>​ 每个字符串对应一 JSON 属性，其映射 interface{} 类型对应值 ，可以是任何类型。使用 interface 字段时，通过 Go 语言断言的方式进行类型转换:</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>if</span> description, ok <span style=color:#ff7b72;font-weight:700>:=</span> result[<span style=color:#a5d6ff>&#34;description&#34;</span>].(<span style=color:#ff7b72>string</span>);ok{
</span></span><span style=display:flex><span>  fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(description)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=3-kubernetes-非结构化数据处理>3. Kubernetes 非结构化数据处理<a hidden class=anchor aria-hidden=true href=#3-kubernetes-非结构化数据处理>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// staging/src/k8s.io/apimachinery/pkg/runtime/interfaces.go
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Unstructured objects store values as map[string]interface{}, with only values that can be serialized
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// to JSON allowed.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Unstructured <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	Object
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// NewEmptyInstance returns a new instance of the concrete type containing only kind/apiVersion and no other data.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// This should be called instead of reflect.New() for unstructured types because the go type alone does not preserve kind/apiVersion info.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>NewEmptyInstance</span>() Unstructured
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// UnstructuredContent returns a non-nil map with this object&#39;s contents. Values may be
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// []interface{}, map[string]interface{}, or any primitive type. Contents are typically serialized to
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// and from JSON. SetUnstructuredContent should be used to mutate the contents.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>UnstructuredContent</span>() <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// SetUnstructuredContent updates the object content to match the provided map.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>SetUnstructuredContent</span>(<span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// IsList returns true if this type is a list or matches the list convention - has an array called &#34;items&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>IsList</span>() <span style=color:#ff7b72>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// EachListItem should pass a single item out of the list as an Object to the provided function. Any
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// error should terminate the iteration. If IsList() returns false, this method should return an error
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// instead of calling the provided function.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#d2a8ff;font-weight:700>EachListItem</span>(<span style=color:#ff7b72>func</span>(Object) <span style=color:#ff7b72>error</span>) <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// staging/src/k8s.io/apimachinery/pkg/apis/meta/v1/unstructured/unstructured.go
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Unstructured <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// Object is a JSON compatible map with string, float, int, bool, []interface{}, or
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// map[string]interface{}
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// children.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	Object <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在上述代码中，Kubernetes 非结构化数据通过 map[string]interface{} 表达，并提供接口。在 client-go 编程式交互的 DynamicClient 内部，实现了 Unstructured 类型， 用于处理非结构化数据。</p><h2 id=scheme-资源注册表>Scheme 资源注册表<a hidden class=anchor aria-hidden=true href=#scheme-资源注册表>#</a></h2><p>​ 大家在使用Windows 操作系统时都应该听说过， 当在操作系统上安装应用程序 时， 该程序 的一些信息会注册到注册表中; 当从操作系统 上卸载应用程序时， 会从 注册表中删除该程序的相关信息。而 KubernetesScheme 资源注册表类似于Windows 操作系统上的注册表，只不过注册的是资源类型。</p><p>​ Kuberetes 系统拥有众多资源，每一种资源就是一个资源类型，这些资源类型需要有统一的注册 、 存储 、 查询 、 管理等机制 。目前 Kuberetes 系统中的所有资源类型都已注册到 Scheme 资源注册表中，其是 一个内存型的资源注册表，拥有如下特点。</p><ul><li>支持注册多种资源类型，包括内部版本和外部版本。</li><li>支持多种版 本转换机制。</li><li>支持不同资源的序列化/反序列化机制。</li></ul><p>​ Scheme 资源注册表支持两种资源类型( Type )的注册，分别是 UnversionedType 和KnownType 资源类型，分别介绍如下</p><ul><li>UnversionedType: 无版本资源类型，这是一个早期 Kubernetes 系统中的概 念， 它主要应用于某些没有版本的资源类型，该类型的资源对象并不需要进行转换。在目前的 Kubernetes 发行版本中，无版本类型已被弱化，几乎所有的资源对象都拥有版本， 但在 metav1 元数据中还有部分类型 ，它们既属于 meta.k8s.io/v1 又属于 UnversionedType 无版本资源类型，例如 metav1.Status, metav1.APIVersions、metav1.APIGroupList、metavI.APIGroup、metav1.APIResourceList.</li><li>KnownType: 是目前Kubernetes 最常用的资源类型，也可称其为“ 拥有版本的资源类型”</li></ul><h3 id=schema-资源注册表数据结构>Schema 资源注册表数据结构<a hidden class=anchor aria-hidden=true href=#schema-资源注册表数据结构>#</a></h3><p>​ Scheme资源注册表数据结构主要由4 个map结构组成，它们分别是. gvkToType、typeToGVK、unversionedTypes、unversionedKinds.</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>eme <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// gvkToType allows one to figure out the go type of an object with
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// the given version and name.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	gvkToType <span style=color:#ff7b72>map</span>[schema.GroupVersionKind]reflect.Type
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// typeToGVK allows one to find metadata for a given go object.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// The reflect.Type we index by should *not* be a pointer.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	typeToGVK <span style=color:#ff7b72>map</span>[reflect.Type][]schema.GroupVersionKind
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// unversionedTypes are transformed without conversion in ConvertToVersion.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	unversionedTypes <span style=color:#ff7b72>map</span>[reflect.Type]schema.GroupVersionKind
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// unversionedKinds are the names of kinds that can be created in the context of any group
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// or version
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// TODO: resolve the status of unversioned types.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	unversionedKinds <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]reflect.Type
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ Scheme 资源注册表结构字段说明如下。</p><ul><li><p>gVkToType: 存储 GVK 与 Type 的映射关系。</p></li><li><p>typeToGVK: 存储 Type 与 GVK 的映射关系,一个 Type 会对应一个或多个 GVK。</p></li><li><p>unversionedTypes: 存储 UnversionedType 与 GVK 的映射关系。</p></li><li><p>unversionedKinds: 存储 Kind (资源种类)名称与UnversionedType 的映射关系。</p><p>Scheme 资源注册表通过Go 语言的map结构实现映射关系，这些映射关系可以 实现高效的正向和反向检索，从 Scheme 资源注册表中检索某个 GVK 的Type， 它的时间复杂度为O（1）。</p></li></ul><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420143016157.png alt=image-20230420143016157></p><p>​ Scheme 资源注册表在 Kubernetes 系统体系中属于非常核心的数据结构。示例代码：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	appsv1 <span style=color:#a5d6ff>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span style=display:flex><span>	corev1 <span style=color:#a5d6ff>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style=display:flex><span>	metav1 <span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// KnownType external
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	coreGV <span style=color:#ff7b72;font-weight:700>:=</span> schema.GroupVersion{Group: <span style=color:#a5d6ff>&#34;&#34;</span>, Version: <span style=color:#a5d6ff>&#34;v1&#34;</span>}
</span></span><span style=display:flex><span>	extensionsGV <span style=color:#ff7b72;font-weight:700>:=</span> schema.GroupVersion{Group: <span style=color:#a5d6ff>&#34;extensions&#34;</span>, Version: <span style=color:#a5d6ff>&#34;v1beta1&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// KnownType internal
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	coreInternalGV <span style=color:#ff7b72;font-weight:700>:=</span> schema.GroupVersion{Group: <span style=color:#a5d6ff>&#34;&#34;</span>, Version: runtime.APIVersionInternal}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// UnversionedType
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	Unversioned <span style=color:#ff7b72;font-weight:700>:=</span> schema.GroupVersion{Group: <span style=color:#a5d6ff>&#34;&#34;</span>, Version: <span style=color:#a5d6ff>&#34;v1&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	scheme <span style=color:#ff7b72;font-weight:700>:=</span> runtime.<span style=color:#d2a8ff;font-weight:700>NewScheme</span>()
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(coreGV, <span style=color:#ff7b72;font-weight:700>&amp;</span>corev1.Pod{})
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(extensionsGV, <span style=color:#ff7b72;font-weight:700>&amp;</span>appsv1.DaemonSet{})
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(coreInternalGV, <span style=color:#ff7b72;font-weight:700>&amp;</span>corev1.Pod{})
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddUnversionedTypes</span>(Unversioned, <span style=color:#ff7b72;font-weight:700>&amp;</span>metav1.Status{})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ 在上述代码中，首先定义了两种类型的GV( 资源组、资源版本)，KnownType 类型有 coreGV、extensionsGV、coreInternalGV 对象，其中 corelnternalGV 对象属于内部版本(即runtime.APIVersioninternal )，而 UnversionedType 类型有 Unversioned 对象。
​ 通过 runtime.NewScheme 实例化一个新的Scheme资源注册表。注册资源类型到 Scheme 资源注册表有两种方式，第一种通过scheme.AddKnownTypes 方法注册 KnownType 类型的对象，第二种通过 scheme. AddUnversionedTypes 方法注册 UnversionedType 类型的对象。</p><p>​ 在 Scheme Example 代码示例中，我们往 Scheme 资源注册表中分别注册了Pod、 DaemonSet、Pod ( 内部版本)及 Status (无版本资源类型)类型对象，那么这些资源的映射关系，如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420144147025.png alt=image-20230420144147025></p><p>​ GVK(资源组、资源版本、资源种类)在Scheme资源注册表中以<code>&lt;group>/&lt;version>, Kind =&lt;kind></code>的形式存在，其中对于 Kind ( 资源种类)字段，在注册时如果不指定该 字段的名称，那么默认使用类型的名称，例如corev1.Pod 类型，通过reflect 机制获 取资源类型的名称，那么它的资源种类 Kind-Pod。
​ 资源类型在Scheme 资源注册表中以 Go Type (通过 reflect 机制获取)形式存在。</p><p>​ 另外， 需要注意的是，UnversionedType 类型的对象在通过 scheme.AddUnversionedTypes 方法注册时，会同时存在于4个map 结构中，代码示例如</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/* 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>AddUnversionedTypes 将提供的类型注册为“未版本化”，这意味着它们遵循特殊规则。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>每当序列化此类型的对象时，它都会使用提供的组版本进行序列化，而不是
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>转换。因此，未版本化的对象应该永远保持向后兼容，就好像它们在一个永远不会更新的 API 组和版本。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Scheme) <span style=color:#d2a8ff;font-weight:700>AddUnversionedTypes</span>(version schema.GroupVersion, types <span style=color:#ff7b72;font-weight:700>...</span>Object) {
</span></span><span style=display:flex><span>	s.<span style=color:#d2a8ff;font-weight:700>addObservedVersion</span>(version)
</span></span><span style=display:flex><span>	s.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(version, types<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> _, obj <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> types {
</span></span><span style=display:flex><span>		t <span style=color:#ff7b72;font-weight:700>:=</span> reflect.<span style=color:#d2a8ff;font-weight:700>TypeOf</span>(obj).<span style=color:#d2a8ff;font-weight:700>Elem</span>()
</span></span><span style=display:flex><span>		gvk <span style=color:#ff7b72;font-weight:700>:=</span> version.<span style=color:#d2a8ff;font-weight:700>WithKind</span>(t.<span style=color:#d2a8ff;font-weight:700>Name</span>())
</span></span><span style=display:flex><span>		s.unversionedTypes[t] = gvk
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> old, ok <span style=color:#ff7b72;font-weight:700>:=</span> s.unversionedKinds[gvk.Kind]; ok <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> t <span style=color:#ff7b72;font-weight:700>!=</span> old {
</span></span><span style=display:flex><span>			panic(fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;%v.%v has already been registered as unversioned kind %q - kind name must be unique in scheme %q&#34;</span>, old.<span style=color:#d2a8ff;font-weight:700>PkgPath</span>(), old.<span style=color:#d2a8ff;font-weight:700>Name</span>(), gvk, s.schemeName))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		s.unversionedKinds[gvk.Kind] = t
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=资源注册表注册方法>资源注册表注册方法<a hidden class=anchor aria-hidden=true href=#资源注册表注册方法>#</a></h3><p>​ 在Scheme 资源 注册表中，不同的资源类型使用的注册方法不同，分别介绍如下。</p><ul><li>scheme. AddUnversionedTypes: 注册 UnversionedType 资源类型。</li><li>scheme. AddKnownTypes: 注册 KnownType 资源类型。</li><li>scheme. AddKnownTypewithName: 注册KnownType 资源类型，须指定资源的 Kind 资源种类名</li></ul><p>​ 以 scheme. AddKnownTypes 方法为例，在注册资源类型时，无须指定 Kind 名称， 而是通过 reflect 机制获取资源类型的名称作为资源种类名称，代码示例如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> AddKnownTypes 将“types”中传递的所有类型注册为版本“version”的成员。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> 传递给类型的所有对象都应该是指向结构的指针。去报道的名字
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> 该结构在编码时成为“种类”字段。版本不能为空 - 使用
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> APIVersionInternal 常数，如果你有一个没有正式版本的类型
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Scheme) <span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(gv schema.GroupVersion, types <span style=color:#ff7b72;font-weight:700>...</span>Object) {
</span></span><span style=display:flex><span>	s.<span style=color:#d2a8ff;font-weight:700>addObservedVersion</span>(gv)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> _, obj <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> types {
</span></span><span style=display:flex><span>		t <span style=color:#ff7b72;font-weight:700>:=</span> reflect.<span style=color:#d2a8ff;font-weight:700>TypeOf</span>(obj)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> t.<span style=color:#d2a8ff;font-weight:700>Kind</span>() <span style=color:#ff7b72;font-weight:700>!=</span> reflect.Pointer {
</span></span><span style=display:flex><span>			panic(<span style=color:#a5d6ff>&#34;All types must be pointers to structs.&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		t = t.<span style=color:#d2a8ff;font-weight:700>Elem</span>()
</span></span><span style=display:flex><span>		s.<span style=color:#d2a8ff;font-weight:700>AddKnownTypeWithName</span>(gv.<span style=color:#d2a8ff;font-weight:700>WithKind</span>(t.<span style=color:#d2a8ff;font-weight:700>Name</span>()), obj)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=资源注册表查询方法>资源注册表查询方法<a hidden class=anchor aria-hidden=true href=#资源注册表查询方法>#</a></h3><p>​ 在运行过程中，kube-apiserver 组件常对 Scheme 资源注册表进行查询，它提供了如下方法。</p><ul><li>scheme.KnownTypes: 查询注册表中指定GV 下的资源类型。</li><li>scheme. AlKnownTypes: 查询注册表中所有GVK 下的资源类型。</li><li>scheme.ObjectKinds: 查询资源对象所对应的GVK， 一个资源对象可能存在多个GVK。</li><li>scheme.New: 查询GVK 所对应的资源对象。</li><li>scheme.IsGroupRegistered: 判断指定的资源组是否已经注册。</li><li>scheme.IsVersionRegistered : 判断指定的 G V 是否己经注册。</li><li>scheme.Recognizes: 判断指定的GVK 是否己经注册。</li><li>scheme.IsUnversioned: 判断指定的资源对象是否属于 UnversionedType 类型。</li></ul><h2 id=codec-编解码器>Codec 编解码器<a hidden class=anchor aria-hidden=true href=#codec-编解码器>#</a></h2><p>​ 在详解 Codec 编解码器之前，先认识下 Codec 编解码器与 Serializer 序列化器之间的差异。</p><ul><li><p>Serializer: 序列化器，包含序列化操作与反序列化操作。序列化操作是将数据 (例如数组 、对象或结构体等 ) 转换为宇符串的过程 ， 反序列化操作是将字符串转换为数据的过程，因此可以轻松地维护数据结构 并存储或传输数据</p></li><li><p>Codee: 编解码器，包含编码器与解码器。编解码器是一个通用术语，指的是可以表示数据的任何格式，或者将数据转换为特定格式的过程。所以，可以将 Serializer 序列化器也理解为 Codec 编解码器的一种 。</p><p>Codec 编解码器通用接又定义如下:</p></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> Decoder <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>Decode</span>(data []<span style=color:#ff7b72>byte</span>, defaults <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, into Object) (Object, <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, <span style=color:#ff7b72>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> Encoder <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>Encode</span>(obj Object, w io.Writer) <span style=color:#ff7b72>error</span>
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>Identifier</span>() Identifier
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> Serializer <span style=color:#ff7b72>interface</span> {
</span></span><span style=display:flex><span>	Encoder
</span></span><span style=display:flex><span>	Decoder
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Codec is a Serializer that deals with the details of versioning objects. It offers the same
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// interface as Serializer, so this is a marker to consumers that care about the version of the objects
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// they receive.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Codec Serializer
</span></span></code></pre></td></tr></table></div></div><p>​ 从Codec 编解码器通用接又的定义可以看出，Serializer 序列化器属于Codec 编解码器的一种，这是因为每种序列化器都实现了Encoder 与 Decoder 方法。我们可以认为，只要实现了Encoder 与Decoder 方法的数据结构，就是序列化器。Kubernetes 目前支持 3 种主要的序列化器。Codec 编解码器如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420151842029.png alt=image-20230420151842029></p><p>​ Codec 编解码器包含了种序列化器 ， 在进行编解码操作时 ，每一种序列化器都对资源对象的 metav1.TypeMeta (即 APIVersion 和Kind 字段)进行验证，如果资源对象未提供这些字段，就会返回错误。每种序列化器分别实现了 Encode 序列化方法与 Decode 反序列化方法 ，分别介绍如下</p><ul><li><strong>jsonSerializer</strong>: JSON 格式序列化/反序列化器。它使用 <code>application/json</code>的 ContentType 作为标识</li><li><strong>yamlSerializer</strong>: YAML 格式化格式序列化/反序列化器。它使用 <code>application/yaml</code>的 ContentType 作为标识</li><li><strong>protobufSerializer</strong>： Protobuf 格式化格式序列化/反序列化器。它使用 <code>application/vnd.kubernetes.protobuf</code>的 ContentType 作为标识</li></ul><p>Codec 编解码器将 Eted 集群中的数据进行编解码操作。</p><h3 id=codec-编解码实例化>Codec 编解码实例化<a hidden class=anchor aria-hidden=true href=#codec-编解码实例化>#</a></h3><p>​ Codec 编码器通过 NewCodecFactory 函数实例化，在实例化的过程中会将 jsonSerializer、yamlSerializer、protobufSerializer 序列化器全部实例化，NewCodecFactory -> newSerializersForScheme ，示例代码如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>newSerializersForScheme</span>(scheme <span style=color:#ff7b72;font-weight:700>*</span>runtime.Scheme, mf json.MetaFactory, options CodecFactoryOptions) []serializerType {
</span></span><span style=display:flex><span>	jsonSerializer <span style=color:#ff7b72;font-weight:700>:=</span> json.<span style=color:#d2a8ff;font-weight:700>NewSerializerWithOptions</span>(
</span></span><span style=display:flex><span>		mf, scheme, scheme,
</span></span><span style=display:flex><span>		json.SerializerOptions{Yaml: <span style=color:#79c0ff>false</span>, Pretty: <span style=color:#79c0ff>false</span>, Strict: options.Strict},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	jsonSerializerType <span style=color:#ff7b72;font-weight:700>:=</span> serializerType{
</span></span><span style=display:flex><span>		AcceptContentTypes: []<span style=color:#ff7b72>string</span>{runtime.ContentTypeJSON},
</span></span><span style=display:flex><span>		ContentType:        runtime.ContentTypeJSON,
</span></span><span style=display:flex><span>		FileExtensions:     []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;json&#34;</span>},
</span></span><span style=display:flex><span>		EncodesAsText:      <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>		Serializer:         jsonSerializer,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		Framer:           json.Framer,
</span></span><span style=display:flex><span>		StreamSerializer: jsonSerializer,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> options.Pretty {
</span></span><span style=display:flex><span>		jsonSerializerType.PrettySerializer = json.<span style=color:#d2a8ff;font-weight:700>NewSerializerWithOptions</span>(
</span></span><span style=display:flex><span>			mf, scheme, scheme,
</span></span><span style=display:flex><span>			json.SerializerOptions{Yaml: <span style=color:#79c0ff>false</span>, Pretty: <span style=color:#79c0ff>true</span>, Strict: options.Strict},
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	strictJSONSerializer <span style=color:#ff7b72;font-weight:700>:=</span> json.<span style=color:#d2a8ff;font-weight:700>NewSerializerWithOptions</span>(
</span></span><span style=display:flex><span>		mf, scheme, scheme,
</span></span><span style=display:flex><span>		json.SerializerOptions{Yaml: <span style=color:#79c0ff>false</span>, Pretty: <span style=color:#79c0ff>false</span>, Strict: <span style=color:#79c0ff>true</span>},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	jsonSerializerType.StrictSerializer = strictJSONSerializer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	yamlSerializer <span style=color:#ff7b72;font-weight:700>:=</span> json.<span style=color:#d2a8ff;font-weight:700>NewSerializerWithOptions</span>(
</span></span><span style=display:flex><span>		mf, scheme, scheme,
</span></span><span style=display:flex><span>		json.SerializerOptions{Yaml: <span style=color:#79c0ff>true</span>, Pretty: <span style=color:#79c0ff>false</span>, Strict: options.Strict},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	strictYAMLSerializer <span style=color:#ff7b72;font-weight:700>:=</span> json.<span style=color:#d2a8ff;font-weight:700>NewSerializerWithOptions</span>(
</span></span><span style=display:flex><span>		mf, scheme, scheme,
</span></span><span style=display:flex><span>		json.SerializerOptions{Yaml: <span style=color:#79c0ff>true</span>, Pretty: <span style=color:#79c0ff>false</span>, Strict: <span style=color:#79c0ff>true</span>},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	protoSerializer <span style=color:#ff7b72;font-weight:700>:=</span> protobuf.<span style=color:#d2a8ff;font-weight:700>NewSerializer</span>(scheme, scheme)
</span></span><span style=display:flex><span>	protoRawSerializer <span style=color:#ff7b72;font-weight:700>:=</span> protobuf.<span style=color:#d2a8ff;font-weight:700>NewRawSerializer</span>(scheme, scheme)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	serializers <span style=color:#ff7b72;font-weight:700>:=</span> []serializerType{
</span></span><span style=display:flex><span>		jsonSerializerType,
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			AcceptContentTypes: []<span style=color:#ff7b72>string</span>{runtime.ContentTypeYAML},
</span></span><span style=display:flex><span>			ContentType:        runtime.ContentTypeYAML,
</span></span><span style=display:flex><span>			FileExtensions:     []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;yaml&#34;</span>},
</span></span><span style=display:flex><span>			EncodesAsText:      <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>			Serializer:         yamlSerializer,
</span></span><span style=display:flex><span>			StrictSerializer:   strictYAMLSerializer,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			AcceptContentTypes: []<span style=color:#ff7b72>string</span>{runtime.ContentTypeProtobuf},
</span></span><span style=display:flex><span>			ContentType:        runtime.ContentTypeProtobuf,
</span></span><span style=display:flex><span>			FileExtensions:     []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;pb&#34;</span>},
</span></span><span style=display:flex><span>			Serializer:         protoSerializer,
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// note, strict decoding is unsupported for protobuf,
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#8b949e;font-style:italic>// fall back to regular serializing
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			StrictSerializer: protoSerializer,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			Framer:           protobuf.LengthDelimitedFramer,
</span></span><span style=display:flex><span>			StreamSerializer: protoRawSerializer,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> _, fn <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> serializerExtensions {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> serializer, ok <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>fn</span>(scheme); ok {
</span></span><span style=display:flex><span>			serializers = append(serializers, serializer)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> serializers
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ jsonSerializer 与 yamlSerializer 分别通过json.NewSerializer 和 json.NewYAMLSerializer 函数进行实例化，jsonSerializer通过 application/json 的ContentType 标识， 文件扩展名为 json，而yamlSerializer 通过application/yaml 的 ContentType 标识，文件扩展名 为 yaml。protobufserializer 通过 protobuf.NewSerializer 函数进行实例化，它通过 application/ vnd.kubernetes.protobuf 的ContentType 标识，文件扩展名为pb</p><h3 id=jsonserializer-与-yamlserializer-序列化器>jsonSerializer 与 yamlSerializer 序列化器<a hidden class=anchor aria-hidden=true href=#jsonserializer-与-yamlserializer-序列化器>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// staging/src/k8s.io/apimachinery/pkg/runtime/serializer/json/json.go
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Serializer) <span style=color:#d2a8ff;font-weight:700>Decode</span>(originalData []<span style=color:#ff7b72>byte</span>, gvk <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, into runtime.Object) (runtime.Object, <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>	data <span style=color:#ff7b72;font-weight:700>:=</span> originalData
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> s.options.Yaml {
</span></span><span style=display:flex><span>		altered, err <span style=color:#ff7b72;font-weight:700>:=</span> yaml.<span style=color:#d2a8ff;font-weight:700>YAMLToJSON</span>(data)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		data = altered
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	actual, err <span style=color:#ff7b72;font-weight:700>:=</span> s.meta.<span style=color:#d2a8ff;font-weight:700>Interpret</span>(data)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> gvk <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72;font-weight:700>*</span>actual = <span style=color:#d2a8ff;font-weight:700>gvkWithDefaults</span>(<span style=color:#ff7b72;font-weight:700>*</span>actual, <span style=color:#ff7b72;font-weight:700>*</span>gvk)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> unk, ok <span style=color:#ff7b72;font-weight:700>:=</span> into.(<span style=color:#ff7b72;font-weight:700>*</span>runtime.Unknown); ok <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> unk <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		unk.Raw = originalData
</span></span><span style=display:flex><span>		unk.ContentType = runtime.ContentTypeJSON
</span></span><span style=display:flex><span>		unk.<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>().<span style=color:#d2a8ff;font-weight:700>SetGroupVersionKind</span>(<span style=color:#ff7b72;font-weight:700>*</span>actual)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> unk, actual, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> into <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		_, isUnstructured <span style=color:#ff7b72;font-weight:700>:=</span> into.(runtime.Unstructured)
</span></span><span style=display:flex><span>		types, _, err <span style=color:#ff7b72;font-weight:700>:=</span> s.typer.<span style=color:#d2a8ff;font-weight:700>ObjectKinds</span>(into)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>switch</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> runtime.<span style=color:#d2a8ff;font-weight:700>IsNotRegisteredError</span>(err), isUnstructured:
</span></span><span style=display:flex><span>			strictErrs, err <span style=color:#ff7b72;font-weight:700>:=</span> s.<span style=color:#d2a8ff;font-weight:700>unmarshal</span>(into, data, originalData)
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, err
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// when decoding directly into a provided unstructured object,
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#8b949e;font-style:italic>// extract the actual gvk decoded from the provided data,
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#8b949e;font-style:italic>// and ensure it is non-empty.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#ff7b72>if</span> isUnstructured {
</span></span><span style=display:flex><span>				<span style=color:#ff7b72;font-weight:700>*</span>actual = into.<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>().<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>()
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>if</span> len(actual.Kind) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewMissingKindErr</span>(string(originalData))
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#8b949e;font-style:italic>// TODO(109023): require apiVersion here as well once unstructuredJSONScheme#Decode does
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> len(strictErrs) &gt; <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> into, actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewStrictDecodingError</span>(strictErrs)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> into, actual, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span>:
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, err
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#ff7b72;font-weight:700>*</span>actual = <span style=color:#d2a8ff;font-weight:700>gvkWithDefaults</span>(<span style=color:#ff7b72;font-weight:700>*</span>actual, types[<span style=color:#a5d6ff>0</span>])
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> len(actual.Kind) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewMissingKindErr</span>(string(originalData))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> len(actual.Version) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewMissingVersionErr</span>(string(originalData))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// use the target if necessary
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	obj, err <span style=color:#ff7b72;font-weight:700>:=</span> runtime.<span style=color:#d2a8ff;font-weight:700>UseOrCreateObject</span>(s.typer, s.creater, <span style=color:#ff7b72;font-weight:700>*</span>actual, into)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	strictErrs, err <span style=color:#ff7b72;font-weight:700>:=</span> s.<span style=color:#d2a8ff;font-weight:700>unmarshal</span>(obj, data, originalData)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, actual, err
</span></span><span style=display:flex><span>	} <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> len(strictErrs) &gt; <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> obj, actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewStrictDecodingError</span>(strictErrs)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> obj, actual, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ Decode 两数支持两种格式的反序列化操作 ，分别是 YAML 格式和 JSON格式。</p><p>​ 如果是 YAML 格式，则通过 yaml.YAMLTOJSON 两数将 JSON 格式数据转换为资源对象并填充到data 字段中。此时，无论反序列化操作的是YAML格式还是JSON 格式，data 字段中都是JSON格式数据。按着通过s.meta.Interpret 函数从JSON格式 数据中提取出资源对象的metav1.TypeMeta (即 APIVersion 和Kind 字段)。最后通过 caseSensitiveJsonlterator.Unmarshal 函数 (即json-iterator )将JSON 数据反序列化并返回。</p><h3 id=protobufserializer-序列化器>protobufSerializer 序列化器<a hidden class=anchor aria-hidden=true href=#protobufserializer-序列化器>#</a></h3><p>​ Protobuf (Google Protocol Buffer )是Google 公司内部的混合语言数据标准， Protocol Buffers是一种轻便、高效的结构化数据存储格式，可以用于结构化数据序列 化。它很适合做数据存储或成为 RPC 数据交换格式。它可用于通信协议、数据存储等领域，与语言无关、与平台无关、可扩展的序列化结构数据格式。</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#ff7b72>package</span> <span style=color:#ff7b72>lm</span>;<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>message</span> <span style=color:#f0883e;font-weight:700>helloworld</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span>{<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>required</span> <span style=color:#ff7b72>int32</span> id <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>; <span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>required</span> <span style=color:#ff7b72>string</span> str <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>2</span>; <span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>optional</span> <span style=color:#ff7b72>int32</span> opt <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3</span>;<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span>}<span style=color:#f85149>
</span></span></span></code></pre></td></tr></table></div></div><p>​ Protobuf 序列化器使用 proto 库来实现序列化和反序列操作</p><h4 id=1-序列化操作>1. 序列化操作<a hidden class=anchor aria-hidden=true href=#1-序列化操作>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Serializer) <span style=color:#d2a8ff;font-weight:700>doEncode</span>(obj runtime.Object, w io.Writer, memAlloc runtime.MemoryAllocator) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> memAlloc <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		klog.<span style=color:#d2a8ff;font-weight:700>Error</span>(<span style=color:#a5d6ff>&#34;a mandatory memory allocator wasn&#39;t provided, this might have a negative impact on performance, check invocations of EncodeWithAllocator method, falling back on runtime.SimpleAllocator&#34;</span>)
</span></span><span style=display:flex><span>		memAlloc = <span style=color:#ff7b72;font-weight:700>&amp;</span>runtime.SimpleAllocator{}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	prefixSize <span style=color:#ff7b72;font-weight:700>:=</span> uint64(len(s.prefix))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>var</span> unk runtime.Unknown
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>switch</span> t <span style=color:#ff7b72;font-weight:700>:=</span> obj.(<span style=color:#ff7b72>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> <span style=color:#ff7b72;font-weight:700>*</span>runtime.Unknown:
</span></span><span style=display:flex><span>		estimatedSize <span style=color:#ff7b72;font-weight:700>:=</span> prefixSize <span style=color:#ff7b72;font-weight:700>+</span> uint64(t.<span style=color:#d2a8ff;font-weight:700>Size</span>())
</span></span><span style=display:flex><span>		data <span style=color:#ff7b72;font-weight:700>:=</span> memAlloc.<span style=color:#d2a8ff;font-weight:700>Allocate</span>(estimatedSize)
</span></span><span style=display:flex><span>		i, err <span style=color:#ff7b72;font-weight:700>:=</span> t.<span style=color:#d2a8ff;font-weight:700>MarshalTo</span>(data[prefixSize:])
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		copy(data, s.prefix)
</span></span><span style=display:flex><span>		_, err = w.<span style=color:#d2a8ff;font-weight:700>Write</span>(data[:prefixSize<span style=color:#ff7b72;font-weight:700>+</span>uint64(i)])
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>		kind <span style=color:#ff7b72;font-weight:700>:=</span> obj.<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>().<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>()
</span></span><span style=display:flex><span>		unk = runtime.Unknown{
</span></span><span style=display:flex><span>			TypeMeta: runtime.TypeMeta{
</span></span><span style=display:flex><span>				Kind:       kind.Kind,
</span></span><span style=display:flex><span>				APIVersion: kind.<span style=color:#d2a8ff;font-weight:700>GroupVersion</span>().<span style=color:#d2a8ff;font-weight:700>String</span>(),
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>switch</span> t <span style=color:#ff7b72;font-weight:700>:=</span> obj.(<span style=color:#ff7b72>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> bufferedMarshaller:
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// this path performs a single allocation during write only when the Allocator wasn&#39;t provided
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#8b949e;font-style:italic>// it also requires the caller to implement the more efficient Size and MarshalToSizedBuffer methods
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		encodedSize <span style=color:#ff7b72;font-weight:700>:=</span> uint64(t.<span style=color:#d2a8ff;font-weight:700>Size</span>())
</span></span><span style=display:flex><span>		estimatedSize <span style=color:#ff7b72;font-weight:700>:=</span> prefixSize <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#d2a8ff;font-weight:700>estimateUnknownSize</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>unk, encodedSize)
</span></span><span style=display:flex><span>		data <span style=color:#ff7b72;font-weight:700>:=</span> memAlloc.<span style=color:#d2a8ff;font-weight:700>Allocate</span>(estimatedSize)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		i, err <span style=color:#ff7b72;font-weight:700>:=</span> unk.<span style=color:#d2a8ff;font-weight:700>NestedMarshalTo</span>(data[prefixSize:], t, encodedSize)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		copy(data, s.prefix)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		_, err = w.<span style=color:#d2a8ff;font-weight:700>Write</span>(data[:prefixSize<span style=color:#ff7b72;font-weight:700>+</span>uint64(i)])
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> proto.Marshaler:
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// this path performs extra allocations
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		data, err <span style=color:#ff7b72;font-weight:700>:=</span> t.<span style=color:#d2a8ff;font-weight:700>Marshal</span>()
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		unk.Raw = data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		estimatedSize <span style=color:#ff7b72;font-weight:700>:=</span> prefixSize <span style=color:#ff7b72;font-weight:700>+</span> uint64(unk.<span style=color:#d2a8ff;font-weight:700>Size</span>())
</span></span><span style=display:flex><span>		data = memAlloc.<span style=color:#d2a8ff;font-weight:700>Allocate</span>(estimatedSize)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		i, err <span style=color:#ff7b72;font-weight:700>:=</span> unk.<span style=color:#d2a8ff;font-weight:700>MarshalTo</span>(data[prefixSize:])
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		copy(data, s.prefix)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		_, err = w.<span style=color:#d2a8ff;font-weight:700>Write</span>(data[:prefixSize<span style=color:#ff7b72;font-weight:700>+</span>uint64(i)])
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// TODO: marshal with a different content type and serializer (JSON for third party objects)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>return</span> errNotMarshalable{reflect.<span style=color:#d2a8ff;font-weight:700>TypeOf</span>(obj)}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ Encode 函数首先验证资源对象 proto.Marshaler类型，proto.Marshaler是一个interface接又类型，该接又专门留给对象自定义实现的序列化操作。如果资源对象为proto.Marshaler类型，则通过t.Marshal序列化函数进行编码。
​ 而且，通过unk.MarshalTo两数在编码后的数据前加上protoEncodingPrefix前缀，前缀为magic-number特殊标识，其用于标识一个包的完整性。所有通过protobufSerializer序列化器编码的数据都会有前缀。前缀数据共4字节，分别是0x6b、0x38、0x73、0x00，其中第4个字节是为编码样式保留的。</p><h4 id=2-反序列化操作>2. 反序列化操作<a hidden class=anchor aria-hidden=true href=#2-反序列化操作>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>Serializer) <span style=color:#d2a8ff;font-weight:700>Decode</span>(originalData []<span style=color:#ff7b72>byte</span>, gvk <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, into runtime.Object) (runtime.Object, <span style=color:#ff7b72;font-weight:700>*</span>schema.GroupVersionKind, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>	prefixLen <span style=color:#ff7b72;font-weight:700>:=</span> len(s.prefix)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> len(originalData) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// TODO: treat like decoding {} from JSON with defaulting
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;empty data&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> len(originalData) &lt; prefixLen <span style=color:#ff7b72;font-weight:700>||</span> !bytes.<span style=color:#d2a8ff;font-weight:700>Equal</span>(s.prefix, originalData[:prefixLen]):
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;provided data does not appear to be a protobuf message, expected prefix %v&#34;</span>, s.prefix)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>case</span> len(originalData) <span style=color:#ff7b72;font-weight:700>==</span> prefixLen:
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// TODO: treat like decoding {} from JSON with defaulting
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;empty body&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	data <span style=color:#ff7b72;font-weight:700>:=</span> originalData[prefixLen:]
</span></span><span style=display:flex><span>	unk <span style=color:#ff7b72;font-weight:700>:=</span> runtime.Unknown{}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> unk.<span style=color:#d2a8ff;font-weight:700>Unmarshal</span>(data); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	actual <span style=color:#ff7b72;font-weight:700>:=</span> unk.<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>()
</span></span><span style=display:flex><span>	<span style=color:#d2a8ff;font-weight:700>copyKindDefaults</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>actual, gvk)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> intoUnknown, ok <span style=color:#ff7b72;font-weight:700>:=</span> into.(<span style=color:#ff7b72;font-weight:700>*</span>runtime.Unknown); ok <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> intoUnknown <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72;font-weight:700>*</span>intoUnknown = unk
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>if</span> ok, _, _ <span style=color:#ff7b72;font-weight:700>:=</span> s.<span style=color:#d2a8ff;font-weight:700>RecognizesData</span>(unk.Raw); ok {
</span></span><span style=display:flex><span>			intoUnknown.ContentType = runtime.ContentTypeProtobuf
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> intoUnknown, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> into <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		types, _, err <span style=color:#ff7b72;font-weight:700>:=</span> s.typer.<span style=color:#d2a8ff;font-weight:700>ObjectKinds</span>(into)
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>switch</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> runtime.<span style=color:#d2a8ff;font-weight:700>IsNotRegisteredError</span>(err):
</span></span><span style=display:flex><span>			pb, ok <span style=color:#ff7b72;font-weight:700>:=</span> into.(proto.Message)
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> !ok {
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, errNotMarshalable{reflect.<span style=color:#d2a8ff;font-weight:700>TypeOf</span>(into)}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> proto.<span style=color:#d2a8ff;font-weight:700>Unmarshal</span>(unk.Raw, pb); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, err
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> into, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>case</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span>:
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, err
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#d2a8ff;font-weight:700>copyKindDefaults</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>actual, <span style=color:#ff7b72;font-weight:700>&amp;</span>types[<span style=color:#a5d6ff>0</span>])
</span></span><span style=display:flex><span>			<span style=color:#8b949e;font-style:italic>// if the result of defaulting did not set a version or group, ensure that at least group is set
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#8b949e;font-style:italic>// (copyKindDefaults will not assign Group if version is already set). This guarantees that the group
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#8b949e;font-style:italic>// of into is set if there is no better information from the caller or object.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>			<span style=color:#ff7b72>if</span> len(actual.Version) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> len(actual.Group) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>				actual.Group = types[<span style=color:#a5d6ff>0</span>].Group
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> len(actual.Kind) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewMissingKindErr</span>(fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;%#v&#34;</span>, unk.TypeMeta))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> len(actual.Version) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, runtime.<span style=color:#d2a8ff;font-weight:700>NewMissingVersionErr</span>(fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;%#v&#34;</span>, unk.TypeMeta))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> <span style=color:#d2a8ff;font-weight:700>unmarshalToObject</span>(s.typer, s.creater, <span style=color:#ff7b72;font-weight:700>&amp;</span>actual, into, unk.Raw)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>​ Decode两数首先验证protoEncodingPrefix前缀，前级为magic-number特殊标识，其用于标识一个包的完整性，然后验证资源对象是否为proto.Mesage类型，最后通过 proto.Unmarshal 反序列化函数进行解码。</p><h2 id=converter-资源版本转换器>Converter 资源版本转换器<a hidden class=anchor aria-hidden=true href=#converter-资源版本转换器>#</a></h2><p>​ 在Kubernetes 系统中，同一资源拥有多个资源版本，Kubernetes 系统允许同一资 源的不同资源版本进行转换，例如Deployment 资源对象， 当前运行的是v1beta1 资 源版本，但vlbetal 资源版本的某些功能或字段不如v1资源版本完善，则可以将 Deployment 资源对象的v1beta1 资源版本转换为 v1 版本。可通过kubectl convert 命 令进行资源版本转换，执行命令如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>apps/v1beta1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Deployment</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>	</span><span style=color:#a5d6ff>name:nginx-deployment</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>	</span><span style=color:#7ee787>replicas</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>template</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>containers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      	</span><span style=color:#7ee787>image</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>nginx:1.7.9</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      	</span>- <span style=color:#a5d6ff>containerPort:80</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl convert -f vlbeta1Deployment.yami --output-version<span style=color:#ff7b72;font-weight:700>=</span>apps/v1
</span></span></code></pre></td></tr></table></div></div><p>​ 首先，定义一个 YAML Manifest File 资源描述文件，该文件中定义Deployment 资源版本为v1beta1。通过执行kubect convert 命令，&ndash;output -ver sion 将 资源版本转换 为指定的资源版本v1。如果指定的资源版本不在Scheme 资源注册表中，则会报错。 如果不指定资源版本，则默认转换为资源的首选版本。</p><p>​ Converter 资源版本转换器主要用于解决多资源版本转换问题，Kubernetes 系统 中的一 个资源支持多个资源版本，如果要在每个资源版本之间转换，最直接的方式是，每个资源版本都支持其他资源版本的转换，但这样处理起来非常麻烦。例如，某个资源对象支持 3 个资源版本，那么就需要提前定义一个资源版本转换到其他两个资源版本(vI&ndash; vlalphal,vI- vlbetal)、(vlalphal-v1,vlalphal-v1beta1)及( v1beta1-v1, vlbetal&ndash;vlalphal)，随着资源版本的增加，资源版本转换的定义会越来越多。</p><p>​ 为了解决这个问题，Kubernetes通过内部版本(InternalVersion)机制实现资源版本转换，Converter 资源版本转换过程如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420175427860.png alt=image-20230420175427860></p><p>​ 当需要在两个资源版本之间转换时，例如 vlalphal&ndash;vlbetal 或 vlalphal&ndash;v1。 Converter 资源版本转换器先将第 一个资源版本转换为_ internal 内部版本，再转换为相应的资源版本。每个资源只要能支持内部版本，就能与其他任何资源版本进行间接的资源版本转换</p><h3 id=converter-转换器数据结构>Converter 转换器数据结构<a hidden class=anchor aria-hidden=true href=#converter-转换器数据结构>#</a></h3><p>​ Converter转换器数据结构主要存放转换函数(即Conversion Funcs)。Converter 转换器数据结构代码示例如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Converter knows how to convert one type to another.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>type</span> Converter <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// Map from the conversion pair to a function which can
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#8b949e;font-style:italic>// do the conversion.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	conversionFuncs          ConversionFuncs
</span></span><span style=display:flex><span>	generatedConversionFuncs ConversionFuncs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// Set of conversions that should be treated as a no-op
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	ignoredUntypedConversions <span style=color:#ff7b72>map</span>[typePair]<span style=color:#ff7b72>struct</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>conversionFuncs: 默认转换两数。这些转换西数 一般定义在资源目录下的 conversion.go 代码文件中。</li><li>generatedConversionFuncs: 自动生成的转换两数。这些转换函数 一般定 义在资源目录下的 zz_generated.conversion.go 代码文件中，是由代码生成器自动生成的转换函数。</li><li>ignoredConversions: 若资源对象注册到此字段，则忽略此资源对象的转换操作。</li></ul><p>​ Converter转换器数据结构中存放的转换两数(即ConversionFuncs)可以分为两类，分别为默认的转换两数(即conversionFuncs字段)和自动生成的转换函数(即generatedConversionFuncs字段)。它们都通过ConversionFuncs来管理转换函数，代码示例如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> ConversionFuncs <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	untyped <span style=color:#ff7b72>map</span>[typePair]ConversionFunc
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> typePair <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>	source reflect.Type
</span></span><span style=display:flex><span>	dest   reflect.Type
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> ConversionFunc <span style=color:#ff7b72>func</span>(a, b <span style=color:#ff7b72>interface</span>{}, scope Scope) <span style=color:#ff7b72>error</span>
</span></span></code></pre></td></tr></table></div></div><p>​ ConversionFunc 类型函数(即Type Function )定义了转换函数实现的结构，将资 源对象a转换为资源对象b。a 参数定义了转换源(即source)的资源类型，b 参数定义 了转换目标(即dest)的资源类型。scope 定义了多次转换机制(即递归调用转换函数)。</p><blockquote><p>ConversionFunc 类型函数的资源对象传参必须是指针，否则无法进 行转换并抛出异常</p></blockquote><h3 id=converter-注册转换函数>Converter 注册转换函数<a hidden class=anchor aria-hidden=true href=#converter-注册转换函数>#</a></h3><p>​ Converter 转换函数需要通过注册才能在Kubernetes 内部使用，目前 Kubernetes 支持 5 个注册转换西数，分别介绍如下。</p><ul><li>scheme. AddlgnoredConversionType :注册忽略的资源类型，不会执行转换操作，忽略资源对象的转换操作。</li><li>scheme. AddConversionFuncs: 注册多个Conversion Func 转换函数</li><li>scheme.AddConversionFunc: 注册单个Conversion Func转换函数</li><li>scheme. AddGeneratedConversionFunc: 注册自动生成的转换函数</li><li>scheme.AddFieldLabelConversionFune: 注册字段标签 ( FieldLabel )的转换函数</li></ul><p>​ 以apps/v1资源组、资源版本为例，通过scheme.AddConversionFuncs函数注册所有资源的转换函数，代码示例如下</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// v1版本好像已经弃用了
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>addConversionFuncs</span>(scheme <span style=color:#ff7b72;font-weight:700>*</span>runtime.Scheme) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// Add field label conversions for kinds having selectable nothing but ObjectMeta fields.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> scheme.<span style=color:#d2a8ff;font-weight:700>AddFieldLabelConversionFunc</span>(SchemeGroupVersion.<span style=color:#d2a8ff;font-weight:700>WithKind</span>(<span style=color:#a5d6ff>&#34;StatefulSet&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>func</span>(label, value <span style=color:#ff7b72>string</span>) (<span style=color:#ff7b72>string</span>, <span style=color:#ff7b72>string</span>, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>switch</span> label {
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#34;metadata.name&#34;</span>, <span style=color:#a5d6ff>&#34;metadata.namespace&#34;</span>, <span style=color:#a5d6ff>&#34;status.successful&#34;</span>:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> label, value, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#ff7b72>default</span>:
</span></span><span style=display:flex><span>				<span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#34;&#34;</span>, <span style=color:#a5d6ff>&#34;&#34;</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;field label not supported for appsv1beta2.StatefulSet: %s&#34;</span>, label)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=converter-资源版本转换原理>Converter 资源版本转换原理<a hidden class=anchor aria-hidden=true href=#converter-资源版本转换原理>#</a></h3><p>​ Converter 转换器在 Kubernetes 源码中实际应用非常广泛，例如 Deployment 资源对象，起初使用 v1beta1 资源版本，而 v1 资源版本更稳定，则会将 v1beta1 资源版本转换为v1资源版本 。Converter 资源版本转换过程如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420181057162.png alt=image-20230420181057162></p><p>代码示例</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ! 版本转换在1.7中废弃，此代码在最新版本中转换失败
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	appsv1 <span style=color:#a5d6ff>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span style=display:flex><span>	appsv1beta1 <span style=color:#a5d6ff>&#34;k8s.io/api/apps/v1beta1&#34;</span>
</span></span><span style=display:flex><span>	metav1 <span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a5d6ff>&#34;k8s.io/kubernetes/pkg/apis/apps&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// KnownType external
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	scheme <span style=color:#ff7b72;font-weight:700>:=</span> runtime.<span style=color:#d2a8ff;font-weight:700>NewScheme</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(appsv1beta1.SchemeGroupVersion, <span style=color:#ff7b72;font-weight:700>&amp;</span>appsv1beta1.Deployment{})
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(appsv1.SchemeGroupVersion, <span style=color:#ff7b72;font-weight:700>&amp;</span>appsv1.Deployment{})
</span></span><span style=display:flex><span>	scheme.<span style=color:#d2a8ff;font-weight:700>AddKnownTypes</span>(apps.SchemeGroupVersion, <span style=color:#ff7b72;font-weight:700>&amp;</span>appsv1.Deployment{})
</span></span><span style=display:flex><span>	metav1.<span style=color:#d2a8ff;font-weight:700>AddToGroupVersion</span>(scheme, appsv1beta1.SchemeGroupVersion)
</span></span><span style=display:flex><span>	metav1.<span style=color:#d2a8ff;font-weight:700>AddToGroupVersion</span>(scheme, appsv1.SchemeGroupVersion)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	v1betalDeployment <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>appsv1beta1.Deployment{TypeMeta: metav1.TypeMeta{Kind: <span style=color:#a5d6ff>&#34;Deployment&#34;</span>, APIVersion: <span style=color:#a5d6ff>&#34;apps/v1beta1&#34;</span>}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// v1beta1 - internal
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	objInternal, err <span style=color:#ff7b72;font-weight:700>:=</span> scheme.<span style=color:#d2a8ff;font-weight:700>ConvertToVersion</span>(v1betalDeployment, apps.SchemeGroupVersion)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		panic(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;GVK:&#34;</span>, objInternal.<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>().<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>().<span style=color:#d2a8ff;font-weight:700>String</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// internal - v1
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>	objV1, err <span style=color:#ff7b72;font-weight:700>:=</span> scheme.<span style=color:#d2a8ff;font-weight:700>ConvertToVersion</span>(objInternal, appsv1.SchemeGroupVersion)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>		panic(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	v1Deployment, ok <span style=color:#ff7b72;font-weight:700>:=</span> objV1.(<span style=color:#ff7b72;font-weight:700>*</span>appsv1.Deployment)
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> !ok {
</span></span><span style=display:flex><span>		panic(<span style=color:#a5d6ff>&#34;not a Deployment&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	fmt.<span style=color:#d2a8ff;font-weight:700>Println</span>(<span style=color:#a5d6ff>&#34;GVK:&#34;</span>, v1Deployment.<span style=color:#d2a8ff;font-weight:700>GetObjectKind</span>().<span style=color:#d2a8ff;font-weight:700>GroupVersionKind</span>().<span style=color:#d2a8ff;font-weight:700>String</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>代码分析：</p><ul><li><p>第 1 部分 ： 实例化一个空的 scheme 资源注册表 ， 将 v1beta1 资源版本 、 v1 资源版本及内部版本 （ internal ） 的 Deployment 资源注册到 scheme 资源注册表中 。</p></li><li><p>第 2 部分 ： 实例化 v1beta1 Deployment 资源对象 ， 通过 scheme.ConvefiToVersion 将其转换为目标资源版本（ 即 internale 版本 ），得到 objlnternal资源对象 ， objlnternal 资源对象的 GVK 输出为 “ / ， Kind= ”</p></li><li><p>第 3 部分 ： 将 obj lnternal 资源对象通过 scheme.ConvertToVersion 转换为目标资源版本 （ 即 v1 资源版本 ） ， 得到 objV1资源对象 ， 并通过断言的方式来验证是否转换成功 ， objV1 资源对象的 GVK 输出为 “ apps/v 1 ， Kind=Deployment " 。</p><ul><li>在 converter Example 代码示例的第 2 部分中 ， 将 vlbetal 资源版本转换为内部版本 （ 即 internal 版本 ） ， 得到转换后资源对象的 GVK 为 “ / ， Kind= ” 。 在这里 ， 读者肯定会产生疑问 ， 为什么 vlbetal 资源版本转换为内部版本以后得到的 GVK 为 “ / ，Kind= ” 而不是 “ apps/__internal ， Kmd=Deployment ” 。 下面带着疑问来看看 Kubernetes源码实现 。</li><li>scheme 资源注册表可以通过两种方式进行版本转换 ， 分别介绍如下 。</li><li>scheme.ConvertToVersion ： 将传入的 (in) 资源对象转换成目标 （ target ）资源版本 ，在版本转换之前 ，会将资源对象深复制一份后再执行转换操作 ，相当于安全的内存对象转换操作 。与 scheme.ConvertToVersion 功能相同 ，</li><li>scheme.UnsafeConvcrtToVersion ：但在转换过程中不会深复制资源对象 ， 而是直接对原资源对象进行转换操作 ， 尽可能高效地实现转换 。但该操作是非安全的内存对象转换操作 。</li></ul><p>scheme.ConvertToVersion 与 scheme.UnsafeConveftToVersion 资源版本转换功能都依赖于 s.convertToVersion 函数来实现 ， Converter 转换器流程图如图</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/Lucareful/RepoImg/img/image-20230420183659993.png alt=image-20230420183659993></p></li></ul><h4 id=1获取传入的资源对象的反射类型>1.获取传入的资源对象的反射类型<a hidden class=anchor aria-hidden=true href=#1获取传入的资源对象的反射类型>#</a></h4><p>​ 资源版本转换的类型可以是 runtime.ObJect 或 runtime.Unstructured ， 它们都属于Go 语言里的 struct 数据结构 ， 通过 Go 语言标准库 reflect 机制获取该资源类型的反射类型 ， 因为在 scheme 资源注册表中是以反射类型注册资源的 。 获取传入的资源对象的反射类型 。</p><h4 id=2从资源注册表中查找到传入的资源对象的-gvk>2.从资源注册表中查找到传入的资源对象的 GVK<a hidden class=anchor aria-hidden=true href=#2从资源注册表中查找到传入的资源对象的-gvk>#</a></h4><p>从 scheme 资源注册表中查找到传入的资源对象的所有 GVK ， 验证传入的资源对象是否己经注册 ， 如果未曾注册 ， 则返回错误.</p><h4 id=3从个-gvk-中选出与目标资源对象相匹配的-gvk>3.从个 GVK 中选出与目标资源对象相匹配的 GVK<a hidden class=anchor aria-hidden=true href=#3从个-gvk-中选出与目标资源对象相匹配的-gvk>#</a></h4><p>​ target.KindForGroupVersionKinds 函数从多个可转换的 GVK 中选出与目标资源对象相匹配的 GVK 。 这里有一个优化点 ， 转换过程是相对耗时的 ， 大量的相同资源之间进行版本转换的耗时会比较长 。 在 Kubemetes 源码中判断 ， 如果目标资源对象的 GVK 在可转换的 G VK 列表中 ， 则直接将传入的资源对象的 G VK 设置为目标资源对象的 GVK ， 而无须执行转换操作 ， 缩短部分耗时 。</p><h4 id=4判断传入的资源对象是否属于-unversioned-类型>4.判断传入的资源对象是否属于 Unversioned 类型<a hidden class=anchor aria-hidden=true href=#4判断传入的资源对象是否属于-unversioned-类型>#</a></h4><p>​ 对于 Unversioned 类型 ， 前面曾介绍过 ， 即无版本类型 （ UnversionedType) 。 属于该类型的资源对象并不需要进行转换操作 ， 而是直接将传入的资源对象的 GVK 设置为目标资源对象的 GVK 。</p><h4 id=5执行转换操作>5.执行转换操作<a hidden class=anchor aria-hidden=true href=#5执行转换操作>#</a></h4><p>在执行转换操作之前 ， 先判断是否需要对传入的资源对象执行深复制操作 ， 然后通过 s.converter.Convert 转换函数执行转换操作.</p><p>​ 实际的转换函数是通过 doconversion 函数执行的 ， 执行过程如下 。</p><ul><li>从默认转换函数列表 （ 即 c.conversionFuncs ） 中查找出 pair 对应的转换函数 ， 如果存在则执行该转换函数 （ 即fn ） 并返回 。</li><li>从自动生成的转换函数列表 （ 即 generatedConversionFuncs ） 中查找出 pair 对应的转换函数 ， 如果存在则执行该转换函数 （ 即fn ） 并返回 。</li><li>如果默认转换函数列表和自动生成的转换函数列表中都不存在当前资源对象的转换函数 ， 则使用 doconversion 函数传入的转换函数 （ 即 f) 。 调用 f
之前 ， 需要将 s rc 与 dest 资源对象通过 EnforcePtr 函数取指针的值 ， 因为函数传入的转换函数接收的是非指针资源对象 。</li></ul><h4 id=6设置转换后资源对象的-gvk>6.设置转换后资源对象的 GVK<a hidden class=anchor aria-hidden=true href=#6设置转换后资源对象的-gvk>#</a></h4><p>​ 在代码示例的第 2 部分中 ， 将 v1beta1 资源版本转换为内部版本 （ 即 internal 版本 ），得到转换后资源对象的 GVK 为 “ / ， Kind= ” 。 原因在于 setTargetKind 函数 ， 转换操作执行完成以后 ， 通过 setTargetKind 函数设置转换后资源对象的 GVK ， 判断当前资源对象是否为内部版本 （ 即 APIVersion1nternal) ， 是内部版本则设置 GVK 为 schema.GroupVersionKind{}</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.me/en/tags/k8s/>K8s</a></li></ul><nav class=paginav><a class=prev href=https://luenci.me/en/posts/prometheus-%E5%85%A5%E9%97%A8%E5%AE%9E%E6%93%8D/><span class=title>« Prev</span><br><span>Prometheus 入门实操</span>
</a><a class=next href=https://luenci.me/en/posts/k8s%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%841/><span class=title>Next »</span><br><span>k8s核心数据结构（1）</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on x" href="https://x.com/intent/tweet/?text=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f&amp;hashtags=k8s"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f&amp;title=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89&amp;summary=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89&amp;source=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f&title=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on whatsapp" href="https://api.whatsapp.com/send?text=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89%20-%20https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on telegram" href="https://telegram.me/share/url?text=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89&amp;url=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share k8s核心数据结构（2） on ycombinator" href="https://news.ycombinator.com/submitlink?t=k8s%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%ef%bc%882%ef%bc%89&u=https%3a%2f%2fluenci.me%2fen%2fposts%2fk8s%25E6%25A0%25B8%25E5%25BF%2583%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%25842%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2024 <a href=https://luenci.me/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>