<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Golang pprof 性能分析指南 | Luenci</title>
<meta name=keywords content="golang"><meta name=description content='Golang pprof 性能分析指南

pprof 是一个用于可视化和分析分析数据的工具。
采样方式

  
      
          方式名称
          如何使用
          优点
          缺点
          使用场景
      
  
  
      
          runtime/pprof
          手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。
          灵活性高、按需采集。
          
          工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。
      
      
          net/http/pprof
          通过http服务来获取Profile采样文件。 import _ "net/http/pprof"。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来
          简单易用
          
          在线服务（一直运行着的程序）
      
      
          go test
          通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。
          针对性强、细化到函数
          
          进行某函数的性能测试
      
  

指标解释


常用指标如下：


allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的


block：导致在同步原语上发生阻塞的堆栈跟踪


cmdline： 当前程序的命令行的完整调用路径。


goroutine：目前的 goroutine 数量及运行情况


heap：当前时刻的内存使用情况


mutex：查看导致互斥锁的竞争持有者的堆栈跟踪


profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件


threadcreate：查看创建新 OS 线程的堆栈跟踪。


trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）



注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：


1
2


runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block  
runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex



注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。
'><meta name=author content="Luenci"><link rel=canonical href=https://luenci.com/en/posts/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=16x16 href=https://luenci.com/images/L.png><link rel=icon type=image/png sizes=32x32 href=https://luenci.com/images/L.png><link rel=apple-touch-icon href=https://luenci.com/L.png><link rel=mask-icon href=https://luenci.com/L.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://luenci.com/en/posts/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://umami.luenci.com/script.js data-website-id=b0a9e971-b470-43a2-bda9-182c654377f4></script><meta property="og:title" content="Golang pprof 性能分析指南"><meta property="og:description" content='Golang pprof 性能分析指南

pprof 是一个用于可视化和分析分析数据的工具。
采样方式

  
      
          方式名称
          如何使用
          优点
          缺点
          使用场景
      
  
  
      
          runtime/pprof
          手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。
          灵活性高、按需采集。
          
          工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。
      
      
          net/http/pprof
          通过http服务来获取Profile采样文件。 import _ "net/http/pprof"。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来
          简单易用
          
          在线服务（一直运行着的程序）
      
      
          go test
          通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。
          针对性强、细化到函数
          
          进行某函数的性能测试
      
  

指标解释


常用指标如下：


allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的


block：导致在同步原语上发生阻塞的堆栈跟踪


cmdline： 当前程序的命令行的完整调用路径。


goroutine：目前的 goroutine 数量及运行情况


heap：当前时刻的内存使用情况


mutex：查看导致互斥锁的竞争持有者的堆栈跟踪


profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件


threadcreate：查看创建新 OS 线程的堆栈跟踪。


trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）



注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：


1
2


runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block  
runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex



注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。
'><meta property="og:type" content="article"><meta property="og:url" content="https://luenci.com/en/posts/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-03T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-03T00:00:00+00:00"><meta property="og:site_name" content="(〃'▽'〃)"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang pprof 性能分析指南"><meta name=twitter:description content='Golang pprof 性能分析指南

pprof 是一个用于可视化和分析分析数据的工具。
采样方式

  
      
          方式名称
          如何使用
          优点
          缺点
          使用场景
      
  
  
      
          runtime/pprof
          手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。
          灵活性高、按需采集。
          
          工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。
      
      
          net/http/pprof
          通过http服务来获取Profile采样文件。 import _ "net/http/pprof"。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来
          简单易用
          
          在线服务（一直运行着的程序）
      
      
          go test
          通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。
          针对性强、细化到函数
          
          进行某函数的性能测试
      
  

指标解释


常用指标如下：


allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的


block：导致在同步原语上发生阻塞的堆栈跟踪


cmdline： 当前程序的命令行的完整调用路径。


goroutine：目前的 goroutine 数量及运行情况


heap：当前时刻的内存使用情况


mutex：查看导致互斥锁的竞争持有者的堆栈跟踪


profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件


threadcreate：查看创建新 OS 线程的堆栈跟踪。


trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）



注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：


1
2


runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block  
runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex



注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。
'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luenci.com/en/posts/"},{"@type":"ListItem","position":2,"name":"Golang pprof 性能分析指南","item":"https://luenci.com/en/posts/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golang pprof 性能分析指南","name":"Golang pprof 性能分析指南","description":"Golang pprof 性能分析指南 pprof 是一个用于可视化和分析分析数据的工具。\n采样方式 方式名称 如何使用 优点 缺点 使用场景 runtime/pprof 手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。 灵活性高、按需采集。 工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。 net/http/pprof 通过http服务来获取Profile采样文件。 import _ \u0026quot;net/http/pprof\u0026quot;。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来 简单易用 在线服务（一直运行着的程序） go test 通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。 针对性强、细化到函数 进行某函数的性能测试 指标解释 常用指标如下：\nallocs：所有时刻的内存使用情况，包括正在使用的及已经回收的\nblock：导致在同步原语上发生阻塞的堆栈跟踪\ncmdline： 当前程序的命令行的完整调用路径。\ngoroutine：目前的 goroutine 数量及运行情况\nheap：当前时刻的内存使用情况\nmutex：查看导致互斥锁的竞争持有者的堆栈跟踪\nprofile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件\nthreadcreate：查看创建新 OS 线程的堆栈跟踪。\ntrance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）\n注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：\n1 2 runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex 注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。 ","keywords":["golang"],"articleBody":"Golang pprof 性能分析指南 pprof 是一个用于可视化和分析分析数据的工具。\n采样方式 方式名称 如何使用 优点 缺点 使用场景 runtime/pprof 手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等API来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。 灵活性高、按需采集。 工具型应用（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。 net/http/pprof 通过http服务来获取Profile采样文件。 import _ \"net/http/pprof\"。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来 简单易用 在线服务（一直运行着的程序） go test 通过命令go test -bench . -cpuprofile cpu.prof来进行采集数据。 针对性强、细化到函数 进行某函数的性能测试 指标解释 常用指标如下：\nallocs：所有时刻的内存使用情况，包括正在使用的及已经回收的\nblock：导致在同步原语上发生阻塞的堆栈跟踪\ncmdline： 当前程序的命令行的完整调用路径。\ngoroutine：目前的 goroutine 数量及运行情况\nheap：当前时刻的内存使用情况\nmutex：查看导致互斥锁的竞争持有者的堆栈跟踪\nprofile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件\nthreadcreate：查看创建新 OS 线程的堆栈跟踪。\ntrance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（深入浅出 Go trace (qq.com)）\n注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：\n1 2 runtime.SetBlockProfileRate(1) // 开启对阻塞操作的跟踪，block runtime.SetMutexProfileFraction(1) // 开启对锁调用的跟踪，mutex 注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。 理解指标 flat：函数自身的运行耗时。 flat%：函数自身在 CPU 运行耗时总比例。 sum%：函数自身累积使用 CPU 总比例。 cum：函数自身及其调用函数的运行总耗时。 cum%：函数自身及其调用函数的运行耗时总比例。 flat flat% 一个函数内的 directly 操作的物理耗时。例如 flat只会记录 step2 和 step3 的时间\n1 2 3 4 5 6 7 func foo(){ a() // step1 largeArray := [math.MaxInt64]int64{} // step2 for i := 0; i \u003c math.MaxInt64; i++ { // step3 c() // step4 } } flat%即是 `flat/总运行时间`。内存等参数同理。**所有的 flat 相加即是总采样时间**，所有的flat%相加应该等于100%。 flat一般是我们最关注的。其代表一个函数可能非常耗时，或者调用了非常多次，或者两者兼而有之，从而导致这个函数消耗了最多的时间。 如果是我们自己编写的代码，则很可能有一些无脑 for 循环、复杂的计算、字符串操作、频繁申请内存等等。 如果是第三方库的代码，则很可能我们过于频繁地调用了这些第三方库，或者以不正确的方式使用了这些第三方库。 cum cum% 相比 flat，cum则是这个函数内所有操作的物理耗时，比如包括了上述的 step1、2、3、4。 cum%即是`cum的时间/总运行时间`。内存等参数同理。 一般cum是我们次关注的，且需要结合flat来看。 flat 可以让我们知道哪个函数耗时多，而 cum 可以帮助我们找到是哪些函数调用了这些耗时的（flat 值大的）函数。\nsum% 其上所有行的flat%的累加。可以视为，这一行及其以上行，其所有的 directly 操作一共占了多少物理时间。 案例分析 go test cpu 使用分析：-cpuprofile=cpu.pprof 内存使用分析：-benchmem -memprofile=mem.pprof block分析：-blockprofile=block.pprof 1 2 3 4 go test -bench=. -run=none -benchmem -memprofile=mem.pprof go test -bench=. -run=none -blockprofile=block.pprof go test -bench=. -run=none -benchmem -memprofile=mem.pprof -cpuprofile=cpu.pprof s go test -bench=. -run=none -benchmem -memprofile=mem.pprof -cpuprofsile=cpu.pprof -blockprofile=block.pprof runtime/pprof 除了注入 http handler 和 go test 以外，我们还可以在程序中通过 pprof 所提供的 Lookup 方法来进行相关内容的采集和调用，其一共支持六种类型，分别是：goroutine、threadcreate、heap、block、mutex，代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 type LookupType int8 const ( LookupGoroutine LookupType = iota LookupThreadcreate LookupHeap LookupAllocs LookupBlock LookupMutex ) func pprofLookup(lookupType LookupType, w io.Writer) error { var err error switch lookupType { case LookupGoroutine: p := pprof.Lookup(\"goroutine\") err = p.WriteTo(w, 2) case LookupThreadcreate: p := pprof.Lookup(\"threadcreate\") err = p.WriteTo(w, 2) case LookupHeap: p := pprof.Lookup(\"heap\") err = p.WriteTo(w, 2) case LookupAllocs: p := pprof.Lookup(\"allocs\") err = p.WriteTo(w, 2) case LookupBlock: p := pprof.Lookup(\"block\") err = p.WriteTo(w, 2) case LookupMutex: p := pprof.Lookup(\"mutex\") err = p.WriteTo(w, 2) } return err } 接下来我们只需要对该方法进行调用就好了，其提供了 io.Writer 接口，也就是只要实现了对应的 Write 方法，我们可以将其写到任何支持地方去，如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func init() { runtime.SetMutexProfileFraction(1) runtime.SetBlockProfileRate(1) } func main() { http.HandleFunc(\"/lookup/heap\", func(w http.ResponseWriter, r *http.Request) { _ = pprofLookup(LookupHeap, os.Stdout) }) http.HandleFunc(\"/lookup/threadcreate\", func(w http.ResponseWriter, r *http.Request) { _ = pprofLookup(LookupThreadcreate, os.Stdout) }) http.HandleFunc(\"/lookup/block\", func(w http.ResponseWriter, r *http.Request) { _ = pprofLookup(LookupBlock, os.Stdout) }) http.HandleFunc(\"/lookup/goroutine\", func(w http.ResponseWriter, r *http.Request) { _ = pprofLookup(LookupGoroutine, os.Stdout) }) _ = http.ListenAndServe(\"0.0.0.0:6060\", nil) } 采集CPU(CPU 占用过高) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func CollectCpu() { // 创建分析文件，在当前目录下 file, err := os.Create(\"./cpu.prof\") if err != nil { fmt.Printf(\"创建采集文件失败, err:%v\\n\", err) return } // 进行 cpu 数据的获取 pprof.StartCPUProfile(file) defer pprof.SweightCPUProfile() // 执行一段有问题的代码 for i := 0; i \u003c 4; i++ { s go do1() } time.Sleep(10 * time.Second) } net/http/pprof 1 2 # 网页，运行该命令让程序开始半分钟（默认值）的CPU采样 服务开启了 pprof $ go tool pprof http://127.0.0.1:8080/debug/pprof/profile 扩展参数选项 选项名 作用 alloc_objects 分析应用程序的内存临时分配情况 alloc_space 查看每个函数分配的内存空间大小 inuse_space 分析应用程序的常驻内存占用情况 inuse_objects 查看每个函数所分配的对象数量 常用命令 web （连线图） 通过Web浏览器可视化图\nweb 将会生成一张svg格式的图片，并用默认打开程序打开（一般是浏览器）。渲染图片需要下载 Download | Graphviz\n节点的颜色越红，其cum和cum%越大。其颜色越灰白，则cum和cum%越小。 节点越大，其flat和flat%越大；其越小，则flat和flat%越小 线条代表了函数的调用链，线条越粗，代表指向的函数消耗了越多的资源。反之亦然。 线条的样式代表了调用关系。实线代表直接调用；虚线代表中间少了几个节点；带有inline字段表示该函数被内联进了调用方（不用在意，可以理解成实线）。 对于一些代码行比较少的函数，编译器倾向于将它们在编译期展开从而消除函数调用，这种行为就是内联。\nweight weight默认按flat排序，打印出消耗前10的函数。也可以选择消耗前N的函数，比如weight5，weight20。\nlist 当发现某个函数资源占用情况可疑时，可以通过 list 函数名 定位到具体的代码位置。比如: list Fire\n火焰图 调用顺序**由上到下**，每一块代表一个函数，越大代表占用 CPU 的时间更长。同时它也可以支持点击块深入进行分析。 代码优化建议 以下是一些从其它项目借鉴或者自己总结的实践经验，它们只是建议，而不是准则，实际项目中应该以性能分析数据来作为优化的参考，避免过早优化。\n对频繁分配的小对象，使用 sync.Pool 对象池避免分配 自动化的 DeepCopy 是非常耗时的，其中涉及到反射，内存分配，容器(如 map)扩展等，大概比手动拷贝慢一个数量级 用 atomic.Load/StoreXXX，atomic.Value, sync.Map 等代替 Mutex。(优先级递减) 使用高效的第三方库，如用fasthttp替代 net/http 在开发环境加上-race编译选项进行竞态检查 在开发环境开启 net/http/pprof，方便实时 pprof 将所有外部IO(网络IO，磁盘IO)做成异步ss 参考文章 Go 语言性能调试与分析工具：pprof 用法简介 | wxsm’s pace golang pprof实用使用指南 - 掘金 (juejin.cn) Profiling in Go: A Practical Guide | nyadgar.com golang的pprof与火焰图实战 | wish (debug-lixiwen.github.io) golang pprof 实战 | Wolfogre’s Blog Go性能分析工具 | Farmer (farmerchillax.github.io) ","wordCount":"3029","inLanguage":"en","datePublished":"2024-08-03T00:00:00Z","dateModified":"2024-08-03T00:00:00Z","author":{"@type":"Person","name":"Luenci"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luenci.com/en/posts/golang-pprof-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/"},"publisher":{"@type":"Organization","name":"Luenci","logo":{"@type":"ImageObject","url":"https://luenci.com/images/L.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luenci.com/en/ accesskey=h title="Luenci (Alt + H)"><img src=https://luenci.com/images/avatar.jpg alt aria-label=logo height=35>Luenci</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luenci.com/en/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://luenci.com/en/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luenci.com/en/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luenci.com/en/archives title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luenci.com/en/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luenci.com/en/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luenci.com/en/links title=🤝友链><span>🤝友链</span></a></li><li><a href=https://luenci.com/en/index.xml title=📬RSS><span>📬RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luenci.com/en/>Home</a>&nbsp;»&nbsp;<a href=https://luenci.com/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Golang pprof 性能分析指南</h1><div class=post-meta><span title='2024-08-03 00:00:00 +0000 UTC'>2024-08-03</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;3029 words&nbsp;·&nbsp;Luenci</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#golang-pprof-%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97 aria-label="Golang pprof 性能分析指南">Golang pprof 性能分析指南</a><ul><li><a href=#%e9%87%87%e6%a0%b7%e6%96%b9%e5%bc%8f aria-label=采样方式>采样方式</a></li><li><a href=#%e6%8c%87%e6%a0%87%e8%a7%a3%e9%87%8a aria-label=指标解释>指标解释</a></li><li><a href=#%e7%90%86%e8%a7%a3%e6%8c%87%e6%a0%87 aria-label=理解指标>理解指标</a><ul><li><a href=#flat-flat aria-label="flat flat%"><code>flat flat%</code></a></li><li><a href=#cum-cum aria-label="cum cum%"><code>cum cum%</code></a></li><li><a href=#sum aria-label=sum%><code>sum%</code></a></li></ul></li><li><a href=#%e6%a1%88%e4%be%8b%e5%88%86%e6%9e%90 aria-label=案例分析>案例分析</a></li><li><a href=#go-test aria-label="go test">go test</a></li><li><a href=#runtimepprof aria-label=runtime/pprof>runtime/pprof</a><ul><li><a href=#%e9%87%87%e9%9b%86cpucpu-%e5%8d%a0%e7%94%a8%e8%bf%87%e9%ab%98 aria-label="采集CPU(CPU 占用过高)">采集CPU(CPU 占用过高)</a></li></ul></li><li><a href=#nethttppprof aria-label=net/http/pprof>net/http/pprof</a><ul><li><a href=#%e6%89%a9%e5%b1%95%e5%8f%82%e6%95%b0%e9%80%89%e9%a1%b9 aria-label=扩展参数选项>扩展参数选项</a></li><li><a href=#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label=常用命令>常用命令</a><ul><li><a href=#web-%e8%bf%9e%e7%ba%bf%e5%9b%be aria-label="web （连线图）">web （连线图）</a></li><li><a href=#weight aria-label=weight>weight</a></li><li><a href=#list aria-label=list>list</a></li></ul></li><li><a href=#%e7%81%ab%e7%84%b0%e5%9b%be aria-label=火焰图>火焰图</a></li></ul></li><li><a href=#%e4%bb%a3%e7%a0%81%e4%bc%98%e5%8c%96%e5%bb%ba%e8%ae%ae aria-label=代码优化建议>代码优化建议</a></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 aria-label=参考文章>参考文章</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=golang-pprof-性能分析指南>Golang pprof 性能分析指南<a hidden class=anchor aria-hidden=true href=#golang-pprof-性能分析指南>#</a></h1><blockquote><p>pprof 是一个用于可视化和分析分析数据的工具。</p></blockquote><h2 id=采样方式>采样方式<a hidden class=anchor aria-hidden=true href=#采样方式>#</a></h2><table><thead><tr><th style=text-align:left>方式名称</th><th style=text-align:left>如何使用</th><th style=text-align:left>优点</th><th style=text-align:left>缺点</th><th style=text-align:left>使用场景</th></tr></thead><tbody><tr><td style=text-align:left>runtime/pprof</td><td style=text-align:left>手动调用【runtime.StartCPUProfile、runtime.SweightCPUProfile】等<strong>API</strong>来进行数据的采集。采集程序（非 Server）的指定区块的运行数据进行分析。</td><td style=text-align:left><strong>灵活性高</strong>、按需采集。</td><td style=text-align:left></td><td style=text-align:left><strong>工具型应用</strong>（比如说定制化的分析小工具、集成到公司监控系统）。这种应用运行一段时间就结束。</td></tr><tr><td style=text-align:left>net/http/pprof</td><td style=text-align:left>通过<strong>http</strong>服务来获取Profile采样文件。 <code>import _ "net/http/pprof"</code>。基于 HTTP Server 运行，并且可以采集运行时数据进行分析。<code>net/http/pprof中只是使用runtime/pprof包来进行封装了一下，并在http端口上暴露出来</code></td><td style=text-align:left><strong>简单易用</strong></td><td style=text-align:left></td><td style=text-align:left>在线服务（一直运行着的程序）</td></tr><tr><td style=text-align:left>go test</td><td style=text-align:left>通过命令<code>go test -bench . -cpuprofile cpu.prof</code>来进行采集数据。</td><td style=text-align:left><strong>针对性强</strong>、细化到函数</td><td style=text-align:left></td><td style=text-align:left>进行某函数的性能测试</td></tr></tbody></table><h2 id=指标解释>指标解释<a hidden class=anchor aria-hidden=true href=#指标解释>#</a></h2><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151739088.png alt=350959005-c2182bee-333f-4ec3-94cb-7a36440bb105></p><p>常用指标如下：</p><ul><li><p>allocs：所有时刻的内存使用情况，包括正在使用的及已经回收的</p></li><li><p>block：导致在同步原语上发生阻塞的堆栈跟踪</p></li><li><p>cmdline： 当前程序的命令行的完整调用路径。</p></li><li><p>goroutine：目前的 goroutine 数量及运行情况</p></li><li><p>heap：当前时刻的内存使用情况</p></li><li><p>mutex：查看导致互斥锁的竞争持有者的堆栈跟踪</p></li><li><p>profile：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件</p></li><li><p>threadcreate：查看创建新 OS 线程的堆栈跟踪。</p></li><li><p>trance：当前程序执行的追踪，可以在秒数的 GET 参数中指定持续时间。在获取追踪文件后，请使用 go 工具的 trace 命令来调查追踪。（<a href=https://mp.weixin.qq.com/s/I9xSMxy32cALSNQAN8wlnQ>深入浅出 Go trace (qq.com)</a>）</p></li></ul><blockquote><p>注意，默认情况下是不追踪block和mutex的信息的，如果想要看这两个信息，需要在代码中加上两行：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>runtime.<span style=color:#d2a8ff;font-weight:700>SetBlockProfileRate</span>(<span style=color:#a5d6ff>1</span>) <span style=color:#8b949e;font-style:italic>// 开启对阻塞操作的跟踪，block  </span>
</span></span><span style=display:flex><span>runtime.<span style=color:#d2a8ff;font-weight:700>SetMutexProfileFraction</span>(<span style=color:#a5d6ff>1</span>) <span style=color:#8b949e;font-style:italic>// 开启对锁调用的跟踪，mutex</span>
</span></span></code></pre></td></tr></table></div></div></blockquote><pre><code>注意，上文的所有信息都是实时的，如果你刷新一下，是可以看到数字在变化的。此时如果点击蓝色的连接，可以看到一些协程的栈信息，这些信息并不容易阅读。如果想要更加清晰的数据，需要将信息保存下来，在本地进行分析。
</code></pre><h2 id=理解指标>理解指标<a hidden class=anchor aria-hidden=true href=#理解指标>#</a></h2><ul><li>flat：函数自身的运行耗时。</li><li>flat%：函数自身在 CPU 运行耗时总比例。</li><li>sum%：函数自身累积使用 CPU 总比例。</li><li>cum：函数自身及其调用函数的运行总耗时。</li><li>cum%：函数自身及其调用函数的运行耗时总比例。</li></ul><h3 id=flat-flat><code>flat flat%</code><a hidden class=anchor aria-hidden=true href=#flat-flat>#</a></h3><pre><code>一个函数内的 directly 操作的物理耗时。例如
</code></pre><blockquote><p>flat只会记录 step2 和 step3 的时间</p></blockquote><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>foo</span>(){
</span></span><span style=display:flex><span>     <span style=color:#d2a8ff;font-weight:700>a</span>()                                        <span style=color:#8b949e;font-style:italic>// step1</span>
</span></span><span style=display:flex><span>     largeArray <span style=color:#ff7b72;font-weight:700>:=</span> [math.MaxInt64]<span style=color:#ff7b72>int64</span>{}       <span style=color:#8b949e;font-style:italic>// step2</span>
</span></span><span style=display:flex><span>     <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; math.MaxInt64; i<span style=color:#ff7b72;font-weight:700>++</span> {       <span style=color:#8b949e;font-style:italic>// step3</span>
</span></span><span style=display:flex><span>             <span style=color:#d2a8ff;font-weight:700>c</span>()                                <span style=color:#8b949e;font-style:italic>// step4</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span> }
</span></span></code></pre></td></tr></table></div></div><pre><code>flat%即是 `flat/总运行时间`。内存等参数同理。**所有的 flat 相加即是总采样时间**，所有的flat%相加应该等于100%。

flat一般是我们最关注的。其代表一个函数可能非常耗时，或者调用了非常多次，或者两者兼而有之，从而导致这个函数消耗了最多的时间。

如果是我们自己编写的代码，则很可能有一些无脑 for 循环、复杂的计算、字符串操作、频繁申请内存等等。

如果是第三方库的代码，则很可能我们过于频繁地调用了这些第三方库，或者以不正确的方式使用了这些第三方库。
</code></pre><h3 id=cum-cum><code>cum cum%</code><a hidden class=anchor aria-hidden=true href=#cum-cum>#</a></h3><pre><code>相比 flat，cum则是这个函数内所有操作的物理耗时，比如包括了上述的 step1、2、3、4。

cum%即是`cum的时间/总运行时间`。内存等参数同理。

一般cum是我们次关注的，且需要结合flat来看。
</code></pre><p><strong>flat 可以让我们知道哪个函数耗时多，而 cum 可以帮助我们找到是哪些函数调用了这些耗时的（flat 值大的）函数。</strong></p><h3 id=sum><code>sum%</code><a hidden class=anchor aria-hidden=true href=#sum>#</a></h3><pre><code>其上所有行的flat%的累加。可以视为，这一行及其以上行，其所有的 directly 操作一共占了多少物理时间。
</code></pre><h2 id=案例分析>案例分析<a hidden class=anchor aria-hidden=true href=#案例分析>#</a></h2><h2 id=go-test>go test<a hidden class=anchor aria-hidden=true href=#go-test>#</a></h2><ul><li>cpu 使用分析：<code>-cpuprofile=cpu.pprof</code></li><li>内存使用分析：<code>-benchmem -memprofile=mem.pprof</code></li><li>block分析：<code>-blockprofile=block.pprof</code></li></ul><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go test -bench<span style=color:#ff7b72;font-weight:700>=</span>. -run<span style=color:#ff7b72;font-weight:700>=</span>none -benchmem -memprofile<span style=color:#ff7b72;font-weight:700>=</span>mem.pprof 
</span></span><span style=display:flex><span>go test -bench<span style=color:#ff7b72;font-weight:700>=</span>. -run<span style=color:#ff7b72;font-weight:700>=</span>none -blockprofile<span style=color:#ff7b72;font-weight:700>=</span>block.pprof 
</span></span><span style=display:flex><span>go test -bench<span style=color:#ff7b72;font-weight:700>=</span>. -run<span style=color:#ff7b72;font-weight:700>=</span>none -benchmem -memprofile<span style=color:#ff7b72;font-weight:700>=</span>mem.pprof -cpuprofile<span style=color:#ff7b72;font-weight:700>=</span>cpu.pprof s
</span></span><span style=display:flex><span>go test -bench<span style=color:#ff7b72;font-weight:700>=</span>. -run<span style=color:#ff7b72;font-weight:700>=</span>none -benchmem -memprofile<span style=color:#ff7b72;font-weight:700>=</span>mem.pprof -cpuprofsile<span style=color:#ff7b72;font-weight:700>=</span>cpu.pprof -blockprofile<span style=color:#ff7b72;font-weight:700>=</span>block.pprof
</span></span></code></pre></td></tr></table></div></div><h2 id=runtimepprof>runtime/pprof<a hidden class=anchor aria-hidden=true href=#runtimepprof>#</a></h2><p>除了注入 http handler 和 go test 以外，我们还可以在程序中通过 pprof 所提供的 Lookup 方法来进行相关内容的采集和调用，其一共支持六种类型，分别是：goroutine、threadcreate、heap、block、mutex，代码如下：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> LookupType <span style=color:#ff7b72>int8</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> ( 
</span></span><span style=display:flex><span>    LookupGoroutine LookupType = <span style=color:#79c0ff>iota</span> 
</span></span><span style=display:flex><span>    LookupThreadcreate LookupHeap 
</span></span><span style=display:flex><span>    LookupAllocs LookupBlock LookupMutex ) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>pprofLookup</span>(lookupType LookupType, w io.Writer) <span style=color:#ff7b72>error</span> { 
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>var</span> err <span style=color:#ff7b72>error</span> 
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>switch</span> lookupType { 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> LookupGoroutine: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;goroutine&#34;</span>) 
</span></span><span style=display:flex><span>        err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>    	<span style=color:#ff7b72>case</span> LookupThreadcreate: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;threadcreate&#34;</span>) 
</span></span><span style=display:flex><span>        err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> LookupHeap: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;heap&#34;</span>) 
</span></span><span style=display:flex><span>        err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> LookupAllocs: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;allocs&#34;</span>) 
</span></span><span style=display:flex><span>        	err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> LookupBlock: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;block&#34;</span>) 
</span></span><span style=display:flex><span>        	err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> LookupMutex: 
</span></span><span style=display:flex><span>        	p <span style=color:#ff7b72;font-weight:700>:=</span> pprof.<span style=color:#d2a8ff;font-weight:700>Lookup</span>(<span style=color:#a5d6ff>&#34;mutex&#34;</span>) 
</span></span><span style=display:flex><span>        	err = p.<span style=color:#d2a8ff;font-weight:700>WriteTo</span>(w, <span style=color:#a5d6ff>2</span>) 
</span></span><span style=display:flex><span>    	} 
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> err 
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>接下来我们只需要对该方法进行调用就好了，其提供了 <code>io.Writer</code> 接口，也就是只要实现了对应的 Write 方法，我们可以将其写到任何支持地方去，如下：</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>init</span>() { 
</span></span><span style=display:flex><span>    runtime.<span style=color:#d2a8ff;font-weight:700>SetMutexProfileFraction</span>(<span style=color:#a5d6ff>1</span>) 
</span></span><span style=display:flex><span>    runtime.<span style=color:#d2a8ff;font-weight:700>SetBlockProfileRate</span>(<span style=color:#a5d6ff>1</span>) 
</span></span><span style=display:flex><span>} 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() { 
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>HandleFunc</span>(<span style=color:#a5d6ff>&#34;/lookup/heap&#34;</span>, <span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>        _ = <span style=color:#d2a8ff;font-weight:700>pprofLookup</span>(LookupHeap, os.Stdout) }) 
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>HandleFunc</span>(<span style=color:#a5d6ff>&#34;/lookup/threadcreate&#34;</span>, <span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) { 
</span></span><span style=display:flex><span>        _ = <span style=color:#d2a8ff;font-weight:700>pprofLookup</span>(LookupThreadcreate, os.Stdout) }) 
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>HandleFunc</span>(<span style=color:#a5d6ff>&#34;/lookup/block&#34;</span>, <span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) { 
</span></span><span style=display:flex><span>        _ = <span style=color:#d2a8ff;font-weight:700>pprofLookup</span>(LookupBlock, os.Stdout) }) 
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>HandleFunc</span>(<span style=color:#a5d6ff>&#34;/lookup/goroutine&#34;</span>, <span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) { 
</span></span><span style=display:flex><span>        _ = <span style=color:#d2a8ff;font-weight:700>pprofLookup</span>(LookupGoroutine, os.Stdout) }) 
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    _ = http.<span style=color:#d2a8ff;font-weight:700>ListenAndServe</span>(<span style=color:#a5d6ff>&#34;0.0.0.0:6060&#34;</span>, <span style=color:#79c0ff>nil</span>) 
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=采集cpucpu-占用过高>采集CPU(CPU 占用过高)<a hidden class=anchor aria-hidden=true href=#采集cpucpu-占用过高>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>CollectCpu</span>() { 
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 创建分析文件，在当前目录下 </span>
</span></span><span style=display:flex><span>	file, err <span style=color:#ff7b72;font-weight:700>:=</span> os.<span style=color:#d2a8ff;font-weight:700>Create</span>(<span style=color:#a5d6ff>&#34;./cpu.prof&#34;</span>) 
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> { 
</span></span><span style=display:flex><span>		fmt.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;创建采集文件失败, err:%v\n&#34;</span>, err) 
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>return</span> 
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 进行 cpu 数据的获取 </span>
</span></span><span style=display:flex><span>	pprof.<span style=color:#d2a8ff;font-weight:700>StartCPUProfile</span>(file) 
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>defer</span> pprof.<span style=color:#d2a8ff;font-weight:700>SweightCPUProfile</span>() 
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>// 执行一段有问题的代码 </span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>; i &lt; <span style=color:#a5d6ff>4</span>; i<span style=color:#ff7b72;font-weight:700>++</span> { s
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>go</span> <span style=color:#d2a8ff;font-weight:700>do1</span>() 
</span></span><span style=display:flex><span>	} 
</span></span><span style=display:flex><span>	time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(<span style=color:#a5d6ff>10</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second) 
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=nethttppprof>net/http/pprof<a hidden class=anchor aria-hidden=true href=#nethttppprof>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span> <span style=color:#8b949e;font-style:italic># 网页，运行该命令让程序开始半分钟（默认值）的CPU采样 服务开启了 pprof</span>
</span></span><span style=display:flex><span> <span style=color:#ff7b72;font-weight:700>$</span> go <span style=color:#ff7b72>tool</span> pprof http:<span style=color:#ff7b72;font-weight:700>//</span><span style=color:#a5d6ff>127.0</span><span style=color:#ff7b72;font-weight:700>.</span><span style=color:#a5d6ff>0.1</span>:<span style=color:#a5d6ff>8080</span><span style=color:#ff7b72;font-weight:700>/</span>debug<span style=color:#ff7b72;font-weight:700>/</span>pprof<span style=color:#ff7b72;font-weight:700>/</span>profile
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151742895.png alt=350959401-d56c6bdc-d272-4960-8ac0-943f42b46e54></p><h3 id=扩展参数选项>扩展参数选项<a hidden class=anchor aria-hidden=true href=#扩展参数选项>#</a></h3><table><thead><tr><th style=text-align:left>选项名</th><th style=text-align:left>作用</th></tr></thead><tbody><tr><td style=text-align:left>alloc_objects</td><td style=text-align:left>分析应用程序的内存临时分配情况</td></tr><tr><td style=text-align:left>alloc_space</td><td style=text-align:left>查看每个函数分配的内存空间大小</td></tr><tr><td style=text-align:left>inuse_space</td><td style=text-align:left>分析应用程序的常驻内存占用情况</td></tr><tr><td style=text-align:left>inuse_objects</td><td style=text-align:left>查看每个函数所分配的对象数量</td></tr></tbody></table><h3 id=常用命令>常用命令<a hidden class=anchor aria-hidden=true href=#常用命令>#</a></h3><h4 id=web-连线图>web （连线图）<a hidden class=anchor aria-hidden=true href=#web-连线图>#</a></h4><blockquote><p>通过Web浏览器可视化图</p></blockquote><blockquote><p><code>web</code> 将会生成一张svg格式的图片，并用默认打开程序打开（一般是浏览器）。渲染图片需要下载 <a href=https://graphviz.org/download/>Download | Graphviz</a></p></blockquote><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151744662.png alt=350959152-f919098b-a923-4cbd-8349-89f0e3a0d52b></p><pre><code>节点的颜色越红，其cum和cum%越大。其颜色越灰白，则cum和cum%越小。

节点越大，其flat和flat%越大；其越小，则flat和flat%越小

线条代表了函数的调用链，线条越粗，代表指向的函数消耗了越多的资源。反之亦然。

线条的样式代表了调用关系。实线代表直接调用；虚线代表中间少了几个节点；带有inline字段表示该函数被内联进了调用方（不用在意，可以理解成实线）。
</code></pre><blockquote><p>对于一些代码行比较少的函数，编译器倾向于将它们在编译期展开从而消除函数调用，这种行为就是内联。</p></blockquote><h4 id=weight>weight<a hidden class=anchor aria-hidden=true href=#weight>#</a></h4><blockquote><p><code>weight</code>默认按flat排序，打印出消耗前10的函数。也可以选择消耗前N的函数，比如<code>weight5</code>，<code>weight20</code>。</p></blockquote><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151745485.png alt=350959570-a1c83317-3d82-4bfe-aaf7-4abfebd1884f></p><h4 id=list>list<a hidden class=anchor aria-hidden=true href=#list>#</a></h4><blockquote><p>当发现某个函数资源占用情况可疑时，可以通过 <code>list 函数名</code> 定位到具体的代码位置。比如:<code> list Fire</code></p></blockquote><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151746075.png alt=350959588-87007000-e59a-43d1-bcce-2c8e5fe79a9c></p><h3 id=火焰图>火焰图<a hidden class=anchor aria-hidden=true href=#火焰图>#</a></h3><pre><code>调用顺序**由上到下**，每一块代表一个函数，越大代表占用 CPU 的时间更长。同时它也可以支持点击块深入进行分析。
</code></pre><p><img loading=lazy src=https://raw.githubusercontent.com/Lucareful/RepoImg/main/img/202410151746996.png alt=350959621-4992c35f-ac6f-4e44-8246-a99ce6302bfb></p><h2 id=代码优化建议>代码优化建议<a hidden class=anchor aria-hidden=true href=#代码优化建议>#</a></h2><p>以下是一些从其它项目借鉴或者自己总结的实践经验，它们只是建议，而不是准则，实际项目中应该以性能分析数据来作为优化的参考，<strong>避免过早优化</strong>。</p><ol><li>对频繁分配的小对象，使用 <a href=https://golang.org/pkg/sync/#Pool>sync.Pool</a> 对象池避免分配</li><li>自动化的 DeepCopy 是非常耗时的，其中涉及到反射，内存分配，容器(如 map)扩展等，大概比手动拷贝慢一个数量级</li><li>用 atomic.Load/StoreXXX，atomic.Value, sync.Map 等代替 Mutex。(优先级递减)</li><li>使用高效的第三方库，如用<a href=https://github.com/valyala/fasthttp>fasthttp</a>替代 net/http</li><li>在开发环境加上<code>-race</code>编译选项进行竞态检查</li><li>在开发环境开启 net/http/pprof，方便实时 pprof</li><li>将所有外部IO(网络IO，磁盘IO)做成异步ss</li></ol><h2 id=参考文章>参考文章<a hidden class=anchor aria-hidden=true href=#参考文章>#</a></h2><ul><li><a href=https://wxsm.space/2023/go-pprof-note/>Go 语言性能调试与分析工具：pprof 用法简介 | wxsm&rsquo;s pace</a></li><li><a href=https://juejin.cn/post/7122473470424219656>golang pprof实用使用指南 - 掘金 (juejin.cn)</a></li><li><a href=https://nyadgar.com/posts/go-profiling-like-a-pro/>Profiling in Go: A Practical Guide | nyadgar.com</a></li><li><a href=https://debug-lixiwen.github.io/2021/07/18/shi-zhan/>golang的pprof与火焰图实战 | wish (debug-lixiwen.github.io)</a></li><li><a href=https://blog.wolfogre.com/posts/go-ppof-practice/>golang pprof 实战 | Wolfogre&rsquo;s Blog</a></li><li><a href=https://farmerchillax.github.io/2023/07/04/Go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/>Go性能分析工具 | Farmer (farmerchillax.github.io)</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://luenci.com/en/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://luenci.com/en/posts/golang-slice-%E5%B9%B6%E5%8F%91%E5%86%99%E5%85%A5/><span class=title>« Prev</span><br><span>golang slice 并发写入</span>
</a><a class=next href=https://luenci.com/en/posts/%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%92%8C%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B/><span class=title>Next »</span><br><span>声明式和命令式编程</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on x" href="https://x.com/intent/tweet/?text=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f&amp;hashtags=golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f&amp;title=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97&amp;summary=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97&amp;source=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f&title=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on whatsapp" href="https://api.whatsapp.com/send?text=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97%20-%20https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on telegram" href="https://telegram.me/share/url?text=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Golang pprof 性能分析指南 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Golang%20pprof%20%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e6%8c%87%e5%8d%97&u=https%3a%2f%2fluenci.com%2fen%2fposts%2fgolang-pprof-%25E6%2580%25A7%25E8%2583%25BD%25E5%2588%2586%25E6%259E%2590%25E6%258C%2587%25E5%258D%2597%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Lucareful/Lucareful.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxOTMzMDM3NDA=" data-category=Q&A data-category-id=DIC_kwDOC4WUvM4ChdIQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script><script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—— "+e.data.origin.author})</script><span><a id=running-time></a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>👁️‍🗨️访客人数: <span id=busuanzi_value_site_uv></span>|
🌐访问量: <span id=busuanzi_value_site_pv></span></span></span><br><span>&copy; 2025 <a href=https://luenci.com/en/>Luenci</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> 📖
<text class=poem_sentence></text><text class=poem_info></text></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});const RunningTimerInterval=1e3,StartTime=new Date("10/11/2018 00:00:00");function prefixZero(e){return e<10&&(e="0"+e),e}function updateTime(){const r=new Date;let e=r.getTime()-StartTime.getTime();const t=24*60*60*1e3,n=Math.floor(e/t);e-=n*t;const s=60*60*1e3,o=Math.floor(e/s);e-=o*s;const i=60*1e3,a=Math.floor(e/i);e-=a*i;const c=Math.floor(e/1e3),l=document.getElementById("running-time");l.innerText="🕚: "+n+"天"+prefixZero(o)+"小时"+prefixZero(a)+"分"+prefixZero(c)+"秒"}document.addEventListener("DOMContentLoaded",()=>{let e=setInterval(updateTime,RunningTimerInterval)})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>